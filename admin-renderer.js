function qs(id){ return document.getElementById(id); }
const escapeHtml = (s) => (typeof window.escapeHtml === 'function') ? window.escapeHtml(s) : String(s||'');
const parseDateFlexible = (val) => (typeof window.parseDateAny === 'function') ? window.parseDateAny(val) : null;
function findKey(headers, pattern){ const rx = new RegExp(pattern, 'i'); return headers.find(h => rx.test(h)) || null; }
function matchesSearch(c, term){ if(!term) return true; term = term.toLowerCase(); const keys = window._clientiHeaders || Object.keys(c); return keys.some(k => String(c[k]||'').toLowerCase().includes(term)); }
function withinExpiryFilter(c, months){ if(!months) return true; const headers = window._clientiHeaders || Object.keys(c); const expKey = window._clientiExpiryKey || (window._clientiExpiryKey = findKey(headers, 'SCADENZA.*PATENTE|SCADENZA')); if(!expKey) return true; const raw = c[expKey] ?? c[expKey+'Formatted']; const d = parseDateFlexible(raw); if(!d || isNaN(d.getTime())) return false; const limit = new Date(); limit.setMonth(limit.getMonth() + parseInt(months,10)); return d <= limit; }
function renderClienti(data){ const tbody = qs('clienti-tbody'); const thead = qs('clienti-thead'); if(!tbody || !thead) return; const term = qs('clienti-search')?.value?.trim()||''; const months = qs('clienti-filter-scadenza')?.value||''; const rawHeaders = (data && data.length) ? Object.keys(data[0]) : (window._clientiHeaders||[]); const headers = (window._clientiHeaders = rawHeaders.filter(h => !/formatted$/i.test(h))); thead.innerHTML = headers.map(h => `<th style="cursor:pointer" data-key="${escapeHtml(h)}">${escapeHtml(h)} ${window._clientiSort?.key===h ? (window.adminValidation?.arrow?.(window._clientiSort.dir) || '') : ''}</th>`).join('') + '<th class="text-end">Azioni</th>'; const cfKey = window._clientiCFKey || (window._clientiCFKey = findKey(headers, 'CODICE.*FISCALE|CF')); let rowsData = (data||[]).filter(c => headers.some(h => String(c[h]||'').trim() !== '')) .filter(c => matchesSearch(c, term)) .filter(c => withinExpiryFilter(c, months)); if(window._clientiSort && window._clientiSort.key){ const key = window._clientiSort.key; const dir = window._clientiSort.dir==='asc'?1:-1; const cmpDate = window.adminValidation?.cmpDate || (()=>0); const cmpNum = window.adminValidation?.cmpNum || (()=>0); const cmpStr = window.adminValidation?.cmpStr || (()=>0); rowsData = rowsData.sort((a,b) => { const av = a[key+'Formatted'] ?? a[key]; const bv = b[key+'Formatted'] ?? b[key]; const dcmp = cmpDate(av,bv); if(dcmp !== 0) return dcmp * dir; const ncmp = cmpNum(av,bv); if(ncmp !== 0) return ncmp * dir; return cmpStr(av,bv) * dir; }); }
 tbody.innerHTML = ''; if (!rowsData.length) { tbody.innerHTML = `<tr><td colspan="${headers.length+1}" class="text-center text-muted">Nessun cliente</td></tr>`; } else { const chunkSize = 200; let index = 0; const renderChunk = () => { const frag = document.createDocumentFragment(); for (let i = 0; i < chunkSize && index < rowsData.length; i++, index++) { const c = rowsData[index]; const tr = document.createElement('tr'); let html = ''; for (let h of headers) { const fmtKey = h + 'Formatted'; const value = c[fmtKey] ?? c[h]; const asDate = parseDateFlexible(value); const display = asDate ? (window.formatDateIT?.(asDate) || '') : (value ?? ''); html += `<td>${escapeHtml(display)}</td>`; } const cf = cfKey ? String(c[cfKey]||'') : ''; html += `<td class="text-end"><button class="btn btn-sm btn-outline-light" data-action="edit" data-cf="${escapeHtml(cf)}"><i class="fas fa-edit me-1"></i>Modifica</button></td>`; tr.innerHTML = html; frag.appendChild(tr); } tbody.appendChild(frag); if (index < rowsData.length) { requestAnimationFrame(renderChunk); } else { tbody.querySelectorAll('button[data-action="edit"]').forEach(btn => btn.addEventListener('click', () => window.openClienteModal?.(btn.dataset.cf))); } }; requestAnimationFrame(renderChunk); }
 thead.querySelectorAll('th[data-key]').forEach(th => { th.addEventListener('click', () => window.setClientiSort?.(th.dataset.key)); }); }
function renderFlottaTable(flotta){ const tb = document.getElementById('flotta-tbody'); if(!tb) return; if(!flotta?.length){ tb.innerHTML = `<tr><td colspan="6" class="text-center py-4">Nessun veicolo in flotta</td></tr>`; return; } const flottaSort = window.flottaSort || { key:'targa', dir:'asc' }; const cmpStr = window.adminValidation?.cmpStr || (()=>0); const cmpNum = window.adminValidation?.cmpNum || (()=>0); const dir = flottaSort.dir==='asc'?1:-1; const sorted = [...flotta].sort((a,b) => { let cmp = 0; switch(flottaSort.key){ case 'targa': cmp = cmpStr(a.Targa, b.Targa); break; case 'mm': cmp = cmpStr(`${a.Marca||''} ${a.Modello||''}`, `${b.Marca||''} ${b.Modello||''}`); break; case 'posti': cmp = cmpNum(a.Posti, b.Posti); break; case 'stato': { const sa = a.InManutenzioneOggi ? 'In manutenzione' : 'Disponibile'; const sb = b.InManutenzioneOggi ? 'In manutenzione' : 'Disponibile'; cmp = cmpStr(sa, sb); break; } case 'man': cmp = cmpStr(a.StatoManutenzione, b.StatoManutenzione); break; default: cmp = cmpStr(a.Targa, b.Targa); } return cmp * dir; }); tb.innerHTML = sorted.map(v => { const statoBadge = v.InManutenzioneOggi ? '<span class="pill-action pill-danger">Manutenzione attiva</span>' : '<span class="pill-action pill-success">Disponibile</span>'; const manInfo = v.StatoManutenzione && v.StatoManutenzione !== '-' ? `<span class="chip chip-muted"><i class="fas fa-tools me-1"></i>${v.StatoManutenzione}</span>` : `<span class="text-muted small">â€”</span>`; return `<tr>
          <td class="fw-semibold text-white">${v.Targa}</td>
          <td>${v.Marca} ${v.Modello}</td>
          <td>${v.Posti}</td>
          <td>${statoBadge}</td>
          <td>${manInfo}</td>
          <td class="text-end">
            <button class="btn action-btn action-secondary me-1" data-action="manutenzioni" data-targa="${v.Targa}" title="Gestisci manutenzioni"><i class="fas fa-tools"></i></button>
            <button class="btn action-btn action-warning me-1" data-action="modifica" data-targa="${v.Targa}" title="Modifica veicolo"><i class="fas fa-edit"></i></button>
            <button class="btn action-btn action-danger" data-action="elimina" data-targa="${v.Targa}" title="Elimina veicolo"><i class="fas fa-trash"></i></button>
          </td>
        </tr>`; }).join(''); tb.querySelectorAll('button[data-action]').forEach(btn => { const act = btn.getAttribute('data-action'); const targa = btn.getAttribute('data-targa'); if(act==='modifica') btn.addEventListener('click',()=> window.openVehicleModal?.(targa)); if(act==='elimina') btn.addEventListener('click',()=> window.deleteVehicle?.(targa)); if(act==='manutenzioni') btn.addEventListener('click',()=> window.openMaintenanceModal?.(targa)); }); }
function renderAdminVehicles(flotta, availableTags){ const grid = qs('admin-vehicles-grid'); if(!grid) return; const availableSet = new Set(availableTags); const available = flotta.filter(v => availableSet.has(v.Targa)); if(available.length === 0) { grid.innerHTML = '<div class="text-center text-muted p-3">Nessun veicolo disponibile</div>'; return; } grid.innerHTML = available.map(v => { const badges = ['<span class="badge bg-success">Disponibile</span>']; const passoLungo = v.PassoLungo || v.Targa === 'EC787NM'; if(passoLungo) badges.push('<span class="badge bg-warning">Passo Lungo</span>'); return `<div class="mb-3 p-3 border rounded"><div class="d-flex justify-content-between align-items-start mb-2">
          <div><h6 class="fw-bold mb-1">${escapeHtml(String(v.Marca||''))} ${escapeHtml(String(v.Modello||''))}</h6><div class="small text-muted">Targa: ${escapeHtml(String(v.Targa||''))} | ${escapeHtml(String(v.Posti||''))} posti</div></div>
          <div class="d-flex flex-wrap gap-1">${badges.join('')}</div></div>
        <button class="btn btn-sm btn-primary admin-vehicle-select" data-targa="${escapeHtml(String(v.Targa||''))}" data-vehicle='${encodeURIComponent(JSON.stringify(v))}'>
          <i class="fas fa-check me-1"></i>Seleziona per prenotazione</button></div>`; }).join(''); const countEl = qs('admin-vehicles-count'); if(countEl) countEl.textContent = `${available.length} disponibili su ${flotta.length} totali`; grid.querySelectorAll('.admin-vehicle-select').forEach(btn=>{ btn.addEventListener('click', (ev)=>{ try{ window.adminSelectedVehicle = JSON.parse(decodeURIComponent(ev.currentTarget.dataset.vehicle)); window.showAdminQuoteStep?.(); }catch(e){ window.adminSelectedVehicle=null; } }); }); }
const adminRenderer = { renderClienti, renderFlottaTable, renderAdminVehicles };
window.adminRenderer = adminRenderer;
window.renderClienti = renderClienti;
export { renderClienti, renderFlottaTable, renderAdminVehicles };
