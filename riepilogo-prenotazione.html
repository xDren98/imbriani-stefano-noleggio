<!DOCTYPE html>
<html lang="it" class="h-100">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Riepilogo Prenotazione - Imbriani Noleggio</title>
  <meta name="description" content="Riepilogo completo prenotazione, verifica dati autisti e conferma con email di aggiornamento.">
  <meta name="theme-color" content="#0066FF">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" integrity="sha512-RXf+QSDCUQs6b4v5A9R2v6KUVKp1R9+XcMgy7pYzFSHLn3U4a8gE9F7R5C3XxR28Z59TLEEqzvvR1vpuYeIRsA==" crossorigin="anonymous">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <style>
    body{background:linear-gradient(135deg,#0f172a 0%,#1e293b 100%);min-height:100vh}
    .glass-card{background:rgba(15,23,42,.8);border:1px solid rgba(148,163,184,.2);border-radius:12px;backdrop-filter:blur(10px)}
    .section-title{color:#e2e8f0;font-weight:700}
    .label{color:#94a3b8;min-width:170px;display:inline-block}
    .value{color:#e5e7eb}
    .btn-premium{background:linear-gradient(45deg,#0ea5e9,#3b82f6);border:none;color:#fff;font-weight:600}
    .btn-premium:hover{background:linear-gradient(45deg,#0284c7,#2563eb);color:#fff}
    .btn-linklike{color:#93c5fd; cursor:pointer; text-decoration:underline}
    .warn{color:#fbbf24}
    .small-muted{color:#94a3b8;font-size:.9rem}
  </style>
</head>
<body class="d-flex flex-column h-100">
<header class="py-4">
  <div class="container d-flex align-items-center justify-content-between flex-wrap gap-3">
    <div>
      <h1 class="h3 text-white fw-bold mb-1"><i class="fas fa-clipboard-check me-2"></i>Riepilogo Prenotazione</h1>
      <p class="text-white-50 mb-0">Verifica tutti i dati prima di confermare</p>
    </div>
    <div class="d-flex gap-2">
      <button type="button" id="back-btn" class="btn btn-outline-light btn-sm"><i class="fas fa-arrow-left me-1"></i>Indietro</button>
      <span class="px-3 py-1 rounded-pill" style="background:linear-gradient(45deg,#06b6d4,#2563eb);color:#fff;font-weight:700;">Step 4 di 4</span>
    </div>
  </div>
</header>

<main class="flex-grow-1 py-4">
  <div class="container">
    <div class="glass-card p-4 mb-4">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="section-title mb-0"><i class="fas fa-car me-2"></i>Dati prenotazione</h5>
        <span id="edit-booking" class="btn-linklike">Modifica dati prenotazione</span>
      </div>
      <div id="booking-summary" class="small-muted">Caricamento...</div>
    </div>

    <div class="glass-card p-4 mb-4">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="section-title mb-0"><i class="fas fa-id-card me-2"></i>Autisti</h5>
        <span id="edit-drivers" class="btn-linklike">Modifica dati autisti</span>
      </div>
      <div id="drivers-summary" class="small-muted">Caricamento...</div>
    </div>

    <div class="glass-card p-4 mb-4">
      <h5 class="section-title mb-3"><i class="fas fa-envelope me-2"></i>Ricevi aggiornamenti via email</h5>
      <div class="row g-3">
        <div class="col-md-8">
          <label class="form-label text-white-50">Email</label>
          <input type="email" id="emailUpdate" class="form-control" placeholder="nome@esempio.it" />
          <div class="form-text text-warning">Opzionale ma consigliata: riceverai conferma, eventuale preventivo e aggiornamenti stato.</div>
        </div>
      </div>
    </div>

    <div class="d-flex justify-content-between align-items-center glass-card p-4">
      <div class="small-muted"><i class="fas fa-triangle-exclamation me-1 warn"></i>Controlla con attenzione: nome, CF, date e residenza. Premi Conferma solo se tutti i dati sono corretti.</div>
      <button id="confirm-btn" class="btn btn-premium"><span id="confirm-spinner" class="spinner-border spinner-border-sm me-2 d-none"></span>Conferma e invia prenotazione</button>
    </div>
  </div>
</main>

<div id="toast-container" class="position-fixed top-0 end-0 p-3" style="z-index:1055;"></div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="config.js"></script>
<script src="shared-utils.js"></script>
<script>
  var selectedVehicle=null, selectedDates=null, drivers=null;
  document.addEventListener('DOMContentLoaded', function(){
    // Recupero da localStorage
    try{ selectedVehicle=JSON.parse(localStorage.getItem('imbriani_selected_vehicle')||'null'); }catch(_){ }
    try{ selectedDates=JSON.parse(localStorage.getItem('imbriani_selected_dates')||'null'); }catch(_){ }
    try{ drivers=JSON.parse(localStorage.getItem('imbriani_drivers')||'null'); }catch(_){ }

    if (!selectedVehicle || !selectedDates || !drivers){
      if (window.showToast) showToast('Dati incompleti: torna allo step precedente','error');
      return setTimeout(function(){ location.href='dati-autisti.html'; }, 1000);
    }

    renderBookingSummary();
    renderDriversSummary();
    bindUI();
  });

  function fmtDate(d){
    try{ return window.formatDateIT ? window.formatDateIT(d) : new Date(d).toLocaleDateString('it-IT'); }
    catch(_){ return d||''; }
  }

  function renderBookingSummary(){
    var el=document.getElementById('booking-summary');
    el.innerHTML = '\
      <div class="row">\
        <div class="col-md-6">\
          <div><span class="label">Veicolo</span> <span class="value">'+((window.escapeHtml?escapeHtml(selectedVehicle.Targa||''):(selectedVehicle.Targa||'')))+' - '+((window.escapeHtml?escapeHtml(selectedVehicle.Marca||''):(selectedVehicle.Marca||'')))+' '+((window.escapeHtml?escapeHtml(selectedVehicle.Modello||''):(selectedVehicle.Modello||'')))+'</span></div>\
          <div><span class="label">Posti</span> <span class="value">'+((window.escapeHtml?escapeHtml(String(selectedVehicle.Posti||'')):(selectedVehicle.Posti||'')))+(selectedVehicle.PassoLungo?' • Passo Lungo':'')+'</span></div>\
          <div><span class="label">Destinazione</span> <span class="value">'+((window.escapeHtml?escapeHtml(selectedDates.destinazione||'-'):(selectedDates.destinazione||'-')))+'</span></div>\
        </div>\
        <div class="col-md-6">\
          <div><span class="label">Ritiro</span> <span class="value">'+fmtDate(selectedDates.dataInizio)+' '+(selectedDates.oraRitiro||'')+'</span></div>\
          <div><span class="label">Riconsegna</span> <span class="value">'+fmtDate(selectedDates.dataFine)+' '+(selectedDates.oraRiconsegna||'')+'</span></div>\
        </div>\
      </div>';
  }

  function driverBlock(title, d){
    if (!d) return '';
    function v(x){
      const val = (x===undefined||x===null||x==='')?'-':String(x);
      return window.escapeHtml ? escapeHtml(val) : val;
    }
    const fmt = (x) => {
      if (!x) return '-';
      try { return (window.formatDateIT ? window.formatDateIT(x) : new Date(x).toLocaleDateString('it-IT')); }
      catch(_) { return x; }
    };
    return '\
      <div class="mb-3">\
        <div class="text-info fw-semibold mb-2">'+title+'</div>\
        <div class="row">\
          <div class="col-md-6">\
            <div><span class="label">Nome completo</span> <span class="value">'+v(d.nomeCompleto)+'</span></div>\
            <div><span class="label">Codice Fiscale</span> <span class="value">'+v(d.codiceFiscale)+'</span></div>\
            <div><span class="label">Data Nascita</span> <span class="value">'+fmt(d.dataNascita)+'</span></div>\
            <div><span class="label">Luogo Nascita</span> <span class="value">'+v(d.luogoNascita)+'</span></div>\
            <div><span class="label">Cellulare</span> <span class="value">'+v(d.cell || d.cellulare)+'</span></div>\
          </div>\
          <div class="col-md-6">\
            <div><span class="label">Numero Patente</span> <span class="value">'+v(d.numeroPatente)+'</span></div>\
            <div><span class="label">Inizio Validità</span> <span class="value">'+fmt(d.inizioValiditaPatente || d.dataInizioPatente)+'</span></div>\
            <div><span class="label">Scadenza</span> <span class="value">'+fmt(d.scadenzaPatente)+'</span></div>\
            <div><span class="label">Residenza</span> <span class="value">'+[v(d.viaResidenza), v(d.civicoResidenza), v(d.comuneResidenza)].filter(Boolean).join(', ')+'</span></div>\
          </div>\
        </div>\
      </div>';
  }

  function renderDriversSummary(){
    var el=document.getElementById('drivers-summary');
    el.innerHTML = [
      driverBlock('Autista principale', drivers.autista1),
      drivers.autista2&&drivers.autista2.codiceFiscale? driverBlock('Autista 2', drivers.autista2): '',
      drivers.autista3&&drivers.autista3.codiceFiscale? driverBlock('Autista 3', drivers.autista3): ''
    ].join('');
  }

  function bindUI(){
    var back=document.getElementById('back-btn'); if (back) back.addEventListener('click', function(){ history.back(); });
    var editDrivers=document.getElementById('edit-drivers'); if (editDrivers) editDrivers.addEventListener('click', function(){ location.href='dati-autisti.html'; });
    var editBooking=document.getElementById('edit-booking'); if (editBooking) editBooking.addEventListener('click', function(){ location.href='richiesta-preventivo.html'; });

    var btn=document.getElementById('confirm-btn'); var spn=document.getElementById('confirm-spinner');
    btn.addEventListener('click', async function(){
      var email=document.getElementById('emailUpdate').value.trim();
      btn.disabled=true; spn.classList.remove('d-none');
      try{
        const toIT = (d) => { try { return (window.formatDateIT ? window.formatDateIT(d) : d) || ''; } catch(_) { return d||''; } };
        const mapDriverDates = (drv) => {
          if (!drv) return null;
          const out = { ...drv };
          out.dataNascita = toIT(drv.dataNascita);
          out.inizioValiditaPatente = toIT(drv.inizioValiditaPatente || drv.dataInizioPatente);
          out.scadenzaPatente = toIT(drv.scadenzaPatente);
          return out;
        };
        var payload={
          targa:selectedVehicle.Targa,
          giornoInizio: toIT(selectedDates.dataInizio),
          giornoFine: toIT(selectedDates.dataFine),
          oraInizio:selectedDates.oraRitiro,
          oraFine:selectedDates.oraRiconsegna,
          destinazione:selectedDates.destinazione||'',
          autista1: (function(){ const base = mapDriverDates(drivers.autista1)||{}; base.cellulare = (drivers.autista1 && (drivers.autista1.cell || drivers.autista1.cellulare)) || ''; return base; })(),
          autista2: (drivers.autista2 && drivers.autista2.codiceFiscale) ? (function(){ const base = mapDriverDates(drivers.autista2)||{}; base.cellulare = (drivers.autista2 && (drivers.autista2.cell || drivers.autista2.cellulare)) || ''; return base; })() : null,
          autista3: (drivers.autista3 && drivers.autista3.codiceFiscale) ? (function(){ const base = mapDriverDates(drivers.autista3)||{}; base.cellulare = (drivers.autista3 && (drivers.autista3.cell || drivers.autista3.cellulare)) || ''; return base; })() : null,
          email: email || null,
          upsertClienti:true
        };

        // Usa il wrapper sicuro: include il token nel body e gestisce fallback
        var res = await (window.securePost ? window.securePost('creaPrenotazione', payload) : Promise.resolve({success:false,message:'securePost non disponibile'}));
        if (!res || !res.success) throw new Error(res && res.message ? res.message : 'Errore creazione prenotazione');

        if (email) try{ localStorage.setItem('imbriani_user_email', email); }catch(_){ }
        if (window.showToast) showToast('Prenotazione inviata! Riceverai aggiornamenti via email se indicata.', 'success');
        // cleanup locale
        localStorage.removeItem('imbriani_preventivo_richiesto');
        localStorage.removeItem('imbriani_drivers');
        setTimeout(function(){ location.href='area-personale.html'; }, 1000);
      }catch(e){
        console.error(e);
        if (window.showToast) showToast(e.message, 'error');
      }finally{ btn.disabled=false; spn.classList.add('d-none'); }
    });
  }
</script>
</body>
</html>
