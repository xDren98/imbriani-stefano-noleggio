<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Diagnostics - Imbriani Stefano Noleggio</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; font-family: monospace; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .test-btn { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        .test-btn:hover { background: #0056b3; }
        .test-btn:disabled { background: #6c757d; cursor: not-allowed; }
        .code { background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; margin: 10px 0; white-space: pre-wrap; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
        .section { background: #f8f9fa; padding: 15px; border-radius: 4px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Sistema Diagnostics - Imbriani Stefano Noleggio</h1>
        
        <div class="section">
            <h3>üìä Configurazione Sistema</h3>
            <div class="status info">
                <strong>Environment:</strong> <span id="env">Loading...</span><br>
                <strong>Config Version:</strong> <span id="version">Loading...</span><br>
                <strong>API URL:</strong> <span id="apiUrl">Loading...</span><br>
                <strong>Token:</strong> <span id="token">Loading...</span><br>
                <strong>Sheets ID:</strong> <span id="sheetsId">Loading...</span><br>
                <strong>Origin:</strong> <span id="origin">Loading...</span><br>
                <strong>Timestamp:</strong> <span id="timestamp">Loading...</span>
            </div>
        </div>

        <div class="grid">
            <div>
                <h3>üß™ Test Sistema</h3>
                <button class="test-btn" onclick="testBackendDirect()">üéØ Test Backend Diretto</button>
                <button class="test-btn" onclick="testAPIConnection()">üîó Test API via Proxy</button>
                <button class="test-btn" onclick="testCORS()">üåê Test CORS Headers</button>
                <button class="test-btn" onclick="testLogin()">üë§ Test Login Mock</button>
                <button class="test-btn" onclick="testHealth()">üíì Test Health Endpoint</button>
                <button class="test-btn" onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
            </div>
            
            <div>
                <h3>‚ö° Test Rapidi</h3>
                <button class="test-btn" onclick="runAllTests()">üöÄ Run All Tests</button>
                <button class="test-btn" onclick="testSheets()">üìä Test Sheets Access</button>
                <button class="test-btn" onclick="testToken()">üîë Test Token</button>
                <button class="test-btn" onclick="exportDiagnostics()">üíæ Export Diagnostics</button>
            </div>
        </div>
        
        <div class="section">
            <h3>üìã Test Results</h3>
            <div id="testResults"></div>
        </div>
        
        <div class="section">
            <h3>üìÑ Console Logs</h3>
            <div id="consoleLogs" class="code" style="height: 300px; overflow-y: scroll; max-height: 300px;"></div>
        </div>
        
        <div class="section">
            <h3>üè† Navigation</h3>
            <a href="index.html" style="margin-right: 10px;">‚Üê App Principale</a>
            <a href="admin.html" style="margin-right: 10px;">‚öôÔ∏è Admin Panel</a>
            <a href="veicoli.html">üöê Veicoli</a>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        function initDiagnostics() {
            document.getElementById('env').textContent = window.ENV_NAME || 'Unknown';
            document.getElementById('version').textContent = '8.2.1';
            document.getElementById('apiUrl').textContent = window.API_URL || 'Not loaded';
            document.getElementById('token').textContent = window.API_TOKEN ? window.API_TOKEN.substring(0,8) + '...' : 'Not loaded';
            document.getElementById('sheetsId').textContent = window.SHEETS_CONFIG?.SPREADSHEET_ID || 'Not loaded';
            document.getElementById('origin').textContent = window.location.origin;
            document.getElementById('timestamp').textContent = new Date().toLocaleString('it-IT');
        }

        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        const logsContainer = document.getElementById('consoleLogs');

        function addLogToPage(message, type = 'log') {
            const div = document.createElement('div');
            div.style.color = type === 'error' ? '#721c24' : type === 'warn' ? '#856404' : '#0c5460';
            div.style.marginBottom = '2px';
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logsContainer.appendChild(div);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        console.log = function(...args) { originalLog.apply(console, args); addLogToPage(args.join(' '), 'log'); };
        console.error = function(...args) { originalError.apply(console, args); addLogToPage(args.join(' '), 'error'); };
        console.warn = function(...args) { originalWarn.apply(console, args); addLogToPage(args.join(' '), 'warn'); };

        function showResult(message, type = 'info') { const results = document.getElementById('testResults'); const div = document.createElement('div'); div.className = `status ${type}`; div.innerHTML = message; results.appendChild(div); }

        async function testBackendDirect() {
            showResult('üéØ Testing backend diretto...', 'info');
            try {
                const directUrl = 'https://script.google.com/macros/s/AKfycbx8vOsfdliS4e5odoRMkvCwaWY7SowSkgtW0zTuvqDIu4R99sUEixlLSW7Y9MyvNWk/exec?token=imbriani_secret_2025&action=health&ts=' + Date.now();
                const response = await fetch(directUrl, { mode: 'cors' });
                const data = await response.json();
                if (data.success) { showResult(`‚úÖ Backend diretto OK - Version: ${data.version}`, 'success'); } else { showResult(`‚ùå Backend error: ${data.message}`, 'error'); }
            } catch (error) { showResult(`‚ùå Backend diretto failed: ${error.message}`, 'error'); }
        }

        async function testAPIConnection() {
            showResult('üîó Testing API via proxy...', 'info');
            try { const data = await window.apiCall('/health'); if (data.success) { showResult('‚úÖ API proxy connection successful!', 'success'); } else { showResult(`‚ùå API proxy error: ${data.message}`, 'error'); } } catch (error) { showResult(`‚ùå API proxy failed: ${error.message}`, 'error'); }
        }

        async function testCORS() {
            showResult('üåê Testing CORS headers...', 'info');
            try {
                const response = await fetch(window.API_URL + '/login', { method: 'OPTIONS', headers: { 'Origin': window.location.origin } });
                const corsOrigin = response.headers.get('access-control-allow-origin');
                const corsMethods = response.headers.get('access-control-allow-methods');
                if (corsOrigin && corsMethods) { showResult(`‚úÖ CORS OK - Origin: ${corsOrigin}, Methods: ${corsMethods}`, 'success'); } else { showResult(`‚ùå CORS headers missing - Status: ${response.status}`, 'error'); }
            } catch (error) { showResult(`‚ùå CORS test failed: ${error.message}`, 'error'); }
        }

        async function testLogin() {
            showResult('üë§ Testing login endpoint...', 'info');
            try { const data = await window.apiCall('/login', { method: 'POST', body: JSON.stringify({ codiceFiscale: 'TEST123456789ABCD' }) }); if (data.success || data.message) { showResult(`‚úÖ Login endpoint responding: ${data.message}`, 'success'); } else { showResult(`‚ùå Login failed: ${JSON.stringify(data)}`, 'error'); } } catch (error) { showResult(`‚ùå Login test failed: ${error.message}`, 'error'); }
        }

        async function testHealth() { showResult('üíì Testing health endpoint...', 'info'); try { const data = await window.apiCall('/?action=health'); if (data.success) { showResult(`‚úÖ Health OK - Version: ${data.version}`, 'success'); } else { showResult(`‚ö†Ô∏è Health warning: ${data.message}`, 'warning'); } } catch (error) { showResult(`‚ùå Health failed: ${error.message}`, 'error'); } }

        async function testToken() { showResult('üîë Testing token validation...', 'info'); const token = window.API_TOKEN; if (!token) { showResult('‚ùå No token configured', 'error'); return; } showResult(`‚úÖ Token loaded: ${token.substring(0,8)}...*****`, 'success'); }

        async function testSheets() { showResult('üìä Testing Sheets configuration...', 'info'); const config = window.SHEETS_CONFIG; if (!config) { showResult('‚ùå No Sheets config found', 'error'); return; } const tabs = Object.keys(config.TABS).join(', '); showResult(`‚úÖ Sheets config OK - ID: ${config.SPREADSHEET_ID.substring(0,10)}..., Tabs: ${tabs}`, 'success'); }

        async function runAllTests() { clearLogs(); showResult('üöÄ Running all tests...', 'info'); await testToken(); await testSheets(); await testBackendDirect(); await testCORS(); await testAPIConnection(); await testHealth(); await testLogin(); showResult('üéâ All tests completed!', 'success'); }

        function exportDiagnostics() { const data = { timestamp: new Date().toISOString(), environment: window.ENV_NAME, apiUrl: window.API_URL, origin: window.location.origin, sheetsId: window.SHEETS_CONFIG?.SPREADSHEET_ID, userAgent: navigator.userAgent, logs: document.getElementById('consoleLogs').textContent }; const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `imbriani-diagnostics-${new Date().toISOString().slice(0,16).replace(/:/g,'-')}.json`; a.click(); URL.revokeObjectURL(url); }

        function clearLogs() { document.getElementById('consoleLogs').innerHTML = ''; document.getElementById('testResults').innerHTML = ''; }

        document.addEventListener('DOMContentLoaded', function() { initDiagnostics(); window.logApp('üîß Diagnostics page loaded'); window.logApp(`Environment: ${window.ENV_NAME}`); window.logApp(`API URL: ${window.API_URL}`); });
    </script>
</body>
</html>