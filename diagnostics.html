<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Diagnostica API — Imbriani</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" integrity="sha512-Avb2QiuDEEvB4bZJYdft2mNjVShBftLdPG8FJ0V7irTLQ8Uo0qcPxh4Plq7G5tGm0rU+1SPhVotteLpBERwTkw==" crossorigin="anonymous" />
  <style>
    body { background: #0b1727; color: #eaf1ff; }
    .card { background: #12233a; border: 1px solid #2a4a75; }
    .small-muted { color: #c3d3ea; font-size: 0.92rem; }
    .badge-pass { background-color: #28a745; }
    .badge-fail { background-color: #dc3545; }
    .badge-chip { background-color: #1f3554; color: #eaf1ff; border: 1px solid #2a4a75; font-weight: 500; }
    .code { color: #eaf1ff; background: #0f1f36; border: 1px solid #2a4a75; border-radius: 6px; padding: 10px; white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .result-head { display: flex; align-items: center; gap: 8px; justify-content: space-between; }
    .result-title { color: #eaf1ff; font-weight: 600; }
    .result-actions { display: flex; align-items: center; gap: 8px; }
    .btn-xs { padding: 2px 8px; font-size: 0.8rem; }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="d-flex align-items-center mb-3">
      <i class="fas fa-stethoscope me-2"></i>
      <h3 class="mb-0">Pagina di Test e Diagnostica API</h3>
    </div>

    <!-- Avviso autenticazione -->
    <div id="auth-warning" class="alert alert-warning d-none" role="alert">
      <i class="fas fa-exclamation-triangle me-2"></i>
      Sessione admin non valida o assente. Effettua login (OTP) o usa il login di sviluppo su localhost.
    </div>

    <!-- Info Config -->
    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">Informazioni Ambiente</h5>
        <div id="env-info" class="code small-muted"></div>
      </div>
    </div>

    <!-- Azioni principali -->
    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">Test Automatici</h5>
        <div class="d-flex flex-wrap gap-2 mb-3">
          <button id="run-all" class="btn btn-primary"><i class="fas fa-play me-2"></i>Esegui tutti i test</button>
          <button id="test-health" class="btn btn-outline-light">Health</button>
          <button id="test-version" class="btn btn-outline-light">Version</button>
          <button id="test-debugauth" class="btn btn-outline-warning">Debug Auth</button>
          <button id="test-veicoli" class="btn btn-outline-info">GET: getVeicoli</button>
          <button id="test-firstslot" class="btn btn-outline-info">GET: firstAvailableSlot</button>
          <button id="test-direct-health" class="btn btn-outline-secondary">Direct (GAS): health</button>
          <button id="test-cache-hit" class="btn btn-outline-success">GET (cache): getVeicoli</button>
          <button id="test-sheet-clients" class="btn btn-outline-info">GET: getSheet CLIENTI (fields/limit)</button>
        </div>

        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Admin Name</label>
            <select id="admin-name" class="form-select">
              <option value="Antonio">Antonio</option>
              <option value="Beatrice">Beatrice</option>
              <option value="Stefano">Stefano</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">OTP</label>
            <input id="admin-otp" type="text" inputmode="numeric" autocomplete="off" class="form-control" placeholder="6 cifre" />
          </div>
          <div class="col-md-4 d-flex align-items-end gap-2">
            <button id="test-request-otp" class="btn btn-outline-primary flex-grow-1">Richiedi OTP</button>
            <button id="test-admin-login" class="btn btn-outline-success flex-grow-1">Login Admin</button>
            <button id="diag-dev-login-btn" class="btn btn-outline-secondary flex-grow-1">Accedi in sviluppo (localhost)</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">Riepilogo</h5>
        <div id="summary" class="small-muted"></div>
      </div>
    </div>
    <!-- Risultati -->
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">Risultati</h5>
        <div id="results"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
  <script src="config.js"></script>
  <script src="shared-utils.js"></script>
  <script>
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx8vOsfdliS4e5odoRMkvCwaWY7SowSkgtW0zTuvqDIu4R99sUEixlLSW7Y9MyvNWk/exec';

    function isLocalHost() { return ['localhost','127.0.0.1'].includes(location.hostname); }

    function setAdminSessionCookie(session){
      try{
        const payload = btoa(unescape(encodeURIComponent(JSON.stringify(session))));
        document.cookie = `imbriani_admin_session=${payload}; path=/; max-age=${60*60*24}; SameSite=Lax`;
      }catch(_){ }
    }

    function tokenPreview() {
      try {
        const rawAdmin = localStorage.getItem('imbriani_admin_session');
        if (rawAdmin) {
          const s = JSON.parse(rawAdmin);
          if (s && s.token) return String(s.token).substring(0, 8) + '… (admin session)';
        }
        const rawSess = localStorage.getItem('imbriani_session');
        if (rawSess) {
          const s2 = JSON.parse(rawSess);
          if (s2 && s2.token) return String(s2.token).substring(0, 8) + '… (user session)';
        }
      } catch (_) {}
      try { return (window.CONFIG?.AUTH_TOKEN || 'n/a').substring(0, 8) + '… (AUTH_TOKEN)'; } catch (_) { return 'n/a'; }
    }

    function hasAdminSession() {
      try { return !!localStorage.getItem('imbriani_admin_session'); } catch (_) { return false; }
    }

    function printEnvInfo() {
      const info = {
        origin: location.origin,
        apiUrl: window.CONFIG?.API_URL,
        appsScriptUrl: APPS_SCRIPT_URL,
        authTokenPreview: tokenPreview(),
        hasAdminSession: hasAdminSession(),
        userAgent: navigator.userAgent
      };
      document.getElementById('env-info').textContent = JSON.stringify(info, null, 2);
    }

  const __metrics = { total:0, pass:0, fail:0, cache:{HIT:0,MISS:0,STALE:0,'N/A':0}, actions:{}, times:[] };
  function renderSummary(){
    const el = document.getElementById('summary'); if (!el) return;
    const avg = __metrics.times.length ? Math.round(__metrics.times.reduce((a,b)=>a+b,0)/__metrics.times.length) : 0;
    const hit = __metrics.cache.HIT||0, miss=__metrics.cache.MISS||0, stale=__metrics.cache.STALE||0, na=__metrics.cache['N/A']||0;
    const cacheTotal = hit+miss+stale+na; const hitPct = cacheTotal?Math.round(hit*100/cacheTotal):0; const stalePct = cacheTotal?Math.round(stale*100/cacheTotal):0; const missPct = cacheTotal?Math.round(miss*100/cacheTotal):0;
    const rows = Object.entries(__metrics.actions).map(([k,v])=>{
      const aavg = v.times.length?Math.round(v.times.reduce((x,y)=>x+y,0)/v.times.length):0;
      const h=v.cache.HIT||0,m=v.cache.MISS||0,s=v.cache.STALE||0,n=v.cache['N/A']||0; const tot=h+m+s+n || 1;
      const hp=Math.round(h*100/tot), sp=Math.round(s*100/tot), mp=Math.round(m*100/tot);
      return `<tr><td>${k}</td><td><span class="badge badge-chip">${aavg} ms</span></td><td><span class="badge badge-chip">HIT ${hp}%</span> <span class="badge badge-chip">STALE ${sp}%</span> <span class="badge badge-chip">MISS ${mp}%</span></td><td>${v.count}</td></tr>`;
    }).join('');
    el.innerHTML = `
      <div class="d-flex flex-wrap gap-2 mb-2">
        <span class="badge badge-chip">Test: ${__metrics.total}</span>
        <span class="badge badge-chip">Pass: ${__metrics.pass}</span>
        <span class="badge badge-chip">Fail: ${__metrics.fail}</span>
        <span class="badge badge-chip">Avg: ${avg} ms</span>
        <span class="badge badge-chip">Cache HIT ${hitPct}%</span>
        <span class="badge badge-chip">Cache STALE ${stalePct}%</span>
        <span class="badge badge-chip">Cache MISS ${missPct}%</span>
      </div>
      <div class="table-responsive"><table class="table table-sm align-middle text-white-50"><thead><tr><th>Azione</th><th>Tempo medio</th><th>Cache</th><th>Chiamate</th></tr></thead><tbody>${rows||'<tr><td colspan="4" class="text-muted">Esegui i test per vedere il riepilogo</td></tr>'}</tbody></table></div>`;
  }
  function updateMetrics(title,data,ok){
    __metrics.total += 1; if (ok===true) __metrics.pass += 1; else if (ok===false) __metrics.fail += 1;
    const meta = (data && data.__meta) ? data.__meta : null; if (meta && typeof meta.ms==='number') __metrics.times.push(meta.ms);
    const cache = meta && meta.cache ? meta.cache : 'N/A'; if (!__metrics.cache[cache]) __metrics.cache[cache]=0; __metrics.cache[cache]+=1;
    const action = String(title||'').split(' ')[1] || title; if (!__metrics.actions[action]) __metrics.actions[action] = { times:[], cache:{HIT:0,MISS:0,STALE:0,'N/A':0}, count:0 };
    __metrics.actions[action].count += 1; if (meta && typeof meta.ms==='number') __metrics.actions[action].times.push(meta.ms);
    if (!__metrics.actions[action].cache[cache]) __metrics.actions[action].cache[cache]=0; __metrics.actions[action].cache[cache]+=1;
    renderSummary();
  }
  function appendResult(title, data, ok = null) {
    const container = document.getElementById('results');
    const wrapper = document.createElement('div');
    wrapper.className = 'mb-3';
    const passfail = ok === null ? '' : `<span class="badge ${ok ? 'badge-pass' : 'badge-fail'}">${ok ? 'PASS' : 'FAIL'}</span>`;
    const meta = (data && data.__meta) ? data.__meta : null;
    const metaBadges = meta ? `<span class="badge badge-chip">${meta.ms} ms</span><span class="badge badge-chip">HTTP ${meta.status}</span><span class="badge badge-chip">Cache: ${meta.cache}</span>` : '';
    const out = (data && data.__payload) ? data.__payload : data;
    const codeText = escapeHtml(JSON.stringify(out, null, 2));
    const id = 'code_' + Math.random().toString(36).slice(2);
    wrapper.innerHTML = `
      <div class="result-head mb-1">
        <div class="result-title">${title} ${passfail}</div>
        <div class="result-actions">
          ${metaBadges}
          <button class="btn btn-outline-light btn-xs" data-action="toggle" data-target="${id}">Dettagli</button>
          <button class="btn btn-outline-light btn-xs" data-action="copy" data-target="${id}">Copia</button>
        </div>
      </div>
      <div id="${id}" class="code">${codeText}</div>
    `;
    container.prepend(wrapper);
    const toggleBtn = wrapper.querySelector('button[data-action="toggle"]');
    const copyBtn = wrapper.querySelector('button[data-action="copy"]');
    const codeEl = wrapper.querySelector('#'+id);
    if (toggleBtn && codeEl) toggleBtn.onclick = () => { codeEl.classList.toggle('d-none'); };
    if (copyBtn && codeEl) copyBtn.onclick = async () => { try { await navigator.clipboard.writeText(codeEl.textContent); copyBtn.textContent='Copiato'; setTimeout(()=>copyBtn.textContent='Copia',1500); } catch(_) { } };
    updateMetrics(title, data, ok);
  }

    function escapeHtml(s){
      return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
    }

    async function runHealth() {
      try {
        const res = await secureGet('health');
        appendResult('GET health (proxy)', res, !!(res && res.success));
      } catch (err) {
        appendResult('GET health (proxy) — errore', { error: err.message }, false);
      }
    }

    async function runVersion() {
      try {
        const res = await secureGet('version');
        appendResult('GET version (proxy)', res, !!(res && res.success));
      } catch (err) {
        appendResult('GET version (proxy) — errore', { error: err.message }, false);
      }
    }

    async function runDebugAuth() {
      try {
        const res = await secureGet('debugAuth', { targetAction: 'getVeicoli', debug: 1 });
        const ok = !!(res && res.success);
        appendResult('GET debugAuth (proxy)', res, ok);
        const warn = document.getElementById('auth-warning');
        if (warn) {
          const validAdmin = !!(res && res.success && res.sessionValid && String(res.sessionRole||'').toLowerCase()==='admin');
          warn.classList.toggle('d-none', validAdmin);
        }
      } catch (err) {
        appendResult('GET debugAuth (proxy) — errore', { error: err.message }, false);
      }
    }

  async function runGetVeicoli() {
    try {
      const res = await diagFetchGet('getVeicoli');
      const ok = (res && res.__meta && res.__meta.status < 400) && !(res && res.__payload && res.__payload.success === false);
      appendResult('GET getVeicoli (proxy)', res, ok);
    } catch (err) {
      appendResult('GET getVeicoli (proxy) — errore', { error: err.message }, false);
    }
  }

  async function diagFetchGet(action, params={}) {
    const url = new URL(window.CONFIG?.API_URL || '');
    url.searchParams.set('action', action);
    url.searchParams.set('diag', '1');
    Object.entries(params).forEach(([k,v]) => { if (v!==undefined&&v!==null) url.searchParams.set(k, String(v)); });
    const token = (typeof getActiveToken === 'function') ? getActiveToken() : (window.CONFIG?.AUTH_TOKEN || '');
    const t0 = performance.now();
    const res = await fetch(url.toString(), { method:'GET', headers: { 'Authorization': `Bearer ${token}` } });
    const t1 = performance.now();
    let cacheHdr = res.headers.get('X-Proxy-Cache') || res.headers.get('x-proxy-cache') || 'N/A';
    const meta = { ms: Math.round(t1 - t0), status: res.status, cache: cacheHdr };
    let payload; try { payload = await res.json(); } catch(_) { payload = { success:false, message:'non-JSON' }; }
    const displayMeta = { ...meta };
    if (payload && payload.__proxy && payload.__proxy.cache) displayMeta.cache = payload.__proxy.cache;
    return { __meta: displayMeta, __payload: payload };
  }

  async function runCacheHit(){
    const a = await diagFetchGet('getVeicoli');
    appendResult('GET getVeicoli (proxy) #1', a, (a && a.__meta && a.__meta.status < 400) && !(a && a.__payload && a.__payload.success === false));
    const b = await diagFetchGet('getVeicoli');
    appendResult('GET getVeicoli (proxy) #2', b, (b && b.__meta && b.__meta.status < 400) && !(b && b.__payload && b.__payload.success === false));
    // Attendi la revalidazione asincrona del proxy, poi verifica HIT
    await new Promise(r => setTimeout(r, 900));
    const c = await diagFetchGet('getVeicoli');
    appendResult('GET getVeicoli (proxy) #3 (atteso HIT)', c, (c && c.__meta && c.__meta.status < 400) && !(c && c.__payload && c.__payload.success === false));
  }

  async function runSheetClients(){
    const res = await diagFetchGet('getSheet', { name:'CLIENTI', fields:'NOME,CODICE_FISCALE,SCADENZA_PATENTE', limit: 100 });
    appendResult('GET getSheet CLIENTI (fields/limit)', res, (res && res.__meta && res.__meta.status < 400) && !(res && res.__payload && res.__payload.success === false));
  }

    function todayPlus(days) {
      const d = new Date();
      d.setDate(d.getDate() + days);
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }

    async function runFirstAvailableSlot() {
      try {
        const res = await secureGet('firstAvailableSlot', {
          dataInizio: todayPlus(0),
          dataFine: todayPlus(1),
          oraInizio: '08:00',
          oraFine: '22:00'
        });
        appendResult('GET firstAvailableSlot (proxy)', res, !!(res && res.success));
      } catch (err) {
        appendResult('GET firstAvailableSlot (proxy) — errore', { error: err.message }, false);
      }
    }

    // Direct GET (Apps Script) via JSONP per diagnostica
    async function runDirectHealth() {
      const url = new URL(APPS_SCRIPT_URL);
      url.searchParams.set('action', 'health');
      const token = (window.CONFIG && window.CONFIG.AUTH_TOKEN) ? String(window.CONFIG.AUTH_TOKEN) : '';
      if (token) url.searchParams.set('token', token);

      return new Promise((resolve) => {
        const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
        url.searchParams.set('callback', callbackName);
        window[callbackName] = function(data) {
          delete window[callbackName];
          document.body.removeChild(script);
          appendResult('GET health (direct GAS)', data, !!(data && data.success));
          resolve(data);
        };
        const script = document.createElement('script');
        script.onerror = function() {
          delete window[callbackName];
          document.body.removeChild(script);
          appendResult('GET health (direct GAS) — errore', { error: 'script error' }, false);
          resolve(null);
        };
        script.src = url.toString();
        document.body.appendChild(script);
        setTimeout(() => {
          if (window[callbackName]) {
            delete window[callbackName];
            document.body.removeChild(script);
            appendResult('GET health (direct GAS) — timeout', { timeout: true }, false);
            resolve(null);
          }
        }, 8000);
      });
    }

    async function runRequestOTP() {
      const name = document.getElementById('admin-name')?.value || 'Antonio';
      try {
        const res = await securePost('requestAdminOTP', { name });
        appendResult('POST requestAdminOTP (proxy)', res, !!(res && res.success));
        if (res && res.debugOtp) {
          const otpEl = document.getElementById('admin-otp');
          if (otpEl) otpEl.value = String(res.debugOtp);
        }
      } catch (err) {
        appendResult('POST requestAdminOTP (proxy) — errore', { error: err.message }, false);
      }
    }

    async function runAdminLogin() {
      const name = document.getElementById('admin-name')?.value || '';
      const otp = document.getElementById('admin-otp')?.value || '';
      try {
        const res = await securePost('adminLogin', { name, otp });
        appendResult('POST adminLogin (proxy)', res, !!(res && res.success));
        if (res && res.success && res.token) {
          const session = { name: res.name||name, token: res.token, role: res.role||'admin', exp: res.exp, timestamp: Date.now() };
          try { localStorage.setItem('imbriani_admin_session', JSON.stringify(session)); } catch(_){}
          setAdminSessionCookie(session);
          const warn = document.getElementById('auth-warning');
          if (warn) warn.classList.add('d-none');
        }
      } catch (err) {
        appendResult('POST adminLogin (proxy) — errore', { error: err.message }, false);
      }
    }

    // Login di sviluppo (solo localhost)
    async function runDevLogin(){
      try {
        if (!isLocalHost()) { appendResult('Dev login', { message: 'Disponibile solo su localhost' }, false); return; }
        const token = (window.CONFIG && (window.CONFIG.AUTH_TOKEN || window.CONFIG.TOKEN)) || 'imbriani_secret_2025';
        const name = document.getElementById('admin-name')?.value || 'DevAdmin';
        const session = { name, token, role: 'admin', exp: new Date(Date.now()+60*60*1000).toISOString(), timestamp: Date.now() };
        try { localStorage.setItem('imbriani_admin_session', JSON.stringify(session)); } catch(_){}
        setAdminSessionCookie(session);
        appendResult('Dev login', { success:true, name, tokenPreview: String(token).substring(0,8)+'…' }, true);
        const warn = document.getElementById('auth-warning');
        if (warn) warn.classList.add('d-none');
      } catch(err) {
        appendResult('Dev login — errore', { error: err.message }, false);
      }
    }

    async function runAll() {
      document.getElementById('results').innerHTML = '';
      printEnvInfo();
      await runHealth();
      await runVersion();
      renderSummary();
      await runDebugAuth();
      await runGetVeicoli();
      await runCacheHit();
      await runSheetClients();
      await runFirstAvailableSlot();
      await runDirectHealth();
    }

    // Bind
  window.addEventListener('DOMContentLoaded', async () => {
      printEnvInfo();
      // Nascondi pulsante di sviluppo fuori da localhost
      try { const btn = document.getElementById('diag-dev-login-btn'); if (btn && !isLocalHost()) btn.classList.add('d-none'); } catch(_){}
      await runDebugAuth();
      document.getElementById('run-all')?.addEventListener('click', runAll);
      document.getElementById('test-health')?.addEventListener('click', runHealth);
      document.getElementById('test-version')?.addEventListener('click', runVersion);
      document.getElementById('test-debugauth')?.addEventListener('click', runDebugAuth);
      document.getElementById('test-veicoli')?.addEventListener('click', runGetVeicoli);
      document.getElementById('test-cache-hit')?.addEventListener('click', runCacheHit);
      document.getElementById('test-sheet-clients')?.addEventListener('click', runSheetClients);
      document.getElementById('test-firstslot')?.addEventListener('click', runFirstAvailableSlot);
      document.getElementById('test-direct-health')?.addEventListener('click', runDirectHealth);
      document.getElementById('test-request-otp')?.addEventListener('click', runRequestOTP);
      document.getElementById('test-admin-login')?.addEventListener('click', runAdminLogin);
      document.getElementById('diag-dev-login-btn')?.addEventListener('click', runDevLogin);
    });
  </script>
</body>
</html>
