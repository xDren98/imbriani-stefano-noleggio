<!DOCTYPE html>
<html lang="it" class="h-100">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Selezione Veicoli ‚Äî Imbriani Stefano Noleggio</title>
  <meta name="description" content="Selezione veicoli disponibili - Imbriani Stefano Noleggio">
  <meta name="theme-color" content="#0066FF">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üöê</text></svg>">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <style>
    body{background:linear-gradient(135deg,#0f172a 0%,#1e293b 100%);min-height:100vh}
    .vehicle-card{transition:all .3s ease;border:2px solid transparent}
    .vehicle-card:hover{transform:translateY(-4px);border-color:#0066ff30}
    .vehicle-card.selected{border-color:#0066ff;box-shadow:0 8px 25px rgba(0,102,255,.3)}
    .badge-passo-lungo{background:linear-gradient(45deg,#f59e0b,#d97706);color:#fff}
  </style>
</head>
<body class="d-flex flex-column h-100">
  <header class="py-4">
    <div class="container">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
        <div>
          <h1 class="h3 text-white fw-bold mb-1">
            <i class="fas fa-car me-2"></i>
            Selezione Veicoli
          </h1>
          <p class="text-white-50 mb-0" id="header-subtitle">Scegli date e orari per vedere i veicoli disponibili</p>
        </div>
        <div class="d-flex gap-2">
          <button type="button" id="back-btn" class="btn btn-outline-light btn-sm">
            <i class="fas fa-arrow-left me-1"></i>Indietro
          </button>
          <button type="button" id="logout-btn" class="btn btn-outline-light btn-sm d-none">
            <i class="fas fa-sign-out-alt me-1"></i>Logout
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="flex-grow-1 py-4">
    <div class="container">
      <div class="glass-card p-4 mb-4" id="date-form-section">
        <h5 class="fw-bold text-white mb-3">
          <i class="fas fa-calendar-alt me-2"></i>Quando hai bisogno del veicolo?
        </h5>
        <form id="availability-form" class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Data inizio</label>
            <input type="date" class="form-control form-control-modern" id="data_inizio" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Data fine</label>
            <input type="date" class="form-control form-control-modern" id="data_fine" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Ora ritiro</label>
            <select class="form-select form-control-modern" id="ora_ritiro" required>
              <option value="">Seleziona ora</option>
              <option value="08:00">08:00</option>
              <option value="10:00">10:00</option>
              <option value="12:00">12:00</option>
              <option value="14:00">14:00</option>
              <option value="16:00">16:00</option>
              <option value="18:00">18:00</option>
              <option value="20:00">20:00</option>
              <option value="22:00">22:00</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Ora riconsegna</label>
            <select class="form-select form-control-modern" id="ora_riconsegna" required>
              <option value="">Seleziona ora</option>
              <option value="08:00">08:00</option>
              <option value="10:00">10:00</option>
              <option value="12:00">12:00</option>
              <option value="14:00">14:00</option>
              <option value="16:00">16:00</option>
              <option value="18:00">18:00</option>
              <option value="20:00">20:00</option>
              <option value="22:00">22:00</option>
            </select>
          </div>
          <div class="col-12">
            <button type="submit" class="btn btn-premium">
              <i class="fas fa-search me-2"></i>
              <span id="search-btn-text">Cerca veicoli disponibili</span>
              <div class="spinner-border spinner-border-sm ms-2 d-none" id="search-spinner"></div>
            </button>
          </div>
        </form>
      </div>

      <div id="results-section" class="d-none">
        <div class="glass-card p-4">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <h5 class="fw-bold text-white mb-0">
              <i class="fas fa-car-side me-2"></i>Veicoli disponibili
            </h5>
            <button type="button" id="modify-dates" class="btn btn-outline-light btn-sm">
              <i class="fas fa-edit me-1"></i>Modifica date
            </button>
          </div>
          <div class="text-muted mb-3" id="search-summary"></div>
          <div id="vehicles-list">
            <div class="text-center text-muted py-4">
              <div class="spinner-border spinner-border-sm me-2"></div>
              Ricerca veicoli disponibili...
            </div>
          </div>
          <div id="no-vehicles" class="text-center text-muted py-5 d-none">
            <i class="fas fa-car-crash mb-3" style="font-size:3rem"></i>
            <h5>Nessun veicolo disponibile</h5>
            <p>Per le date e gli orari selezionati non ci sono veicoli liberi.</p>
            <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('modify-dates').click()">Modifica date</button>
          </div>
        </div>
      </div>

      <div id="vehicle-selected-section" class="d-none">
        <div class="glass-card p-4">
          <h5 class="fw-bold text-white mb-3">
            <i class="fas fa-check-circle me-2"></i>Veicolo selezionato
          </h5>
          <div id="selected-vehicle-info"></div>
          <div class="d-flex gap-2 mt-3">
            <button type="button" id="change-vehicle" class="btn btn-outline-secondary">
              <i class="fas fa-exchange-alt me-1"></i>Cambia veicolo
            </button>
            <button type="button" id="proceed-next-step" class="btn btn-premium">
              <i class="fas fa-arrow-right me-2"></i>Procedi al prossimo step
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <div id="toast-container" class="position-fixed top-0 end-0 p-3" style="z-index:1055"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="config.js"></script>
  <script src="shared-utils.js"></script>
  <script>
    let currentUser = null;
    let selectedDates = null;
    let selectedVehicle = null;
    let availableVehicles = [];

    document.addEventListener('DOMContentLoaded', async () => {
      const userData = localStorage.getItem('imbriani_user');
      if (userData) {
        currentUser = JSON.parse(userData);
        document.getElementById('logout-btn').classList.remove('d-none');
        document.getElementById('header-subtitle').textContent = `Ciao ${currentUser.nome}, scegli il tuo veicolo`;
      }

      const urlParams = new URLSearchParams(window.location.search);
      const dal = urlParams.get('dal');
      const al = urlParams.get('al');
      if (dal && al) {
        document.getElementById('data_inizio').value = dal;
        document.getElementById('data_fine').value = al;
        setTimeout(() => document.getElementById('availability-form').dispatchEvent(new Event('submit')), 300);
      }

      setupUI();
    });

    function setupUI() {
      document.getElementById('back-btn')?.addEventListener('click', () => {
        window.location.href = currentUser ? 'area-personale.html' : 'index.html';
      });

      document.getElementById('logout-btn')?.addEventListener('click', (e) => {
        e.preventDefault();
        localStorage.removeItem('imbriani_user');
        localStorage.removeItem('imbriani_session');
        if (window.showToast) showToast('Logout effettuato', 'info');
        setTimeout(() => window.location.href = 'index.html', 600);
      });

      document.getElementById('availability-form')?.addEventListener('submit', handleSearchVehicles);
      document.getElementById('modify-dates')?.addEventListener('click', () => {
        document.getElementById('date-form-section').classList.remove('d-none');
        document.getElementById('results-section').classList.add('d-none');
        document.getElementById('vehicle-selected-section').classList.add('d-none');
        selectedVehicle = null;
      });

      document.getElementById('change-vehicle')?.addEventListener('click', () => {
        document.getElementById('vehicle-selected-section').classList.add('d-none');
        document.getElementById('results-section').classList.remove('d-none');
        selectedVehicle = null;
      });

      document.getElementById('proceed-next-step')?.addEventListener('click', () => {
        if (window.showToast) showToast('üõë STOP: Avvisami ora per il prossimo step da implementare!', 'warning');
        console.log('üõë NEXT STEP REQUIRED - Selected vehicle:', selectedVehicle);
        console.log('üìÖ Selected dates:', selectedDates);
        console.log('üë§ Current user:', currentUser);
      });

      const today = new Date().toISOString().split('T')[0];
      document.getElementById('data_inizio').min = today;
      document.getElementById('data_fine').min = today;
    }

    async function handleSearchVehicles(e) {
      e.preventDefault();
      const dataInizio = document.getElementById('data_inizio').value;
      const dataFine = document.getElementById('data_fine').value;
      const oraRitiro = document.getElementById('ora_ritiro').value;
      const oraRiconsegna = document.getElementById('ora_riconsegna').value;

      if (!dataInizio || !dataFine || !oraRitiro || !oraRiconsegna) {
        if (window.showToast) showToast('Compila tutti i campi richiesti', 'error');
        return;
      }
      if (new Date(dataFine) < new Date(dataInizio)) {
        if (window.showToast) showToast('La fine deve essere successiva all\'inizio', 'error');
        return;
      }
      if (dataInizio === dataFine && oraRiconsegna <= oraRitiro) {
        if (window.showToast) showToast('Per lo stesso giorno serve un\'ora di riconsegna successiva', 'error');
        return;
      }

      selectedDates = { dataInizio, dataFine, oraRitiro, oraRiconsegna };

      // NEW: aggiorna stati live prima della ricerca
      try {
        const upd = await fetch(`${CONFIG.API_URL}?action=updateStatiLive&token=${encodeURIComponent(CONFIG.TOKEN)}`).then(r=>r.json());
        console.log('updateStatiLive:', upd);
      } catch (err) {
        console.warn('updateStatiLive non disponibile, continuo');
      }

      const searchBtn = document.querySelector('#availability-form button[type="submit"]');
      const searchSpinner = document.getElementById('search-spinner');
      const searchBtnText = document.getElementById('search-btn-text');
      searchBtn.disabled = true; searchSpinner.classList.remove('d-none'); searchBtnText.textContent = 'Ricerca in corso...';

      try { await searchAvailableVehicles(); }
      catch (error) { console.error('Errore ricerca veicoli:', error); if (window.showToast) showToast('Errore durante la ricerca veicoli', 'error'); }
      finally { searchBtn.disabled = false; searchSpinner.classList.add('d-none'); searchBtnText.textContent = 'Cerca veicoli disponibili'; }
    }

    /* ...resto del file invariato (searchAvailableVehicles, overlap checks, render)... */
  </script>
</body>
</html>