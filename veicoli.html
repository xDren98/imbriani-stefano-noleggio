<!DOCTYPE html>
<html lang="it" class="h-100">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Selezione Veicoli ‚Äî Imbriani Stefano Noleggio</title>
  <meta name="description" content="Selezione veicoli disponibili - Imbriani Stefano Noleggio">
  <meta name="theme-color" content="#0066FF">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üöê</text></svg>">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <style>body{background:linear-gradient(135deg,#0f172a 0%,#1e293b 100%);min-height:100vh}.vehicle-card{transition:all .3s ease;border:2px solid transparent}.vehicle-card:hover{transform:translateY(-4px);border-color:#0066ff30}.vehicle-card.selected{border-color:#0066ff;box-shadow:0 8px 25px rgba(0,102,255,.3)}.badge-passo-lungo{background:linear-gradient(45deg,#f59e0b,#d97706);color:#fff}.guest-badge{background:linear-gradient(45deg,#10b981,#059669);color:#fff;font-size:0.75rem}</style>
</head>
<body class="d-flex flex-column h-100">
  <header class="py-4">
    <div class="container">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
        <div>
          <h1 class="h3 text-white fw-bold mb-1">
            <i class="fas fa-car me-2"></i>
            Selezione Veicoli
          </h1>
          <p class="text-white-50 mb-0" id="header-subtitle">Scegli date e orari per vedere i veicoli disponibili</p>
        </div>
        <div class="d-flex gap-2">
          <span id="user-type-badge" class="badge guest-badge d-none">
            <i class="fas fa-user-plus me-1"></i>Guest
          </span>
          <button type="button" id="back-btn" class="btn btn-outline-light btn-sm">
            <i class="fas fa-arrow-left me-1"></i>Indietro
          </button>
          <button type="button" id="logout-btn" class="btn btn-outline-light btn-sm d-none">
            <i class="fas fa-sign-out-alt me-1"></i>Logout
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="flex-grow-1 py-4">
    <div class="container">
      <div class="glass-card p-4 mb-4" id="date-form-section">
        <h5 class="fw-bold text-white mb-3">
          <i class="fas fa-calendar-alt me-2"></i>Quando hai bisogno del veicolo?
        </h5>
        <form id="availability-form" class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Data inizio</label>
            <input type="date" class="form-control form-control-modern" id="data_inizio" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Data fine</label>
            <input type="date" class="form-control form-control-modern" id="data_fine" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Ora ritiro</label>
            <select class="form-select form-control-modern" id="ora_ritiro" required>
              <option value="">Seleziona ora</option>
              <option value="08:00">08:00</option>
              <option value="10:00">10:00</option>
              <option value="12:00">12:00</option>
              <option value="14:00">14:00</option>
              <option value="16:00">16:00</option>
              <option value="18:00">18:00</option>
              <option value="20:00">20:00</option>
              <option value="22:00">22:00</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Ora riconsegna</label>
            <select class="form-select form-control-modern" id="ora_riconsegna" required>
              <option value="">Seleziona ora</option>
              <option value="08:00">08:00</option>
              <option value="10:00">10:00</option>
              <option value="12:00">12:00</option>
              <option value="14:00">14:00</option>
              <option value="16:00">16:00</option>
              <option value="18:00">18:00</option>
              <option value="20:00">20:00</option>
              <option value="22:00">22:00</option>
            </select>
          </div>
          <div class="col-12">
            <button type="submit" class="btn btn-premium">
              <i class="fas fa-search me-2"></i>
              <span id="search-btn-text">Cerca veicoli disponibili</span>
              <div class="spinner-border spinner-border-sm ms-2 d-none" id="search-spinner"></div>
            </button>
          </div>
        </form>
      </div>

      <div id="results-section" class="d-none">
        <div class="glass-card p-4">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <h5 class="fw-bold text-white mb-0">
              <i class="fas fa-car-side me-2"></i>Veicoli disponibili
            </h5>
            <button type="button" id="modify-dates" class="btn btn-outline-light btn-sm">
              <i class="fas fa-edit me-1"></i>Modifica date
            </button>
          </div>
          <div class="text-muted mb-3" id="search-summary"></div>
          <div id="vehicles-list">
            <div class="text-center text-muted py-4">
              <div class="spinner-border spinner-border-sm me-2"></div>
              Ricerca veicoli disponibili...
            </div>
          </div>
          <div id="no-vehicles" class="text-center text-muted py-5 d-none">
            <i class="fas fa-car-crash mb-3" style="font-size:3rem"></i>
            <h5>Nessun veicolo disponibile</h5>
            <p>Per le date e gli orari selezionati non ci sono veicoli liberi.</p>
            <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('modify-dates').click()">Modifica date</button>
          </div>
        </div>
      </div>

      <div id="vehicle-selected-section" class="d-none">
        <div class="glass-card p-4">
          <h5 class="fw-bold text-white mb-3">
            <i class="fas fa-check-circle me-2"></i>Veicolo selezionato
          </h5>
          <div id="selected-vehicle-info"></div>
          <div class="d-flex gap-2 mt-3">
            <button type="button" id="change-vehicle" class="btn btn-outline-secondary">
              <i class="fas fa-exchange-alt me-1"></i>Cambia veicolo
            </button>
            <button type="button" id="proceed-next-step" class="btn btn-premium">
              <i class="fas fa-arrow-right me-2"></i>
              <span id="next-step-text">Procedi alla prenotazione</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <div id="toast-container" class="position-fixed top-0 end-0 p-3" style="z-index:1055"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="config.js"></script>
  <script src="shared-utils.js"></script>
  <script>
    // Fix: debounce di ricerca e calendar picker
    let debounceTimeout = null;

    // Inizializza Bootstrap Datepicker se vuoi compatibilit√† extra (ma input type="date" √® nativo su quasi tutti i browser)
    document.addEventListener('DOMContentLoaded', async () => {
      setupUI();
      // Evento focus su input date: mostra il calendario
      document.getElementById('data_inizio').addEventListener('focus', function(){ this.showPicker && this.showPicker(); });
      document.getElementById('data_fine').addEventListener('focus', function(){ this.showPicker && this.showPicker(); });
    });

    function setupUI() {
      document.getElementById('back-btn')?.addEventListener('click', () => {
        if (isGuestUser) {
          window.location.href = 'index.html';
        } else {
          window.location.href = currentUser ? 'area-personale.html' : 'index.html';
        }
      });
      document.getElementById('logout-btn')?.addEventListener('click', (e) => {
        e.preventDefault();
        localStorage.removeItem('imbriani_user');
        localStorage.removeItem('imbriani_session');
        localStorage.removeItem('imbriani_guest_booking');
        if (window.showToast) showToast('Logout effettuato', 'info');
        setTimeout(() => window.location.href = 'index.html', 600);
      });
      document.getElementById('availability-form')?.addEventListener('submit', function(e){
        e.preventDefault();
        // Applica debounce per la ricerca
        if (debounceTimeout) clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(() => handleSearchVehicles(e), 300);
      });
      document.getElementById('modify-dates')?.addEventListener('click', () => {
        document.getElementById('date-form-section').classList.remove('d-none');
        document.getElementById('results-section').classList.add('d-none');
        document.getElementById('vehicle-selected-section').classList.add('d-none');
        selectedVehicle = null;
      });
      document.getElementById('change-vehicle')?.addEventListener('click', () => {
        document.getElementById('vehicle-selected-section').classList.add('d-none');
        document.getElementById('results-section').classList.remove('d-none');
        selectedVehicle = null;
      });
      document.getElementById('proceed-next-step')?.addEventListener('click', proceedToNextStep);
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('data_inizio').min = today;
      document.getElementById('data_fine').min = today;
    }

    // ... resto del codice JS invariato ...

  </script>
</body>
</html>
