<!DOCTYPE html>
<html lang="it" class="h-100">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Selezione Veicoli ‚Äî Imbriani Stefano Noleggio</title>
  <meta name="description" content="Selezione veicoli disponibili - Imbriani Stefano Noleggio">
  <meta name="theme-color" content="#0066FF">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üöê</text></svg>">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <style>
    body{background:linear-gradient(135deg,#0f172a 0%,#1e293b 100%);min-height:100vh}
    .vehicle-card{transition:all .3s ease;border:2px solid transparent}
    .vehicle-card:hover{transform:translateY(-4px);border-color:#0066ff30}
    .vehicle-card.selected{border-color:#0066ff;box-shadow:0 8px 25px rgba(0,102,255,.3)}
    .badge-passo-lungo{background:linear-gradient(45deg,#f59e0b,#d97706);color:#fff}
    .guest-badge{background:linear-gradient(45deg,#10b981,#059669);color:#fff;font-size:0.75rem}
  </style>
</head>
<body class="d-flex flex-column h-100">
  <header class="py-4">
    <div class="container">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
        <div>
          <h1 class="h3 text-white fw-bold mb-1">
            <i class="fas fa-car me-2"></i>
            Selezione Veicoli
          </h1>
          <p class="text-white-50 mb-0" id="header-subtitle">Scegli il veicolo per la tua prenotazione</p>
        </div>
        <div class="d-flex gap-2">
          <span id="user-type-badge" class="badge guest-badge d-none">
            <i class="fas fa-user-plus me-1"></i>Guest
          </span>
          <button type="button" id="back-btn" class="btn btn-outline-light btn-sm">
            <i class="fas fa-arrow-left me-1"></i>Indietro
          </button>
          <button type="button" id="logout-btn" class="btn btn-outline-light btn-sm d-none">
            <i class="fas fa-sign-out-alt me-1"></i>Logout
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="flex-grow-1 py-4">
    <div class="container">
      <div class="glass-card p-4 mb-4 d-none" id="date-form-section">
        <h5 class="fw-bold text-white mb-3">
          <i class="fas fa-calendar-alt me-2"></i>Quando hai bisogno del veicolo?
        </h5>
        <form id="availability-form" class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Data inizio</label>
            <div class="input-with-calendar">
              <input type="date" class="form-control form-control-modern" id="data_inizio" required>
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label">Data fine</label>
            <div class="input-with-calendar">
              <input type="date" class="form-control form-control-modern" id="data_fine" required>
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label">Ora ritiro</label>
            <select class="form-select form-control-modern" id="ora_ritiro" required>
              <option value="">Seleziona ora</option>
              <option value="08:00">08:00</option>
              <option value="10:00">10:00</option>
              <option value="12:00">12:00</option>
              <option value="14:00">14:00</option>
              <option value="16:00">16:00</option>
              <option value="18:00">18:00</option>
              <option value="20:00">20:00</option>
              <option value="22:00">22:00</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Ora riconsegna</label>
            <select class="form-select form-control-modern" id="ora_riconsegna" required>
              <option value="">Seleziona ora</option>
              <option value="08:00">08:00</option>
              <option value="10:00">10:00</option>
              <option value="12:00">12:00</option>
              <option value="14:00">14:00</option>
              <option value="16:00">16:00</option>
              <option value="18:00">18:00</option>
              <option value="20:00">20:00</option>
              <option value="22:00">22:00</option>
            </select>
          </div>
          <div class="col-12">
            <button type="submit" class="btn btn-premium">
              <i class="fas fa-search me-2"></i>
              <span id="search-btn-text">Cerca veicoli disponibili</span>
              <div class="spinner-border spinner-border-sm ms-2 d-none" id="search-spinner"></div>
            </button>
          </div>
        </form>
      </div>

      <div id="results-section" class="d-none">
        <div class="glass-card p-4">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <h5 class="fw-bold text-white mb-0">
              <i class="fas fa-car-side me-2"></i>Veicoli disponibili
            </h5>
            <button type="button" id="modify-dates" class="btn btn-outline-light btn-sm">
              <i class="fas fa-edit me-1"></i>Modifica date
            </button>
          </div>
          <div class="text-muted mb-3" id="search-summary"></div>
          <div id="vehicles-list">
            <div class="text-center text-muted py-4">
              <div class="spinner-border spinner-border-sm me-2"></div>
              Ricerca veicoli disponibili...
            </div>
          </div>
          <div id="no-vehicles" class="text-center text-muted py-5 d-none">
            <i class="fas fa-car-crash mb-3" style="font-size:3rem"></i>
            <h5>Nessun veicolo disponibile</h5>
            <p>Per le date e gli orari selezionati non ci sono veicoli liberi.</p>
            <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('modify-dates').click()">Modifica date</button>
          </div>
        </div>
      </div>

      <div id="vehicle-selected-section" class="d-none">
        <div class="glass-card p-4">
          <h5 class="fw-bold text-white mb-3">
            <i class="fas fa-check-circle me-2"></i>Veicolo selezionato
          </h5>
          <div id="selected-vehicle-info"></div>
          <div class="d-flex gap-2 mt-3">
            <button type="button" id="change-vehicle" class="btn btn-outline-secondary">
              <i class="fas fa-exchange-alt me-1"></i>Cambia veicolo
            </button>
            <button type="button" id="proceed-next-step" class="btn btn-premium">
              <i class="fas fa-arrow-right me-2"></i>
              <span id="next-step-text">Procedi alla prenotazione</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <div id="toast-container" class="position-fixed top-0 end-0 p-3" style="z-index:1055"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="config.js"></script>
  <script src="shared-utils.js"></script>
  <script>
    let currentUser = null;
    let isGuestUser = false;
    let selectedDates = null;
    let selectedVehicle = null;
    let availableVehicles = [];

    document.addEventListener('DOMContentLoaded', async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const isGuestParam = urlParams.get('guest') === '1';
      const userData = localStorage.getItem('imbriani_user');

      if (userData && !isGuestParam) {
        currentUser = JSON.parse(userData);
        isGuestUser = false;
        document.getElementById('logout-btn').classList.remove('d-none');
        document.getElementById('header-subtitle').textContent = `Ciao ${currentUser.nome}, scegli il tuo veicolo`;
      } else {
        isGuestUser = true;
        document.getElementById('user-type-badge').classList.remove('d-none');
        document.getElementById('header-subtitle').textContent = 'Seleziona il veicolo per la tua prenotazione';
        document.getElementById('next-step-text').innerHTML = '<i class="fas fa-phone me-1"></i>Richiedi preventivo';
      }

      // Recupera dati da URL o localStorage, con fallback sicuro
      const dal = urlParams.get('dal');
      const al = urlParams.get('al');
      const guestDataRaw = localStorage.getItem('imbriani_guest_booking');
      let guestData = null;
      try { guestData = guestDataRaw ? JSON.parse(guestDataRaw) : null; } catch(_) {}

      const dataInizio = dal || guestData?.dataInizio || new Date().toISOString().slice(0,10);
      const dataFine   = al  || guestData?.dataFine   || new Date(Date.now()+24*60*60*1000).toISOString().slice(0,10);
      const oraRitiro = guestData?.oraRitiro || '08:00';
      const oraRiconsegna = guestData?.oraRiconsegna || '20:00';

      // Popola (anche se il form √® nascosto)
      document.getElementById('data_inizio').value = dataInizio;
      document.getElementById('data_fine').value = dataFine;
      document.getElementById('ora_ritiro').value = oraRitiro;
      document.getElementById('ora_riconsegna').value = oraRiconsegna;

      // Avvia subito ricerca e mostra il contenitore risultati
      document.getElementById('results-section').classList.remove('d-none');
      await handleSearchVehicles(new Event('submit'));
    });

    function setupUI() {
      document.getElementById('back-btn')?.addEventListener('click', () => {
        if (isGuestUser) { window.location.href = 'index.html'; }
        else { window.location.href = currentUser ? 'area-personale.html' : 'index.html'; }
      });

      document.getElementById('logout-btn')?.addEventListener('click', (e) => {
        e.preventDefault();
        localStorage.removeItem('imbriani_user');
        localStorage.removeItem('imbriani_session');
        localStorage.removeItem('imbriani_guest_booking');
        if (window.showToast) showToast('Logout effettuato', 'info');
        setTimeout(() => window.location.href = 'index.html', 600);
      });

      document.getElementById('availability-form')?.addEventListener('submit', handleSearchVehicles);
      document.getElementById('modify-dates')?.addEventListener('click', () => {
        document.getElementById('date-form-section').classList.remove('d-none');
        document.getElementById('results-section').classList.add('d-none');
        document.getElementById('vehicle-selected-section').classList.add('d-none');
        selectedVehicle = null;
      });

      document.getElementById('change-vehicle')?.addEventListener('click', () => {
        document.getElementById('vehicle-selected-section').classList.add('d-none');
        document.getElementById('results-section').classList.remove('d-none');
        selectedVehicle = null;
      });

      document.getElementById('proceed-next-step')?.addEventListener('click', proceedToNextStep);
    }

    async function handleSearchVehicles(e) {
      e?.preventDefault?.();
      const dataInizio = document.getElementById('data_inizio').value;
      const dataFine = document.getElementById('data_fine').value;
      const oraRitiro = document.getElementById('ora_ritiro').value;
      const oraRiconsegna = document.getElementById('ora_riconsegna').value;

      // Validazione robusta con default gi√† impostati
      if (!dataInizio || !dataFine || !oraRitiro || !oraRiconsegna) {
        if (window.showToast) showToast('Compila tutti i campi data/ora', 'error');
        return;
      }
      if (new Date(dataFine) < new Date(dataInizio)) {
        if (window.showToast) showToast('La fine deve essere successiva all\'inizio', 'error');
        return;
      }
      if (dataInizio === dataFine && oraRiconsegna <= oraRitiro) {
        if (window.showToast) showToast('Per lo stesso giorno serve un\'ora di riconsegna successiva', 'error');
        return;
      }

      selectedDates = { dataInizio, dataFine, oraRitiro, oraRiconsegna };

      // Aggiorna stati live prima della ricerca (best-effort)
      try { await fetch(`${CONFIG.API_URL}?action=updateStatiLive&token=${encodeURIComponent(CONFIG.TOKEN)}`); } catch (_) {}

      const searchBtn = document.querySelector('#availability-form button[type="submit"]');
      const searchSpinner = document.getElementById('search-spinner');
      const searchBtnText = document.getElementById('search-btn-text');
      if (searchBtn) { searchBtn.disabled = true; }
      if (searchSpinner) { searchSpinner.classList.remove('d-none'); }
      if (searchBtnText) { searchBtnText.textContent = 'Ricerca in corso...'; }

      try { await searchAvailableVehicles(); }
      finally {
        if (searchBtn) { searchBtn.disabled = false; }
        if (searchSpinner) { searchSpinner.classList.add('d-none'); }
        if (searchBtnText) { searchBtnText.textContent = 'Cerca veicoli disponibili'; }
      }
    }

    function toDate(d){ return new Date(d + 'T00:00:00'); }

    function hasDateOverlap(reqStart, reqEnd, blkStart, blkEnd){ return !(reqEnd < blkStart || reqStart > blkEnd); }

    function hasDateTimeOverlap(req, pre){
      const rStart = toDate(req.dataInizio);
      const rEnd = toDate(req.dataFine);
      const pStart = new Date(pre.giornoInizio);
      const pEnd = new Date(pre.giornoFine);
      if (!hasDateOverlap(rStart, rEnd, pStart, pEnd)) return false;

      const sameStartDay = rStart.toDateString() === pStart.toDateString();
      const sameEndDay = rEnd.toDateString() === pEnd.toDateString();
      const toHour = (hhmm)=> parseInt(hhmm.split(':')[0],10);
      const reqStartH = toHour(req.oraRitiro);
      const reqEndH = toHour(req.oraRiconsegna);
      const preStartH = toHour(pre.oraInizio||'08:00');
      let preEndH = toHour(pre.oraFine||'20:00');
      preEndH = Math.min(22, preEndH + 2);

      if (sameStartDay && reqStartH < preEndH) return true;
      if (sameEndDay && reqEndH > preStartH) return true;
      return true;
    }

    function hasMaintenanceOverlap(req, man){
      const stato = (man.stato || '').toLowerCase();
      if (!(stato.includes('programmata') || stato.includes('in corso'))) return false;
      const rStart = toDate(req.dataInizio);
      const rEnd = toDate(req.dataFine);
      const mStart = new Date(man.dataInizio);
      const mEnd = new Date(man.dataFine);
      return hasDateOverlap(rStart, rEnd, mStart, mEnd);
    }

    async function searchAvailableVehicles(){
      try{
        const [vehiclesResponse, prenotazioniResponse] = await Promise.all([
          api.call({ action: 'getVeicoli' }),
          api.call({ action: 'getPrenotazioni' })
        ]);
        if (!vehiclesResponse.success) { if (window.showToast) showToast('Errore caricamento veicoli', 'error'); return; }
        const allVehicles = vehiclesResponse.data || [];
        const allPren = (prenotazioniResponse.success ? prenotazioniResponse.data : []) || [];

        let manut = [];
        try {
          const url = `${CONFIG.API_URL}?action=getSheet&name=MANUTENZIONI&token=${encodeURIComponent(CONFIG.TOKEN)}`;
          const resp = await fetch(url).then(r => r.json());
          manut = (resp.success ? resp.data : []) || [];
        } catch(_) {}

        const maintRows = manut.map(r => ({
          targa: r.Targa || r.targa || r[0],
          stato: r.Stato || r.stato || r[4],
          dataInizio: r['Data Inizio Manutenzione'] || r.dataInizio || r[5],
          dataFine: r['Data Fine Manutenzione'] || r.dataFine || r[6],
        })).filter(m => m.targa && m.dataInizio && m.dataFine);

        availableVehicles = [];
        for (const v of allVehicles){
          if (!v.Disponibile) continue;
          const prenV = allPren.filter(p => p.targa === v.Targa && !['Rifiutata','Completata','Da confermare'].includes(p.stato));
          const manV = maintRows.filter(m => m.targa === v.Targa);
          const manOverlap = manV.some(m => hasMaintenanceOverlap(selectedDates, m));
          if (manOverlap) continue;
          const preOverlap = prenV.some(p => hasDateTimeOverlap(selectedDates, p));
          if (preOverlap) continue;
          availableVehicles.push(v);
        }

        displayVehicleResults();
      }catch(err){
        console.error('Errore ricerca:', err);
        if (window.showToast) showToast('Errore ricerca veicoli', 'error');
      }
    }

    function displayVehicleResults(){
      const resultsSection = document.getElementById('results-section');
      const vehiclesList = document.getElementById('vehicles-list');
      const noVehicles = document.getElementById('no-vehicles');
      const searchSummary = document.getElementById('search-summary');

      document.getElementById('date-form-section').classList.add('d-none');
      resultsSection.classList.remove('d-none');

      const formatDate = (d) => new Date(d).toLocaleDateString('it-IT');
      const userTypeText = isGuestUser ? 'Guest' : (currentUser ? currentUser.nome : 'Cliente');
      searchSummary.innerHTML = `<i class=\"fas fa-info-circle me-1\"></i> ${userTypeText} - Ricerca: ${formatDate(selectedDates.dataInizio)} ${selectedDates.oraRitiro} ‚Üí ${formatDate(selectedDates.dataFine)} ${selectedDates.oraRiconsegna}`;

      if (availableVehicles.length === 0){ vehiclesList.classList.add('d-none'); noVehicles.classList.remove('d-none'); return; }

      noVehicles.classList.add('d-none'); vehiclesList.classList.remove('d-none');
      vehiclesList.innerHTML = `<div class=\"row g-4\">${availableVehicles.map(vehicle => `
        <div class=\"col-lg-4 col-md-6\">
          <div class=\"glass-card vehicle-card p-4 h-100 cursor-pointer\" data-targa=\"${vehicle.Targa}\">
            <div class=\"d-flex align-items-center justify-content-between mb-3\">
              <h6 class=\"fw-bold text-white mb-0\">${vehicle.Targa}</h6>
              ${vehicle.PassoLungo ? '<span class=\"badge badge-passo-lungo\">Passo Lungo</span>' : ''}
            </div>
            <div class=\"mb-2\"><span class=\"text-white fw-semibold\">${vehicle.Marca} ${vehicle.Modello}</span></div>
            <div class=\"mb-3\">
              <span class=\"badge bg-success\"><i class=\"fas fa-users me-1\"></i>${vehicle.Posti} posti</span>
              <span class=\"badge bg-info ms-1\"><i class=\"fas fa-check-circle me-1\"></i>Disponibile</span>
            </div>
            ${vehicle.Note ? `<div class=\"small text-white-50 mb-3\">${vehicle.Note}</div>` : ''}
            <button type=\"button\" class=\"btn btn-premium w-100\" onclick=\"selectVehicle('${vehicle.Targa}')\"><i class=\"fas fa-hand-pointer me-2\"></i>Seleziona questo veicolo</button>
          </div>
        </div>`).join('')}</div>`;
    }
  </script>
</body>
</html>