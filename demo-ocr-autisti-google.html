<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Prenotazione Noleggio - OCR Autisti Google Vision API</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js"></script>
  <style>
    body {
      font-family: 'Inter', Arial, sans-serif;
      background: radial-gradient(900px 800px at 30% -10%, #232c46 0%, rgba(100,116,255,0.14) 60%), linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: #E2E8F0;
      min-height: 100vh;
    }
    .container {
      max-width: 680px;
      margin: 0 auto;
      padding: 32px 12px;
      background: rgba(24,32,48,0.90);
      border-radius: 18px;
      box-shadow: 0 8px 32px rgba(19,22,37,0.22);
    }
    .autista-card {
      margin-bottom: 32px; background: rgba(40,43,60,0.93); border-radius: 16px; box-shadow: 0 4px 14px rgba(99,102,241,.08); padding: 24px 12px;
    }
    .autista-card h3 {
      color: #0ea5e9;
      font-weight:700;
      font-size:1.29rem;
      margin-bottom:10px;
    }
    .btn-file {
      display: inline-block; cursor: pointer; background: linear-gradient(99deg,#6366F1 30%,#0ea5e9 100%); color: #fff; padding: 11px 24px; border-radius: 12px; font-size: 1.09rem; box-shadow: 0 6px 24px rgba(99,102,241,0.09); min-width:210px; margin-bottom:9px;
    }
    input[type="file"] { display: none; }
    .ocr-preview img {
      max-width: 220px; max-height: 320px; border-radius: 12px; border: 2px solid #6366F1; margin:9px 0; box-shadow:0 4px 16px #6366F155;
    }
    .loader {margin-top: 10px;}
    .field-group {margin: 13px 0; display: flex; gap:14px;}
    .field-group label {min-width:96px;color:#A5B4FC;font-size:0.99rem;}
    .field-group input {width: 100%; font-size:1rem; border: 2px solid #6366F1; border-radius: 7px; padding: 6px 10px; background: rgba(16, 185, 129, 0.07); color: #232c46; font-weight:700;}
    .ocr-success {color: #10B981; margin-top:10px; background: rgba(16,185,129,0.08); border-radius:8px; padding:8px 0;}
    .ocr-error {color: #EF4444; margin-top:10px; background: rgba(239,68,68,0.07); border-radius:8px; padding:8px 0;}
    .debug {font-size:0.92em; color:#A5B4FC; background: rgba(40,43,60,0.23); border-radius:6px; padding:10px 6px; margin-top:9px; white-space:pre-wrap; max-height:110px; overflow:auto;}
    .autista-num {color:#6366F1; font-size:1.22rem; font-weight:bold;}
  </style>
</head>
<body>
  <div class="container">
    <h2 style="text-align:center;margin-bottom:1em;">Prenotazione Noleggio - OCR Autisti</h2>
    <p style="text-align:center; color:#A5B4FC; margin-bottom:24px;">Scansiona il documento per ciascun autista.<br>Ogni sezione Ã¨ indipendente, usa la tua <b>API Key Google Vision</b> (giÃ  integrata).</p>
    <!-- Ripetizione per autisti -->
    <div id="ocr-autisti"></div>
  </div>
<script>
// CONFIGURA la tua API Key Google Cloud Vision qui!
const VISION_API_KEY = 'AIzaSyA0xqCwwA3ywzW8rOIErg1WS6CnjQeUU2Y';
// Numero di autisti (cambia per future versioni)
const NUM_AUTISTI = 3;
function renderAutistaCards() {
  let html = '';
  for (let i = 1; i <= NUM_AUTISTI; i++) {
    html += `<div class='autista-card'>
      <h3><span class='autista-num'>Autista ${i}</span></h3>
      <label for="ocr-file-${i}" class="btn-file"><i class="fas fa-camera me-2"></i> Scansiona Documento (Patente/CI)</label>
      <input type="file" id="ocr-file-${i}" accept="image/*" capture="environment" />
      <div class="ocr-preview" id="ocr-preview-${i}"></div>
      <div class="loader" id="ocr-loader-${i}" style="display:none;">ðŸ”„ Riconoscimento in corso...</div>
      <div id="ocr-success-${i}" class="ocr-success" style="display:none;">âœ… Dati estratti! Controlla e correggi se serve.</div>
      <div id="ocr-error-${i}" class="ocr-error" style="display:none;"></div>
      <div class="field-group"><label>Nome:</label><input type="text" id="nome-${i}" disabled></div>
      <div class="field-group"><label>Cognome:</label><input type="text" id="cognome-${i}" disabled></div>
      <div class="field-group"><label>Data nascita:</label><input type="text" id="data-nascita-${i}" disabled></div>
      <div class="field-group"><label>Codice Fiscale:</label><input type="text" id="cf-${i}" disabled></div>
      <div class="field-group"><label>NÂ° Documento:</label><input type="text" id="numero-doc-${i}" disabled></div>
      <div class="debug" id="ocr-debug-${i}" style="display:none;"></div>
    </div>`;
  }
  document.getElementById('ocr-autisti').innerHTML = html;
}
renderAutistaCards();

// Gestione OCR per ciascun autista
for(let i = 1; i <= NUM_AUTISTI; i++) {
  document.getElementById(`ocr-file-${i}`).onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    document.getElementById(`ocr-preview-${i}`).innerHTML = `<img src="${URL.createObjectURL(file)}">`;
    document.getElementById(`ocr-loader-${i}`).style.display = '';
    document.getElementById(`ocr-success-${i}`).style.display = 'none';
    document.getElementById(`ocr-error-${i}`).style.display = 'none';
    document.getElementById(`ocr-debug-${i}`).style.display = 'none';
    try {
      const base64 = await fileToBase64(file);
      // Chiamata API Vision
      const visionUrl = `https://vision.googleapis.com/v1/images:annotate?key=${VISION_API_KEY}`;
      const payload = {
        requests: [{
          image: { content: base64.replace(/^data:image\/[^;]+;base64,/, '') },
          features: [{ type: 'DOCUMENT_TEXT_DETECTION', maxResults: 1 }],
          imageContext: { languageHints: ['it'] } 
        }]
      };
      const response = await fetch(visionUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await response.json();
      document.getElementById(`ocr-loader-${i}`).style.display = 'none';
      let text = data?.responses?.[0]?.fullTextAnnotation?.text || '';
      document.getElementById(`ocr-debug-${i}`).textContent = text.trim();
      document.getElementById(`ocr-debug-${i}`).style.display = '';
      let extracted = { nome: '', cognome: '', dataNascita: '', cf: '', numeroDoc: '' };
      // --- Parsing italiano ---
      let cf = text.match(/\b[A-Z]{6}[0-9]{2}[A-Z][0-9]{2}[A-Z][0-9]{3}[A-Z]\b/i);
      if (cf) extracted.cf = cf[0];
      let date = text.match(/\b(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})\b/);
      if (date) extracted.dataNascita = `${date[1].padStart(2, '0')}/${date[2].padStart(2, '0')}/${date[3]}`;
      let nome = text.match(/NOME[:\s]+([A-Za-z]+)/i); if (nome) extracted.nome = nome[1];
      let cognome = text.match(/COGNOME[:\s]+([A-Za-z]+)/i); if (cognome) extracted.cognome = cognome[1];
      let ndoc = text.match(/\b[A-Z]{2}[0-9]{7}\b/); if (ndoc) extracted.numeroDoc = ndoc[0];
      // Riporta campi
      document.getElementById(`nome-${i}`).value = extracted.nome;
      document.getElementById(`cognome-${i}`).value = extracted.cognome;
      document.getElementById(`data-nascita-${i}`).value = extracted.dataNascita;
      document.getElementById(`cf-${i}`).value = extracted.cf;
      document.getElementById(`numero-doc-${i}`).value = extracted.numeroDoc;
      document.getElementById(`ocr-success-${i}`).style.display = '';
    } catch (err) {
      document.getElementById(`ocr-loader-${i}`).style.display = 'none';
      document.getElementById(`ocr-error-${i}`).textContent = 'Errore OCR: ' + err;
      document.getElementById(`ocr-error-${i}`).style.display = '';
    }
  };
}
function fileToBase64(file){return new Promise((resolve,reject)=>{const reader=new FileReader();reader.onload=()=>resolve(reader.result);reader.onerror=reject;reader.readAsDataURL(file);});}
</script>
</body>
</html>
