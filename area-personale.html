<!DOCTYPE html>
<html lang="it" class="h-100">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Area Personale â€” Imbriani Stefano Noleggio</title>
  <meta name="description" content="Area riservata clienti - Imbriani Stefano Noleggio">
  <meta name="theme-color" content="#0066FF">
  <link rel="apple-touch-icon" href="pwa/icons/apple-icon-180x180.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" integrity="sha512-RXf+QSDCUQs6b4v5A9R2v6KUVKp1R9+XcMgy7pYzFSHLn3U4a8gE9F7R5C3XxR28Z59TLEEqzvvR1vpuYeIRsA==" crossorigin="anonymous">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css?v=8012">
  <style>
    body{background:linear-gradient(135deg,#0f172a 0%,#1e293b 100%);min-height:100vh}
    .stat-card{transition:all .3s cubic-bezier(.4,0,.2,1)}
    .stat-card:hover{transform:translateY(-2px)}
    .booking-status{display:inline-block;padding:.25rem .75rem;border-radius:1rem;font-size:.75rem;font-weight:600}
    .status-attesa{background:rgba(251,191,36,.2);color:#f59e0b;border:1px solid rgba(251,191,36,.3)}
    .status-confermata{background:rgba(34,197,94,.2);color:#22c55e;border:1px solid rgba(34,197,94,.3)}
    .status-completata{background:rgba(107,114,128,.2);color:#9ca3af;border:1px solid rgba(107,114,128,.3)}
    .status-rifiutata{background:rgba(239,68,68,.2);color:#ef4444;border:1px solid rgba(239,68,68,.3)}
  </style>
</head>
<body class="d-flex flex-column h-100">
  <header class="py-4">
    <div class="container">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
        <div>
          <h1 class="h3 text-white fw-bold mb-1">
            <i class="fas fa-user-circle me-2"></i>
            Benvenuto, <span id="user-name">Cliente</span>
          </h1>
          <p class="text-white-50 mb-0">La tua area personale per gestire prenotazioni e profilo</p>
        </div>
        <div class="d-flex gap-2">
          <button type="button" id="logout-btn" class="btn btn-outline-light btn-sm">
            <i class="fas fa-sign-out-alt me-1"></i>Logout
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="flex-grow-1 py-4">
    <div class="container">
      <!-- Statistiche rapide -->
      <div class="row g-4 mb-4">
        <div class="col-md-3">
          <div class="glass-card stat-card p-3 text-center">
            <div class="h4 text-success mb-1" id="stat-prenotazioni-attive">-</div>
            <div class="small text-muted">Prenotazioni Attive</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="glass-card stat-card p-3 text-center">
            <div class="h4 text-info mb-1" id="stat-prenotazioni-totali">-</div>
            <div class="small text-muted">Totali</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="glass-card stat-card p-3 text-center">
            <div class="h4 text-warning mb-1" id="stat-prossima-scadenza">-</div>
            <div class="small text-muted">Prossima Patente</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="glass-card stat-card p-3 text-center">
            <button type="button" id="nuova-prenotazione" class="btn btn-premium w-100">
              <i class="fas fa-plus me-2"></i>Nuova Prenotazione
            </button>
          </div>
        </div>
      </div>

      <div class="row g-4">
        <!-- Prenotazioni Attive -->
        <div class="col-lg-8">
          <div class="glass-card p-4">
            <div class="d-flex align-items-center justify-content-between mb-3">
              <h5 class="fw-bold text-white mb-0">
                <i class="fas fa-calendar-check me-2"></i>Le tue prenotazioni
              </h5>
              <button type="button" id="refresh-bookings" class="btn btn-outline-light btn-sm">
                <i class="fas fa-sync-alt"></i>
              </button>
            </div>
            <div id="bookings-list">
              <div class="text-center text-muted py-4">
                <div class="spinner-border spinner-border-sm me-2"></div>
                Caricamento prenotazioni...
              </div>
            </div>
          </div>
        </div>

        <!-- Profilo Utente -->
        <div class="col-lg-4">
          <div class="glass-card p-4">
            <h5 class="fw-bold text-white mb-3">
              <i class="fas fa-user me-2"></i>Il tuo profilo
            </h5>
            <div id="user-profile">
              <div class="text-center text-muted py-3">
                <div class="spinner-border spinner-border-sm me-2"></div>
                Caricamento profilo...
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal Modifica Profilo -->
  <div class="modal fade" id="editProfileModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Modifica Profilo</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="edit-profile-form" class="row g-3">
            <div class="col-12">
              <label class="form-label">Nome</label>
              <input type="text" class="form-control form-control-modern" id="ep_nome" required>
            </div>
            <div class="col-12">
              <label class="form-label">Codice Fiscale</label>
              <input type="text" class="form-control form-control-modern" id="ep_cf" disabled>
            </div>
            <div class="col-12">
              <label class="form-label">Luogo di nascita</label>
              <input type="text" class="form-control form-control-modern" id="ep_luogoNascita">
            </div>
            <div class="col-12">
              <label class="form-label">Comune di residenza</label>
              <input type="text" class="form-control form-control-modern" id="ep_comuneResidenza">
            </div>
            <div class="col-8">
              <label class="form-label">Via di residenza</label>
              <input type="text" class="form-control form-control-modern" id="ep_viaResidenza">
            </div>
            <div class="col-4">
              <label class="form-label">Civico</label>
              <input type="text" class="form-control form-control-modern" id="ep_civicoResidenza">
            </div>
            <div class="col-6">
              <label class="form-label">Numero patente</label>
              <input type="text" class="form-control form-control-modern" id="ep_numeroPatente">
            </div>
            <div class="col-6">
              <label class="form-label">Inizio validitÃ  patente</label>
              <input type="date" class="form-control form-control-modern" id="ep_inizioValiditaPatente">
            </div>
            <div class="col-6">
              <label class="form-label">Scadenza patente</label>
              <input type="date" class="form-control form-control-modern" id="ep_scadenzaPatente">
            </div>
            <div class="col-6">
              <label class="form-label">Cellulare</label>
              <input type="text" class="form-control form-control-modern" id="ep_cellulare">
            </div>
            <div class="col-12">
              <label class="form-label">Email</label>
              <input type="email" class="form-control form-control-modern" id="ep_email">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
          <button type="button" id="ep_save_btn" class="btn btn-premium">
            <span class="spinner-border spinner-border-sm me-2 d-none" id="ep_saving_spinner"></span>
            <span id="ep_save_text">Salva Modifiche</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="toast-container" class="position-fixed top-0 end-0 p-3" style="z-index:1055"></div>
  <div id="spinner" class="loader-premium d-none"><div class="loader-spinner"></div><div class="loader-text" id="loader-message">Caricamento...</div></div>

  <!-- Bootstrap JS necessario per i toast -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
  <script src="config.js"></script>
  <script src="shared-utils.js"></script>
  <script>
    let currentUser = null;
    let editProfileModal = null;

    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const userData = localStorage.getItem('imbriani_user');
        const sessionData = localStorage.getItem('imbriani_session');
        
        // Validazione sessione completa
        if (!userData || !sessionData) {
          handleSessionExpired('Dati sessione mancanti');
          return;
        }
        
        currentUser = JSON.parse(userData);
        const session = JSON.parse(sessionData);
        
        // Controllo timeout sessione (24 ore)
        const sessionTimeout = 24 * 60 * 60 * 1000; // 24 ore in millisecondi
        const now = Date.now();
        const sessionAge = now - (session.timestamp || 0);
        
        if (sessionAge > sessionTimeout) {
          handleSessionExpired('Sessione scaduta (24 ore)');
          return;
        }
        
        // Controllo validitÃ  dati utente
        if (!currentUser.codiceFiscale || !currentUser.nome) {
          handleSessionExpired('Dati utente non validi');
          return;
        }
        
        // Sessione valida - aggiorna timestamp
        session.timestamp = now;
        localStorage.setItem('imbriani_session', JSON.stringify(session));
        
        document.getElementById('user-name').textContent = currentUser.nome || 'Cliente';
        // Arricchisce i dati utente dal backend (foglio CLIENTI)
        await enrichUserFromBackend();
        await loadUserData();
        bindUI();
        
      } catch (error) {
        console.error('[SESSION] Errore durante il caricamento:', error);
        handleSessionExpired('Errore durante il caricamento della sessione');
      }
    });
    
    function handleSessionExpired(reason) {
      console.log(`[SESSION] Sessione scaduta: ${reason}`);
      localStorage.removeItem('imbriani_user');
      localStorage.removeItem('imbriani_session');
      if (window.showToast) {
        showToast('Sessione scaduta. Effettua di nuovo il login.', 'warning');
        setTimeout(() => location.href = 'index.html', 1500);
      } else {
        alert('Sessione scaduta. Effettua di nuovo il login.');
        location.href = 'index.html';
      }
    }

    function bindUI(){
      document.getElementById('logout-btn')?.addEventListener('click', async (e) => { 
        e.preventDefault(); 
        
        // Conferma logout
        const confirmed = await new Promise(resolve => {
          if (window.showToast) {
            // Usa una conferma visiva con toast
            showToast('Logout in corso...', 'info');
            resolve(true);
          } else {
            resolve(confirm('Sei sicuro di voler effettuare il logout?'));
          }
        });
        
        if (!confirmed) return;
        
        try {
          // Pulizia completa della sessione
          localStorage.removeItem('imbriani_user');
          localStorage.removeItem('imbriani_session');
          sessionStorage.removeItem('userData');
          
          if (window.showToast) {
            showToast('Logout effettuato con successo', 'success');
            setTimeout(() => location.href = 'index.html', 800);
          } else {
            alert('Logout effettuato');
            location.href = 'index.html';
          }
        } catch (error) {
          console.error('[LOGOUT] Errore durante il logout:', error);
          // Forza il redirect anche in caso di errore
          location.href = 'index.html';
        }
      });
      document.getElementById('nuova-prenotazione')?.addEventListener('click', ()=> location.href='veicoli.html');
      document.getElementById('refresh-bookings')?.addEventListener('click', loadBookings);

      document.querySelector('#user-profile')?.addEventListener('click', (e)=>{
        const btn = e.target.closest('button[data-role="edit-profile"]');
        if (!btn) return;
        openEditProfile();
      });

      editProfileModal = new bootstrap.Modal(document.getElementById('editProfileModal'));
      document.getElementById('ep_save_btn')?.addEventListener('click', saveProfile);
    }

    async function loadUserData(){ await Promise.all([loadProfile(), loadBookings(), loadStats()]); }

    // Recupera dati completi dal backend e unisce con currentUser
    async function enrichUserFromBackend(){
      try{
        const res = await api.call({ action: 'getCliente', codiceFiscale: currentUser.codiceFiscale });
        if (res && res.success && res.data){
          const incoming = res.data;
          const merged = { ...currentUser };
          // Campi anagrafici e contatto
          merged.nome = incoming.nome || merged.nome;
          merged.cognome = incoming.cognome || merged.cognome;
          merged.nomeCompleto = incoming.nomeCompleto || merged.nomeCompleto;
          merged.email = incoming.email || merged.email;
          merged.cellulare = incoming.cellulare || incoming.telefono || merged.cellulare;
          merged.telefono = incoming.telefono || merged.telefono;
          // Residenza e indirizzo
          merged.indirizzo = incoming.indirizzo || merged.indirizzo;
          merged.comuneResidenza = incoming.comuneResidenza || merged.comuneResidenza;
          merged.viaResidenza = incoming.viaResidenza || merged.viaResidenza;
          merged.civicoResidenza = incoming.civicoResidenza || merged.civicoResidenza;
          // Nascita
          merged.dataNascita = incoming.dataNascita || merged.dataNascita;
          merged.dataNascitaFormatted = incoming.dataNascitaFormatted || merged.dataNascitaFormatted;
          merged.luogoNascita = incoming.luogoNascita || merged.luogoNascita;
          // Patente
          merged.numeroPatente = incoming.numeroPatente || merged.numeroPatente;
          merged.inizioValiditaPatente = incoming.inizioValiditaPatente || merged.inizioValiditaPatente || merged.dataInizioPatente;
          merged.inizioValiditaPatenteFormatted = incoming.inizioValiditaPatenteFormatted || merged.inizioValiditaPatenteFormatted;
          merged.scadenzaPatente = incoming.scadenzaPatente || merged.scadenzaPatente;
          merged.scadenzaPatenteFormatted = incoming.scadenzaPatenteFormatted || merged.scadenzaPatenteFormatted;

          currentUser = merged;
          localStorage.setItem('imbriani_user', JSON.stringify(currentUser));
          sessionStorage.setItem('userData', JSON.stringify(currentUser));
        }
      }catch(err){
        console.warn('[PROFILE] Arricchimento dati fallito:', err.message);
      }
    }

    function safe(v){
      const s = (v===undefined||v===null||v==='') ? 'N/A' : String(v);
      return window.escapeHtml ? escapeHtml(s) : s;
    }

    // ðŸ‡®ðŸ‡¹ Helper per formattare date in formato italiano in tutta la pagina
    function fmtDateIT(d) {
      try {
        const out = (window.formatDateIT ? window.formatDateIT(d) : new Date(d).toLocaleDateString('it-IT'));
        return out || 'N/A';
      } catch { return 'N/A'; }
    }

    // Parsing robusto per stringhe dd/mm/yyyy o ISO yyyy-mm-dd
    function parseDateAny(value){
      return window.parseDateAny ? window.parseDateAny(value) : null;
    }

    async function loadProfile(){
      const profileEl = document.getElementById('user-profile');
      function parseItalianDate(str){
        if (!str || typeof str !== 'string') return null;
        return window.parseDateAny ? window.parseDateAny(str) : null;
      }
      function tryParseDate(raw, formatted){
        return window.parseDateAny ? window.parseDateAny(raw || formatted) : null;
      }
      function splitAddress(addr){
        if (!addr || typeof addr !== 'string') return { via:'', civico:'' };
        const parts = addr.split(',').map(s => s.trim());
        // Cerca pattern tipo "Via/Piazza ... nÂ° ..."
        const viaMatch = addr.match(/\b(via|viale|piazza|corso|strada|vicolo)\b[^,\d]*/i);
        let via = viaMatch ? viaMatch[0] : (parts[1] || '').trim();
        const civicoMatch = addr.match(/\b(\d+[A-Za-z]?)\b/);
        const civico = civicoMatch ? civicoMatch[1] : '';
        return { via: (via||'').trim(), civico: (civico||'').trim() };
      }
      const scadenzaPatente = tryParseDate(currentUser.scadenzaPatente, currentUser.scadenzaPatenteFormatted);
      const inizioValidita = tryParseDate(currentUser.inizioValiditaPatente || currentUser.dataInizioPatente, currentUser.inizioValiditaPatenteFormatted);
      const giorni = scadenzaPatente ? Math.ceil((scadenzaPatente - new Date())/(1000*60*60*24)) : null;
      let indirizzoFull = `${safe(currentUser.viaResidenza)} ${safe(currentUser.civicoResidenza)}`.trim();
      if (indirizzoFull === 'N/A N/A' || indirizzoFull === 'N/A') {
        const addr = currentUser.indirizzo || '';
        const s = splitAddress(addr);
        indirizzoFull = (s.via || s.civico) ? `${s.via} ${s.civico}`.trim() : safe(addr);
      }
      const comune = safe(currentUser.comuneResidenza);
      const luogoNascita = safe(currentUser.luogoNascita);
      const numeroPatente = safe(currentUser.numeroPatente);
      const inizioValiditaStr = inizioValidita ? fmtDateIT(inizioValidita) : fmtDateIT(currentUser.inizioValiditaPatenteFormatted || currentUser.inizioValiditaPatente || currentUser.dataInizioPatente);
      const scadenzaPatenteStr = scadenzaPatente ? fmtDateIT(scadenzaPatente) : fmtDateIT(currentUser.scadenzaPatenteFormatted || currentUser.scadenzaPatente);
      profileEl.innerHTML = `
        <div class="mb-2"><strong class="text-white">Nome:</strong> <span class="text-white-75">${safe(currentUser.nome)}</span></div>
        <div class="mb-2"><strong class="text-white">Codice Fiscale:</strong> <span class="text-white-75">${safe(currentUser.codiceFiscale)}</span></div>
        <div class="mb-2"><strong class="text-white">Comune:</strong> <span class="text-white-75">${comune}</span></div>
        <div class="mb-2"><strong class="text-white">Indirizzo:</strong> <span class="text-white-75">${indirizzoFull}</span></div>
        <div class="mb-2"><strong class="text-white">Luogo di nascita:</strong> <span class="text-white-75">${luogoNascita}</span></div>
        <div class="mb-2"><strong class="text-white">Patente:</strong> <span class="text-white-75">${numeroPatente}</span></div>
        <div class="mb-2"><strong class="text-white">Inizio validitÃ :</strong> <span class="text-white-75">${inizioValiditaStr}</span></div>
        <div class="mb-3"><strong class="text-white">Scadenza:</strong> <span class="text-white-75">${scadenzaPatenteStr}</span> ${giorni && giorni < 60 ? `<span class="badge bg-warning ms-1">${giorni}g</span>` : ''}</div>
        <div class="mb-2"><strong class="text-white">Telefono:</strong> <span class="text-white-75">${safe(currentUser.cellulare)}</span></div>
        <div class="mb-3 d-flex align-items-center justify-content-between">
          <div><strong class="text-white">Email:</strong> <span class="text-white-75">${safe(currentUser.email) || 'N/A'}</span></div>
          <button type="button" class="btn btn-outline-light btn-sm" data-role="edit-profile"><i class="fas fa-edit me-1"></i>Modifica Profilo</button>
        </div>`;
    }

    function openEditProfile(){
      document.getElementById('ep_nome').value = currentUser.nome || '';
      document.getElementById('ep_cf').value = currentUser.codiceFiscale || '';
      document.getElementById('ep_luogoNascita').value = currentUser.luogoNascita || '';
      document.getElementById('ep_comuneResidenza').value = currentUser.comuneResidenza || '';
      document.getElementById('ep_viaResidenza').value = currentUser.viaResidenza || '';
      document.getElementById('ep_civicoResidenza').value = currentUser.civicoResidenza || '';
      document.getElementById('ep_numeroPatente').value = currentUser.numeroPatente || '';
      const editInizio = tryParseDate(currentUser.inizioValiditaPatente || currentUser.dataInizioPatente, currentUser.inizioValiditaPatenteFormatted);
      const editScadenza = tryParseDate(currentUser.scadenzaPatente, currentUser.scadenzaPatenteFormatted);
      function formatYMDLocal(d){ const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
      document.getElementById('ep_inizioValiditaPatente').value = editInizio ? formatYMDLocal(editInizio) : '';
      document.getElementById('ep_scadenzaPatente').value = editScadenza ? formatYMDLocal(editScadenza) : '';
      document.getElementById('ep_cellulare').value = currentUser.cellulare || '';
      document.getElementById('ep_email').value = currentUser.email || '';
      editProfileModal.show();
    }

    async function saveProfile(){
      const btn = document.getElementById('ep_save_btn');
      const spn = document.getElementById('ep_saving_spinner');
      const txt = document.getElementById('ep_save_text');

      // UI loading state
      btn.disabled = true; spn.classList.remove('d-none'); txt.textContent = 'Salvataggio...';

      const payload = {
        action: 'aggiornaCliente',
        codiceFiscale: currentUser.codiceFiscale,
        nome: document.getElementById('ep_nome').value.trim(),
        luogoNascita: document.getElementById('ep_luogoNascita').value.trim(),
        comuneResidenza: document.getElementById('ep_comuneResidenza').value.trim(),
        viaResidenza: document.getElementById('ep_viaResidenza').value.trim(),
        civicoResidenza: document.getElementById('ep_civicoResidenza').value.trim(),
        numeroPatente: document.getElementById('ep_numeroPatente').value.trim(),
        inizioValiditaPatente: document.getElementById('ep_inizioValiditaPatente').value,
        scadenzaPatente: document.getElementById('ep_scadenzaPatente').value,
        cellulare: document.getElementById('ep_cellulare').value.trim(),
        email: document.getElementById('ep_email').value.trim()
      };
      try{
        const res = await api.call(payload);
        if (res.success){
          if (window.showToast) showToast('Profilo aggiornato con successo', 'success');
          Object.assign(currentUser, payload);
          localStorage.setItem('imbriani_user', JSON.stringify(currentUser));
          await loadProfile();
          editProfileModal.hide();
        } else {
          if (window.showToast) showToast(res.message || 'Errore aggiornamento profilo', 'error');
        }
      }catch(err){ if (window.showToast) showToast('Errore di rete: '+err.message, 'error'); }
      finally{ btn.disabled = false; spn.classList.add('d-none'); txt.textContent = 'Salva Modifiche'; }
    }

    async function loadBookings(){
      const listEl = document.getElementById('bookings-list');
      try {
        const response = await api.call({ action: 'getPrenotazioni' });
        if (!response.success){ listEl.innerHTML = '<div class="text-danger">Errore caricamento prenotazioni</div>'; return; }
        const bookings = (response.data || []).filter(b => b.codiceFiscaleAutista1 === currentUser.codiceFiscale);
        if (bookings.length === 0){ listEl.innerHTML = `<div class="text-center text-muted py-4"><i class="fas fa-calendar-times mb-2" style="font-size:2rem"></i><div>Nessuna prenotazione trovata</div><button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="document.getElementById('nuova-prenotazione').click()">Crea la tua prima prenotazione</button></div>`; return; }
        listEl.innerHTML = bookings.slice(0,5).map(booking => {
          const status = booking.stato || 'In attesa';
          const statusClass = { 'In attesa':'status-attesa','Confermata':'status-confermata','Completata':'status-completata','Rifiutata':'status-rifiutata' }[status] || 'status-attesa';
          const targa = window.escapeHtml ? escapeHtml(booking.targa || 'Targa N/A') : (booking.targa || 'Targa N/A');
          const dataInizio = booking.giornoInizio ? fmtDateIT(booking.giornoInizio) : 'N/A';
          const dataFine = booking.giornoFine ? fmtDateIT(booking.giornoFine) : 'N/A';
          const destinazione = window.escapeHtml ? escapeHtml(booking.destinazione || 'Destinazione N/A') : (booking.destinazione || 'Destinazione N/A');
          const importo = booking.importo ? `${booking.importo}â‚¬` : '';
          return `<div class="border-bottom border-secondary pb-3 mb-3"><div class="d-flex justify-content-between align-items-start mb-1"><h6 class="text-white fw-semibold mb-0">${targa}</h6><span class="booking-status ${statusClass}">${status}</span></div><div class="small text-white-50 mb-1"><i class="fas fa-calendar me-1"></i>${dataInizio} â†’ ${dataFine}</div><div class="small text-white-75 mb-2"><i class="fas fa-map-marker-alt me-1"></i>${destinazione}</div>${importo ? `<div class="small text-success text-end">${importo}</div>` : ''}</div>`; }).join('');
        if (bookings.length > 5){ listEl.innerHTML += `<div class="text-center mt-3"><button class="btn btn-outline-light btn-sm">Vedi tutte (${bookings.length})</button></div>`; }
      } catch (error) { console.error('Errore caricamento prenotazioni:', error); listEl.innerHTML = '<div class="text-danger">Errore caricamento prenotazioni</div>'; }
    }

    async function loadStats(){
      try{
        const response = await api.call({ action: 'getPrenotazioni' }); if (!response.success) return;
        const bookings = (response.data || []).filter(b => b.codiceFiscaleAutista1 === currentUser.codiceFiscale);
        const attive = bookings.filter(b => ['In attesa','Confermata'].includes(b.stato)).length;
        const totali = bookings.length;
        document.getElementById('stat-prenotazioni-attive').textContent = attive;
        document.getElementById('stat-prenotazioni-totali').textContent = totali;
        if (currentUser.scadenzaPatente || currentUser.scadenzaPatenteFormatted){
          const scadenza = parseDateAny(currentUser.scadenzaPatente || currentUser.scadenzaPatenteFormatted);
          if (scadenza){
            const giorni = Math.ceil((scadenza - new Date())/(1000*60*60*24));
            document.getElementById('stat-prossima-scadenza').textContent = giorni > 0 ? `${giorni}gg` : 'Scaduta';
            if (giorni < 60) document.getElementById('stat-prossima-scadenza').className = 'h4 text-danger mb-1';
          }
        }
      }catch(error){ console.error('Errore caricamento statistiche:', error); }
    }
  </script>
</body>
</html>
