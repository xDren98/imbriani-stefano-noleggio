<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Errori di Rete Forzati</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover { background: #c82333; }
        .test-button.success { background: #28a745; }
        .test-button.success:hover { background: #218838; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .log-entry {
            font-family: monospace;
            font-size: 12px;
            padding: 5px;
            margin: 2px 0;
            background: #f8f9fa;
            border-left: 3px solid #007bff;
        }
        .log-error { border-left-color: #dc3545; }
        .log-success { border-left-color: #28a745; }
        .log-warning { border-left-color: #ffc107; }
        .network-status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .online { background: #d4edda; color: #155724; }
        .offline { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>ðŸ§ª Test Errori di Rete Forzati</h1>
    
    <div class="test-section">
        <h2>Stato Connessione</h2>
        <div id="network-status" class="network-status">
            ðŸ”„ Controllo connessione...
        </div>
    </div>
    
    <div class="test-section">
        <h2>Test Errori di Rete</h2>
        <p>Questi test forzano errori di rete per verificare la gestione degli errori.</p>
        
        <button class="test-button" onclick="testInvalidProxy()">Test Proxy Invalido</button>
        <button class="test-button" onclick="testTimeoutError()">Test Timeout Error</button>
        <button class="test-button" onclick="testBothConnectionsFail()">Test Entrambe le Connessioni Falliscono</button>
        <button class="test-button" onclick="testRetryExhaustion()">Test Retry Exhaustion</button>
        <button class="test-button success" onclick="testValidConnection()">Test Connessione Valida</button>
        <button class="test-button" onclick="clearLogs()">Pulisci Log</button>
        
        <div id="status"></div>
    </div>
    
    <div class="test-section">
        <h2>Log dei Test</h2>
        <div id="log-container" style="max-height: 400px; overflow-y: auto;"></div>
    </div>

    <script src="shared-utils.js"></script>
    <script>
        let testCount = 0;
        let originalConfig = {};
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('it-IT');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            document.getElementById('log-container').appendChild(logEntry);
            document.getElementById('log-container').scrollTop = document.getElementById('log-container').scrollHeight;
            
            if (type === 'error') {
                console.error(`[TEST ERROR] ${message}`);
            } else {
                console.log(`[TEST LOG] ${message}`);
            }
        }
        
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<span class="${type}">${message}</span>`;
        }
        
        function updateNetworkStatus() {
            const statusDiv = document.getElementById('network-status');
            if (navigator.onLine) {
                statusDiv.className = 'network-status online';
                statusDiv.innerHTML = 'ðŸŸ¢ Connessione attiva';
            } else {
                statusDiv.className = 'network-status offline';
                statusDiv.innerHTML = 'ðŸ”´ Connessione assente';
            }
        }
        
        // Backup configurazione originale
        function backupConfig() {
            originalConfig.API_URL = window.CONFIG?.API_URL;
            originalConfig.timeout = window.CONFIG?.timeout;
        }
        
        // Ripristina configurazione
        function restoreConfig() {
            if (window.CONFIG) {
                window.CONFIG.API_URL = originalConfig.API_URL;
                if (originalConfig.timeout) {
                    window.CONFIG.timeout = originalConfig.timeout;
                }
            }
        }
        
        async function testInvalidProxy() {
            testCount++;
            log(`=== Test ${testCount}: Proxy Invalido ===`, 'info');
            updateStatus('Testing invalid proxy...', 'warning');
            
            backupConfig();
            
            try {
                // Forza URL proxy invalido
                if (!window.CONFIG) window.CONFIG = {};
                window.CONFIG.API_URL = 'https://invalid-proxy-12345.nonexistent.com';
                
                log('ðŸ”— Forzando proxy invalido...', 'warning');
                const startTime = performance.now();
                
                const result = await secureGet('getVeicoli', {});
                const duration = performance.now() - startTime;
                
                if (result && result.success) {
                    log(`âœ… SUCCESS: Fallback funzionante! Durata: ${duration.toFixed(2)}ms`, 'success');
                    log('ðŸ“¡ Connessione diretta a Google Apps Script riuscita', 'success');
                    updateStatus('âœ… Test superato: fallback funzionante', 'success');
                } else {
                    log(`âŒ ERROR: ${JSON.stringify(result)}`, 'error');
                    updateStatus('âŒ Test fallito', 'error');
                }
                
            } catch (error) {
                const duration = performance.now() - startTime;
                log(`âŒ EXCEPTION: ${error.message} (dopo ${duration.toFixed(2)}ms)`, 'error');
                updateStatus(`âŒ Test fallito: ${error.message}`, 'error');
            } finally {
                restoreConfig();
            }
        }
        
        async function testTimeoutError() {
            testCount++;
            log(`=== Test ${testCount}: Timeout Error ===`, 'info');
            updateStatus('Testing timeout error...', 'warning');
            
            // Test che verifica la gestione dei timeout
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 100); // Timeout molto breve
            
            try {
                log('â±ï¸ Forzando timeout con segnale AbortController...', 'warning');
                const startTime = performance.now();
                
                // Sovrascrivi temporaneamente fetch per forzare un timeout
                const originalFetch = window.fetch;
                window.fetch = function(url, options) {
                    options = options || {};
                    options.signal = controller.signal;
                    return originalFetch.call(this, url, options);
                };
                
                const result = await secureGet('getVeicoli', {});
                const duration = performance.now() - startTime;
                
                // Ripristina fetch originale
                window.fetch = originalFetch;
                clearTimeout(timeoutId);
                
                log(`âŒ UNEXPECTED: Timeout non rilevato - ${JSON.stringify(result)}`, 'error');
                updateStatus('âŒ Test fallito: timeout non rilevato', 'error');
                
            } catch (error) {
                const duration = performance.now() - startTime;
                log(`âœ… SUCCESS: Timeout rilevato correttamente! ${error.message} (${duration.toFixed(2)}ms)`, 'success');
                updateStatus('âœ… Test superato: timeout gestito', 'success');
            } finally {
                // Ripristina fetch originale in caso di errore
                if (window.fetch !== window.fetch) {
                    window.fetch = originalFetch;
                }
                clearTimeout(timeoutId);
            }
        }
        
        async function testBothConnectionsFail() {
            testCount++;
            log(`=== Test ${testCount}: Entrambe le Connessioni Falliscono ===`, 'info');
            updateStatus('Testing both connections failing...', 'warning');
            
            backupConfig();
            
            try {
                // Forza entrambi gli endpoint a fallire
                if (!window.CONFIG) window.CONFIG = {};
                window.CONFIG.API_URL = 'https://invalid-proxy-12345.nonexistent.com';
                
                // Sovrascrivi temporaneamente il fallback URL
                const originalSecureGetInternal = window.secureGetInternal;
                
                window.secureGetInternal = async function(action, params, ck, url) {
                    try {
                        // Prova prima il proxy (fallirÃ )
                        return await originalSecureGetInternal.call(this, action, params, ck, url);
                    } catch (proxyError) {
                        // Poi prova il fallback (fallirÃ  anche)
                        throw new Error('Both proxy and direct connection failed - TEST SIMULATION');
                    }
                };
                
                log('ðŸ”¥ Forzando fallimento di entrambe le connessioni...', 'warning');
                const startTime = performance.now();
                
                const result = await secureGet('getVeicoli', {});
                const duration = performance.now() - startTime;
                
                // Ripristina funzione originale
                window.secureGetInternal = originalSecureGetInternal;
                
                if (result && result.error_type === 'service_unavailable') {
                    log(`âœ… SUCCESS: Entrambe le connessioni fallite gestite correttamente! ${duration.toFixed(2)}ms`, 'success');
                    log(`ðŸ“¨ Messaggio: ${result.message}`, 'success');
                    updateStatus('âœ… Test superato: errore gestito', 'success');
                } else {
                    log(`âŒ UNEXPECTED: ${JSON.stringify(result)}`, 'error');
                    updateStatus('âŒ Test fallito: comportamento inatteso', 'error');
                }
                
            } catch (error) {
                const duration = performance.now() - startTime;
                log(`âœ… SUCCESS: Errore gestito correttamente! ${error.message} (${duration.toFixed(2)}ms)`, 'success');
                updateStatus('âœ… Test superato: errore gestito', 'success');
            } finally {
                restoreConfig();
            }
        }
        
        async function testRetryExhaustion() {
            testCount++;
            log(`=== Test ${testCount}: Retry Exhaustion ===`, 'info');
            updateStatus('Testing retry exhaustion...', 'warning');
            
            let attemptCount = 0;
            
            const failingFunction = async () => {
                attemptCount++;
                log(`ðŸ”„ Tentativo ${attemptCount}`, 'warning');
                throw new Error(`Simulated failure ${attemptCount}`);
            };
            
            try {
                log('ðŸ”„ Forzando esaurimento retry...', 'warning');
                const startTime = performance.now();
                
                await retryWithBackoff(failingFunction, 3, 200); // 3 tentativi con breve delay
                
                const duration = performance.now() - startTime;
                log(`âŒ UNEXPECTED: Retry non esaurito`, 'error');
                updateStatus('âŒ Test fallito: retry non esaurito', 'error');
                
            } catch (error) {
                const duration = performance.now() - startTime;
                log(`âœ… SUCCESS: Retry esaurito correttamente dopo ${attemptCount} tentativi! ${error.message} (${duration.toFixed(2)}ms)`, 'success');
                updateStatus('âœ… Test superato: retry esaurito', 'success');
            }
        }
        
        async function testValidConnection() {
            testCount++;
            log(`=== Test ${testCount}: Connessione Valida ===`, 'info');
            updateStatus('Testing valid connection...', 'warning');
            
            restoreConfig();
            
            try {
                log('ðŸŸ¢ Test connessione valida...', 'info');
                const startTime = performance.now();
                
                const result = await secureGet('getVeicoli', {});
                const duration = performance.now() - startTime;
                
                if (result && result.success) {
                    log(`âœ… SUCCESS: Connessione valida! ${duration.toFixed(2)}ms`, 'success');
                    log(`ðŸ“Š Dati: ${result.data ? result.data.length : 0} veicoli`, 'success');
                    updateStatus('âœ… Test superato: connessione valida', 'success');
                } else {
                    log(`âŒ ERROR: ${JSON.stringify(result)}`, 'error');
                    updateStatus('âŒ Test fallito: connessione non valida', 'error');
                }
                
            } catch (error) {
                const duration = performance.now() - startTime;
                log(`âŒ EXCEPTION: ${error.message} (${duration.toFixed(2)}ms)`, 'error');
                updateStatus(`âŒ Test fallito: ${error.message}`, 'error');
            }
        }
        
        function clearLogs() {
            document.getElementById('log-container').innerHTML = '';
            document.getElementById('status').innerHTML = '';
            testCount = 0;
            log('ðŸ§¹ Log puliti. Pronto per nuovi test.', 'info');
        }
        
        // Inizializzazione
        window.addEventListener('load', () => {
            updateNetworkStatus();
            backupConfig();
            log('ðŸš€ Test Errori di Rete Forzati avviato', 'info');
            log(`ðŸ“¡ Stato iniziale: ${navigator.onLine ? 'Online' : 'Offline'}`, 'info');
        });
        
        // Monitoraggio cambiamenti di rete
        window.addEventListener('online', () => {
            updateNetworkStatus();
            log('ðŸŸ¢ Connessione ristabilita', 'success');
        });
        
        window.addEventListener('offline', () => {
            updateNetworkStatus();
            log('ðŸ”´ Connessione persa', 'error');
        });
    </script>
</body>
</html>