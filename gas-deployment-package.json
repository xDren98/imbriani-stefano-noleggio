{
  "timestamp": "2025-11-15T01:06:50.575Z",
  "version": "1.0.0-security-fixes",
  "files": {
    "backend/Config.gs": {
      "content": "/**\r\n * CONFIGURAZIONE GLOBALE\r\n * Imbriani Stefano Noleggio - Backend v8.9.5\r\n * \r\n * Contiene tutte le configurazioni e costanti del sistema\r\n */\r\n\r\n// Utilizza Script Properties per caricare segreti e configurazioni sensibili,\r\n// mantenendo compatibilità con i valori attuali come fallback.\r\nfunction getScriptProp(key, fallback) {\r\n  try {\r\n    var props = PropertiesService.getScriptProperties();\r\n    var val = props.getProperty(key);\r\n    if (val && String(val).trim() !== '') return val;\r\n    if (fallback !== undefined) {\r\n      Logger.log('[CONFIG] Proprietà mancante: ' + key + ' — uso fallback');\r\n      return fallback;\r\n    }\r\n    return null;\r\n  } catch (err) {\r\n    Logger.log('[CONFIG] Errore lettura proprietà ' + key + ': ' + err.message);\r\n    return fallback;\r\n  }\r\n}\r\n\r\nconst CONFIG = {\r\n  VERSION: '8.9.7',\r\n  SPREADSHEET_ID: getScriptProp('SPREADSHEET_ID', null),\r\n  TOKEN: getScriptProp('TOKEN', null),\r\n  // Elenco token consentiti per rotazione; supporta CSV o JSON in Script Properties (chiave: TOKENS)\r\n  TOKENS: (function(){\r\n    var raw = getScriptProp('TOKENS', null);\r\n    if (!raw || String(raw).trim() === '') return [];\r\n    try {\r\n      var parsed = JSON.parse(raw);\r\n      if (Array.isArray(parsed) && parsed.length > 0) return parsed.map(String);\r\n    } catch (_){ /* fallback CSV */ }\r\n    return String(raw).split(',').map(function(t){ return String(t).trim(); }).filter(function(t){ return t.length>0; });\r\n  })(),\r\n  \r\n  SHEETS: {\r\n    PRENOTAZIONI: 'PRENOTAZIONI',\r\n    PULMINI: 'PULMINI',\r\n    CLIENTI: 'CLIENTI',\r\n    MANUTENZIONI: 'MANUTENZIONI'\r\n  },\r\n  \r\n  PRENOTAZIONI_COLS: {\r\n    TIMESTAMP: 1,\r\n    NOME_AUTISTA_1: 2,\r\n    DATA_NASCITA_AUTISTA_1: 3,\r\n    LUOGO_NASCITA_AUTISTA_1: 4,\r\n    CODICE_FISCALE_AUTISTA_1: 5,\r\n    COMUNE_RESIDENZA_AUTISTA_1: 6,\r\n    VIA_RESIDENZA_AUTISTA_1: 7,\r\n    CIVICO_RESIDENZA_AUTISTA_1: 8,\r\n    NUMERO_PATENTE_AUTISTA_1: 9,\r\n    DATA_INIZIO_PATENTE_AUTISTA_1: 10,\r\n    SCADENZA_PATENTE_AUTISTA_1: 11,\r\n    TARGA: 12,\r\n    ORA_INIZIO: 13,\r\n    ORA_FINE: 14,\r\n    GIORNO_INIZIO: 15,\r\n    GIORNO_FINE: 16,\r\n    DESTINAZIONE: 17,\r\n    CELLULARE: 18,\r\n    DATA_CONTRATTO: 19,\r\n    NOME_AUTISTA_2: 20,\r\n    DATA_NASCITA_AUTISTA_2: 21,\r\n    LUOGO_NASCITA_AUTISTA_2: 22,\r\n    CODICE_FISCALE_AUTISTA_2: 23,\r\n    COMUNE_RESIDENZA_AUTISTA_2: 24,\r\n    VIA_RESIDENZA_AUTISTA_2: 25,\r\n    CIVICO_RESIDENZA_AUTISTA_2: 26,\r\n    NUMERO_PATENTE_AUTISTA_2: 27,\r\n    DATA_INIZIO_PATENTE_AUTISTA_2: 28,\r\n    SCADENZA_PATENTE_AUTISTA_2: 29,\r\n    NOME_AUTISTA_3: 30,\r\n    DATA_NASCITA_AUTISTA_3: 31,\r\n    LUOGO_NASCITA_AUTISTA_3: 32,\r\n    CODICE_FISCALE_AUTISTA_3: 33,\r\n    COMUNE_RESIDENZA_AUTISTA_3: 34,\r\n    VIA_RESIDENZA_AUTISTA_3: 35,\r\n    CIVICO_RESIDENZA_AUTISTA_3: 36,\r\n    NUMERO_PATENTE_AUTISTA_3: 37,\r\n    DATA_INIZIO_PATENTE_AUTISTA_3: 38,\r\n    SCADENZA_PATENTE_AUTISTA_3: 39,\r\n    ID_PRENOTAZIONE: 40,\r\n    STATO_PRENOTAZIONE: 41,\r\n    IMPORTO_PREVENTIVO: 42,\r\n    EMAIL: 43,\r\n    TEST: 44,\r\n    PDF_URL: 45\r\n  },\r\n  \r\n  CLIENTI_COLS: {\r\n    NOME: 1,\r\n    DATA_NASCITA: 2,\r\n    LUOGO_NASCITA: 3,\r\n    CODICE_FISCALE: 4,\r\n    COMUNE_RESIDENZA: 5,\r\n    VIA_RESIDENZA: 6,\r\n    CIVICO_RESIDENZA: 7,\r\n    NUMERO_PATENTE: 8,\r\n    DATA_INIZIO_PATENTE: 9,\r\n    SCADENZA_PATENTE: 10,\r\n    CELLULARE: 11,\r\n    EMAIL: 12\r\n  },\r\n  \r\n  PULMINI_COLS: {\r\n    TARGA: 1,\r\n    MARCA: 2,\r\n    MODELLO: 3,\r\n    POSTI: 4,\r\n    STATO: 5,\r\n    NOTE: 6\r\n  },\r\n  \r\n  MANUTENZIONI_COLS: {\r\n    TARGA: 1,\r\n    MARCA: 2,\r\n    MODELLO: 3,\r\n    POSTI: 4,\r\n    STATO: 5,\r\n    DATA_INIZIO: 6,\r\n    DATA_FINE: 7,\r\n    COSTO: 8,\r\n    NOTE: 9\r\n  },\r\n  \r\n  GOOGLE: {\r\n    // API Key per Google Cloud Vision (OCR documenti)\r\n    VISION_API_KEY: getScriptProp('GOOGLE_VISION_API_KEY', null)\r\n  },\r\n  \r\n  TELEGRAM: {\r\n    BOT_TOKEN: getScriptProp('TELEGRAM_BOT_TOKEN', null),\r\n    CHAT_ID: getScriptProp('TELEGRAM_CHAT_ID', null)\r\n  },\r\n  \r\n  EMAIL: {\r\n    FROM_NAME: getScriptProp('EMAIL_FROM_NAME', 'Imbriani Stefano Noleggio'),\r\n    FROM_EMAIL: getScriptProp('EMAIL_FROM_EMAIL', null)\r\n  },\r\n  \r\n  PDF: {\r\n    TEMPLATE_DOC_ID: getScriptProp('PDF_TEMPLATE_DOC_ID', null),\r\n    PDF_FOLDER_ID: getScriptProp('PDF_FOLDER_ID', null),\r\n    TIMEZONE: 'Europe/Rome',\r\n    VEICOLI: {\r\n      'DN391FW': { marca: 'Fiat', modello: 'Ducato' },\r\n      'EC787NM': { marca: 'Fiat', modello: 'Ducato' },\r\n      'EZ841FA': { marca: 'Renault', modello: 'Trafic' }\r\n    }\r\n  },\r\n  \r\n  // Flag globale per attivare/disattivare logging dettagliato lato backend\r\n  DEBUG_LOGS: false,\r\n\r\n  // Sicurezza sessioni e 2FA\r\n  SECURITY: {\r\n    SESSION_TTL_MINUTES: Number(getScriptProp('SESSION_TTL_MINUTES', 120)), // durata sessione client\r\n    REQUIRE_OTP_FOR_ADMIN: String(getScriptProp('REQUIRE_OTP_FOR_ADMIN', 'true')) === 'true',\r\n    OTP_TTL_MINUTES: Number(getScriptProp('OTP_TTL_MINUTES', 5)), // validità OTP admin\r\n    DEBUG_OTP: String(getScriptProp('DEBUG_OTP', 'false')) === 'true' // mostra OTP in risposta per test\r\n  }\r\n};\r\nfunction setConfigProps(post){\r\n  var allowed=['SPREADSHEET_ID','GOOGLE_VISION_API_KEY','TELEGRAM_BOT_TOKEN','TELEGRAM_CHAT_ID','EMAIL_FROM_EMAIL','EMAIL_FROM_NAME','PDF_TEMPLATE_DOC_ID','PDF_FOLDER_ID','SESSION_TTL_MINUTES','JWT_SECRET'];\r\n  var p=PropertiesService.getScriptProperties();\r\n  var body=post||{};\r\n  var setList=[];\r\n  for(var i=0;i<allowed.length;i++){\r\n    var k=allowed[i];\r\n    if(body.hasOwnProperty(k)){\r\n      var v=String(body[k]||'').trim();\r\n      p.setProperty(k,v);\r\n      setList.push(k);\r\n    }\r\n  }\r\n  return createJsonResponse({success:true,updated:setList});\r\n}\r\n",
      "size": 5545,
      "lines": 184
    },
    "backend/Auth.gs": {
      "content": "function parseToken(e){var a=(e&&e.parameter&&e.parameter.Authorization)||'';if(a){a=a.trim().replace(/^Bearer\\s+/i,'');return a}var t=(e&&e.parameter&&e.parameter.token)||'';return t.trim()}\nfunction getProps(){return PropertiesService.getScriptProperties()}\nfunction nowSec(){return Math.floor(Date.now()/1000)}\nfunction base64urlEncode(bytes){var s=Utilities.base64Encode(bytes).replace(/=/g,'').replace(/\\+/g,'-').replace(/\\//g,'_');return s}\nfunction base64urlEncodeString(str){return base64urlEncode(Utilities.newBlob(str).getBytes())}\nfunction getJWTSecret(){var s=getProps().getProperty('JWT_SECRET');if(!s||!String(s).trim()){throw new Error('JWT_SECRET non configurato. Impostare JWT_SECRET in ScriptProperties prima di utilizzare il sistema.')}return s}\nfunction createJWT(payload){var header={alg:'HS256',typ:'JWT'};var h=base64urlEncodeString(JSON.stringify(header));var p=base64urlEncodeString(JSON.stringify(payload));var data=h+'.'+p;var sig=Utilities.computeHmacSha256Signature(data,getJWTSecret());var s=base64urlEncode(sig);return data+'.'+s}\nfunction verifyJWT(token){try{var parts=String(token||'').split('.');if(parts.length!==3)return null;var h=parts[0],p=parts[1],s=parts[2];var data=h+'.'+p;var sig=Utilities.computeHmacSha256Signature(data,getJWTSecret());var s2=base64urlEncode(sig);if(s!==s2)return null;var json=Utilities.newBlob(Utilities.base64Decode(p)).getDataAsString();var payload=JSON.parse(json);if(payload&&payload.exp&&payload.exp<nowSec())return null;return payload}catch(_){return null}}\nfunction putSession(token,session){if(!token)return false;var p=getProps();p.setProperty('SESSION:'+token,JSON.stringify(session));return true}\nfunction getSessionLegacy(token){if(!token)return null;var raw=getProps().getProperty('SESSION:'+token);if(!raw)return null;try{var s=JSON.parse(raw);if(s&&s.exp&&s.exp<nowSec()){revokeSession(token);return null}return s}catch(_){return null}}\nfunction revokeSession(token){if(!token)return false;getProps().deleteProperty('SESSION:'+token);return true}\nfunction getSession(token){if(!token)return null;var jwt=verifyJWT(token);if(jwt)return jwt;return getSessionLegacy(token)}\nfunction isAdmin(token){var s=getSession(token);return !!(s&&String(s.role||'')==='admin')}\nfunction getSessionInfo(token){var s=getSession(token);return{sessionValid:!!s,sessionRole:s?(s.role||'user'):'none'}}\n\nfunction generateCSRFToken(sessionToken){\n  if(!sessionToken)return null;\n  var session=getSession(sessionToken);\n  if(!session)return null;\n  var timestamp=nowSec();\n  var data=sessionToken+':'+timestamp;\n  var signature=Utilities.computeHmacSha256Signature(data,getJWTSecret());\n  var token=base64urlEncode(signature)+':'+timestamp;\n  return token;\n}\n\nfunction validateCSRFToken(sessionToken,csrfToken){\n  if(!sessionToken||!csrfToken)return false;\n  var session=getSession(sessionToken);\n  if(!session)return false;\n  var parts=String(csrfToken).split(':');\n  if(parts.length!==2)return false;\n  var sig=parts[0],timestamp=parseInt(parts[1],10);\n  if(!timestamp||isNaN(timestamp))return false;\n  if(timestamp<(nowSec()-3600))return false;\n  var data=sessionToken+':'+timestamp;\n  var expectedSig=base64urlEncode(Utilities.computeHmacSha256Signature(data,getJWTSecret()));\n  return sig===expectedSig;\n}\nfunction json(o,code){var t=ContentService.createTextOutput(JSON.stringify(o));t.setMimeType(ContentService.MimeType.JSON);if(code&&t.setStatusCode)t.setStatusCode(code);return t}\n",
      "size": 3449,
      "lines": 41
    },
    "backend/Helpers.gs": {
      "content": "/**\n * HELPER GENERICI\n * \n * Funzioni di utility generiche utilizzate in tutto il sistema\n */\n\n/**\n * Sanitizza i valori per prevenire formula injection in Google Sheets\n * @param {string} value - Valore da sanitizzare\n * @return {string} Valore sanitizzato\n */\nfunction sanitizeSheetValue(value) {\n  if (value === null || value === undefined) return '';\n  var str = String(value).trim();\n  \n  // Se il valore inizia con caratteri pericolosi per le formule, aggiungi uno spazio davanti\n  var dangerousPrefixes = /^[=+\\-@]/;\n  if (dangerousPrefixes.test(str)) {\n    return ' ' + str;\n  }\n  \n  return str;\n}\n\n/**\n * Crea una risposta JSON standardizzata\n * @param {Object} data - Dati da restituire\n * @param {number} status - Codice HTTP status (default 200)\n * @return {ContentService} Risposta JSON formattata\n */\nfunction createJsonResponse(data, status) {\n  var s = status || 200;\n  var resp = data;\n  resp.timestamp = new Date().toISOString();\n  resp.version = CONFIG.VERSION;\n  resp.status = s;\n  \n  return ContentService\n    .createTextOutput(JSON.stringify(resp))\n    .setMimeType(ContentService.MimeType.JSON);\n}\n\n/**\n * Recupera dati generici da un foglio Google Sheets\n * @param {Object} p - Parametri contenenti 'name' del foglio\n * @return {ContentService} Risposta JSON con dati del foglio\n */\nfunction getSheetGeneric(p) {\n  try {\n    var name = p.name;\n    if (!name) {\n      return createJsonResponse({ success: false, message: 'Parametro name mancante' }, 400);\n    }\n    var fieldsRaw = String(p.fields || '').trim();\n    var fields = fieldsRaw ? fieldsRaw.split(',').map(function(s){ return String(s).trim(); }).filter(function(s){ return s.length>0; }) : null;\n    var limit = parseInt(p.limit, 10); if (isNaN(limit) || limit <= 0) limit = 0;\n    var offset = parseInt(p.offset, 10); if (isNaN(offset) || offset < 0) offset = 0;\n    var nocache = String(p.nocache || '').trim() === '1';\n    var cacheKey = 'sheet:' + name + ':' + (fields ? fields.join('|') : '*') + ':' + limit + ':' + offset;\n    var cache = CacheService.getScriptCache();\n    if (!nocache) {\n      var cached = cache.get(cacheKey);\n      if (cached) {\n        return ContentService.createTextOutput(cached).setMimeType(ContentService.MimeType.JSON);\n      }\n    }\n    var sh = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID).getSheetByName(name);\n    if (!sh) {\n      return createJsonResponse({ success: false, message: 'Foglio non trovato: ' + name }, 404);\n    }\n    var lastRow = sh.getLastRow();\n    var lastCol = sh.getLastColumn();\n    var headers = sh.getRange(1, 1, 1, lastCol).getValues()[0];\n    var idxMap = {};\n    for (var c = 0; c < headers.length; c++) { idxMap[headers[c]] = c; }\n    var selectedIdx = null;\n    var outHeaders = headers;\n    if (fields && fields.length) {\n      selectedIdx = [];\n      outHeaders = fields;\n      for (var k = 0; k < fields.length; k++) {\n        var h = fields[k];\n        if (idxMap[h] !== undefined) selectedIdx.push(idxMap[h]);\n      }\n    }\n    var rows = [];\n    var dataStartRow = 2 + offset; // dati iniziano dalla riga 2\n    var availableRows = Math.max(0, lastRow - (1 + offset));\n    var takeRows = limit > 0 ? Math.min(availableRows, limit) : availableRows;\n    var vals = takeRows > 0 ? sh.getRange(dataStartRow, 1, takeRows, lastCol).getValues() : [];\n    for (var i = 0; i < vals.length; i++) {\n      var obj = {};\n      if (selectedIdx) {\n        for (var s = 0; s < selectedIdx.length; s++) {\n          var ci = selectedIdx[s];\n          var key = outHeaders[s];\n          var val = vals[i][ci];\n          obj[key] = val;\n          if (val instanceof Date && !isNaN(val.getTime())) { obj[key + 'Formatted'] = formatDateToItalian(val); }\n        }\n      } else {\n        for (var j = 0; j < headers.length; j++) {\n          var v = vals[i][j];\n          obj[headers[j]] = v;\n          if (v instanceof Date && !isNaN(v.getTime())) { obj[headers[j] + 'Formatted'] = formatDateToItalian(v); }\n        }\n      }\n      rows.push(obj);\n    }\n    var respObj = { success: true, data: rows, count: rows.length };\n    var respText = JSON.stringify(respObj);\n    if (!nocache) { cache.put(cacheKey, respText, 60); }\n    return ContentService.createTextOutput(respText).setMimeType(ContentService.MimeType.JSON);\n  } catch(err) {\n    return createJsonResponse({ success: false, message: 'Errore getSheet: ' + err.message }, 500);\n  }\n}\n\n/**\n * Normalizza un nome completo per utilizzo nei filename\n * @param {string} nomeCompleto - Nome da normalizzare\n * @return {Object} Oggetto con varianti del nome\n */\nfunction normalizzaNome(nomeCompleto) {\n  if (!nomeCompleto) return { conUnderscore: '', senzaSpazi: '', originale: '' };\n  \n  var nome = String(nomeCompleto).trim().replace(/\\s+/g, ' ');\n  var conUnderscore = nome.replace(/\\s+/g, '_');\n  var senzaSpazi = nome.replace(/\\s+/g, '');\n  \n  return {\n    conUnderscore: conUnderscore,\n    senzaSpazi: senzaSpazi,\n    originale: nome\n  };\n}\n\n/**\n * Genera informazioni sulla versione del backend\n * @return {Object} Oggetto con info versione\n */\nfunction versionInfo() {\n  return {\n    success: true,\n    service: 'imbriani-backend',\n    version: CONFIG.VERSION,\n    features: [\n      'pdf_generation',\n      'modifica_prenotazione',\n      'elimina_prenotazione',\n      'aggiornaStatoPrenotazione',\n      'booking_id_dinamico_anno',\n      'date_format_italian',\n      'modular_architecture'\n    ],\n    time: new Date().toISOString()\n  };\n}\n\n/**\n * Cache helpers JSON\n */\nfunction getCacheJson(key){ try{ var c=CacheService.getScriptCache(); var raw=c.get(key); return raw?JSON.parse(raw):null; }catch(_){ return null } }\nfunction putCacheJson(key,obj,ttl){ try{ var c=CacheService.getScriptCache(); c.put(key, JSON.stringify(obj), ttl||300); }catch(_){ } }\n\n/**\n * Indici per ricerche veloci su CLIENTI e PRENOTAZIONI\n */\nfunction buildClientIndex(){\n  var ss = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);\n  var sh = ss.getSheetByName(CONFIG.SHEETS.CLIENTI);\n  if (!sh) return { rows:{}, updated: new Date().toISOString() };\n  var vals = sh.getDataRange().getValues();\n  var C = CONFIG.CLIENTI_COLS;\n  var map = {};\n  for (var i=1;i<vals.length;i++){ var cf = String(vals[i][C.CODICE_FISCALE-1]||'').trim().toUpperCase(); if (cf) map[cf] = i+1; }\n  var idx = { rows: map, updated: new Date().toISOString(), lastRow: sh.getLastRow() };\n  putCacheJson('IDX_CLIENTI_V1', idx, 600);\n  return idx;\n}\nfunction clientRowIndexByCF(cf){ cf=String(cf||'').trim().toUpperCase(); if (!cf) return -1; var idx = getCacheJson('IDX_CLIENTI_V1'); if (!idx || !idx.rows || !idx.rows[cf]) { idx = buildClientIndex(); }\n  return idx.rows[cf] ? idx.rows[cf] : -1;\n}\n\nfunction buildPrenIndexById(){\n  var ss = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);\n  var sh = ss.getSheetByName(CONFIG.SHEETS.PRENOTAZIONI);\n  if (!sh) return { rows:{}, updated: new Date().toISOString() };\n  var vals = sh.getDataRange().getValues();\n  var C = CONFIG.PRENOTAZIONI_COLS;\n  var map = {};\n  for (var i=1;i<vals.length;i++){ var id = String(vals[i][C.ID_PRENOTAZIONE-1]||'').trim(); if (id) map[id] = i+1; }\n  var idx = { rows: map, updated: new Date().toISOString(), lastRow: sh.getLastRow() };\n  putCacheJson('IDX_PREN_V1', idx, 600);\n  return idx;\n}\nfunction prenRowIndexById(id){ id=String(id||'').trim(); if (!id) return -1; var idx = getCacheJson('IDX_PREN_V1'); if (!idx || !idx.rows || !idx.rows[id]) { idx = buildPrenIndexById(); }\n  return idx.rows[id] ? idx.rows[id] : -1;\n}\n\nfunction invalidateIndex(kind){ try{ var c=CacheService.getScriptCache(); if (kind==='CLIENTI' || !kind) { c.remove('IDX_CLIENTI_V1'); c.remove('SNAP_CLIENTI_V1'); } if (kind==='PREN' || !kind) { c.remove('IDX_PREN_V1'); c.remove('SNAP_PREN_V1'); } }catch(_){ } }\n\nfunction normalizeKey(s){ try{ return String(s||'').toLowerCase().normalize('NFD').replace(/[\\u0300-\\u036f]/g,'').replace(/[^a-z0-9]+/g,' ').replace(/\\s+/g,' ').trim(); }catch(_){ return String(s||'').toLowerCase().replace(/[^a-z0-9]+/g,' ').replace(/\\s+/g,' ').trim(); } }\n\nfunction getClientsSnapshot(){\n  var snap = getCacheJson('SNAP_CLIENTI_V1');\n  if (snap && Array.isArray(snap.data)) return snap;\n  var ss = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);\n  var sh = ss.getSheetByName(CONFIG.SHEETS.CLIENTI);\n  if (!sh) return { data:[], count:0, updated:new Date().toISOString() };\n  var vals = sh.getDataRange().getValues();\n  var C = CONFIG.CLIENTI_COLS;\n  var out = [];\n  for (var i=1;i<vals.length;i++){\n    var r = vals[i];\n    out.push({\n      nome: r[C.NOME-1]||'',\n      cf: String(r[C.CODICE_FISCALE-1]||'').toUpperCase(),\n      email: r[C.EMAIL-1]||'',\n      cellulare: r[C.CELLULARE-1]||'',\n      dataNascita: r[C.DATA_NASCITA-1]||'',\n      scadenzaPatente: r[C.SCADENZA_PATENTE-1]||''\n    });\n  }\n  var res = { data: out, count: out.length, updated: new Date().toISOString() };\n  putCacheJson('SNAP_CLIENTI_V1', res, 120);\n  return res;\n}\n\nfunction getPrenotazioniSnapshot(){\n  var snap = getCacheJson('SNAP_PREN_V1');\n  if (snap && Array.isArray(snap.data)) return snap;\n  var ss = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);\n  var sh = ss.getSheetByName(CONFIG.SHEETS.PRENOTAZIONI);\n  if (!sh) return { data:[], count:0, updated:new Date().toISOString() };\n  var vals = sh.getDataRange().getValues();\n  var C = CONFIG.PRENOTAZIONI_COLS;\n  var out = [];\n  for (var i=1;i<vals.length;i++){\n    var r = vals[i];\n    out.push({\n      id: String(r[C.ID_PRENOTAZIONE-1]||''),\n      targa: r[C.TARGA-1]||'',\n      destinazione: r[C.DESTINAZIONE-1]||'',\n      nome1: r[C.NOME_AUTISTA_1-1]||'',\n      nome2: r[C.NOME_AUTISTA_2-1]||'',\n      nome3: r[C.NOME_AUTISTA_3-1]||'',\n      stato: r[C.STATO_PRENOTAZIONE-1]||'',\n      giornoInizio: r[C.GIORNO_INIZIO-1]||'',\n      giornoFine: r[C.GIORNO_FINE-1]||''\n    });\n  }\n  var res = { data: out, count: out.length, updated: new Date().toISOString() };\n  putCacheJson('SNAP_PREN_V1', res, 120);\n  return res;\n}\n\n/**\n * Logging condizionale: scrive nei log solo se DEBUG_LOGS è true\n * @param {string} msg\n */\nfunction dbg(msg){\n  try {\n    if (CONFIG && CONFIG.DEBUG_LOGS) Logger.log(msg);\n  } catch (_) {}\n}\n",
      "size": 10091,
      "lines": 267
    },
    "backend/DateUtils.gs": {
      "content": "/**\r\n * UTILITY PER GESTIONE DATE\r\n * \r\n * Contiene funzioni per formattazione e parsing date\r\n * - Formattazione italiana (gg/mm/aaaa)\r\n * - Formattazione per filename\r\n * - Parsing date\r\n */\r\n\r\n/**\r\n * Formatta una data in formato italiano gg/mm/aaaa\r\n * @param {Date|string} date - Data da formattare\r\n * @return {string} Data formattata o stringa vuota se invalida\r\n */\r\nfunction formatDateToItalian(date) {\n  if (!date) return '';\n  try {\n    // Se è già una stringa italiana (gg/mm/aaaa), validala e restituiscila normalizzata\n    if (typeof date === 'string' && date.indexOf('/') > -1) {\n      var parts = date.split('/');\n      if (parts.length === 3) {\n        var gg = ('0' + parseInt(parts[0], 10)).slice(-2);\n        var mm = ('0' + parseInt(parts[1], 10)).slice(-2);\n        var yyyy = String(parts[2]).trim();\n        if (!isNaN(parseInt(gg,10)) && !isNaN(parseInt(mm,10)) && !isNaN(parseInt(yyyy,10))) {\n          return gg + '/' + mm + '/' + yyyy;\n        }\n      }\n      return '';\n    }\n    // Altrimenti prova a creare un Date (supporta anche ISO yyyy-mm-dd)\n    var d = (date instanceof Date) ? date : new Date(date);\n    if (isNaN(d.getTime())) return '';\n    var day = String(d.getDate()).padStart(2, '0');\n    var month = String(d.getMonth() + 1).padStart(2, '0');\n    var year = d.getFullYear();\n    return day + '/' + month + '/' + year;\n  } catch (e) {\n    Logger.log('[formatDateToItalian] Errore: ' + e.message);\n    return '';\n  }\n}\n\r\n/**\r\n * Formatta una data per utilizzo nei nomi file (gg-mm-aaaa)\r\n * @param {Date} date - Data da formattare\r\n * @return {string} Data formattata per filename o stringa vuota\r\n */\r\nfunction formatDateForFilename(date) {\r\n  if (date instanceof Date && !isNaN(date.getTime())) {\r\n    var d = Utilities.formatDate(date, CONFIG.PDF.TIMEZONE, 'dd/MM/yyyy');\r\n    return d.replace(/\\//g, '-');\r\n  }\r\n  return '';\r\n}\r\n\r\n/**\r\n * Normalizza una data rimuovendo ore/minuti/secondi\r\n * @param {Date} date - Data da normalizzare\r\n * @return {Date} Data normalizzata (solo anno/mese/giorno)\r\n */\r\nfunction normalizeDate(date) {\n  if (!date || !(date instanceof Date)) return null;\n  return new Date(date.getFullYear(), date.getMonth(), date.getDate());\n}\n\n/**\n * Parsing sicuro per date in formato italiano (gg/mm/aaaa) o ISO (yyyy-mm-dd)\n * @param {string|Date} value\n * @return {Date|null}\n */\nfunction parseItalianOrISO(value) {\n  if (!value) return null;\n  try {\n    if (value instanceof Date) {\n      // Usa mezzogiorno locale per evitare shift di giornata dovuti al timezone\n      return new Date(value.getFullYear(), value.getMonth(), value.getDate(), 12, 0, 0, 0);\n    }\n    if (typeof value === 'string') {\n      if (value.indexOf('/') > -1) {\n        var p = value.split('/');\n        if (p.length === 3) {\n          var day = parseInt(p[0], 10);\n          var month = parseInt(p[1], 10) - 1;\n          var year = parseInt(p[2], 10);\n          // Costruisci la data a mezzogiorno\n          var d = new Date(year, month, day, 12, 0, 0, 0);\n          return isNaN(d.getTime()) ? null : d;\n        }\n      } else if (value.indexOf('-') > -1) {\n        var s = value.split('-');\n        if (s.length === 3) {\n          var y = parseInt(s[0], 10);\n          var m = parseInt(s[1], 10) - 1;\n          var dd = parseInt(s[2], 10);\n          // Input ISO da <input type=\"date\"> → set a mezzogiorno\n          var d2 = new Date(y, m, dd, 12, 0, 0, 0);\n          return isNaN(d2.getTime()) ? null : d2;\n        }\n      }\n    }\n    // Fallback\n    var f = new Date(value);\n    return isNaN(f.getTime()) ? null : new Date(f.getFullYear(), f.getMonth(), f.getDate(), 12, 0, 0, 0);\n  } catch (e) {\n    Logger.log('[parseItalianOrISO] Errore: ' + e.message + ' per value=' + value);\n    return null;\n  }\n}\n\r\n/**\r\n * Verifica se due date sono lo stesso giorno\r\n * @param {Date} date1 - Prima data\r\n * @param {Date} date2 - Seconda data\r\n * @return {boolean} True se stesso giorno\r\n */\r\nfunction isSameDay(date1, date2) {\r\n  if (!date1 || !date2) return false;\r\n  return date1.getFullYear() === date2.getFullYear() &&\r\n         date1.getMonth() === date2.getMonth() &&\r\n         date1.getDate() === date2.getDate();\r\n}\r\n\r\n/**\r\n * Calcola differenza in giorni tra due date\r\n * @param {Date} startDate - Data inizio\r\n * @param {Date} endDate - Data fine\r\n * @return {number} Numero di giorni\r\n */\r\nfunction daysDifference(startDate, endDate) {\r\n  if (!startDate || !endDate) return 0;\r\n  var diffTime = Math.abs(endDate - startDate);\r\n  return Math.ceil(diffTime / (1000 * 60 * 60 * 24));\r\n}\r\n",
      "size": 4535,
      "lines": 135
    },
    "backend/Main.gs": {
      "content": "/**\r\n * ENTRY POINT PRINCIPALE\r\n * \r\n * Punto di ingresso per tutte le richieste HTTP\r\n * Delega la gestione agli endpoint specifici\r\n */\r\n\r\n/**\r\n * Gestisce richieste GET\r\n * @param {Object e - Evento richiesta HTTP\r\n * @return {ContentService} Risposta JSON\r\n */\r\nfunction doGet(e) {\r\n  Logger.log('[doGet] Chiamata ricevuta: ' + JSON.stringify(e.parameter));\r\n  // Verifica autorizzazione\n  if (!isRequestAuthorized(e)) {\n    Logger.log('[doGet] Accesso negato da IP/domino non autorizzato');\n    return ContentService.createTextOutput(JSON.stringify({\n      success: false,\n      message: 'Accesso negato'\n    })).setMimeType(ContentService.MimeType.JSON);\n  }\n  \n  return handleGet(e);\r\n}\r\n\r\n/**\r\n * Gestisce richieste POST\r\n * @param {Object} e - Evento richiesta HTTP con postData\r\n * @return {ContentService} Risposta JSON\r\n */\r\nfunction doPost(e) {\r\n  Logger.log('[doPost] Chiamata ricevuta');\r\n  // Verifica autorizzazione\n  if (!isRequestAuthorized(e)) {\n    Logger.log('[doPost] Accesso negato da IP/domino non autorizzato');\n    return ContentService.createTextOutput(JSON.stringify({\n      success: false,\n      message: 'Accesso negato'\n    })).setMimeType(ContentService.MimeType.JSON);\n  }\n  \n  return handlePost(e);\n}\n\n/**\n * Verifica se la richiesta proviene da un IP/domino autorizzato\n * @param {Object} e - Evento richiesta HTTP\n * @return {boolean} true se la richiesta è autorizzata\n */\nfunction isRequestAuthorized(e) {\n  try {\n    // Recupera lista di IP/domini autorizzati dalle proprietà\n    var allowedIPs = getProps().getProperty('ALLOWED_IPS');\n    var allowedDomains = getProps().getProperty('ALLOWED_DOMAINS');\n    \n    // Se non sono configurati restrizioni, permetti tutto (default behavior)\n    if (!allowedIPs && !allowedDomains) {\n      return true;\n    }\n    \n    // Recupera IP del client\n    var userIP = e?.parameter?.userIp || '';\n    var referrer = e?.parameter?.referrer || '';\n    \n    // Verifica IP autorizzati\n    if (allowedIPs) {\n      var ipList = allowedIPs.split(',').map(function(ip) { return ip.trim(); });\n      if (ipList.indexOf(userIP) !== -1) {\n        return true;\n      }\n    }\n    \n    // Verifica domini autorizzati nel referrer\n    if (allowedDomains && referrer) {\n      var domainList = allowedDomains.split(',').map(function(domain) { return domain.trim(); });\n      for (var i = 0; i < domainList.length; i++) {\n        if (referrer.indexOf(domainList[i]) !== -1) {\n          return true;\n        }\n      }\n    }\n    \n    return false;\n  } catch (error) {\n    Logger.log('[isRequestAuthorized] Errore nel controllo accesso: ' + error.message);\n    return false;\n  }\r\n}\r\n",
      "size": 2640,
      "lines": 90
    },
    "backend/EndpointsGet.gs": {
      "content": "function handleGet(e){var p=(e&&e.parameter)||{};var action=String(p.action||'').trim();var token=parseToken(e);\n  if(action==='debugAuth'){var i=getSessionInfo(token);var resp=createJsonResponse({success:true,sessionValid:i.sessionValid,sessionRole:i.sessionRole});return resp}\n  if(action==='getVeicoli'&&typeof getVeicoli==='function'){var noc=String(p.nocache||'')==='1';var k='getVeicoli:'+JSON.stringify(p||{});var c=CacheService.getScriptCache();if(!noc){var hit=c.get(k);if(hit){return ContentService.createTextOutput(hit).setMimeType(ContentService.MimeType.JSON)}}var r=getVeicoli(p);try{var t=r.getContent();if(!noc&&t)c.put(k,t,120)}catch(_){ }return r}\n  if(action==='disponibilita'&&typeof checkDisponibilita==='function'){var rd=checkDisponibilita(p);return rd}\n  if(action==='bulkCheckDisponibilita'&&typeof bulkCheckDisponibilita==='function'){var rb=bulkCheckDisponibilita(p);return rb}\n  if(action==='firstAvailableSlot'&&typeof firstAvailableSlot==='function'){var rf=firstAvailableSlot(p);return rf}\n  if(action==='getPrenotazioni'&&typeof getPrenotazioni==='function'){var noc2=String(p.nocache||'')==='1';var k2='getPrenotazioni:'+JSON.stringify(p||{});var c2=CacheService.getScriptCache();if(!noc2){var hit2=c2.get(k2);if(hit2){return ContentService.createTextOutput(hit2).setMimeType(ContentService.MimeType.JSON)}}var r2=getPrenotazioni(p);try{var t2=r2.getContent();if(!noc2&&t2)c2.put(k2,t2,120)}catch(_){ }return r2}\n  if(action==='getCliente'&&typeof getCliente==='function'){var cf=String(p.codiceFiscale||p.cf||'').trim().toUpperCase();var noc3=String(p.nocache||'')==='1';var k3='getCliente:'+cf;var c3=CacheService.getScriptCache();if(!noc3&&cf.length===16){var hit3=c3.get(k3);if(hit3){return ContentService.createTextOutput(hit3).setMimeType(ContentService.MimeType.JSON)}}var rc=getCliente(p);try{var t3=rc.getContent();if(!noc3&&t3&&cf.length===16)c3.put(k3,t3,60)}catch(_){ }return rc}\n  if(action==='getSheet'&&typeof getSheetGeneric==='function'){var rs=getSheetGeneric(p);return rs}\n  if(action==='health'){var rh=createJsonResponse({success:true,timestamp:new Date().toISOString()});return rh}\n  if(action==='version'){var rv=createJsonResponse(versionInfo());return rv}\n  if(action==='configStatus'){\n    var keys=['SPREADSHEET_ID','GOOGLE_VISION_API_KEY','TELEGRAM_BOT_TOKEN','TELEGRAM_CHAT_ID','EMAIL_FROM_EMAIL','PDF_TEMPLATE_DOC_ID','PDF_FOLDER_ID','SESSION_TTL_MINUTES','JWT_SECRET'];\n    var props=PropertiesService.getScriptProperties();\n    var status={};\n    for(var i=0;i<keys.length;i++){var k=keys[i];var v=props.getProperty(k);status[k]=!!(v&&String(v).trim());}\n    return createJsonResponse({success:true,status:status});\n  }\n  if(action==='search'){\n    var entity=String(p.entity||'').toLowerCase();\n    var q=String(p.q||p.query||'').trim();\n    var limit=parseInt(p.limit,10); if(isNaN(limit)||limit<=0) limit=50;\n    var offset=parseInt(p.offset,10); if(isNaN(offset)||offset<0) offset=0;\n    var resObj={success:true,data:[],count:0,total:0};\n    if(entity==='clienti'){\n      var snap=getClientsSnapshot();\n      var tokens=q?normalizeKey(q).split(' '):[];\n      var filtered=snap.data.filter(function(it){\n        var s=normalizeKey(it.nome+' '+it.cf+' '+it.email+' '+it.cellulare);\n        for(var i=0;i<tokens.length;i++){ if(tokens[i] && s.indexOf(tokens[i])===-1) return false; }\n        return true;\n      });\n      var total=filtered.length;\n      var sliced=filtered.slice(offset, offset+limit);\n      resObj.data=sliced; resObj.count=sliced.length; resObj.total=total;\n      var jr=createJsonResponse(resObj);\n      return jr;\n    }\n    if(entity==='veicoli'){\n      var noc=String(p.nocache||'')==='1';\n      var key='GET_VEICOLI_V1';\n      var c=CacheService.getScriptCache();\n      var hit=c.get(key);\n      var payload=hit?JSON.parse(hit):null;\n      if(!payload){ var r=getVeicoli({}); try{ var t=r.getContent(); payload=JSON.parse(t); c.put(key,t,120); }catch(_){ payload=null } }\n      var arr=(payload&&payload.data)?payload.data:[];\n      var tokens2=q?normalizeKey(q).split(' '):[];\n      var filtered2=arr.filter(function(v){\n        var s=normalizeKey((v.Targa||'')+' '+(v.Marca||'')+' '+(v.Modello||''));\n        for(var i=0;i<tokens2.length;i++){ if(tokens2[i] && s.indexOf(tokens2[i])===-1) return false; }\n        return true;\n      });\n      var total2=filtered2.length;\n      var sliced2=filtered2.slice(offset, offset+limit);\n      resObj.data=sliced2; resObj.count=sliced2.length; resObj.total=total2;\n      var jr2=createJsonResponse(resObj);\n      return jr2;\n    }\n    if(entity==='prenotazioni'){\n      var snapP=getPrenotazioniSnapshot();\n      var tokensP=q?normalizeKey(q).split(' '):[];\n      var filteredP=snapP.data.filter(function(it){\n        var s=normalizeKey((it.nome1||'')+' '+(it.nome2||'')+' '+(it.nome3||'')+' '+(it.targa||'')+' '+(it.destinazione||'')+' '+(it.stato||''));\n        for(var i=0;i<tokensP.length;i++){ if(tokensP[i] && s.indexOf(tokensP[i])===-1) return false; }\n        return true;\n      });\n      var totalP=filteredP.length;\n      var slicedP=filteredP.slice(offset, offset+limit);\n      resObj.data=slicedP; resObj.count=slicedP.length; resObj.total=totalP;\n      var jrp=createJsonResponse(resObj);\n      return jrp;\n    }\n    var jrn=createJsonResponse({success:false,message:'Entità non supportata'});\n    return jrn;\n  }\n  var rna=createJsonResponse({success:false,message:'Azione non supportata'});return rna}\n",
      "size": 5449,
      "lines": 77
    },
    "backend/EndpointsPost.gs": {
      "content": "function handlePost(e){var p=(e&&e.parameter)||{};var ct=(e&&e.postData&&e.postData.type)||'';var bodyRaw=(e&&e.postData&&e.postData.contents)||'';var body=p;try{if(ct.indexOf('application/json')>-1&&bodyRaw){body=JSON.parse(bodyRaw)}}catch(_){body=p}var action=String(p.action||body.action||'').trim();var token=parseToken(e);\n  var adminRequired=(function(a){return a==='setVeicolo'||a==='eliminaVeicolo'||a==='setManutenzione'||a==='aggiornaPrenotazione'||a==='aggiornaPrenotazioneCompleta'||a==='eliminaPrenotazione'||a==='aggiornaStatoPrenotazione'||a==='aggiornaStato'||a==='confermaPrenotazione'||a==='sincronizzaClienti'||a==='importaPrenotazioniICS'||a==='importaPrenotazioniCSV'||a==='setConfigProps';})(action);\n  if(adminRequired&&!isAdmin(token)){return json({success:false,message:'Admin required'},403)}\n  if(action==='requestAdminOTP'){var name=String(body.name||p.name||'').trim()||'Admin';var code=(''+Math.floor(100000+Math.random()*900000));var ttl=(CONFIG&&CONFIG.SECURITY&&CONFIG.SECURITY.OTP_TTL_MINUTES?CONFIG.SECURITY.OTP_TTL_MINUTES:5)*60;var exp=nowSec()+ttl;getProps().setProperty('OTP:'+name,JSON.stringify({code:code,exp:exp}));try{if(typeof inviaOTPAdmin==='function'){inviaOTPAdmin(name, code)}}catch(_){ }var res={success:true};var dbgFlag=(String(p.debug||body.debug||'')==='1')||(CONFIG&&CONFIG.SECURITY&&CONFIG.SECURITY.DEBUG_OTP);if(dbgFlag){res.debugOtp=code}return json(res)}\n  if(action==='adminLogin'){var name=String(body.name||p.name||'').trim()||'Admin';var otp=String(body.otp||p.otp||'').trim();var raw=getProps().getProperty('OTP:'+name);if(!raw){return json({success:false,message:'OTP missing'})}var o;try{o=JSON.parse(raw)}catch(_){o=null}if(!o||o.exp<nowSec()||o.code!==otp){return json({success:false,message:'OTP invalid'})}getProps().deleteProperty('OTP:'+name);var msgRaw=getProps().getProperty('OTPMSG:'+name);if(msgRaw){try{var m=JSON.parse(msgRaw);if(m&&m.chat_id&&Array.isArray(m.message_ids)&&typeof deleteTelegramMessage==='function'){for(var i=0;i<m.message_ids.length;i++){try{deleteTelegramMessage(m.chat_id,m.message_ids[i])}catch(__){}}}}catch(_){ }getProps().deleteProperty('OTPMSG:'+name)}var exp=nowSec()+3600;var payload={name:name,role:'admin',exp:exp,iat:nowSec()};var jwt=createJWT(payload);var csrfToken=generateCSRFToken(jwt);return json({success:true,token:jwt,csrfToken:csrfToken,role:'admin',exp:new Date(exp*1000).toISOString(),name:name})}\n  // RIMOSSO: devLogin disabilitato per motivi di sicurezza\n  if(action==='revokeSession'){var t=token||String(body.token||p.token||'');if(!t){return json({success:false,message:'token required'})}revokeSession(t);return json({success:true})}\n  if(action==='login'&&typeof login==='function'){return login(body)}\n  if(action==='getVeicoli'&&typeof getVeicoli==='function'){return getVeicoli(body)}\n  if(action==='getPrenotazioni'&&typeof getPrenotazioni==='function'){return getPrenotazioni(body)}\n  if(action==='getCliente'&&typeof getCliente==='function'){return getCliente(body)}\n  if(action==='ocrDocument'&&typeof ocrDocument==='function'){return ocrDocument(body)}\n  if(action==='creaPrenotazione'&&typeof creaPrenotazione==='function'){\n    var csrfToken=String(body.csrfToken||p.csrfToken||'');\n    if(!csrfToken||!validateCSRFToken(token,csrfToken)){return json({success:false,message:'CSRF token invalid'},403)}\n    return creaPrenotazione(body)\n  }\n  if(action==='aggiornaPrenotazione'&&typeof aggiornaPrenotazioneCompleta==='function'){\n    var csrfToken=String(body.csrfToken||p.csrfToken||'');\n    if(!csrfToken||!validateCSRFToken(token,csrfToken)){return json({success:false,message:'CSRF token invalid'},403)}\n    return aggiornaPrenotazioneCompleta(body)\n  }\n  if(action==='aggiornaPrenotazioneCompleta'&&typeof aggiornaPrenotazioneCompleta==='function'){\n    var csrfToken=String(body.csrfToken||p.csrfToken||'');\n    if(!csrfToken||!validateCSRFToken(token,csrfToken)){return json({success:false,message:'CSRF token invalid'},403)}\n    return aggiornaPrenotazioneCompleta(body)\n  }\n  if(action==='aggiornaStatoPrenotazione'&&typeof aggiornaStatoPrenotazione==='function'){\n    var csrfToken=String(body.csrfToken||p.csrfToken||'');\n    if(!csrfToken||!validateCSRFToken(token,csrfToken)){return json({success:false,message:'CSRF token invalid'},403)}\n    return aggiornaStatoPrenotazione(body)\n  }\n  if(action==='aggiornaStato'&&typeof aggiornaStatoPrenotazione==='function'){\n    var csrfToken=String(body.csrfToken||p.csrfToken||'');\n    if(!csrfToken||!validateCSRFToken(token,csrfToken)){return json({success:false,message:'CSRF token invalid'},403)}\n    return aggiornaStatoPrenotazione(body)\n  }\n  if(action==='eliminaPrenotazione'&&typeof eliminaPrenotazione==='function'){\n    var csrfToken=String(body.csrfToken||p.csrfToken||'');\n    if(!csrfToken||!validateCSRFToken(token,csrfToken)){return json({success:false,message:'CSRF token invalid'},403)}\n    return eliminaPrenotazione(body)\n  }\n  if(action==='confermaPrenotazione'&&typeof confermaPrenotazione==='function'){\n    var csrfToken=String(body.csrfToken||p.csrfToken||'');\n    if(!csrfToken||!validateCSRFToken(token,csrfToken)){return json({success:false,message:'CSRF token invalid'},403)}\n    return confermaPrenotazione(body)\n  }\n  if(action==='aggiornaAutistiPubblico'&&typeof aggiornaAutistiPubblico==='function'){return aggiornaAutistiPubblico(body)}\n  if(action==='aggiornaAutistiPubblico_secure'){\n    var s=getSession(token);\n    if(!s){return json({success:false,message:'Auth required'},401)}\n    var cfBody=String(body.codiceFiscale||body.cf||'').trim().toUpperCase();\n    var cfTok=String((s.cf||'')).trim().toUpperCase();\n    if(s.role!=='admin' && cfBody && cfTok && cfBody!==cfTok){return json({success:false,message:'Forbidden'},403)}\n    if(typeof aggiornaAutistiPubblico==='function'){return aggiornaAutistiPubblico(body)}\n    return json({success:false,message:'Funzione non disponibile'})\n  }\n  if(action==='setVeicolo'&&typeof setVeicolo==='function'){\n    var csrfToken=String(body.csrfToken||p.csrfToken||'');\n    if(!csrfToken||!validateCSRFToken(token,csrfToken)){return json({success:false,message:'CSRF token invalid'},403)}\n    return setVeicolo(body)\n  }\n  if(action==='eliminaVeicolo'&&typeof eliminaVeicolo==='function'){\n    var csrfToken=String(body.csrfToken||p.csrfToken||'');\n    if(!csrfToken||!validateCSRFToken(token,csrfToken)){return json({success:false,message:'CSRF token invalid'},403)}\n    return eliminaVeicolo(body)\n  }\n  if(action==='setManutenzione'&&typeof setManutenzione==='function'){\n    var csrfToken=String(body.csrfToken||p.csrfToken||'');\n    if(!csrfToken||!validateCSRFToken(token,csrfToken)){return json({success:false,message:'CSRF token invalid'},403)}\n    return setManutenzione(body)\n  }\n  if(action==='sincronizzaClienti'&&typeof sincronizzaClienti==='function'){\n    var csrfToken=String(body.csrfToken||p.csrfToken||'');\n    if(!csrfToken||!validateCSRFToken(token,csrfToken)){return json({success:false,message:'CSRF token invalid'},403)}\n    return sincronizzaClienti(body)\n  }\n  if(action==='importaPrenotazioniICS'&&typeof importaPrenotazioniICS==='function'){\n    var csrfToken=String(body.csrfToken||p.csrfToken||'');\n    if(!csrfToken||!validateCSRFToken(token,csrfToken)){return json({success:false,message:'CSRF token invalid'},403)}\n    return importaPrenotazioniICS(body)\n  }\n  if(action==='importaPrenotazioniCSV'&&typeof importaPrenotazioniCSV==='function'){\n    var csrfToken=String(body.csrfToken||p.csrfToken||'');\n    if(!csrfToken||!validateCSRFToken(token,csrfToken)){return json({success:false,message:'CSRF token invalid'},403)}\n    return importaPrenotazioniCSV(body)\n  }\n  if(action==='setConfigProps'&&typeof setConfigProps==='function'){\n    var csrfToken=String(body.csrfToken||p.csrfToken||'');\n    if(!csrfToken||!validateCSRFToken(token,csrfToken)){return json({success:false,message:'CSRF token invalid'},403)}\n    return setConfigProps(body)\n  }\n  if(action==='aggiornaCliente'&&typeof aggiornaCliente==='function'){return aggiornaCliente(body)}\n  if(action==='creaCliente'&&typeof creaCliente==='function'){return creaCliente(body)}\n  if(action==='importaPrenotazioniCSV'&&typeof importaPrenotazioniCSV==='function'){return importaPrenotazioniCSV(body)}\n  if(action==='inviaRiepilogo'&&typeof inviaEmailConfermaPreventivo==='function'){\n    var csrfToken=String(body.csrfToken||p.csrfToken||'');\n    if(!csrfToken||!validateCSRFToken(token,csrfToken)){return json({success:false,message:'CSRF token invalid'},403)}\n    return inviaEmailConfermaPreventivo(body)\n  }\n  if(action==='setConfigProps'&&typeof setConfigProps==='function'){return setConfigProps(body)}\n  if(action==='generaPdfUltimaRiga'&&typeof generaPdfUltimaRiga==='function'){return json(generaPdfUltimaRiga(body))}\n  if(action==='generaPDFContratto'&&typeof generaPDFContratto==='function'){\n    var csrfToken=String(body.csrfToken||p.csrfToken||'');\n    if(!csrfToken||!validateCSRFToken(token,csrfToken)){return json({success:false,message:'CSRF token invalid'},403)}\n    return json(generaPDFContratto(String(body.idPrenotazione||body.id||body.ID||''), token))\n  }\n  if(action==='eliminaPDFPrenotazione'&&typeof eliminaPDFPrenotazione==='function'){\n    var csrfToken=String(body.csrfToken||p.csrfToken||'');\n    if(!csrfToken||!validateCSRFToken(token,csrfToken)){return json({success:false,message:'CSRF token invalid'},403)}\n    return json(eliminaPDFPrenotazione(String(body.idPrenotazione||body.id||body.ID||''), token))\n  }\n  return createJsonResponse({success:false,message:'Azione non supportata'})}\n",
      "size": 9585,
      "lines": 114
    },
    "backend/ClientiService.gs": {
      "content": "/**\r\n * SERVIZIO GESTIONE CLIENTI\r\n * \r\n * Gestisce anagrafica clienti e sincronizzazione\r\n */\r\n\r\n/**\r\n * Aggiorna dati cliente esistente\r\n * @param {Object} post - Dati cliente con codiceFiscale\r\n * @return {ContentService} Risposta JSON\r\n */\r\nfunction aggiornaCliente(post) {\n  try {\r\n    var cf = (post.codiceFiscale || '').trim();\r\n    \r\n    if (!cf || cf.length !== 16) {\r\n      return createJsonResponse({\r\n        success: false,\r\n        message: 'Codice fiscale non valido'\r\n      }, 400);\r\n    }\r\n    \r\n    var sh = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID).getSheetByName(CONFIG.SHEETS.CLIENTI);\n    var idxRow = clientRowIndexByCF(cf);\n    \r\n    if (idxRow === -1) {\n      return createJsonResponse({\n        success: false,\n        message: 'Cliente non trovato'\n      }, 404);\n    }\n    var lastCol = sh.getLastColumn();\n    var row = sh.getRange(idxRow, 1, 1, lastCol).getValues()[0];\n    var C = CONFIG.CLIENTI_COLS;\n    function upd(key, val){ if (val !== undefined && val !== null) { row[C[key]-1] = sanitizeSheetValue(val); } }\n    upd('NOME', post.nome || post.nomeCompleto);\n    upd('LUOGO_NASCITA', post.luogoNascita);\n    upd('COMUNE_RESIDENZA', post.comuneResidenza);\n    upd('VIA_RESIDENZA', post.viaResidenza);\n    upd('CIVICO_RESIDENZA', post.civicoResidenza);\n    upd('NUMERO_PATENTE', post.numeroPatente);\n    upd('DATA_INIZIO_PATENTE', post.inizioValiditaPatente || post.dataInizioPatente);\n    upd('SCADENZA_PATENTE', post.scadenzaPatente);\n    upd('CELLULARE', post.cellulare);\n    upd('EMAIL', post.email);\n    sh.getRange(idxRow, 1, 1, lastCol).setValues([row]);\n    invalidateIndex('CLIENTI');\n    \r\n    return createJsonResponse({\n      success: true,\n      message: 'Profilo aggiornato',\n      codiceFiscale: cf\n    });\n  } catch(err) {\r\n    return createJsonResponse({\r\n      success: false,\r\n      message: 'Errore aggiornamento cliente: ' + err.message\r\n    }, 500);\r\n  }\r\n}\r\n\r\n/**\r\n * Sincronizza clienti da PRENOTAZIONI a CLIENTI\r\n * Crea o aggiorna clienti basandosi su autisti nelle prenotazioni\r\n * @return {ContentService} Risposta JSON con contatori\r\n */\r\nfunction sincronizzaClienti() {\r\n  try {\r\n    var ss = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);\r\n    var shP = ss.getSheetByName(CONFIG.SHEETS.PRENOTAZIONI);\r\n    var shC = ss.getSheetByName(CONFIG.SHEETS.CLIENTI);\r\n    \r\n    if (!shP || !shC) {\r\n      return createJsonResponse({\r\n        success: false,\r\n        message: 'Foglio PRENOTAZIONI o CLIENTI non trovato'\r\n      }, 500);\r\n    }\r\n    \r\n    var pVals = shP.getDataRange().getValues();\r\n    var cVals = shC.getDataRange().getValues();\r\n    var idxByCF = {};\r\n    \r\n    // Mappa clienti esistenti per CF\r\n    for (var i = 1; i < cVals.length; i++) {\r\n      var cf = String(cVals[i][CONFIG.CLIENTI_COLS.CODICE_FISCALE - 1] || '').trim();\r\n      if (cf) idxByCF[cf] = i + 1;\r\n    }\r\n    \r\n    var created = 0;\r\n    var updated = 0;\r\n    var skipped = 0;\r\n    \r\n  function upsertCliente(data, isPrimary) {\n      var cf = String(data.codiceFiscale || '').trim();\r\n      if (!cf || cf.length !== 16) {\r\n        skipped++;\r\n        return;\r\n      }\r\n      \r\n      var rowIndex = idxByCF[cf];\r\n      \r\n      function updateCell(colKey, val) {\n        if (val !== undefined && val !== null && val !== '') {\n          shC.getRange(rowIndex, CONFIG.CLIENTI_COLS[colKey]).setValue(val);\n        }\n      }\n      \r\n      if (!rowIndex) {\n        // Crea nuovo cliente\n        var row = new Array(Object.keys(CONFIG.CLIENTI_COLS).length);\r\n        for (var k = 0; k < row.length; k++) row[k] = '';\r\n        \r\n        row[CONFIG.CLIENTI_COLS.NOME - 1] = data.nomeCompleto || data.nome || '';\r\n        row[CONFIG.CLIENTI_COLS.DATA_NASCITA - 1] = data.dataNascita || '';\r\n        row[CONFIG.CLIENTI_COLS.LUOGO_NASCITA - 1] = data.luogoNascita || '';\r\n        row[CONFIG.CLIENTI_COLS.CODICE_FISCALE - 1] = cf;\r\n        row[CONFIG.CLIENTI_COLS.COMUNE_RESIDENZA - 1] = data.comuneResidenza || '';\r\n        row[CONFIG.CLIENTI_COLS.VIA_RESIDENZA - 1] = data.viaResidenza || '';\r\n        row[CONFIG.CLIENTI_COLS.CIVICO_RESIDENZA - 1] = data.civicoResidenza || '';\r\n        row[CONFIG.CLIENTI_COLS.NUMERO_PATENTE - 1] = data.numeroPatente || '';\r\n        row[CONFIG.CLIENTI_COLS.DATA_INIZIO_PATENTE - 1] = data.inizioValiditaPatente || data.dataInizioPatente || '';\r\n        row[CONFIG.CLIENTI_COLS.SCADENZA_PATENTE - 1] = data.scadenzaPatente || '';\r\n        \r\n        if (isPrimary) {\r\n          row[CONFIG.CLIENTI_COLS.CELLULARE - 1] = data.cellulare || '';\r\n          row[CONFIG.CLIENTI_COLS.EMAIL - 1] = data.email || '';\r\n        }\r\n        \r\n        shC.appendRow(row);\n        var last = shC.getLastRow();\n        idxByCF[cf] = last;\n        created++;\n      } else {\n        // Aggiorna cliente esistente\n        updateCell('NOME', data.nomeCompleto || data.nome || '');\r\n        updateCell('DATA_NASCITA', data.dataNascita || '');\r\n        updateCell('LUOGO_NASCITA', data.luogoNascita || '');\r\n        updateCell('COMUNE_RESIDENZA', data.comuneResidenza || '');\r\n        updateCell('VIA_RESIDENZA', data.viaResidenza || '');\r\n        updateCell('CIVICO_RESIDENZA', data.civicoResidenza || '');\r\n        updateCell('NUMERO_PATENTE', data.numeroPatente || '');\r\n        updateCell('DATA_INIZIO_PATENTE', data.inizioValiditaPatente || data.dataInizioPatente || '');\r\n        updateCell('SCADENZA_PATENTE', data.scadenzaPatente || '');\r\n        \r\n        if (isPrimary) {\r\n          updateCell('CELLULARE', data.cellulare || '');\r\n          updateCell('EMAIL', data.email || '');\r\n        }\r\n        updated++;\r\n      }\r\n    }\r\n    \r\n    // Processa tutte le prenotazioni\r\n    for (var r = 1; r < pVals.length; r++) {\r\n      var row = pVals[r];\r\n      \r\n      // Autista 1\r\n      var a1 = {\r\n        nomeCompleto: row[CONFIG.PRENOTAZIONI_COLS.NOME_AUTISTA_1 - 1] || '',\r\n        dataNascita: row[CONFIG.PRENOTAZIONI_COLS.DATA_NASCITA_AUTISTA_1 - 1] || '',\r\n        luogoNascita: row[CONFIG.PRENOTAZIONI_COLS.LUOGO_NASCITA_AUTISTA_1 - 1] || '',\r\n        codiceFiscale: row[CONFIG.PRENOTAZIONI_COLS.CODICE_FISCALE_AUTISTA_1 - 1] || '',\r\n        comuneResidenza: row[CONFIG.PRENOTAZIONI_COLS.COMUNE_RESIDENZA_AUTISTA_1 - 1] || '',\r\n        viaResidenza: row[CONFIG.PRENOTAZIONI_COLS.VIA_RESIDENZA_AUTISTA_1 - 1] || '',\r\n        civicoResidenza: row[CONFIG.PRENOTAZIONI_COLS.CIVICO_RESIDENZA_AUTISTA_1 - 1] || '',\r\n        numeroPatente: row[CONFIG.PRENOTAZIONI_COLS.NUMERO_PATENTE_AUTISTA_1 - 1] || '',\r\n        inizioValiditaPatente: row[CONFIG.PRENOTAZIONI_COLS.DATA_INIZIO_PATENTE_AUTISTA_1 - 1] || '',\r\n        scadenzaPatente: row[CONFIG.PRENOTAZIONI_COLS.SCADENZA_PATENTE_AUTISTA_1 - 1] || '',\r\n        cellulare: row[CONFIG.PRENOTAZIONI_COLS.CELLULARE - 1] || '',\r\n        email: row[CONFIG.PRENOTAZIONI_COLS.EMAIL - 1] || ''\r\n      };\r\n      \r\n      // Autista 2\r\n      var a2 = {\r\n        nomeCompleto: row[CONFIG.PRENOTAZIONI_COLS.NOME_AUTISTA_2 - 1] || '',\r\n        dataNascita: row[CONFIG.PRENOTAZIONI_COLS.DATA_NASCITA_AUTISTA_2 - 1] || '',\r\n        luogoNascita: row[CONFIG.PRENOTAZIONI_COLS.LUOGO_NASCITA_AUTISTA_2 - 1] || '',\r\n        codiceFiscale: row[CONFIG.PRENOTAZIONI_COLS.CODICE_FISCALE_AUTISTA_2 - 1] || '',\r\n        comuneResidenza: row[CONFIG.PRENOTAZIONI_COLS.COMUNE_RESIDENZA_AUTISTA_2 - 1] || '',\r\n        viaResidenza: row[CONFIG.PRENOTAZIONI_COLS.VIA_RESIDENZA_AUTISTA_2 - 1] || '',\r\n        civicoResidenza: row[CONFIG.PRENOTAZIONI_COLS.CIVICO_RESIDENZA_AUTISTA_2 - 1] || '',\r\n        numeroPatente: row[CONFIG.PRENOTAZIONI_COLS.NUMERO_PATENTE_AUTISTA_2 - 1] || '',\r\n        inizioValiditaPatente: row[CONFIG.PRENOTAZIONI_COLS.DATA_INIZIO_PATENTE_AUTISTA_2 - 1] || '',\r\n        scadenzaPatente: row[CONFIG.PRENOTAZIONI_COLS.SCADENZA_PATENTE_AUTISTA_2 - 1] || ''\r\n      };\r\n      \r\n      // Autista 3\r\n      var a3 = {\r\n        nomeCompleto: row[CONFIG.PRENOTAZIONI_COLS.NOME_AUTISTA_3 - 1] || '',\r\n        dataNascita: row[CONFIG.PRENOTAZIONI_COLS.DATA_NASCITA_AUTISTA_3 - 1] || '',\r\n        luogoNascita: row[CONFIG.PRENOTAZIONI_COLS.LUOGO_NASCITA_AUTISTA_3 - 1] || '',\r\n        codiceFiscale: row[CONFIG.PRENOTAZIONI_COLS.CODICE_FISCALE_AUTISTA_3 - 1] || '',\r\n        comuneResidenza: row[CONFIG.PRENOTAZIONI_COLS.COMUNE_RESIDENZA_AUTISTA_3 - 1] || '',\r\n        viaResidenza: row[CONFIG.PRENOTAZIONI_COLS.VIA_RESIDENZA_AUTISTA_3 - 1] || '',\r\n        civicoResidenza: row[CONFIG.PRENOTAZIONI_COLS.CIVICO_RESIDENZA_AUTISTA_3 - 1] || '',\r\n        numeroPatente: row[CONFIG.PRENOTAZIONI_COLS.NUMERO_PATENTE_AUTISTA_3 - 1] || '',\r\n        inizioValiditaPatente: row[CONFIG.PRENOTAZIONI_COLS.DATA_INIZIO_PATENTE_AUTISTA_3 - 1] || '',\r\n        scadenzaPatente: row[CONFIG.PRENOTAZIONI_COLS.SCADENZA_PATENTE_AUTISTA_3 - 1] || ''\r\n      };\r\n      \r\n      if (a1.codiceFiscale) upsertCliente(a1, true);\r\n      if (a2.codiceFiscale) upsertCliente(a2, false);\r\n      if (a3.codiceFiscale) upsertCliente(a3, false);\r\n    }\r\n    \r\n    invalidateIndex('CLIENTI');\n    return createJsonResponse({\n      success: true,\n      message: 'Sincronizzazione CLIENTI completata',\n      created: created,\n      updated: updated,\n      skipped: skipped\n    });\n  } catch(err) {\r\n    return createJsonResponse({\r\n      success: false,\r\n      message: 'Errore sincronizzaClienti: ' + err.message\r\n    }, 500);\r\n  }\r\n}\r\n\r\n/**\r\n * Upsert cliente durante creazione prenotazione\r\n * @param {Object} cliente - Dati cliente\r\n * @param {boolean} isPrimary - Se è autista principale (con email/cell)\r\n */\r\nfunction upsertClienteInCreaPrenotazione(cliente, isPrimary) {\n  var ss = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);\n  var shC = ss.getSheetByName(CONFIG.SHEETS.CLIENTI);\n  var cf = String(cliente.codiceFiscale || '').trim();\n  \r\n  if (!cf || cf.length !== 16) return;\r\n  \r\n  var vals = shC.getDataRange().getValues();\r\n  var idx = -1;\r\n  \r\n  for (var i = 1; i < vals.length; i++) {\r\n    if (String(vals[i][CONFIG.CLIENTI_COLS.CODICE_FISCALE - 1]).trim() === cf) {\r\n      idx = i;\r\n      break;\r\n    }\r\n  }\r\n  \r\n  function setValue(colKey, val) {\r\n    if (val !== undefined && val !== null && val !== '') {\r\n      if (idx > 0) {\r\n        shC.getRange(idx + 1, CONFIG.CLIENTI_COLS[colKey]).setValue(val);\r\n      } else {\r\n        return val;\r\n      }\r\n    }\r\n    return '';\r\n  }\r\n  \r\n  if (idx === -1) {\n    // Crea nuovo\n    var newRow = new Array(Object.keys(CONFIG.CLIENTI_COLS).length);\r\n    for (var k = 0; k < newRow.length; k++) newRow[k] = '';\r\n    \r\n    newRow[CONFIG.CLIENTI_COLS.NOME - 1] = cliente.nomeCompleto || cliente.nome || '';\r\n    newRow[CONFIG.CLIENTI_COLS.DATA_NASCITA - 1] = cliente.dataNascita || '';\r\n    newRow[CONFIG.CLIENTI_COLS.LUOGO_NASCITA - 1] = cliente.luogoNascita || '';\r\n    newRow[CONFIG.CLIENTI_COLS.CODICE_FISCALE - 1] = cf;\r\n    newRow[CONFIG.CLIENTI_COLS.COMUNE_RESIDENZA - 1] = cliente.comuneResidenza || '';\r\n    newRow[CONFIG.CLIENTI_COLS.VIA_RESIDENZA - 1] = cliente.viaResidenza || '';\r\n    newRow[CONFIG.CLIENTI_COLS.CIVICO_RESIDENZA - 1] = cliente.civicoResidenza || '';\r\n    newRow[CONFIG.CLIENTI_COLS.NUMERO_PATENTE - 1] = cliente.numeroPatente || '';\r\n    newRow[CONFIG.CLIENTI_COLS.DATA_INIZIO_PATENTE - 1] = cliente.inizioValiditaPatente || cliente.dataInizioPatente || '';\r\n    newRow[CONFIG.CLIENTI_COLS.SCADENZA_PATENTE - 1] = cliente.scadenzaPatente || '';\r\n    \r\n    if (isPrimary) {\r\n      newRow[CONFIG.CLIENTI_COLS.CELLULARE - 1] = cliente.cellulare || '';\r\n      newRow[CONFIG.CLIENTI_COLS.EMAIL - 1] = cliente.email || '';\r\n    }\r\n    \r\n    shC.appendRow(newRow);\n    invalidateIndex('CLIENTI');\n  } else {\n    // Aggiorna esistente\n    setValue('NOME', cliente.nomeCompleto || cliente.nome);\r\n    setValue('DATA_NASCITA', cliente.dataNascita);\r\n    setValue('LUOGO_NASCITA', cliente.luogoNascita);\r\n    setValue('COMUNE_RESIDENZA', cliente.comuneResidenza);\r\n    setValue('VIA_RESIDENZA', cliente.viaResidenza);\r\n    setValue('CIVICO_RESIDENZA', cliente.civicoResidenza);\r\n    setValue('NUMERO_PATENTE', cliente.numeroPatente);\r\n    setValue('DATA_INIZIO_PATENTE', cliente.inizioValiditaPatente || cliente.dataInizioPatente);\r\n    setValue('SCADENZA_PATENTE', cliente.scadenzaPatente);\r\n    \r\n    if (isPrimary) {\r\n      setValue('CELLULARE', cliente.cellulare);\r\n      setValue('EMAIL', cliente.email);\r\n    }\r\n  }\n}\n\n/**\n * Crea un nuovo cliente nel foglio CLIENTI\n * @param {Object} post - Dati cliente con codiceFiscale obbligatorio (16 caratteri)\n * @return {ContentService} Risposta JSON\n */\nfunction creaCliente(post) {\n  try {\n    var cf = (post.codiceFiscale || '').trim();\n    if (!cf || cf.length !== 16) {\n      return createJsonResponse({\n        success: false,\n        message: 'Codice fiscale non valido'\n      }, 400);\n    }\n    var ss = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);\n    var sh = ss.getSheetByName(CONFIG.SHEETS.CLIENTI);\n    if (!sh) {\n      return createJsonResponse({ success: false, message: 'Foglio CLIENTI non trovato' }, 500);\n    }\n    var vals = sh.getDataRange().getValues();\n    for (var i = 1; i < vals.length; i++) {\n      if (String(vals[i][CONFIG.CLIENTI_COLS.CODICE_FISCALE - 1]).trim() === cf) {\n        return createJsonResponse({\n          success: false,\n          message: 'Cliente già esistente',\n          codiceFiscale: cf\n        }, 409);\n      }\n    }\n\n    var row = new Array(Object.keys(CONFIG.CLIENTI_COLS).length);\n    for (var k = 0; k < row.length; k++) row[k] = '';\n\n    row[CONFIG.CLIENTI_COLS.NOME - 1] = sanitizeSheetValue(post.nomeCompleto || post.nome || '');\n    row[CONFIG.CLIENTI_COLS.DATA_NASCITA - 1] = post.dataNascita || '';\n    row[CONFIG.CLIENTI_COLS.LUOGO_NASCITA - 1] = sanitizeSheetValue(post.luogoNascita || '');\n    row[CONFIG.CLIENTI_COLS.CODICE_FISCALE - 1] = sanitizeSheetValue(cf);\n    row[CONFIG.CLIENTI_COLS.COMUNE_RESIDENZA - 1] = sanitizeSheetValue(post.comuneResidenza || '');\n    row[CONFIG.CLIENTI_COLS.VIA_RESIDENZA - 1] = sanitizeSheetValue(post.viaResidenza || '');\n    row[CONFIG.CLIENTI_COLS.CIVICO_RESIDENZA - 1] = sanitizeSheetValue(post.civicoResidenza || '');\n    row[CONFIG.CLIENTI_COLS.NUMERO_PATENTE - 1] = sanitizeSheetValue(post.numeroPatente || '');\n    row[CONFIG.CLIENTI_COLS.DATA_INIZIO_PATENTE - 1] = post.inizioValiditaPatente || post.dataInizioPatente || '';\n    row[CONFIG.CLIENTI_COLS.SCADENZA_PATENTE - 1] = post.scadenzaPatente || '';\n    row[CONFIG.CLIENTI_COLS.CELLULARE - 1] = sanitizeSheetValue(post.cellulare || '');\n    row[CONFIG.CLIENTI_COLS.EMAIL - 1] = sanitizeSheetValue(post.email || '');\n\n    sh.appendRow(row);\n    invalidateIndex('CLIENTI');\n\n    return createJsonResponse({\n      success: true,\n      message: 'Cliente creato',\n      codiceFiscale: cf\n    });\n  } catch(err) {\n    return createJsonResponse({\n      success: false,\n      message: 'Errore creazione cliente: ' + err.message\n    }, 500);\n  }\n}\n\n/**\n * Recupera i dettagli completi di un cliente dal foglio CLIENTI dato il CF.\n * @param {Object} post - { codiceFiscale }\n * @return {ContentService} Risposta JSON con data\n */\nfunction getCliente(post) {\n  try {\n    var cf = (post && (post.codiceFiscale || post.cf || post.CODICE_FISCALE)) || '';\n    cf = String(cf).trim().toUpperCase();\n    if (!cf || cf.length < 6) {\n      return createJsonResponse({ success: false, message: 'Codice fiscale mancante o non valido' }, 400);\n    }\n\n    var ss = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);\n    var sheet = ss.getSheetByName(CONFIG.SHEETS.CLIENTI);\n    if (!sheet) {\n      return createJsonResponse({ success: false, message: 'Foglio CLIENTI non trovato' }, 500);\n    }\n\n    var C = CONFIG.CLIENTI_COLS;\n    var idxRow = clientRowIndexByCF(cf);\n    \n    if (idxRow === -1) {\n      return createJsonResponse({ success: false, message: 'Cliente non trovato per CF: ' + cf }, 404);\n    }\n    var lastCol = sheet.getLastColumn();\n    var row = sheet.getRange(idxRow, 1, 1, lastCol).getValues()[0];\n    function val(colKey) { return (C[colKey] ? row[C[colKey] - 1] : '') || ''; }\n    function fmtDate(v) { try { return DateUtils.formatDateToItalian(v); } catch(e) { return ''; } }\n\n    var nomeCell = String(val('NOME') || '').trim();\n    var telefonoCell = String(val('CELLULARE') || val('TELEFONO') || '').trim();\n\n    var dataNascitaRaw = val('DATA_NASCITA');\n    var inizioPatenteRaw = val('DATA_INIZIO_PATENTE');\n    var scadenzaPatenteRaw = val('SCADENZA_PATENTE');\n\n    // Prova a leggere eventuale colonna opzionale 'INDIRIZZO' se presente come header\n    var indirizzoFull = '';\n    try {\n      var headers = values[0];\n      var idxIndirizzo = -1;\n      for (var h = 0; h < headers.length; h++) {\n        var name = String(headers[h]).trim().toUpperCase();\n        if (name === 'INDIRIZZO') { idxIndirizzo = h; break; }\n      }\n      if (idxIndirizzo >= 0) indirizzoFull = String(row[idxIndirizzo] || '').trim();\n    } catch(_){ }\n\n    var resp = {\n      codiceFiscale: cf,\n      nome: nomeCell || '',\n      cognome: '',\n      nomeCompleto: nomeCell || '',\n      email: String(val('EMAIL') || '').trim(),\n      cellulare: telefonoCell || '',\n      telefono: telefonoCell || '',\n      indirizzo: indirizzoFull,\n      comuneResidenza: String(val('COMUNE_RESIDENZA') || '').trim(),\n      viaResidenza: String(val('VIA_RESIDENZA') || '').trim(),\n      civicoResidenza: String(val('CIVICO_RESIDENZA') || '').trim(),\n      dataNascita: dataNascitaRaw || '',\n      dataNascitaFormatted: fmtDate(dataNascitaRaw),\n      luogoNascita: String(val('LUOGO_NASCITA') || '').trim(),\n      numeroPatente: String(val('NUMERO_PATENTE') || '').trim(),\n      inizioValiditaPatente: inizioPatenteRaw || '',\n      inizioValiditaPatenteFormatted: fmtDate(inizioPatenteRaw),\n      scadenzaPatente: scadenzaPatenteRaw || '',\n      scadenzaPatenteFormatted: fmtDate(scadenzaPatenteRaw)\n    };\n\n    return createJsonResponse({ success: true, data: resp });\n  } catch(err) {\n    return createJsonResponse({ success: false, message: 'Errore getCliente: ' + err.message }, 500);\n  }\n}\n\n/**\n * Login utente tramite Codice Fiscale\n * @param {Object} post - { codiceFiscale }\n * @return {ContentService} Risposta JSON con user oppure errore\n */\nfunction login(post){\n  try{\n    var cf = String((post && (post.codiceFiscale||post.cf)) || '').trim().toUpperCase();\n    if (!post || (!post.codiceFiscale && !post.cf)){\n      return createJsonResponse({ success:false, message:'Dati di login incompleti', errorCode:'MISSING_DATA' }, 400);\n    }\n    if (cf.length !== 16){\n      return createJsonResponse({ success:false, message:'Formato codice fiscale non valido', errorCode:'INVALID_CF_FORMAT' }, 400);\n    }\n    var ss = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);\n    var sheet = ss.getSheetByName(CONFIG.SHEETS.CLIENTI);\n    if (!sheet){\n      return createJsonResponse({ success:false, message:'Foglio CLIENTI non trovato', errorCode:'DB_ERROR' }, 500);\n    }\n    var C = CONFIG.CLIENTI_COLS;\n    var idx = clientRowIndexByCF(cf);\n    if (idx === -1){\n      return createJsonResponse({ success:false, message:'Codice fiscale non registrato', errorCode:'USER_NOT_FOUND', requiresRegistration:true, remainingAttempts:0 }, 404);\n    }\n    var lastCol = sheet.getLastColumn();\n    var row = sheet.getRange(idx, 1, 1, lastCol).getValues()[0];\n    function val(colKey){ return (C[colKey] ? row[C[colKey]-1] : '') || ''; }\n    var user = {\n      codiceFiscale: cf,\n      nome: String(val('NOME')||'').trim(),\n      email: String(val('EMAIL')||'').trim(),\n      cellulare: String(val('CELLULARE')||'').trim(),\n      comuneResidenza: String(val('COMUNE_RESIDENZA')||'').trim(),\n      viaResidenza: String(val('VIA_RESIDENZA')||'').trim(),\n      civicoResidenza: String(val('CIVICO_RESIDENZA')||'').trim(),\n      numeroPatente: String(val('NUMERO_PATENTE')||'').trim(),\n      dataNascita: val('DATA_NASCITA')||'',\n      inizioValiditaPatente: val('DATA_INIZIO_PATENTE')||'',\n      scadenzaPatente: val('SCADENZA_PATENTE')||''\n    };\n    var exp = nowSec() + (CONFIG && CONFIG.SECURITY ? (CONFIG.SECURITY.SESSION_TTL_MINUTES||1440)*60 : 86400);\n    var payload = { cf: cf, role: 'user', exp: exp, iat: nowSec() };\n    var jwt = createJWT(payload);\n    var csrfToken = generateCSRFToken(jwt);\n    return createJsonResponse({ success:true, user:user, token: jwt, csrfToken: csrfToken, exp: new Date(exp*1000).toISOString() });\n  }catch(err){\n    return createJsonResponse({ success:false, message:'Errore login: ' + err.message, errorCode:'GENERIC_ERROR' }, 500);\n  }\n}\n",
      "size": 20369,
      "lines": 486
    },
    "backend/PrenotazioniService.gs": {
      "content": "/**\r\n * SERVIZIO GESTIONE PRENOTAZIONI\r\n * \r\n * Gestisce CRUD prenotazioni, stati, ID booking\r\n */\r\n\r\n/**\r\n * Recupera tutte le prenotazioni con dati completi e date formattate\r\n * @return {ContentService} Risposta JSON con lista prenotazioni\r\n */\r\nfunction getPrenotazioni() {\n  dbg('[getPrenotazioni] Chiamata ricevuta');\n  \r\n    \r\n    var sh = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID)\r\n      .getSheetByName('PRENOTAZIONI');\r\n    \r\n    if (!sh) {\n      dbg('[getPrenotazioni] Foglio PRENOTAZIONI non trovato');\n      return createJsonResponse({\n        success: false,\n        message: 'Foglio PRENOTAZIONI non trovato'\n      }, 500);\n    }\n    \r\n    var data = sh.getDataRange().getValues();\r\n    \r\n    if (data.length <= 1) {\n      dbg('[getPrenotazioni] Nessuna prenotazione trovata');\n      return createJsonResponse({\n        success: true,\n        message: 'Nessuna prenotazione trovata',\n        data: []\n      });\n    }\n    \r\n    var out = [];\r\n    for (var i = 1; i < data.length; i++) {\r\n      var r = data[i];\r\n      var t = r[CONFIG.PRENOTAZIONI_COLS.TARGA - 1];\n      var cf = r[CONFIG.PRENOTAZIONI_COLS.CODICE_FISCALE_AUTISTA_1 - 1];\n      var statoRow = String(r[CONFIG.PRENOTAZIONI_COLS.STATO_PRENOTAZIONE - 1] || '').trim().toLowerCase();\n      \n      \r\n      out.push({\r\n        id: i,\r\n        targa: t || '',\r\n        \r\n        // 📅 DATE NOLEGGIO\r\n        giornoInizio: r[CONFIG.PRENOTAZIONI_COLS.GIORNO_INIZIO - 1] || '',\r\n        giornoInizioFormatted: formatDateToItalian(r[CONFIG.PRENOTAZIONI_COLS.GIORNO_INIZIO - 1]),\r\n        giornoFine: r[CONFIG.PRENOTAZIONI_COLS.GIORNO_FINE - 1] || '',\r\n        giornoFineFormatted: formatDateToItalian(r[CONFIG.PRENOTAZIONI_COLS.GIORNO_FINE - 1]),\r\n        oraInizio: r[CONFIG.PRENOTAZIONI_COLS.ORA_INIZIO - 1] || '',\r\n        oraFine: r[CONFIG.PRENOTAZIONI_COLS.ORA_FINE - 1] || '',\r\n        destinazione: r[CONFIG.PRENOTAZIONI_COLS.DESTINAZIONE - 1] || '',\r\n        dataContratto: r[CONFIG.PRENOTAZIONI_COLS.DATA_CONTRATTO - 1] || '',\r\n        dataContrattoFormatted: formatDateToItalian(r[CONFIG.PRENOTAZIONI_COLS.DATA_CONTRATTO - 1]),\r\n        \r\n        // 👤 AUTISTA 1 - COMPLETO\r\n        nomeAutista1: r[CONFIG.PRENOTAZIONI_COLS.NOME_AUTISTA_1 - 1] || '',\r\n        codiceFiscaleAutista1: cf || '',\r\n        dataNascitaAutista1: r[CONFIG.PRENOTAZIONI_COLS.DATA_NASCITA_AUTISTA_1 - 1] || '',\r\n        dataNascitaAutista1Formatted: formatDateToItalian(r[CONFIG.PRENOTAZIONI_COLS.DATA_NASCITA_AUTISTA_1 - 1]),\r\n        luogoNascitaAutista1: r[CONFIG.PRENOTAZIONI_COLS.LUOGO_NASCITA_AUTISTA_1 - 1] || '',\r\n        comuneResidenzaAutista1: r[CONFIG.PRENOTAZIONI_COLS.COMUNE_RESIDENZA_AUTISTA_1 - 1] || '',\r\n        viaResidenzaAutista1: r[CONFIG.PRENOTAZIONI_COLS.VIA_RESIDENZA_AUTISTA_1 - 1] || '',\r\n        civicoResidenzaAutista1: r[CONFIG.PRENOTAZIONI_COLS.CIVICO_RESIDENZA_AUTISTA_1 - 1] || '',\r\n        numeroPatenteAutista1: r[CONFIG.PRENOTAZIONI_COLS.NUMERO_PATENTE_AUTISTA_1 - 1] || '',\r\n        dataInizioPatenteAutista1: r[CONFIG.PRENOTAZIONI_COLS.DATA_INIZIO_PATENTE_AUTISTA_1 - 1] || '',\r\n        dataInizioPatenteAutista1Formatted: formatDateToItalian(r[CONFIG.PRENOTAZIONI_COLS.DATA_INIZIO_PATENTE_AUTISTA_1 - 1]),\r\n        scadenzaPatenteAutista1: r[CONFIG.PRENOTAZIONI_COLS.SCADENZA_PATENTE_AUTISTA_1 - 1] || '',\r\n        scadenzaPatenteAutista1Formatted: formatDateToItalian(r[CONFIG.PRENOTAZIONI_COLS.SCADENZA_PATENTE_AUTISTA_1 - 1]),\r\n        \r\n        // 👤 AUTISTA 2 - COMPLETO\r\n        nomeAutista2: r[CONFIG.PRENOTAZIONI_COLS.NOME_AUTISTA_2 - 1] || '',\r\n        codiceFiscaleAutista2: r[CONFIG.PRENOTAZIONI_COLS.CODICE_FISCALE_AUTISTA_2 - 1] || '',\r\n        dataNascitaAutista2: r[CONFIG.PRENOTAZIONI_COLS.DATA_NASCITA_AUTISTA_2 - 1] || '',\r\n        dataNascitaAutista2Formatted: formatDateToItalian(r[CONFIG.PRENOTAZIONI_COLS.DATA_NASCITA_AUTISTA_2 - 1]),\r\n        luogoNascitaAutista2: r[CONFIG.PRENOTAZIONI_COLS.LUOGO_NASCITA_AUTISTA_2 - 1] || '',\r\n        comuneResidenzaAutista2: r[CONFIG.PRENOTAZIONI_COLS.COMUNE_RESIDENZA_AUTISTA_2 - 1] || '',\r\n        viaResidenzaAutista2: r[CONFIG.PRENOTAZIONI_COLS.VIA_RESIDENZA_AUTISTA_2 - 1] || '',\r\n        civicoResidenzaAutista2: r[CONFIG.PRENOTAZIONI_COLS.CIVICO_RESIDENZA_AUTISTA_2 - 1] || '',\r\n        numeroPatenteAutista2: r[CONFIG.PRENOTAZIONI_COLS.NUMERO_PATENTE_AUTISTA_2 - 1] || '',\r\n        dataInizioPatenteAutista2: r[CONFIG.PRENOTAZIONI_COLS.DATA_INIZIO_PATENTE_AUTISTA_2 - 1] || '',\r\n        dataInizioPatenteAutista2Formatted: formatDateToItalian(r[CONFIG.PRENOTAZIONI_COLS.DATA_INIZIO_PATENTE_AUTISTA_2 - 1]),\r\n        scadenzaPatenteAutista2: r[CONFIG.PRENOTAZIONI_COLS.SCADENZA_PATENTE_AUTISTA_2 - 1] || '',\r\n        scadenzaPatenteAutista2Formatted: formatDateToItalian(r[CONFIG.PRENOTAZIONI_COLS.SCADENZA_PATENTE_AUTISTA_2 - 1]),\r\n        \r\n        // 👤 AUTISTA 3 - COMPLETO\r\n        nomeAutista3: r[CONFIG.PRENOTAZIONI_COLS.NOME_AUTISTA_3 - 1] || '',\r\n        codiceFiscaleAutista3: r[CONFIG.PRENOTAZIONI_COLS.CODICE_FISCALE_AUTISTA_3 - 1] || '',\r\n        dataNascitaAutista3: r[CONFIG.PRENOTAZIONI_COLS.DATA_NASCITA_AUTISTA_3 - 1] || '',\r\n        dataNascitaAutista3Formatted: formatDateToItalian(r[CONFIG.PRENOTAZIONI_COLS.DATA_NASCITA_AUTISTA_3 - 1]),\r\n        luogoNascitaAutista3: r[CONFIG.PRENOTAZIONI_COLS.LUOGO_NASCITA_AUTISTA_3 - 1] || '',\r\n        comuneResidenzaAutista3: r[CONFIG.PRENOTAZIONI_COLS.COMUNE_RESIDENZA_AUTISTA_3 - 1] || '',\r\n        viaResidenzaAutista3: r[CONFIG.PRENOTAZIONI_COLS.VIA_RESIDENZA_AUTISTA_3 - 1] || '',\r\n        civicoResidenzaAutista3: r[CONFIG.PRENOTAZIONI_COLS.CIVICO_RESIDENZA_AUTISTA_3 - 1] || '',\r\n        numeroPatenteAutista3: r[CONFIG.PRENOTAZIONI_COLS.NUMERO_PATENTE_AUTISTA_3 - 1] || '',\r\n        dataInizioPatenteAutista3: r[CONFIG.PRENOTAZIONI_COLS.DATA_INIZIO_PATENTE_AUTISTA_3 - 1] || '',\r\n        dataInizioPatenteAutista3Formatted: formatDateToItalian(r[CONFIG.PRENOTAZIONI_COLS.DATA_INIZIO_PATENTE_AUTISTA_3 - 1]),\r\n        scadenzaPatenteAutista3: r[CONFIG.PRENOTAZIONI_COLS.SCADENZA_PATENTE_AUTISTA_3 - 1] || '',\r\n        scadenzaPatenteAutista3Formatted: formatDateToItalian(r[CONFIG.PRENOTAZIONI_COLS.SCADENZA_PATENTE_AUTISTA_3 - 1]),\r\n        \r\n        // 📋 ALTRI DATI\r\n        cellulare: r[CONFIG.PRENOTAZIONI_COLS.CELLULARE - 1] || '',\r\n        email: r[CONFIG.PRENOTAZIONI_COLS.EMAIL - 1] || '',\r\n        stato: r[CONFIG.PRENOTAZIONI_COLS.STATO_PRENOTAZIONE - 1] || 'In attesa',\r\n        importo: r[CONFIG.PRENOTAZIONI_COLS.IMPORTO_PREVENTIVO - 1] || '',\r\n        importoPreventivo: r[CONFIG.PRENOTAZIONI_COLS.IMPORTO_PREVENTIVO - 1] || '',\r\n        idPrenotazione: r[CONFIG.PRENOTAZIONI_COLS.ID_PRENOTAZIONE - 1] || '',\r\n        timestamp: r[CONFIG.PRENOTAZIONI_COLS.TIMESTAMP - 1] || '',\r\n        timestampFormatted: formatDateToItalian(r[CONFIG.PRENOTAZIONI_COLS.TIMESTAMP - 1]),\r\n        pdfUrl: r[CONFIG.PRENOTAZIONI_COLS.PDF_URL - 1] || ''\r\n      });\r\n    }\r\n    \r\n    dbg('[getPrenotazioni] Trovate ' + out.length + ' prenotazioni');\n    return createJsonResponse({\n      success: true,\n      message: 'Trovate ' + out.length + ' prenotazioni',\n      data: out,\n      count: out.length\n    });\n  } catch(err) {\n    dbg('[getPrenotazioni] Errore: ' + err.message);\n    return createJsonResponse({\n      success: false,\n      message: 'Errore caricamento prenotazioni: ' + err.message\n    }, 500);\n  }\n}\n\r\n/**\r\n * Crea nuova prenotazione\r\n * @param {Object} post - Dati prenotazione\r\n * @return {ContentService} Risposta JSON con ID generato\r\n */\r\nfunction creaPrenotazione(post) {\n    var sh = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID)\r\n    var sh = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID)\r\n      .getSheetByName(CONFIG.SHEETS.PRENOTAZIONI);\r\n    \r\n    var row = new Array(45);\r\n    for (var i = 0; i < 45; i++) {\r\n      row[i] = '';\r\n    }\r\n    \r\n    // Timestamp\r\n    row[CONFIG.PRENOTAZIONI_COLS.TIMESTAMP - 1] = new Date();\r\n    \r\n    // Autista 1\r\n    row[CONFIG.PRENOTAZIONI_COLS.NOME_AUTISTA_1 - 1] = post.autista1 && post.autista1.nomeCompleto ? post.autista1.nomeCompleto : (post.autista1 && post.autista1.nome ? post.autista1.nome : '');\r\n    // Normalizza le date autista 1 in oggetti Date per corretta formattazione nel foglio\r\n    row[CONFIG.PRENOTAZIONI_COLS.DATA_NASCITA_AUTISTA_1 - 1] = post.autista1 && post.autista1.dataNascita ? parseItalianOrISO(post.autista1.dataNascita) : '';\r\n    row[CONFIG.PRENOTAZIONI_COLS.LUOGO_NASCITA_AUTISTA_1 - 1] = post.autista1 && post.autista1.luogoNascita ? post.autista1.luogoNascita : '';\r\n    row[CONFIG.PRENOTAZIONI_COLS.CODICE_FISCALE_AUTISTA_1 - 1] = post.autista1 && post.autista1.codiceFiscale ? post.autista1.codiceFiscale : '';\r\n    row[CONFIG.PRENOTAZIONI_COLS.COMUNE_RESIDENZA_AUTISTA_1 - 1] = post.autista1 && post.autista1.comuneResidenza ? post.autista1.comuneResidenza : '';\r\n    row[CONFIG.PRENOTAZIONI_COLS.VIA_RESIDENZA_AUTISTA_1 - 1] = post.autista1 && post.autista1.viaResidenza ? post.autista1.viaResidenza : '';\r\n    row[CONFIG.PRENOTAZIONI_COLS.CIVICO_RESIDENZA_AUTISTA_1 - 1] = post.autista1 && post.autista1.civicoResidenza ? post.autista1.civicoResidenza : '';\r\n    row[CONFIG.PRENOTAZIONI_COLS.NUMERO_PATENTE_AUTISTA_1 - 1] = post.autista1 && post.autista1.numeroPatente ? post.autista1.numeroPatente : '';\r\n    row[CONFIG.PRENOTAZIONI_COLS.DATA_INIZIO_PATENTE_AUTISTA_1 - 1] = post.autista1 && (post.autista1.inizioValiditaPatente || post.autista1.dataInizioPatente) ? parseItalianOrISO(post.autista1.inizioValiditaPatente || post.autista1.dataInizioPatente) : '';\r\n    row[CONFIG.PRENOTAZIONI_COLS.SCADENZA_PATENTE_AUTISTA_1 - 1] = post.autista1 && post.autista1.scadenzaPatente ? parseItalianOrISO(post.autista1.scadenzaPatente) : '';\r\n    \r\n    // Dati noleggio\r\n    row[CONFIG.PRENOTAZIONI_COLS.TARGA - 1] = post.targa || '';\r\n    row[CONFIG.PRENOTAZIONI_COLS.ORA_INIZIO - 1] = post.oraInizio || '';\r\n    row[CONFIG.PRENOTAZIONI_COLS.ORA_FINE - 1] = post.oraFine || '';\r\n    row[CONFIG.PRENOTAZIONI_COLS.GIORNO_INIZIO - 1] = post.giornoInizio ? parseItalianOrISO(post.giornoInizio) : '';\r\n    row[CONFIG.PRENOTAZIONI_COLS.GIORNO_FINE - 1] = post.giornoFine ? parseItalianOrISO(post.giornoFine) : '';\r\n    row[CONFIG.PRENOTAZIONI_COLS.DESTINAZIONE - 1] = post.destinazione || '';\r\n    // Accetta sia 'cellulare' che 'cell' dal payload autista1, con fallback a post.cellulare\r\n    row[CONFIG.PRENOTAZIONI_COLS.CELLULARE - 1] = (post.autista1 && (post.autista1.cellulare || post.autista1.cell)) ? (post.autista1.cellulare || post.autista1.cell) : (post.cellulare || '');\r\n    row[CONFIG.PRENOTAZIONI_COLS.DATA_CONTRATTO - 1] = post.giornoInizio ? parseItalianOrISO(post.giornoInizio) : '';\r\n    row[CONFIG.PRENOTAZIONI_COLS.EMAIL - 1] = post.email || '';\r\n    row[CONFIG.PRENOTAZIONI_COLS.STATO_PRENOTAZIONE - 1] = 'In attesa';\r\n    row[CONFIG.PRENOTAZIONI_COLS.IMPORTO_PREVENTIVO - 1] = post.importo || 0;\r\n    \r\n    // Autista 2 (opzionale)\r\n    if (post.autista2) {\r\n      row[CONFIG.PRENOTAZIONI_COLS.NOME_AUTISTA_2 - 1] = post.autista2.nomeCompleto || post.autista2.nome || '';\r\n      row[CONFIG.PRENOTAZIONI_COLS.DATA_NASCITA_AUTISTA_2 - 1] = post.autista2.dataNascita ? parseItalianOrISO(post.autista2.dataNascita) : '';\r\n      row[CONFIG.PRENOTAZIONI_COLS.LUOGO_NASCITA_AUTISTA_2 - 1] = post.autista2.luogoNascita || '';\r\n      row[CONFIG.PRENOTAZIONI_COLS.CODICE_FISCALE_AUTISTA_2 - 1] = post.autista2.codiceFiscale || '';\r\n      row[CONFIG.PRENOTAZIONI_COLS.COMUNE_RESIDENZA_AUTISTA_2 - 1] = post.autista2.comuneResidenza || '';\r\n      row[CONFIG.PRENOTAZIONI_COLS.VIA_RESIDENZA_AUTISTA_2 - 1] = post.autista2.viaResidenza || '';\r\n      row[CONFIG.PRENOTAZIONI_COLS.CIVICO_RESIDENZA_AUTISTA_2 - 1] = post.autista2.civicoResidenza || '';\r\n      row[CONFIG.PRENOTAZIONI_COLS.NUMERO_PATENTE_AUTISTA_2 - 1] = post.autista2.numeroPatente || '';\r\n      row[CONFIG.PRENOTAZIONI_COLS.DATA_INIZIO_PATENTE_AUTISTA_2 - 1] = (post.autista2.inizioValiditaPatente || post.autista2.dataInizioPatente) ? parseItalianOrISO(post.autista2.inizioValiditaPatente || post.autista2.dataInizioPatente) : '';\r\n      row[CONFIG.PRENOTAZIONI_COLS.SCADENZA_PATENTE_AUTISTA_2 - 1] = post.autista2.scadenzaPatente ? parseItalianOrISO(post.autista2.scadenzaPatente) : '';\r\n    }\r\n    \r\n    // Autista 3 (opzionale)\r\n    if (post.autista3) {\r\n      row[CONFIG.PRENOTAZIONI_COLS.NOME_AUTISTA_3 - 1] = post.autista3.nomeCompleto || post.autista3.nome || '';\r\n      row[CONFIG.PRENOTAZIONI_COLS.DATA_NASCITA_AUTISTA_3 - 1] = post.autista3.dataNascita ? parseItalianOrISO(post.autista3.dataNascita) : '';\r\n      row[CONFIG.PRENOTAZIONI_COLS.LUOGO_NASCITA_AUTISTA_3 - 1] = post.autista3.luogoNascita || '';\r\n      row[CONFIG.PRENOTAZIONI_COLS.CODICE_FISCALE_AUTISTA_3 - 1] = post.autista3.codiceFiscale || '';\r\n      row[CONFIG.PRENOTAZIONI_COLS.COMUNE_RESIDENZA_AUTISTA_3 - 1] = post.autista3.comuneResidenza || '';\r\n      row[CONFIG.PRENOTAZIONI_COLS.VIA_RESIDENZA_AUTISTA_3 - 1] = post.autista3.viaResidenza || '';\r\n      row[CONFIG.PRENOTAZIONI_COLS.CIVICO_RESIDENZA_AUTISTA_3 - 1] = post.autista3.civicoResidenza || '';\r\n      row[CONFIG.PRENOTAZIONI_COLS.NUMERO_PATENTE_AUTISTA_3 - 1] = post.autista3.numeroPatente || '';\r\n      row[CONFIG.PRENOTAZIONI_COLS.DATA_INIZIO_PATENTE_AUTISTA_3 - 1] = (post.autista3.inizioValiditaPatente || post.autista3.dataInizioPatente) ? parseItalianOrISO(post.autista3.inizioValiditaPatente || post.autista3.dataInizioPatente) : '';\r\n      row[CONFIG.PRENOTAZIONI_COLS.SCADENZA_PATENTE_AUTISTA_3 - 1] = post.autista3.scadenzaPatente ? parseItalianOrISO(post.autista3.scadenzaPatente) : '';\r\n    }\r\n    \r\n    // Genera ID booking\r\n    var id = generaNuovoIdBooking();\r\n    row[CONFIG.PRENOTAZIONI_COLS.ID_PRENOTAZIONE - 1] = id;\r\n    \r\n    // Salva prenotazione\r\n    // Sanitizza tutti i valori per prevenire formula injection\n    for (var i = 0; i < row.length; i++) {\n      row[i] = sanitizeSheetValue(row[i]);\n    }\n    \n    sh.appendRow(row);\n    invalidateIndex('PREN');\n    \r\n    // Upsert clienti se richiesto\r\n    if (post.upsertClienti) {\r\n        \r\n        if (post.autista1 && post.autista1.codiceFiscale) upsertClienteInCreaPrenotazione(post.autista1, true);\r\n        if (post.autista2 && post.autista2.codiceFiscale) upsertClienteInCreaPrenotazione(post.autista2, false);\r\n        if (post.autista3 && post.autista3.codiceFiscale) upsertClienteInCreaPrenotazione(post.autista3, false);\r\n      } catch(e) {\r\n        Logger.log('Errore upsert clienti: ' + e.message);\r\n      }\r\n    }\r\n    \r\n    // Notifiche\r\n      var sh = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID)\r\n      inviaNotificaTelegram(post);\r\n    } catch(e) {\r\n      Logger.log('Errore invio Telegram: ' + e.message);\r\n    }\r\n    \r\n    if (post.email) {\r\n      try {\r\n        inviaEmailConfermaCliente({...post, idPrenotazione: id});\r\n      } catch(e) {\r\n        Logger.log('Errore email conferma cliente: ' + e.message);\r\n      }\r\n    }\r\n    \r\n    return createJsonResponse({\r\n      success: true,\r\n      message: 'Prenotazione creata',\r\n      idPrenotazione: id\r\n    });\r\n  } catch(err) {\r\n    return createJsonResponse({\r\n      success: false,\r\n      message: 'Errore creazione prenotazione: ' + err.message\r\n    }, 500);\r\n  }\r\n}\r\n\r\n/**\r\n * Aggiorna stato prenotazione e gestisce conseguenze (PDF, email)\r\n * @param {Object} post - idPrenotazione, nuovoStato, importo (opzionale)\r\n * @return {ContentService} Risposta JSON\r\n */\r\nfunction aggiornaStatoPrenotazione(post) {\n  Logger.log('[aggiornaStatoPrenotazione] Input: ' + JSON.stringify(post));\r\n  \r\n  try {\r\n    var sessionToken = post.sessionToken;\n    var csrfToken = post.csrfToken;\n    \n    if (!sessionToken || !csrfToken) {\n      return createJsonResponse({\n        success: false,\n        message: 'Token di sessione e CSRF richiesti'\n      }, 400);\n    }\n    \n    if (!validateCSRFToken(sessionToken, csrfToken)) {\n      return createJsonResponse({\n        success: false,\n        message: 'Token CSRF non valido'\n      }, 403);\n    }\n    \n    var sessionToken = post.sessionToken;\n    var csrfToken = post.csrfToken;\n    \n    if (!sessionToken || !csrfToken) {\n      return createJsonResponse({\n        success: false,\n        message: 'Token di sessione e CSRF richiesti'\n      }, 400);\n    }\n    \n    if (!validateCSRFToken(sessionToken, csrfToken)) {\n      return createJsonResponse({\n        success: false,\n        message: 'Token CSRF non valido'\n      }, 403);\n    }\n    \n    var idPrenotazione = post.idPrenotazione;\r\n    var nuovoStato = post.nuovoStato;\r\n    var importo = post.importo;\r\n    \r\n    if (!idPrenotazione || !nuovoStato) {\r\n      return createJsonResponse({\r\n        success: false,\r\n        message: 'ID prenotazione e nuovo stato richiesti'\r\n      }, 400);\r\n    }\r\n    \r\n    var sh = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID).getSheetByName(CONFIG.SHEETS.PRENOTAZIONI);\n    var rowIndex = prenRowIndexById(idPrenotazione);\n    \r\n    if (rowIndex === -1) {\r\n      return createJsonResponse({\r\n        success: false,\r\n        message: 'Prenotazione non trovata con ID: ' + idPrenotazione\r\n      }, 404);\r\n    }\r\n    \r\n    var lastCol = sh.getLastColumn();\n    var row = sh.getRange(rowIndex, 1, 1, lastCol).getValues()[0];\n    var C = CONFIG.PRENOTAZIONI_COLS;\n    row[C.STATO_PRENOTAZIONE-1] = nuovoStato;\n    if (importo && nuovoStato === 'Confermata') { row[C.IMPORTO_PREVENTIVO-1] = importo; }\n    sh.getRange(rowIndex, 1, 1, lastCol).setValues([row]);\n    invalidateIndex('PREN');\n    \r\n    var pdfResult = null;\r\n    \r\n    // Genera PDF se confermata\r\n    if (nuovoStato === 'Confermata') {\r\n      try {\r\n        pdfResult = generaPDFContratto(idPrenotazione);\r\n      } catch (e) {\r\n        Logger.log('[aggiornaStatoPrenotazione] Errore generazione PDF: ' + e.message);\r\n      }\r\n      \r\n      // Invia email conferma preventivo\r\n      var row = data[rowIndex - 1];\r\n      var email = row[CONFIG.PRENOTAZIONI_COLS.EMAIL - 1];\r\n      \r\n      if (email) {\r\n        var prenotazione = {\r\n          idPrenotazione: idPrenotazione,\r\n          targa: row[CONFIG.PRENOTAZIONI_COLS.TARGA - 1],\r\n          giornoInizio: row[CONFIG.PRENOTAZIONI_COLS.GIORNO_INIZIO - 1],\r\n          giornoFine: row[CONFIG.PRENOTAZIONI_COLS.GIORNO_FINE - 1],\r\n          oraInizio: row[CONFIG.PRENOTAZIONI_COLS.ORA_INIZIO - 1],\r\n          oraFine: row[CONFIG.PRENOTAZIONI_COLS.ORA_FINE - 1],\r\n          destinazione: row[CONFIG.PRENOTAZIONI_COLS.DESTINAZIONE - 1],\r\n          email: email,\r\n          autista1: { nomeCompleto: row[CONFIG.PRENOTAZIONI_COLS.NOME_AUTISTA_1 - 1] }\r\n        };\r\n        \r\n        try {\r\n          inviaEmailConfermaPreventivo(prenotazione);\r\n        } catch(e) {\r\n          Logger.log('[aggiornaStatoPrenotazione] Errore invio email: ' + e.message);\r\n        }\r\n      }\r\n    }\r\n    \r\n    return createJsonResponse({\r\n      success: true,\r\n      message: 'Stato aggiornato con successo',\r\n      nuovoStato: nuovoStato,\r\n      idPrenotazione: idPrenotazione,\r\n      pdfGenerato: pdfResult ? pdfResult.success : false,\r\n      pdfUrl: pdfResult && pdfResult.success ? pdfResult.pdfUrl : null\r\n    });\r\n  } catch(err) {\r\n    return createJsonResponse({\r\n      success: false,\r\n      message: 'Errore: ' + err.message\r\n    }, 500);\r\n  }\r\n}\r\n\r\n/**\r\n * Aggiorna dati completi prenotazione\r\n * @param {Object} post - Tutti i campi modificabili\r\n * @return {ContentService} Risposta JSON\r\n */\r\nfunction aggiornaPrenotazioneCompleta(post) {\n  Logger.log('[aggiornaPrenotazioneCompleta] Input: ' + JSON.stringify(post));\r\n  \r\n  try {\r\n    var idPrenotazione = post.idPrenotazione;\r\n    if (!idPrenotazione) {\r\n      return createJsonResponse({\r\n        success: false,\r\n        message: 'ID prenotazione richiesto'\r\n      }, 400);\r\n    }\r\n    \r\n    var sh = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID)\r\n      .getSheetByName(CONFIG.SHEETS.PRENOTAZIONI);\r\n    var data = sh.getDataRange().getValues();\r\n    var rowIndex = -1;\r\n    var statoAttuale = '';\r\n    \r\n    for (var i = 1; i < data.length; i++) {\r\n      if (String(data[i][CONFIG.PRENOTAZIONI_COLS.ID_PRENOTAZIONE - 1]) === String(idPrenotazione)) {\r\n        rowIndex = i + 1;\r\n        statoAttuale = data[i][CONFIG.PRENOTAZIONI_COLS.STATO_PRENOTAZIONE - 1];\r\n        break;\r\n      }\r\n    }\r\n    \r\n    if (rowIndex === -1) {\r\n      return createJsonResponse({\r\n        success: false,\r\n        message: 'Prenotazione non trovata'\r\n      }, 404);\r\n    }\r\n    \r\n    // Aggiorna stato prenotazione se presente nel payload\r\n    var nuovoStato = post.stato || post.nuovoStato;\r\n    if (nuovoStato) {\r\n      sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.STATO_PRENOTAZIONE).setValue(sanitizeSheetValue(nuovoStato));\r\n    }\r\n\r\n    // Aggiorna campi prenotazione (accetta sia nomi backend che nomi flat dell'admin)\r\n    if (post.targa) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.TARGA).setValue(sanitizeSheetValue(post.targa));\r\n    if (post.giornoInizio) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.GIORNO_INIZIO).setValue(parseItalianOrISO(post.giornoInizio));\r\n    if (post.giornoFine) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.GIORNO_FINE).setValue(parseItalianOrISO(post.giornoFine));\r\n    if (post.oraInizio) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.ORA_INIZIO).setValue(post.oraInizio);\r\n    if (post.oraFine) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.ORA_FINE).setValue(post.oraFine);\r\n    if (post.destinazione) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.DESTINAZIONE).setValue(sanitizeSheetValue(post.destinazione));\r\n    var cellulareTop = post.cellulare || post.cell; // alias\r\n    if (cellulareTop) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.CELLULARE).setValue(sanitizeSheetValue(cellulareTop));\r\n    if (post.email) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.EMAIL).setValue(sanitizeSheetValue(post.email));\r\n    var importo = (post.importo !== undefined ? post.importo : post.importoPreventivo);\r\n    if (importo) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.IMPORTO_PREVENTIVO).setValue(importo);\r\n\r\n    // Mapping Autista 1: accetta payload annidato o flat dell'admin\r\n    var a1 = post.autista1 || {};\r\n    var nomeA1 = post.nomeAutista1 || a1.nomeCompleto;\r\n    var cfA1 = post.codiceFiscaleAutista1 || a1.codiceFiscale;\r\n    var nascitaA1 = post.dataNascitaAutista1 || a1.dataNascita;\r\n    var luogoNascitaA1 = post.luogoNascitaAutista1 || a1.luogoNascita;\r\n    var patenteNumA1 = post.numeroPatenteAutista1 || a1.numeroPatente;\r\n    var patenteInizioA1 = a1.inizioValiditaPatente || a1.dataInizioPatente; // campo non presente nel form\r\n    var patenteScadenzaA1 = post.scadenzaPatenteAutista1 || a1.scadenzaPatente;\r\n    var comuneResA1 = post.comuneResidenzaAutista1 || a1.comuneResidenza;\r\n    var viaResA1 = post.viaResidenzaAutista1 || a1.viaResidenza;\r\n    var civicoResA1 = post.civicoResidenzaAutista1 || a1.civicoResidenza;\r\n\r\n    if (nomeA1) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.NOME_AUTISTA_1).setValue(sanitizeSheetValue(nomeA1));\r\n    if (cfA1) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.CODICE_FISCALE_AUTISTA_1).setValue(sanitizeSheetValue(cfA1));\r\n    if (luogoNascitaA1) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.LUOGO_NASCITA_AUTISTA_1).setValue(luogoNascitaA1);\r\n    if (comuneResA1) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.COMUNE_RESIDENZA_AUTISTA_1).setValue(comuneResA1);\r\n    if (viaResA1) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.VIA_RESIDENZA_AUTISTA_1).setValue(viaResA1);\r\n    if (civicoResA1) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.CIVICO_RESIDENZA_AUTISTA_1).setValue(civicoResA1);\r\n    if (patenteNumA1) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.NUMERO_PATENTE_AUTISTA_1).setValue(patenteNumA1);\r\n\r\n    // Date Autista 1 normalizzate\r\n    if (nascitaA1) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.DATA_NASCITA_AUTISTA_1).setValue(parseItalianOrISO(nascitaA1));\r\n    if (patenteInizioA1) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.DATA_INIZIO_PATENTE_AUTISTA_1).setValue(parseItalianOrISO(patenteInizioA1));\r\n    if (patenteScadenzaA1) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.SCADENZA_PATENTE_AUTISTA_1).setValue(parseItalianOrISO(patenteScadenzaA1));\r\n\r\n    // Mapping Autista 2 (solo se presenti dati)\r\n    var a2 = post.autista2 || {};\r\n    var nomeA2 = post.nomeAutista2 || a2.nomeCompleto;\r\n    var cfA2 = post.codiceFiscaleAutista2 || a2.codiceFiscale;\r\n    var nascitaA2 = post.dataNascitaAutista2 || a2.dataNascita;\r\n    var luogoNascitaA2 = post.luogoNascitaAutista2 || a2.luogoNascita;\r\n    var patenteNumA2 = post.numeroPatenteAutista2 || a2.numeroPatente;\r\n    var patenteInizioA2 = a2.inizioValiditaPatente || a2.dataInizioPatente;\r\n    var patenteScadenzaA2 = post.scadenzaPatenteAutista2 || a2.scadenzaPatente;\r\n    var comuneResA2 = post.comuneResidenzaAutista2 || a2.comuneResidenza;\r\n    var viaResA2 = post.viaResidenzaAutista2 || a2.viaResidenza;\r\n    var civicoResA2 = post.civicoResidenzaAutista2 || a2.civicoResidenza;\r\n\r\n    if (nomeA2) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.NOME_AUTISTA_2).setValue(sanitizeSheetValue(nomeA2));\r\n    if (cfA2) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.CODICE_FISCALE_AUTISTA_2).setValue(sanitizeSheetValue(cfA2));\r\n    if (luogoNascitaA2) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.LUOGO_NASCITA_AUTISTA_2).setValue(sanitizeSheetValue(luogoNascitaA2));\r\n    if (comuneResA2) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.COMUNE_RESIDENZA_AUTISTA_2).setValue(sanitizeSheetValue(comuneResA2));\r\n    if (viaResA2) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.VIA_RESIDENZA_AUTISTA_2).setValue(sanitizeSheetValue(viaResA2));\r\n    if (civicoResA2) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.CIVICO_RESIDENZA_AUTISTA_2).setValue(sanitizeSheetValue(civicoResA2));\r\n    if (patenteNumA2) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.NUMERO_PATENTE_AUTISTA_2).setValue(sanitizeSheetValue(patenteNumA2));\r\n    if (nascitaA2) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.DATA_NASCITA_AUTISTA_2).setValue(parseItalianOrISO(nascitaA2));\r\n    if (patenteInizioA2) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.DATA_INIZIO_PATENTE_AUTISTA_2).setValue(parseItalianOrISO(patenteInizioA2));\r\n    if (patenteScadenzaA2) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.SCADENZA_PATENTE_AUTISTA_2).setValue(parseItalianOrISO(patenteScadenzaA2));\r\n\r\n    // Mapping Autista 3 (solo se presenti dati)\r\n    var a3 = post.autista3 || {};\r\n    var nomeA3 = post.nomeAutista3 || a3.nomeCompleto;\r\n    var cfA3 = post.codiceFiscaleAutista3 || a3.codiceFiscale;\r\n    var nascitaA3 = post.dataNascitaAutista3 || a3.dataNascita;\r\n    var luogoNascitaA3 = post.luogoNascitaAutista3 || a3.luogoNascita;\r\n    var patenteNumA3 = post.numeroPatenteAutista3 || a3.numeroPatente;\r\n    var patenteInizioA3 = a3.inizioValiditaPatente || a3.dataInizioPatente;\r\n    var patenteScadenzaA3 = post.scadenzaPatenteAutista3 || a3.scadenzaPatente;\r\n    var comuneResA3 = post.comuneResidenzaAutista3 || a3.comuneResidenza;\r\n    var viaResA3 = post.viaResidenzaAutista3 || a3.viaResidenza;\r\n    var civicoResA3 = post.civicoResidenzaAutista3 || a3.civicoResidenza;\r\n\r\n    if (nomeA3) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.NOME_AUTISTA_3).setValue(sanitizeSheetValue(nomeA3));\r\n    if (cfA3) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.CODICE_FISCALE_AUTISTA_3).setValue(sanitizeSheetValue(cfA3));\r\n    if (luogoNascitaA3) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.LUOGO_NASCITA_AUTISTA_3).setValue(luogoNascitaA3);\r\n    if (comuneResA3) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.COMUNE_RESIDENZA_AUTISTA_3).setValue(comuneResA3);\r\n    if (viaResA3) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.VIA_RESIDENZA_AUTISTA_3).setValue(viaResA3);\r\n    if (civicoResA3) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.CIVICO_RESIDENZA_AUTISTA_3).setValue(civicoResA3);\r\n    if (patenteNumA3) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.NUMERO_PATENTE_AUTISTA_3).setValue(patenteNumA3);\r\n    if (nascitaA3) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.DATA_NASCITA_AUTISTA_3).setValue(parseItalianOrISO(nascitaA3));\r\n    if (patenteInizioA3) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.DATA_INIZIO_PATENTE_AUTISTA_3).setValue(parseItalianOrISO(patenteInizioA3));\r\n    if (patenteScadenzaA3) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.SCADENZA_PATENTE_AUTISTA_3).setValue(parseItalianOrISO(patenteScadenzaA3));\r\n    \r\n    // Rigenera PDF se già confermata\r\n    var pdfRigenerato = false;\r\n    if (statoAttuale !== 'In attesa' || nuovoStato === 'Confermata') {\r\n      eliminaPDFPrenotazione(idPrenotazione);\r\n      var pdfResult = generaPDFContratto(idPrenotazione);\r\n      pdfRigenerato = pdfResult.success;\r\n    }\r\n    \r\n    return createJsonResponse({\r\n      success: true,\r\n      message: 'Prenotazione aggiornata',\r\n      pdfRigenerato: pdfRigenerato\r\n    });\r\n  } catch (err) {\r\n    return createJsonResponse({\r\n      success: false,\r\n      message: err.message\r\n    }, 500);\r\n  }\r\n}\n\n/**\n * Aggiorna SOLO i dati degli autisti (endpoint pubblico con token autisti)\n * Non modifica stato, veicolo, importi, PDF.\n * @param {Object} post - { idPrenotazione, autista1?, autista2?, autista3?, cellulare? }\n * @return {ContentService} Risposta JSON\n */\nfunction aggiornaAutistiPubblico(post) {\n  Logger.log('[aggiornaAutistiPubblico] Input: ' + JSON.stringify(post));\n  try {\n\n    var sh = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID)\n      .getSheetByName(CONFIG.SHEETS.PRENOTAZIONI);\n    var data = sh.getDataRange().getValues();\n    var rowIndex = -1;\n    var statoAttuale = '';\n    for (var i = 1; i < data.length; i++) {\n      if (String(data[i][CONFIG.PRENOTAZIONI_COLS.ID_PRENOTAZIONE - 1]) === String(idPrenotazione)) {\n        rowIndex = i + 1;\n        statoAttuale = String(data[i][CONFIG.PRENOTAZIONI_COLS.STATO_PRENOTAZIONE - 1] || '').trim();\n        break;\n      }\n    }\n    if (rowIndex === -1) {\n      return createJsonResponse({ success: false, message: 'Prenotazione non trovata' }, 404);\n    }\n\n    // Consenti aggiornamento cellulare di contatto\n    var cellPublic = post.cellulare || post.cell;\n    if (cellPublic) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.CELLULARE).setValue(cellPublic);\n\n    // Autista 1\n    var a1 = post.autista1 || {};\n    if (post.nomeAutista1 || a1.nomeCompleto) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.NOME_AUTISTA_1).setValue(post.nomeAutista1 || a1.nomeCompleto);\n    if (post.codiceFiscaleAutista1 || a1.codiceFiscale) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.CODICE_FISCALE_AUTISTA_1).setValue(post.codiceFiscaleAutista1 || a1.codiceFiscale);\n    if (post.luogoNascitaAutista1 || a1.luogoNascita) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.LUOGO_NASCITA_AUTISTA_1).setValue(post.luogoNascitaAutista1 || a1.luogoNascita);\n    if (post.comuneResidenzaAutista1 || a1.comuneResidenza) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.COMUNE_RESIDENZA_AUTISTA_1).setValue(post.comuneResidenzaAutista1 || a1.comuneResidenza);\n    if (post.viaResidenzaAutista1 || a1.viaResidenza) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.VIA_RESIDENZA_AUTISTA_1).setValue(post.viaResidenzaAutista1 || a1.viaResidenza);\n    if (post.civicoResidenzaAutista1 || a1.civicoResidenza) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.CIVICO_RESIDENZA_AUTISTA_1).setValue(post.civicoResidenzaAutista1 || a1.civicoResidenza);\n    if (post.numeroPatenteAutista1 || a1.numeroPatente) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.NUMERO_PATENTE_AUTISTA_1).setValue(post.numeroPatenteAutista1 || a1.numeroPatente);\n    if (post.dataNascitaAutista1 || a1.dataNascita) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.DATA_NASCITA_AUTISTA_1).setValue(parseItalianOrISO(post.dataNascitaAutista1 || a1.dataNascita));\n    var a1Start = a1.inizioValiditaPatente || a1.dataInizioPatente;\n    if (a1Start) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.DATA_INIZIO_PATENTE_AUTISTA_1).setValue(parseItalianOrISO(a1Start));\n    if (post.scadenzaPatenteAutista1 || a1.scadenzaPatente) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.SCADENZA_PATENTE_AUTISTA_1).setValue(parseItalianOrISO(post.scadenzaPatenteAutista1 || a1.scadenzaPatente));\n\n    // Autista 2\n    var a2 = post.autista2 || {};\n    if (post.nomeAutista2 || a2.nomeCompleto) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.NOME_AUTISTA_2).setValue(post.nomeAutista2 || a2.nomeCompleto);\n    if (post.codiceFiscaleAutista2 || a2.codiceFiscale) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.CODICE_FISCALE_AUTISTA_2).setValue(post.codiceFiscaleAutista2 || a2.codiceFiscale);\n    if (post.luogoNascitaAutista2 || a2.luogoNascita) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.LUOGO_NASCITA_AUTISTA_2).setValue(post.luogoNascitaAutista2 || a2.luogoNascita);\n    if (post.comuneResidenzaAutista2 || a2.comuneResidenza) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.COMUNE_RESIDENZA_AUTISTA_2).setValue(post.comuneResidenzaAutista2 || a2.comuneResidenza);\n    if (post.viaResidenzaAutista2 || a2.viaResidenza) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.VIA_RESIDENZA_AUTISTA_2).setValue(post.viaResidenzaAutista2 || a2.viaResidenza);\n    if (post.civicoResidenzaAutista2 || a2.civicoResidenza) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.CIVICO_RESIDENZA_AUTISTA_2).setValue(post.civicoResidenzaAutista2 || a2.civicoResidenza);\n    if (post.numeroPatenteAutista2 || a2.numeroPatente) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.NUMERO_PATENTE_AUTISTA_2).setValue(post.numeroPatenteAutista2 || a2.numeroPatente);\n    if (post.dataNascitaAutista2 || a2.dataNascita) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.DATA_NASCITA_AUTISTA_2).setValue(parseItalianOrISO(post.dataNascitaAutista2 || a2.dataNascita));\n    var a2Start = a2.inizioValiditaPatente || a2.dataInizioPatente;\n    if (a2Start) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.DATA_INIZIO_PATENTE_AUTISTA_2).setValue(parseItalianOrISO(a2Start));\n    if (post.scadenzaPatenteAutista2 || a2.scadenzaPatente) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.SCADENZA_PATENTE_AUTISTA_2).setValue(parseItalianOrISO(post.scadenzaPatenteAutista2 || a2.scadenzaPatente));\n\n    // Autista 3\n    var a3 = post.autista3 || {};\n    if (post.nomeAutista3 || a3.nomeCompleto) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.NOME_AUTISTA_3).setValue(post.nomeAutista3 || a3.nomeCompleto);\n    if (post.codiceFiscaleAutista3 || a3.codiceFiscale) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.CODICE_FISCALE_AUTISTA_3).setValue(post.codiceFiscaleAutista3 || a3.codiceFiscale);\n    if (post.luogoNascitaAutista3 || a3.luogoNascita) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.LUOGO_NASCITA_AUTISTA_3).setValue(post.luogoNascitaAutista3 || a3.luogoNascita);\n    if (post.comuneResidenzaAutista3 || a3.comuneResidenza) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.COMUNE_RESIDENZA_AUTISTA_3).setValue(post.comuneResidenzaAutista3 || a3.comuneResidenza);\n    if (post.viaResidenzaAutista3 || a3.viaResidenza) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.VIA_RESIDENZA_AUTISTA_3).setValue(post.viaResidenzaAutista3 || a3.viaResidenza);\n    if (post.civicoResidenzaAutista3 || a3.civicoResidenza) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.CIVICO_RESIDENZA_AUTISTA_3).setValue(post.civicoResidenzaAutista3 || a3.civicoResidenza);\n    if (post.numeroPatenteAutista3 || a3.numeroPatente) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.NUMERO_PATENTE_AUTISTA_3).setValue(post.numeroPatenteAutista3 || a3.numeroPatente);\n    if (post.dataNascitaAutista3 || a3.dataNascita) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.DATA_NASCITA_AUTISTA_3).setValue(parseItalianOrISO(post.dataNascitaAutista3 || a3.dataNascita));\n    var a3Start = a3.inizioValiditaPatente || a3.dataInizioPatente;\n    if (a3Start) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.DATA_INIZIO_PATENTE_AUTISTA_3).setValue(parseItalianOrISO(a3Start));\n    if (post.scadenzaPatenteAutista3 || a3.scadenzaPatente) sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.SCADENZA_PATENTE_AUTISTA_3).setValue(parseItalianOrISO(post.scadenzaPatenteAutista3 || a3.scadenzaPatente));\n\n    // Se la prenotazione è stata importata come Legacy, portala in \"In attesa\" dopo l'invio dei dati autisti\n    if (statoAttuale && /^legacy$/i.test(statoAttuale)) {\n      try {\n        sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.STATO_PRENOTAZIONE).setValue('In attesa');\n        Logger.log('[aggiornaAutistiPubblico] Stato aggiornato: Legacy → In attesa');\n      } catch (e) {\n        Logger.log('[aggiornaAutistiPubblico] Errore aggiornamento stato Legacy→In attesa: ' + e.message);\n      }\n    }\n\n    return createJsonResponse({ success: true, message: 'Dati autisti aggiornati' });\n  } catch (err) {\n    return createJsonResponse({ success: false, message: err.message }, 500);\n  }\n}\n\r\n/**\r\n * Elimina prenotazione e relativo PDF\r\n * @param {Object} post - idPrenotazione\r\n * @return {ContentService} Risposta JSON\r\n */\r\nfunction eliminaPrenotazione(post) {\r\n  Logger.log('[eliminaPrenotazione] ID: ' + post.idPrenotazione);\r\n  \r\n  try {\r\n    var idPrenotazione = post.idPrenotazione;\r\n    if (!idPrenotazione) {\r\n      return createJsonResponse({\r\n        success: false,\r\n        message: 'ID prenotazione richiesto'\r\n      }, 400);\r\n    }\r\n    \r\n    // Elimina PDF\r\n    eliminaPDFPrenotazione(idPrenotazione);\r\n    \r\n    // Elimina riga\r\n    var sh = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID)\r\n      .getSheetByName(CONFIG.SHEETS.PRENOTAZIONI);\r\n    var data = sh.getDataRange().getValues();\r\n    \r\n    for (var i = 1; i < data.length; i++) {\r\n      if (String(data[i][CONFIG.PRENOTAZIONI_COLS.ID_PRENOTAZIONE - 1]) === String(idPrenotazione)) {\r\n        sh.deleteRow(i + 1);\r\n        Logger.log('[eliminaPrenotazione] Riga eliminata: ' + (i + 1));\r\n        break;\r\n      }\r\n    }\r\n    \r\n    return createJsonResponse({\r\n      success: true,\r\n      message: 'Prenotazione eliminata'\r\n    });\r\n  } catch (err) {\r\n    return createJsonResponse({\r\n      success: false,\r\n      message: err.message\r\n    }, 500);\r\n  }\r\n}\r\n\r\n/**\r\n * Conferma prenotazione (shortcut per aggiornaStato)\r\n * @param {Object} post - idPrenotazione\r\n * @return {ContentService} Risposta JSON\r\n */\r\nfunction confermaPrenotazione(post) {\r\n  Logger.log('[confermaPrenotazione] Richiesta ricevuta per ID: ' + post.idPrenotazione);\r\n  \r\n  const idPrenotazione = String(post.idPrenotazione).trim();\r\n  \r\n  if (!idPrenotazione) {\r\n    return createJsonResponse({\r\n      success: false,\r\n      message: 'ID prenotazione mancante'\r\n    }, 400);\r\n  }\r\n  \r\n  try {\r\n    var sh = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID)\r\n      .getSheetByName(CONFIG.SHEETS.PRENOTAZIONI);\r\n    var data = sh.getDataRange().getValues();\r\n    var headers = data[0];\r\n    \r\n    // Trova colonna ID\r\n    var idColIndex = -1;\r\n    for (var h = 0; h < headers.length; h++) {\r\n      var header = String(headers[h]).trim();\r\n      if (header === 'ID prenotazione' ||\r\n          header === 'idPrenotazione' ||\r\n          header === 'IDPRENOTAZIONE' ||\r\n          header.toLowerCase().replace(/\\s+/g, '') === 'idprenotazione') {\r\n        idColIndex = h;\r\n        break;\r\n      }\r\n    }\r\n    \r\n    if (idColIndex === -1) {\r\n      return createJsonResponse({\r\n        success: false,\r\n        message: 'Colonna ID prenotazione non trovata nel foglio'\r\n      }, 500);\r\n    }\r\n    \r\n    // Trova riga\r\n    var rowIndex = -1;\r\n    for (var i = 1; i < data.length; i++) {\r\n      var rowId = String(data[i][idColIndex]).trim();\r\n      if (rowId.toUpperCase() === idPrenotazione.toUpperCase()) {\r\n        rowIndex = i + 1;\r\n        break;\r\n      }\r\n    }\r\n    \r\n    if (rowIndex === -1) {\r\n      return createJsonResponse({\r\n        success: false,\r\n        message: 'Prenotazione non trovata con ID: ' + idPrenotazione\r\n      }, 404);\r\n    }\r\n    \r\n    // Trova colonna stato\r\n    var statoColIndex = -1;\r\n    for (var h = 0; h < headers.length; h++) {\r\n      var header = String(headers[h]).trim();\r\n      if (header === 'stato' ||\r\n          header === 'statoPrenotazione' ||\r\n          header === 'Stato prenotazione' ||\r\n          header === 'STATOPRENOTAZIONE') {\r\n        statoColIndex = h;\r\n        break;\r\n      }\r\n    }\r\n    \r\n    if (statoColIndex === -1) {\r\n      return createJsonResponse({\r\n        success: false,\r\n        message: 'Colonna stato non trovata nel foglio'\r\n      }, 500);\r\n    }\r\n    \r\n    // Aggiorna stato\r\n    sh.getRange(rowIndex, statoColIndex + 1).setValue('Confermata');\r\n    \r\n    // Genera PDF\r\n    var pdfResult = null;\r\n    try {\r\n      if (typeof generaPDFContratto === 'function') {\r\n        pdfResult = generaPDFContratto(idPrenotazione);\r\n      }\r\n    } catch (e) {\r\n      Logger.log('[confermaPrenotazione] Errore generazione PDF: ' + e.message);\r\n    }\r\n    \r\n    return createJsonResponse({\r\n      success: true,\r\n      message: 'Prenotazione confermata con successo',\r\n      data: {\r\n        idPrenotazione: idPrenotazione,\r\n        nuovoStato: 'Confermata',\r\n        riga: rowIndex,\r\n        pdfGenerato: pdfResult ? pdfResult.success : false\r\n      }\r\n    });\r\n  } catch (error) {\r\n    return createJsonResponse({\r\n      success: false,\r\n      message: 'Errore durante la conferma: ' + error.message\r\n    }, 500);\r\n  }\r\n}\r\n\r\n/**\r\n * Aggiorna automaticamente stati prenotazioni in base alle date\r\n * Stati: In attesa -> Programmata -> In corso -> Completata\r\n * @return {ContentService} Risposta JSON con numero aggiornamenti\r\n */\r\nfunction updateStatiLive() {\r\n  try {\r\n    var now = new Date();\r\n    var today = new Date(now.getFullYear(), now.getMonth(), now.getDate());\r\n    var ss = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);\r\n    var shP = ss.getSheetByName(CONFIG.SHEETS.PRENOTAZIONI);\r\n    var valsP = shP.getDataRange().getValues();\r\n    \r\n    var aggiornamenti = 0;\r\n    \r\n    for (var i = 1; i < valsP.length; i++) {\r\n      var r = valsP[i];\r\n      var stato = String(r[CONFIG.PRENOTAZIONI_COLS.STATO_PRENOTAZIONE - 1] || '').trim();\r\n      var di = new Date(r[CONFIG.PRENOTAZIONI_COLS.GIORNO_INIZIO - 1]);\r\n      var df = new Date(r[CONFIG.PRENOTAZIONI_COLS.GIORNO_FINE - 1]);\r\n      \r\n      // Normalizza date (solo anno/mese/giorno, ignora ore)\r\n      var dataInizio = new Date(di.getFullYear(), di.getMonth(), di.getDate());\r\n      var dataFine = new Date(df.getFullYear(), df.getMonth(), df.getDate());\r\n      \r\n      var nuovoStato = stato;\r\n      \r\n      // Skip stati finali o non gestiti automaticamente\n      if (stato === 'In attesa' || stato === 'Rifiutata' || stato === 'Completata' || stato === 'Legacy') {\n        continue;\n      }\n      \r\n      // 🔄 LOGICA CORRETTA DI TRANSIZIONE\r\n      \r\n      // 1️⃣ Se noleggio è CONCLUSO (data fine passata)\r\n      if (today > dataFine) {\r\n        nuovoStato = 'Completata';\r\n      }\r\n      // 2️⃣ Se noleggio è IN CORSO (tra data inizio e data fine, inclusi)\r\n      else if (today >= dataInizio && today <= dataFine) {\r\n        nuovoStato = 'In corso';\r\n      }\r\n      // 3️⃣ Se noleggio è FUTURO e confermato\r\n      else if (today < dataInizio && stato === 'Confermata') {\r\n        nuovoStato = 'Programmata';\r\n      }\r\n      \r\n      // Aggiorna solo se cambiato\r\n      if (nuovoStato !== stato) {\r\n        shP.getRange(i + 1, CONFIG.PRENOTAZIONI_COLS.STATO_PRENOTAZIONE).setValue(nuovoStato);\r\n        aggiornamenti++;\r\n        Logger.log('[updateStatiLive] Riga ' + (i + 1) + ': ' + stato + ' → ' + nuovoStato);\r\n      }\r\n    }\r\n    \r\n    // Gestione manutenzioni\r\n    var shM = ss.getSheetByName(CONFIG.SHEETS.MANUTENZIONI);\r\n    if (shM) {\r\n      var valsM = shM.getDataRange().getValues();\r\n      for (var j = 1; j < valsM.length; j++) {\r\n        var m = valsM[j];\r\n        var ms = String(m[CONFIG.MANUTENZIONI_COLS.STATO - 1] || '').trim();\r\n        var mdi = new Date(m[CONFIG.MANUTENZIONI_COLS.DATA_INIZIO - 1]);\r\n        var mdf = new Date(m[CONFIG.MANUTENZIONI_COLS.DATA_FINE - 1]);\r\n        \r\n        var dataInizioMan = new Date(mdi.getFullYear(), mdi.getMonth(), mdi.getDate());\r\n        var dataFineMan = new Date(mdf.getFullYear(), mdf.getMonth(), mdf.getDate());\r\n        \r\n        var mnext = ms;\r\n        \r\n        // Skip stati finali\r\n        if (ms === 'Completata') continue;\r\n        \r\n        if (today > dataFineMan) {\r\n          mnext = 'Completata';\r\n        } else if (today >= dataInizioMan && today <= dataFineMan) {\r\n          mnext = 'In corso';\r\n        }\r\n        \r\n        if (mnext !== ms) {\r\n          shM.getRange(j + 1, CONFIG.MANUTENZIONI_COLS.STATO).setValue(mnext);\r\n          aggiornamenti++;\r\n        }\r\n      }\r\n    }\r\n    \r\n    Logger.log('[updateStatiLive] Completato: ' + aggiornamenti + ' stati aggiornati');\r\n    return createJsonResponse({\r\n      success: true,\r\n      message: 'Stati aggiornati',\r\n      aggiornamenti: aggiornamenti\r\n    });\r\n  } catch(err) {\r\n    Logger.log('[updateStatiLive] Errore: ' + err.message);\r\n    return createJsonResponse({\r\n      success: false,\r\n      message: 'Errore updateStatiLive: ' + err.message\r\n    }, 500);\r\n  }\r\n}\r\n\r\n/**\r\n * Genera nuovo ID booking univoco per anno\r\n * Formato: BOOK-2025-001\r\n * @return {string} ID prenotazione generato\r\n */\r\nfunction generaNuovoIdBooking() {\n  // Usa LockService per prevenire race conditions in ambienti concorrenti\n  var lock = LockService.getScriptLock();\n  try {\n    // Prova ad acquisire il lock con timeout di 10 secondi\n    if (!lock.tryLock(10000)) {\n      throw new Error('Timeout nell\\'acquisizione del lock per generazione ID');\n    }\n    \r\n  try {\r\n    var sh = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID)\r\n      .getSheetByName(CONFIG.SHEETS.PRENOTAZIONI);\r\n    var data = sh.getDataRange().getValues();\r\n    var annoCorrente = new Date().getFullYear();\r\n    var prefisso = 'BOOK-' + annoCorrente + '-';\r\n    var maxProgressivo = 0;\r\n    \r\n    for (var i = 1; i < data.length; i++) {\r\n      var id = String(data[i][CONFIG.PRENOTAZIONI_COLS.ID_PRENOTAZIONE - 1] || '');\r\n      if (id.startsWith(prefisso)) {\r\n        var numero = parseInt(id.replace(prefisso, ''), 10);\r\n        if (!isNaN(numero) && numero > maxProgressivo) {\r\n          maxProgressivo = numero;\r\n        }\r\n      }\r\n    }\r\n    \r\n    var nuovoProgressivo = maxProgressivo + 1;\r\n    return prefisso + String(nuovoProgressivo).padStart(3, '0');\r\n  } catch (error) {\r\n    var anno = new Date().getFullYear();\r\n    return 'BOOK-' + anno + '-' + String(Date.now()).slice(-3);\r\n  }\r\n}\r\n\r\n/**\r\n * Assegna ID a prenotazioni esistenti che non ne hanno\r\n * @return {ContentService} Risposta JSON con contatori\r\n */\r\nfunction assegnaIdPrenotazioniEsistenti() {\r\n  try {\r\n    var sh = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID)\r\n      .getSheetByName(CONFIG.SHEETS.PRENOTAZIONI);\r\n    var data = sh.getDataRange().getValues();\r\n    \r\n    if (data.length <= 1) {\r\n      return createJsonResponse({\r\n        success: true,\r\n        message: 'Nessuna prenotazione trovata',\r\n        processate: 0\r\n      });\r\n    }\r\n    \r\n    var prenotazioniPerAnno = {};\r\n    var maxProgressiviPerAnno = {};\r\n    \r\n    // Prima passata: raccogli prenotazioni per anno\r\n    for (var i = 1; i < data.length; i++) {\r\n      var row = data[i];\r\n      var idEsistente = String(row[CONFIG.PRENOTAZIONI_COLS.ID_PRENOTAZIONE - 1] || '').trim();\r\n      \r\n      // Determina anno\r\n      var annoPrenotazione;\r\n      var timestamp = row[CONFIG.PRENOTAZIONI_COLS.TIMESTAMP - 1];\r\n      var dataContratto = row[CONFIG.PRENOTAZIONI_COLS.DATA_CONTRATTO - 1];\r\n      var giornoInizio = row[CONFIG.PRENOTAZIONI_COLS.GIORNO_INIZIO - 1];\r\n      \r\n      if (timestamp && timestamp instanceof Date) {\r\n        annoPrenotazione = timestamp.getFullYear();\r\n      } else if (dataContratto && dataContratto instanceof Date) {\r\n        annoPrenotazione = dataContratto.getFullYear();\r\n      } else if (giornoInizio && giornoInizio instanceof Date) {\r\n        annoPrenotazione = giornoInizio.getFullYear();\r\n      } else {\r\n        annoPrenotazione = new Date().getFullYear();\r\n      }\r\n      \r\n      if (!prenotazioniPerAnno[annoPrenotazione]) {\r\n        prenotazioniPerAnno[annoPrenotazione] = [];\r\n        maxProgressiviPerAnno[annoPrenotazione] = 0;\r\n      }\r\n      \r\n      prenotazioniPerAnno[annoPrenotazione].push({\r\n        riga: i + 1,\r\n        row: row,\r\n        idEsistente: idEsistente,\r\n        anno: annoPrenotazione\r\n      });\r\n      \r\n      // Trova massimo progressivo\r\n      var prefisso = 'BOOK-' + annoPrenotazione + '-';\r\n      if (idEsistente.startsWith(prefisso)) {\r\n        var numero = parseInt(idEsistente.replace(prefisso, ''), 10);\r\n        if (!isNaN(numero) && numero > maxProgressiviPerAnno[annoPrenotazione]) {\r\n          maxProgressiviPerAnno[annoPrenotazione] = numero;\r\n        }\r\n      }\r\n    }\r\n    \r\n    var processate = 0;\r\n    var aggiornate = 0;\r\n    \r\n    // Seconda passata: assegna ID mancanti\r\n    for (var anno in prenotazioniPerAnno) {\r\n      var prossimoProgressivo = maxProgressiviPerAnno[anno] + 1;\r\n      var prefisso = 'BOOK-' + anno + '-';\r\n      \r\n      for (var j = 0; j < prenotazioniPerAnno[anno].length; j++) {\r\n        var prenotazione = prenotazioniPerAnno[anno][j];\r\n        \r\n        if (!prenotazione.idEsistente || prenotazione.idEsistente === '') {\r\n          var nuovoId = prefisso + String(prossimoProgressivo).padStart(3, '0');\r\n          sh.getRange(prenotazione.riga, CONFIG.PRENOTAZIONI_COLS.ID_PRENOTAZIONE).setValue(nuovoId);\r\n          prossimoProgressivo++;\r\n          aggiornate++;\r\n        }\r\n        processate++;\r\n      }\r\n    }\r\n    \r\n    return createJsonResponse({\r\n      success: true,\r\n      message: 'ID assegnati',\r\n      processate: processate,\r\n      aggiornate: aggiornate\r\n    });\r\n  } catch (error) {\r\n    return createJsonResponse({\r\n      success: false,\r\n      message: 'Errore: ' + error.message\r\n    }, 500);\r\n  }\r\n}\r\n",
      "size": 49601,
      "lines": 1017
    },
    "backend/VeicoliService.gs": {
      "content": "/**\r\n * SERVIZIO GESTIONE VEICOLI\r\n * \r\n * Gestisce veicoli, disponibilità e controllo sovrapposizioni con orari\r\n * Versione: 8.9.3 - Debug manutenzioni\r\n */\r\n\r\n// Fasce orarie ammesse: dalle 8:00 alle 22:00 ogni 2 ore\r\nconst FASCE_ORARIE = [\"08:00\", \"10:00\", \"12:00\", \"14:00\", \"16:00\", \"18:00\", \"20:00\", \"22:00\"];\r\n\r\n/**\r\n * Verifica se un orario è una fascia valida\r\n * @param {string} orario - Orario in formato HH:MM\r\n * @return {boolean} True se valido\r\n */\r\nfunction isValidFasciaOraria(orario) {\r\n  if (!orario) return false;\r\n  return FASCE_ORARIE.indexOf(orario) !== -1;\r\n}\r\n\r\n/**\r\n * Ottiene la fascia oraria successiva\r\n * @param {string} orario - Orario corrente\r\n * @return {string|null} Fascia successiva o null se ultima\r\n */\r\nfunction fasciaSuccessiva(orario) {\r\n  var idx = FASCE_ORARIE.indexOf(orario);\r\n  if (idx !== -1 && idx < FASCE_ORARIE.length - 1) {\r\n    return FASCE_ORARIE[idx + 1];\r\n  }\r\n  return null;\r\n}\r\n\r\n/**\r\n * Normalizza Date per confronto solo su anno/mese/giorno (ignora orari)\r\n * @param {Date|string} date - Data da normalizzare\r\n * @return {Date} Data normalizzata alle 00:00:00\r\n */\r\nfunction normalizeDate(date) {\r\n  if (!date) return null;\r\n  \r\n  var dateObj;\r\n  \r\n  // Se è stringa, converti in Date\r\n  if (typeof date === 'string') {\r\n    // Prova a parsare come YYYY-MM-DD\r\n    if (date.includes('-')) {\r\n      var dateParts = date.split('-');\r\n      if (dateParts.length === 3) {\r\n        var year = parseInt(dateParts[0], 10);\r\n        var month = parseInt(dateParts[1], 10) - 1;\r\n        var day = parseInt(dateParts[2], 10);\r\n        dateObj = new Date(year, month, day);\r\n      }\r\n    }\r\n    // Prova a parsare come DD/MM/YYYY\r\n    else if (date.includes('/')) {\r\n      var dateParts = date.split('/');\r\n      if (dateParts.length === 3) {\r\n        var day = parseInt(dateParts[0], 10);\r\n        var month = parseInt(dateParts[1], 10) - 1;\r\n        var year = parseInt(dateParts[2], 10);\r\n        dateObj = new Date(year, month, day);\r\n      }\r\n    } else {\r\n      // Prova il costruttore standard\r\n      dateObj = new Date(date);\r\n    }\r\n  } else if (date instanceof Date) {\r\n    dateObj = new Date(date);\r\n  } else {\r\n    // Prova a convertire in Date\r\n    dateObj = new Date(date);\r\n  }\r\n  \r\n  if (!dateObj || isNaN(dateObj.getTime())) return null;\r\n  \r\n  var normalized = new Date(dateObj);\r\n  normalized.setHours(0, 0, 0, 0);\r\n  return normalized;\r\n}\r\n\r\n/**\r\n * Funzione di debug per logging dettagliato delle date\r\n * @param {string} context - Contesto del logging\r\n * @param {Date|string} date - Data da analizzare\r\n * @param {string} label - Etichetta per identificare la data\r\n */\r\nfunction logDateDebug(context, date, label) {\n  // Disattiva logging pesante se DEBUG_LOGS è false\n  if (!CONFIG || CONFIG.DEBUG_LOGS === false) { return; }\n  try {\n    if (!date) {\n      Logger.log('[' + context + '] ' + label + ': NULL');\n      return;\n    }\n    \r\n    var dateObj = (date instanceof Date) ? date : new Date(date);\r\n    \r\n    if (isNaN(dateObj.getTime())) {\r\n      Logger.log('[' + context + '] ' + label + ': Data non valida - \"' + date + '\"');\r\n      return;\r\n    }\r\n    \r\n    Logger.log('[' + context + '] ' + label + ': ' + \r\n      'Raw=\"' + date + '\" ' +\r\n      'Parsed=' + dateObj.toISOString() + ' ' +\r\n      'Locale=' + dateObj.toLocaleDateString('it-IT') + ' ' +\r\n      'Time=' + dateObj.toLocaleTimeString('it-IT') + ' ' +\r\n      'Timestamp=' + dateObj.getTime());\r\n  } catch (e) {\n    Logger.log('[' + context + '] ' + label + ': Errore parsing - \"' + date + '\" - ' + e.message);\n  }\n}\n\r\n/**\r\n * Recupera lista veicoli con stato disponibilità\r\n * Controlla anche manutenzioni attive OGGI\r\n * @return {ContentService} Risposta JSON con lista veicoli\r\n */\r\nfunction getVeicoli() {\n  try {\n    // Cache di breve durata per evitare letture ripetute dei fogli\n    var cache = CacheService.getScriptCache();\n    var cached = cache.get('GET_VEICOLI_V1');\n    if (cached) {\n      try {\n        var payload = JSON.parse(cached);\n        return createJsonResponse({\n          success: true,\n          message: 'Trovati ' + payload.count + ' veicoli (cache)',\n          data: payload.data,\n          count: payload.count\n        });\n      } catch (_) {\n        // In caso di cache corrotta, prosegui con lettura da foglio\n      }\n    }\n    var sp = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);\n    var shP = sp.getSheetByName(CONFIG.SHEETS.PULMINI);\n    var shM = sp.getSheetByName(CONFIG.SHEETS.MANUTENZIONI);\n    \r\n    if (!shP) {\r\n      return createJsonResponse({\r\n        success: false,\r\n        message: 'Foglio PULMINI non trovato'\r\n      }, 500);\r\n    }\r\n    \r\n    var dataP = shP.getDataRange().getValues();\r\n    if (dataP.length <= 1) {\r\n      return createJsonResponse({\r\n        success: true,\r\n        message: 'Nessun veicolo trovato',\r\n        data: []\r\n      });\r\n    }\r\n    \r\n    // Mappa manutenzioni ATTIVE per targa\r\n    var manut = {};\r\n    var oggi = normalizeDate(new Date());\r\n    dbg('[getVeicoli] Oggi normalizzato: ' + oggi);\n    \r\n    // Logging dettagliato data odierna\r\n    logDateDebug('getVeicoli', new Date(), 'DataOdierna');\r\n    logDateDebug('getVeicoli', oggi, 'OggiNormalizzato');\r\n    \r\n    if (shM) {\r\n      var dataM = shM.getDataRange().getValues();\r\n      dbg('[getVeicoli] Righe MANUTENZIONI: ' + (dataM.length - 1));\n      \r\n      for (var i = 1; i < dataM.length; i++) {\r\n        var r = dataM[i];\r\n        var t = r[CONFIG.MANUTENZIONI_COLS.TARGA - 1];\r\n        var st = r[CONFIG.MANUTENZIONI_COLS.STATO - 1];\r\n        \r\n        dbg('[getVeicoli] Riga ' + i + ' - Targa: ' + t + ' | Stato: \"' + st + '\"');\n        \r\n        // Skip manutenzioni completate\r\n        if (!t) {\r\n          dbg('[getVeicoli] Riga ' + i + ' - Skip: targa vuota');\n          continue;\r\n        }\r\n        if (!st) {\r\n          dbg('[getVeicoli] Riga ' + i + ' - Skip: stato vuoto');\n          continue;\r\n        }\r\n        if (st === 'Completata') {\r\n          dbg('[getVeicoli] Riga ' + i + ' - Skip: stato Completata');\n          continue;\r\n        }\r\n        \r\n        var dataInizioMan = r[CONFIG.MANUTENZIONI_COLS.DATA_INIZIO - 1];\r\n        var dataFineMan = r[CONFIG.MANUTENZIONI_COLS.DATA_FINE - 1];\r\n        \r\n        dbg('[getVeicoli] Riga ' + i + ' - Data Inizio: ' + dataInizioMan + ' | Data Fine: ' + dataFineMan);\n        \r\n        // Logging dettagliato date manutenzione\r\n        logDateDebug('getVeicoli', dataInizioMan, 'DataInizioManutenzione_' + i);\r\n        logDateDebug('getVeicoli', dataFineMan, 'DataFineManutenzione_' + i);\r\n        \r\n        if (!dataInizioMan || !dataFineMan) {\r\n          Logger.log('[getVeicoli] Riga ' + i + ' - Skip: date mancanti');\r\n          continue;\r\n        }\r\n        \r\n        // Normalizza date manutenzione (solo giorno, no orari)\r\n        var di = normalizeDate(new Date(dataInizioMan));\r\n        var df = normalizeDate(new Date(dataFineMan));\r\n        \r\n        dbg('[getVeicoli] Riga ' + i + ' - Data Inizio normalizzata: ' + di);\n        dbg('[getVeicoli] Riga ' + i + ' - Data Fine normalizzata: ' + df);\n        \r\n        // Logging dettagliato normalizzazione\r\n        logDateDebug('getVeicoli', di, 'DataInizioManutenzioneNorm_' + i);\r\n        logDateDebug('getVeicoli', df, 'DataFineManutenzioneNorm_' + i);\r\n        \r\n        dbg('[getVeicoli] Riga ' + i + ' - Confronto: oggi=' + oggi.getTime() + ' >= di=' + di.getTime() + ' && oggi=' + oggi.getTime() + ' <= df=' + df.getTime());\n        \r\n        // Verifica se manutenzione è attiva OGGI\r\n        var inManutenzioneOggi = (oggi >= di && oggi <= df);\r\n        \r\n        dbg('[getVeicoli] Riga ' + i + ' - In manutenzione oggi: ' + inManutenzioneOggi);\n        \r\n        manut[t] = {\r\n          stato: st,\r\n          dataInizio: dataInizioMan,\r\n          dataInizioFormatted: formatDateToItalian(dataInizioMan),\r\n          dataFine: dataFineMan,\r\n          dataFineFormatted: formatDateToItalian(dataFineMan),\r\n          note: r[CONFIG.MANUTENZIONI_COLS.NOTE - 1] || '',\r\n          attiva: inManutenzioneOggi\r\n        };\r\n      }\r\n    }\r\n    \r\n    var res = [];\r\n    for (var j = 1; j < dataP.length; j++) {\r\n      var rp = dataP[j];\r\n      var tp = rp[CONFIG.PULMINI_COLS.TARGA - 1];\r\n      if (!tp) continue;\r\n      \r\n      var man = manut[tp];\r\n      var inMan = man && man.attiva;\r\n      \r\n      dbg('[getVeicoli] Veicolo ' + tp + ' - Ha manutenzione: ' + (man ? 'SI' : 'NO') + ' - Attiva: ' + inMan);\n      \r\n      var base = rp[CONFIG.PULMINI_COLS.STATO - 1] || 'Disponibile';\r\n      var note = rp[CONFIG.PULMINI_COLS.NOTE - 1] || '';\r\n      \r\n      res.push({\r\n        Targa: tp,\r\n        Marca: rp[CONFIG.PULMINI_COLS.MARCA - 1] || '',\r\n        Modello: rp[CONFIG.PULMINI_COLS.MODELLO - 1] || '',\r\n        Posti: parseInt(rp[CONFIG.PULMINI_COLS.POSTI - 1], 10) || 9,\r\n        Disponibile: !inMan && (base === 'Disponibile' || base === 'Attivo'),\r\n        Note: note,\r\n        PassoLungo: (tp === 'EC787NM') || (note && String(note).toLowerCase().indexOf('passo lungo') > -1),\r\n        StatoManutenzione: man ? man.stato : '-',\r\n        DataInizioManutenzione: man && man.dataInizio ? man.dataInizio : '',\r\n        DataInizioManutenzioneFormatted: man && man.dataInizioFormatted ? man.dataInizioFormatted : '',\r\n        DataFineManutenzione: man && man.dataFine ? man.dataFine : '',\r\n        DataFineManutenzioneFormatted: man && man.dataFineFormatted ? man.dataFineFormatted : '',\r\n        InManutenzioneOggi: inMan,\r\n        DisponibileDate: !inMan && (base === 'Disponibile' || base === 'Attivo')\r\n      });\r\n    }\r\n    \r\n    dbg('[getVeicoli] Trovati ' + res.length + ' veicoli, controllate manutenzioni attive');\n    // Aggiorna cache\n    try {\n      cache.put('GET_VEICOLI_V1', JSON.stringify({ data: res, count: res.length }), 300);\n    } catch (_) {}\n    return createJsonResponse({\n      success: true,\n      message: 'Trovati ' + res.length + ' veicoli',\n      data: res,\n      count: res.length\n    });\n  } catch(err) {\n    dbg('[getVeicoli] Errore: ' + err.message);\n    return createJsonResponse({\n      success: false,\n      message: 'Errore caricamento veicoli: ' + err.message\n    }, 500);\n  }\n}\n\n/**\n * Controlla disponibilità veicolo considerando DATE + ORARI (fasce 8-22 ogni 2h)\n * Un veicolo è disponibile dalla fascia oraria SUCCESSIVA alla riconsegna\r\n * Le MANUTENZIONI bloccano l'intero periodo (senza orari)\r\n * \r\n * @param {Object} p - Parametri: targa, dataInizio, dataFine, oraInizio, oraFine\r\n * @return {ContentService} Risposta JSON con disponibilità e conflitti\r\n */\r\nfunction checkDisponibilita(p) {\n  Logger.log('[checkDisponibilita] Parametri: ' + JSON.stringify(p));\n  \r\n  try {\r\n    var targa = p.targa;\n    var targaKey = String(targa || '').replace(/\\s+/g, '').toUpperCase();\n    var dataInizioRichiesta = p.dataInizio;\r\n    var dataFineRichiesta = p.dataFine;\r\n    var oraInizioRichiesta = p.oraInizio || '08:00';\r\n    var oraFineRichiesta = p.oraFine || '22:00';\r\n    \r\n    // Logging dettagliato delle date di input\r\n    logDateDebug('checkDisponibilita', dataInizioRichiesta, 'DataInizioRichiesta');\r\n    logDateDebug('checkDisponibilita', dataFineRichiesta, 'DataFineRichiesta');\r\n    Logger.log('[checkDisponibilita] OraInizioRichiesta: ' + oraInizioRichiesta);\r\n    Logger.log('[checkDisponibilita] OraFineRichiesta: ' + oraFineRichiesta);\r\n    \r\n    if (!targa || !dataInizioRichiesta || !dataFineRichiesta) {\r\n      return createJsonResponse({\r\n        success: false,\r\n        message: 'Parametri mancanti: targa, dataInizio, dataFine richiesti'\r\n      }, 400);\r\n    }\r\n    \r\n    // Validazione fasce orarie\r\n    if (!isValidFasciaOraria(oraInizioRichiesta)) {\r\n      return createJsonResponse({\r\n        success: false,\r\n        message: 'Ora inizio non valida. Fasce ammesse: ' + FASCE_ORARIE.join(', ')\r\n      }, 400);\r\n    }\r\n    \r\n    if (!isValidFasciaOraria(oraFineRichiesta)) {\r\n      return createJsonResponse({\r\n        success: false,\r\n        message: 'Ora fine non valida. Fasce ammesse: ' + FASCE_ORARIE.join(', ')\r\n      }, 400);\r\n    }\r\n    \r\n    // Converti date richieste\r\n    var dtInizioRichiesta, dtFineRichiesta;\r\n    try {\r\n      dtInizioRichiesta = parseDateTimeString(dataInizioRichiesta, oraInizioRichiesta);\r\n      dtFineRichiesta = parseDateTimeString(dataFineRichiesta, oraFineRichiesta);\r\n    } catch(e) {\r\n      return createJsonResponse({\r\n        success: false,\r\n        message: 'Formato date non valido: ' + e.message\r\n      }, 400);\r\n    }\r\n    \r\n    // Validazione logica: data fine >= data inizio\r\n    if (dtFineRichiesta <= dtInizioRichiesta) {\r\n      return createJsonResponse({\r\n        success: false,\r\n        message: 'Data/ora fine deve essere successiva a data/ora inizio'\r\n      }, 400);\r\n    }\r\n    \r\n    // Normalizza date richieste per confronto con manutenzioni (solo giorno)\r\n    var dataInizioRichiestaNorm = normalizeDate(dtInizioRichiesta);\r\n    var dataFineRichiestaNorm = normalizeDate(dtFineRichiesta);\r\n    \r\n    // Recupera prenotazioni esistenti\r\n    var shPrenotazioni = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID)\r\n      .getSheetByName(CONFIG.SHEETS.PRENOTAZIONI);\r\n    var dataPrenotazioni = shPrenotazioni.getDataRange().getValues();\r\n    \r\n    var conflitti = [];\r\n    \r\n    // 1️⃣ CONTROLLA SOVRAPPOSIZIONI CON PRENOTAZIONI (con orari)\r\n    for (var i = 1; i < dataPrenotazioni.length; i++) {\r\n      var r = dataPrenotazioni[i];\r\n      var targaPrenotazione = r[CONFIG.PRENOTAZIONI_COLS.TARGA - 1];\n      var targaPrenKey = String(targaPrenotazione || '').replace(/\\s+/g, '').toUpperCase();\n      var statoPrenotazione = r[CONFIG.PRENOTAZIONI_COLS.STATO_PRENOTAZIONE - 1];\r\n      \r\n      // Skip se targa diversa o prenotazione non attiva\r\n      if (targaPrenKey !== targaKey) continue;\n      if (!statoPrenotazione || \r\n          statoPrenotazione === 'Rifiutata' || \r\n          statoPrenotazione === 'Completata' ||\r\n          statoPrenotazione === 'Annullata') {\r\n        continue;\r\n      }\r\n      \r\n      var dataInizioPrenotazione = r[CONFIG.PRENOTAZIONI_COLS.GIORNO_INIZIO - 1];\r\n      var dataFinePrenotazione = r[CONFIG.PRENOTAZIONI_COLS.GIORNO_FINE - 1];\r\n      var oraInizioPrenotazione = r[CONFIG.PRENOTAZIONI_COLS.ORA_INIZIO - 1] || '08:00';\r\n      var oraFinePrenotazione = r[CONFIG.PRENOTAZIONI_COLS.ORA_FINE - 1] || '22:00';\r\n      \r\n      // Logging dettagliato date prenotazione\r\n      logDateDebug('checkDisponibilita', dataInizioPrenotazione, 'DataInizioPrenotazione_' + i);\r\n      logDateDebug('checkDisponibilita', dataFinePrenotazione, 'DataFinePrenotazione_' + i);\r\n      Logger.log('[checkDisponibilita] Prenotazione riga ' + i + ' - OraInizio: ' + oraInizioPrenotazione + ' | OraFine: ' + oraFinePrenotazione);\r\n      \r\n      if (!dataInizioPrenotazione || !dataFinePrenotazione) continue;\r\n      \r\n      // Costruisci datetime completi per prenotazione esistente\r\n      var dtInizioPrenotazione, dtFinePrenotazione;\r\n      try {\r\n        dtInizioPrenotazione = parseDateTimeFromValues(dataInizioPrenotazione, oraInizioPrenotazione);\r\n        dtFinePrenotazione = parseDateTimeFromValues(dataFinePrenotazione, oraFinePrenotazione);\r\n        \r\n        // Logging dettagliato date parsegate\r\n        logDateDebug('checkDisponibilita', dtInizioPrenotazione, 'DtInizioPrenotazioneParsed_' + i);\r\n        logDateDebug('checkDisponibilita', dtFinePrenotazione, 'DtFinePrenotazioneParsed_' + i);\r\n      } catch(e) {\r\n        Logger.log('[checkDisponibilita] Errore parsing date prenotazione riga ' + (i+1) + ': ' + e.message);\r\n        continue;\r\n      }\r\n      \r\n      // LOGICA FASCIA SUCCESSIVA:\r\n      // Il veicolo diventa disponibile dalla fascia SUCCESSIVA alla riconsegna\r\n      var fasciaDisponibilita = fasciaSuccessiva(oraFinePrenotazione);\r\n      var dtDisponibilitaEffettiva = dtFinePrenotazione;\r\n      \r\n      if (fasciaDisponibilita) {\r\n        // Aggiorna l'orario di disponibilità alla fascia successiva\r\n        dtDisponibilitaEffettiva = parseDateTimeFromValues(dataFinePrenotazione, fasciaDisponibilita);\r\n      } else {\r\n        // Se riconsegna è alle 22:00, disponibile dal giorno dopo alle 08:00\r\n        var giornoSuccessivo = new Date(dtFinePrenotazione);\r\n        giornoSuccessivo.setDate(giornoSuccessivo.getDate() + 1);\r\n        dtDisponibilitaEffettiva = parseDateTimeFromValues(giornoSuccessivo, '08:00');\r\n      }\r\n      \r\n      // Controlla sovrapposizione: la nuova richiesta deve iniziare DOPO la disponibilità effettiva\r\n      if (dtInizioRichiesta < dtDisponibilitaEffettiva && dtFineRichiesta > dtInizioPrenotazione) {\r\n        conflitti.push({\r\n          tipo: 'prenotazione',\r\n          idPrenotazione: r[CONFIG.PRENOTAZIONI_COLS.ID_PRENOTAZIONE - 1] || '',\r\n          dataInizio: formatDateToItalian(dataInizioPrenotazione),\r\n          dataFine: formatDateToItalian(dataFinePrenotazione),\r\n          oraInizio: oraInizioPrenotazione,\r\n          oraFine: oraFinePrenotazione,\r\n          fasciaDisponibilita: fasciaDisponibilita || '08:00 (giorno successivo)',\r\n          stato: statoPrenotazione,\r\n          cliente: r[CONFIG.PRENOTAZIONI_COLS.NOME_AUTISTA_1 - 1] || ''\r\n        });\r\n      }\r\n    }\r\n    \r\n    // 2️⃣ CONTROLLA MANUTENZIONI (bloccano l'intero periodo, senza orari)\r\n    var shManutenzioni = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID)\r\n      .getSheetByName(CONFIG.SHEETS.MANUTENZIONI);\r\n    \r\n    if (shManutenzioni) {\r\n      var dataManutenzioni = shManutenzioni.getDataRange().getValues();\r\n      Logger.log('[checkDisponibilita] Controllo ' + (dataManutenzioni.length - 1) + ' righe manutenzioni per targa ' + targa);\r\n      \r\n      for (var j = 1; j < dataManutenzioni.length; j++) {\r\n        var m = dataManutenzioni[j];\n        var targaManutenzione = m[CONFIG.MANUTENZIONI_COLS.TARGA - 1];\n        var targaManKey = String(targaManutenzione || '').replace(/\\s+/g, '').toUpperCase();\n        var statoManutenzione = String(m[CONFIG.MANUTENZIONI_COLS.STATO - 1] || '').trim();\n        \r\n        Logger.log('[checkDisponibilita] Manutenzione riga ' + j + ' - Targa: ' + targaManutenzione + ' | Stato: \"' + statoManutenzione + '\"');\r\n        \r\n        if (targaManKey !== targaKey) continue;\n        if (!statoManutenzione || /^completata$/i.test(statoManutenzione)) {\n          Logger.log('[checkDisponibilita] Manutenzione riga ' + j + ' - Skip: completata o senza stato');\n          continue;\n        }\n        \r\n        var dataInizioManutenzione = m[CONFIG.MANUTENZIONI_COLS.DATA_INIZIO - 1];\r\n        var dataFineManutenzione = m[CONFIG.MANUTENZIONI_COLS.DATA_FINE - 1];\r\n        \r\n        Logger.log('[checkDisponibilita] Manutenzione riga ' + j + ' - Data Inizio: ' + dataInizioManutenzione + ' | Data Fine: ' + dataFineManutenzione);\r\n        \r\n        // Logging dettagliato date manutenzione\r\n        logDateDebug('checkDisponibilita', dataInizioManutenzione, 'DataInizioManutenzione_' + j);\r\n        logDateDebug('checkDisponibilita', dataFineManutenzione, 'DataFineManutenzione_' + j);\r\n        \r\n        if (!dataInizioManutenzione || !dataFineManutenzione) {\r\n          Logger.log('[checkDisponibilita] Manutenzione riga ' + j + ' - Skip: date mancanti');\r\n          continue;\r\n        }\r\n        \r\n        // MANUTENZIONI: normalizza solo la data (senza orari)\n        // Usa parsing robusto per formati italiani (gg/mm/aaaa) o ISO (yyyy-mm-dd)\n        var dtInizioManParsed = parseItalianOrISO(dataInizioManutenzione);\n        var dtFineManParsed = parseItalianOrISO(dataFineManutenzione);\n        var dtInizioManNorm = dtInizioManParsed ? normalizeDate(dtInizioManParsed) : null;\n        var dtFineManNorm = dtFineManParsed ? normalizeDate(dtFineManParsed) : null;\n        \r\n        Logger.log('[checkDisponibilita] Manutenzione riga ' + j + ' - Data Inizio norm: ' + dtInizioManNorm + ' | Data Fine norm: ' + dtFineManNorm);\r\n        \r\n        // Logging dettagliato normalizzazione manutenzioni\r\n        logDateDebug('checkDisponibilita', dtInizioManNorm, 'DataInizioManutenzioneNorm_' + j);\r\n        logDateDebug('checkDisponibilita', dtFineManNorm, 'DataFineManutenzioneNorm_' + j);\r\n        \r\n        Logger.log('[checkDisponibilita] Manutenzione riga ' + j + ' - Confronto: dataFineRich=' + dataFineRichiestaNorm.getTime() + ' < dtInizioMan=' + dtInizioManNorm.getTime() + ' || dataInizioRich=' + dataInizioRichiestaNorm.getTime() + ' > dtFineMan=' + dtFineManNorm.getTime());\r\n        \r\n        if (!dtInizioManNorm || !dtFineManNorm) {\r\n          Logger.log('[checkDisponibilita] Manutenzione riga ' + j + ' - Skip: errore normalizzazione date');\r\n          continue;\r\n        }\r\n        \r\n        // Controlla sovrapposizione a livello di GIORNATE (non orari)\r\n        // Se c'è anche solo UN giorno di sovrapposizione → conflitto\r\n        var sovrappone = !(dataFineRichiestaNorm < dtInizioManNorm || dataInizioRichiestaNorm > dtFineManNorm);\r\n        Logger.log('[checkDisponibilita] Manutenzione riga ' + j + ' - Sovrappone: ' + sovrappone);\r\n        \r\n        if (sovrappone) {\r\n          Logger.log('[checkDisponibilita] Conflitto manutenzione trovato: ' + formatDateToItalian(dataInizioManutenzione) + ' - ' + formatDateToItalian(dataFineManutenzione));\r\n          conflitti.push({\r\n            tipo: 'manutenzione',\r\n            dataInizio: formatDateToItalian(dataInizioManutenzione),\r\n            dataFine: formatDateToItalian(dataFineManutenzione),\r\n            stato: statoManutenzione,\r\n            note: m[CONFIG.MANUTENZIONI_COLS.NOTE - 1] || '',\r\n            descrizione: 'Veicolo in manutenzione per l\\'intero periodo'\r\n          });\r\n        }\r\n      }\r\n    }\r\n    \r\n    var disponibile = conflitti.length === 0;\r\n    \r\n    Logger.log('[checkDisponibilita] Targa ' + targa + ' - Disponibile: ' + disponibile + ' - Conflitti: ' + conflitti.length);\r\n    \r\n    return createJsonResponse({\r\n      success: true,\r\n      disponibile: disponibile,\r\n      targa: targa,\r\n      periodoRichiesto: {\r\n        dataInizio: dataInizioRichiesta,\r\n        dataFine: dataFineRichiesta,\r\n        oraInizio: oraInizioRichiesta,\r\n        oraFine: oraFineRichiesta\r\n      },\r\n      fasceOrarie: FASCE_ORARIE,\r\n      conflitti: conflitti,\r\n      message: disponibile \r\n        ? 'Veicolo disponibile per il periodo richiesto' \r\n        : 'Veicolo non disponibile - ' + conflitti.length + ' conflitto/i trovato/i'\r\n    });\r\n  } catch(err) {\r\n    Logger.log('[checkDisponibilita] Errore: ' + err.message);\r\n    return createJsonResponse({\r\n      success: false,\r\n      message: 'Errore verifica disponibilità: ' + err.message\r\n    }, 500);\r\n  }\r\n}\n\n/**\n * Verifica disponibilità per PIÙ targhe in un'unica chiamata.\n * Riduce tempi leggendo i fogli una sola volta e riutilizzando i dati.\n * Parametri: targhe (CSV), dataInizio, dataFine, oraInizio, oraFine\n */\nfunction bulkCheckDisponibilita(p){\n  try{\n    var targheParam = p.targhe || '';\n    var list = String(targheParam).split(',').map(function(t){ return String(t || '').trim(); }).filter(function(t){ return t.length > 0; });\n    var dataInizio = p.dataInizio;\n    var dataFine = p.dataFine;\n    var oraInizio = p.oraInizio || '08:00';\n    var oraFine = p.oraFine || '22:00';\n\n    if (!list.length || !dataInizio || !dataFine){\n      return createJsonResponse({ success:false, message:'Parametri mancanti: targhe, dataInizio, dataFine' }, 400);\n    }\n    if (!isValidFasciaOraria(oraInizio) || !isValidFasciaOraria(oraFine)){\n      return createJsonResponse({ success:false, message:'Fasce orarie non valide. Ammesse: ' + FASCE_ORARIE.join(', ') }, 400);\n    }\n\n    // Parse periodo richiesto\n    var dtInizio = parseDateTimeString(dataInizio, oraInizio);\n    var dtFine = parseDateTimeString(dataFine, oraFine);\n    if (dtFine <= dtInizio){\n      return createJsonResponse({ success:false, message:'Data/ora fine deve essere successiva a data/ora inizio' }, 400);\n    }\n    var diNorm = normalizeDate(dtInizio);\n    var dfNorm = normalizeDate(dtFine);\n\n    // Carica dati una sola volta\n    var sp = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);\n    var shP = sp.getSheetByName(CONFIG.SHEETS.PRENOTAZIONI);\n    var shM = sp.getSheetByName(CONFIG.SHEETS.MANUTENZIONI);\n    var dataPrenotazioni = shP ? shP.getDataRange().getValues() : [];\n    var dataManutenzioni = shM ? shM.getDataRange().getValues() : [];\n\n    // Funzione interna: verifica disponibilità per singola targa usando dataset pre-caricato\n    function disponibilePerTarga(targa){\n      var targaKey = String(targa || '').replace(/\\s+/g, '').toUpperCase();\n      var conflitto = false;\n\n      // Prenotazioni con orari e fascia successiva\n      for (var i = 1; i < dataPrenotazioni.length; i++){\n        var r = dataPrenotazioni[i];\n        var targaPren = r[CONFIG.PRENOTAZIONI_COLS.TARGA - 1];\n        var tKey = String(targaPren || '').replace(/\\s+/g, '').toUpperCase();\n        if (tKey !== targaKey) continue;\n        var stato = r[CONFIG.PRENOTAZIONI_COLS.STATO_PRENOTAZIONE - 1];\n        if (!stato || stato === 'Rifiutata' || stato === 'Completata' || stato === 'Annullata') continue;\n\n        var dIn = r[CONFIG.PRENOTAZIONI_COLS.GIORNO_INIZIO - 1];\n        var dFi = r[CONFIG.PRENOTAZIONI_COLS.GIORNO_FINE - 1];\n        var oIn = r[CONFIG.PRENOTAZIONI_COLS.ORA_INIZIO - 1] || '08:00';\n        var oFi = r[CONFIG.PRENOTAZIONI_COLS.ORA_FINE - 1] || '22:00';\n        if (!dIn || !dFi) continue;\n\n        var dtInPren = parseDateTimeFromValues(dIn, oIn);\n        var dtFiPren = parseDateTimeFromValues(dFi, oFi);\n\n        var fasciaDisp = fasciaSuccessiva(oFi);\n        var dtDispEff = dtFiPren;\n        if (fasciaDisp){\n          dtDispEff = parseDateTimeFromValues(dFi, fasciaDisp);\n        } else {\n          var giornoSucc = new Date(dtFiPren);\n          giornoSucc.setDate(giornoSucc.getDate() + 1);\n          dtDispEff = parseDateTimeFromValues(giornoSucc, '08:00');\n        }\n\n        // Conflitto se la richiesta inizia prima della disponibilità effettiva e finisce dopo l'inizio prenotazione\n        if (dtInizio < dtDispEff && dtFine > dtInPren){ conflitto = true; break; }\n      }\n\n      if (conflitto) return false;\n\n      // Manutenzioni: bloccano a livello di giorni\n      for (var j = 1; j < dataManutenzioni.length; j++){\n        var m = dataManutenzioni[j];\n        var tMan = m[CONFIG.MANUTENZIONI_COLS.TARGA - 1];\n        var tManKey = String(tMan || '').replace(/\\s+/g, '').toUpperCase();\n        if (tManKey !== targaKey) continue;\n        var statoMan = String(m[CONFIG.MANUTENZIONI_COLS.STATO - 1] || '').trim();\n        if (!statoMan || /^completata$/i.test(statoMan)) continue;\n        var diMan = m[CONFIG.MANUTENZIONI_COLS.DATA_INIZIO - 1];\n        var dfMan = m[CONFIG.MANUTENZIONI_COLS.DATA_FINE - 1];\n        if (!diMan || !dfMan) continue;\n\n        var diParsed = parseItalianOrISO(diMan);\n        var dfParsed = parseItalianOrISO(dfMan);\n        var diNormMan = diParsed ? normalizeDate(diParsed) : null;\n        var dfNormMan = dfParsed ? normalizeDate(dfParsed) : null;\n        if (!diNormMan || !dfNormMan) continue;\n        var sovrapp = !(dfNorm < diNormMan || diNorm > dfNormMan);\n        if (sovrapp) { conflitto = true; break; }\n      }\n\n      return !conflitto;\n    }\n\n    var results = list.map(function(t){ return { targa: t, disponibile: disponibilePerTarga(t) }; });\n    return createJsonResponse({ success:true, results: results, count: results.length });\n  }catch(err){\n    Logger.log('[bulkCheckDisponibilita] Errore: ' + err.message);\n    return createJsonResponse({ success:false, message:'Errore bulk check: ' + err.message }, 500);\n  }\n}\n\n/**\n * Trova la prima fascia oraria utile (più vicina) in cui\n * ALMENO un veicolo è disponibile per l'intero intervallo richiesto.\n * Parametri:\n *  - dataInizio, oraInizio: inizio richiesto (punto di partenza per la ricerca)\n *  - dataFine, oraFine: fine richiesta (intervallo da rispettare)\n *  - targhe: opzionale CSV di targhe da considerare; se assente, usa tutti i veicoli\n *  - maxDays: numero di giorni da scandire (default 2: oggi + domani)\n */\nfunction firstAvailableSlot(p){\n  try{\n    var dataInizio = p.dataInizio;\n    var oraInizio = p.oraInizio || '08:00';\n    var dataFine = p.dataFine || dataInizio;\n    var oraFine = p.oraFine || '22:00';\n    var maxDays = parseInt(p.maxDays || 2, 10);\n\n    if (!dataInizio || !dataFine){\n      return createJsonResponse({ success:false, message:'Parametri mancanti: dataInizio e dataFine sono richiesti' }, 400);\n    }\n    if (!isValidFasciaOraria(oraInizio) || !isValidFasciaOraria(oraFine)){\n      return createJsonResponse({ success:false, message:'Fasce orarie non valide. Ammesse: ' + FASCE_ORARIE.join(', ') }, 400);\n    }\n\n    // Parse intervallo da rispettare\n    var dtFine = parseDateTimeString(dataFine, oraFine);\n    var dtStartBase = parseDateTimeString(dataInizio, oraInizio);\n    if (dtFine <= dtStartBase){\n      return createJsonResponse({ success:false, message:'Data/ora fine deve essere successiva a data/ora inizio' }, 400);\n    }\n\n    // Carica dataset una sola volta\n    var sp = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);\n    var shP = sp.getSheetByName(CONFIG.SHEETS.PRENOTAZIONI);\n    var shM = sp.getSheetByName(CONFIG.SHEETS.MANUTENZIONI);\n    var shV = sp.getSheetByName(CONFIG.SHEETS.PULMINI);\n    var dataPrenotazioni = shP ? shP.getDataRange().getValues() : [];\n    var dataManutenzioni = shM ? shM.getDataRange().getValues() : [];\n\n    // Lista targhe da considerare\n    var targhe = [];\n    if (p.targhe){\n      targhe = String(p.targhe).split(',').map(function(t){ return String(t || '').trim(); }).filter(function(t){ return t.length > 0; });\n    } else if (shV){\n      var dataV = shV.getDataRange().getValues();\n      for (var i=1; i<dataV.length; i++){\n        var t = dataV[i][CONFIG.PULMINI_COLS.TARGA - 1];\n        if (t) targhe.push(String(t).trim());\n      }\n    }\n    if (!targhe.length){\n      return createJsonResponse({ success:false, message:'Nessuna targa da valutare' }, 400);\n    }\n\n    // Helper: verifica disponibilità per targa nel periodo [startSlot, dtFine]\n    function disponibileNelPeriodo(targa, startSlot){\n      var targaKey = String(targa || '').replace(/\\s+/g, '').toUpperCase();\n\n      // 1) Controlla prenotazioni attive con orari e fascia successiva\n      for (var i = 1; i < dataPrenotazioni.length; i++){\n        var r = dataPrenotazioni[i];\n        var targaPren = r[CONFIG.PRENOTAZIONI_COLS.TARGA - 1];\n        var tKey = String(targaPren || '').replace(/\\s+/g, '').toUpperCase();\n        if (tKey !== targaKey) continue;\n        var stato = r[CONFIG.PRENOTAZIONI_COLS.STATO_PRENOTAZIONE - 1];\n        if (!stato || stato === 'Rifiutata' || stato === 'Completata' || stato === 'Annullata') continue;\n\n        var dIn = r[CONFIG.PRENOTAZIONI_COLS.GIORNO_INIZIO - 1];\n        var dFi = r[CONFIG.PRENOTAZIONI_COLS.GIORNO_FINE - 1];\n        var oIn = r[CONFIG.PRENOTAZIONI_COLS.ORA_INIZIO - 1] || '08:00';\n        var oFi = r[CONFIG.PRENOTAZIONI_COLS.ORA_FINE - 1] || '22:00';\n        if (!dIn || !dFi) continue;\n\n        var dtInPren = parseDateTimeFromValues(dIn, oIn);\n        var dtFiPren = parseDateTimeFromValues(dFi, oFi);\n\n        // fascia successiva alla riconsegna\n        var fasciaDisp = fasciaSuccessiva(oFi);\n        var dtDispEff = dtFiPren;\n        if (fasciaDisp){\n          dtDispEff = parseDateTimeFromValues(dFi, fasciaDisp);\n        } else {\n          var giornoSucc = new Date(dtFiPren);\n          giornoSucc.setDate(giornoSucc.getDate() + 1);\n          dtDispEff = parseDateTimeFromValues(giornoSucc, '08:00');\n        }\n\n        // Conflitto se intervallo richiesto [startSlot, dtFine] interseca prenotazione e non rispetta disponibilità successiva\n        var interseca = !(dtFiPren <= startSlot || dtInPren >= dtFine);\n        if (interseca || dtDispEff > startSlot){\n          return false;\n        }\n      }\n\n      // 2) Controlla manutenzioni (bloccano intero giorno)\n      var startNorm = normalizeDate(startSlot);\n      var fineNorm = normalizeDate(dtFine);\n      for (var j = 1; j < dataManutenzioni.length; j++){\n        var m = dataManutenzioni[j];\n        var tMan = m[CONFIG.MANUTENZIONI_COLS.TARGA - 1];\n        var tKeyMan = String(tMan || '').replace(/\\s+/g, '').toUpperCase();\n        if (tKeyMan !== targaKey) continue;\n        var statoMan = m[CONFIG.MANUTENZIONI_COLS.STATO - 1];\n        if (!statoMan || statoMan === 'Completata') continue;\n        var dInMan = m[CONFIG.MANUTENZIONI_COLS.DATA_INIZIO - 1];\n        var dFiMan = m[CONFIG.MANUTENZIONI_COLS.DATA_FINE - 1];\n        if (!dInMan || !dFiMan) continue;\n        var di = normalizeDate(new Date(dInMan));\n        var df = normalizeDate(new Date(dFiMan));\n        var sovrapp = !(df < startNorm || di > fineNorm);\n        if (sovrapp){\n          return false;\n        }\n      }\n      return true;\n    }\n\n    // Scansione fasce: giorno corrente da oraInizio, poi giorni successivi interi\n    for (var d = 0; d < maxDays; d++){\n      var giorno = new Date(dtStartBase);\n      giorno.setDate(giorno.getDate() + d);\n      var times = FASCE_ORARIE.slice();\n      if (d === 0){\n        times = times.filter(function(t){ return t >= oraInizio; });\n      }\n\n      for (var k = 0; k < times.length; k++){\n        var orario = times[k];\n        var startSlot = parseDateTimeFromValues(giorno, orario);\n        if (startSlot >= dtFine) continue; // non ha senso iniziare dopo la fine\n\n        for (var x = 0; x < targhe.length; x++){\n          if (disponibileNelPeriodo(targhe[x], startSlot)){\n            dbg('[firstAvailableSlot] Slot trovato: ' + formatDateToItalian(startSlot) + ' ' + orario + ' - targa ' + targhe[x]);\n            return createJsonResponse({ success:true, found:true, slot:{ data: formatDateToItalian(startSlot), ora: orario, targa: targhe[x] } });\n          }\n        }\n      }\n    }\n\n    return createJsonResponse({ success:true, found:false, slot:null, message:'Nessuna fascia utile nei prossimi ' + maxDays + ' giorni' });\n  }catch(err){\n    dbg('[firstAvailableSlot] Errore: ' + err.message);\n    return createJsonResponse({ success:false, message:'Errore firstAvailableSlot: ' + err.message }, 500);\n  }\n}\n\n/**\n * Crea/Aggiorna veicolo nel foglio PULMINI.\n * Se esiste una riga con stessa targa, viene aggiornata; altrimenti aggiunta.\n * Payload: { targa, marca, modello, posti, stato, note }\n */\nfunction setVeicolo(post) {\n  try {\n    var targa = (post && post.targa) ? String(post.targa).trim().toUpperCase() : '';\n    var marca = (post && post.marca) ? String(post.marca).trim() : '';\n    var modello = (post && post.modello) ? String(post.modello).trim() : '';\n    var posti = (post && post.posti) ? parseInt(post.posti, 10) : 9;\n    var stato = (post && post.stato) ? String(post.stato).trim() : 'Disponibile';\n    var note = (post && post.note) ? String(post.note).trim() : '';\n    var row = (post && post.row) ? parseInt(post.row, 10) : 0; // opzionale: forzare aggiornamento riga\n\n    if (!targa) {\n      return createJsonResponse({ success: false, message: 'Targa obbligatoria' }, 400);\n    }\n\n    var sp = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);\n    var sh = sp.getSheetByName(CONFIG.SHEETS.PULMINI);\n    if (!sh) {\n      return createJsonResponse({ success: false, message: 'Foglio PULMINI non trovato' }, 500);\n    }\n\n    // Prepara i valori\n    var values = [];\n    values[CONFIG.PULMINI_COLS.TARGA - 1] = sanitizeSheetValue(targa);\n    values[CONFIG.PULMINI_COLS.MARCA - 1] = sanitizeSheetValue(marca);\n    values[CONFIG.PULMINI_COLS.MODELLO - 1] = sanitizeSheetValue(modello);\n    values[CONFIG.PULMINI_COLS.POSTI - 1] = posti || 9;\n    values[CONFIG.PULMINI_COLS.STATO - 1] = sanitizeSheetValue(stato || 'Disponibile');\n    values[CONFIG.PULMINI_COLS.NOTE - 1] = sanitizeSheetValue(note || '');\n\n    var updatedRow = 0;\n    var data = sh.getDataRange().getValues();\n    if (row && row > 1) {\n      // aggiornamento forzato a riga specificata\n      updatedRow = row;\n    } else {\n      // cerca per targa\n      for (var i = 1; i < data.length; i++) {\n        var tp = data[i][CONFIG.PULMINI_COLS.TARGA - 1];\n        if (tp && String(tp).toUpperCase().trim() === targa) { updatedRow = i + 1; break; }\n      }\n    }\n\n    var lastCol = CONFIG.PULMINI_COLS.NOTE;\n  if (updatedRow > 1) {\n    sh.getRange(updatedRow, 1, 1, lastCol).setValues([values]);\n    try { CacheService.getScriptCache().remove('GET_VEICOLI_V1'); } catch (_) {}\n    return createJsonResponse({ success: true, message: 'Veicolo aggiornato', data: { row: updatedRow, targa: targa } });\n  } else {\n    sh.appendRow(values);\n    var newRow = sh.getLastRow();\n    try { CacheService.getScriptCache().remove('GET_VEICOLI_V1'); } catch (_) {}\n    return createJsonResponse({ success: true, message: 'Veicolo aggiunto', data: { row: newRow, targa: targa } });\n  }\n  } catch (err) {\n    Logger.log('[setVeicolo] Errore: ' + err.message);\n    return createJsonResponse({ success: false, message: 'Errore salvataggio veicolo: ' + err.message }, 500);\n  }\n}\n\n/**\n * Elimina veicolo dal foglio PULMINI per targa (o riga se fornita).\n * Payload: { targa } | { row }\n */\nfunction eliminaVeicolo(post) {\n  try {\n    var targa = (post && post.targa) ? String(post.targa).trim().toUpperCase() : '';\n    var row = (post && post.row) ? parseInt(post.row, 10) : 0;\n    var sp = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);\n    var sh = sp.getSheetByName(CONFIG.SHEETS.PULMINI);\n    if (!sh) {\n      return createJsonResponse({ success: false, message: 'Foglio PULMINI non trovato' }, 500);\n    }\n\n    var targetRow = 0;\n    if (row && row > 1) {\n      targetRow = row;\n    } else if (targa) {\n      var data = sh.getDataRange().getValues();\n      for (var i = 1; i < data.length; i++) {\n        var tp = data[i][CONFIG.PULMINI_COLS.TARGA - 1];\n        if (tp && String(tp).toUpperCase().trim() === targa) { targetRow = i + 1; break; }\n      }\n    }\n\n    if (!targetRow || targetRow <= 1) {\n      return createJsonResponse({ success: false, message: 'Veicolo non trovato per eliminazione' }, 404);\n    }\n  sh.deleteRow(targetRow);\n  try { CacheService.getScriptCache().remove('GET_VEICOLI_V1'); } catch (_) {}\n  return createJsonResponse({ success: true, message: 'Veicolo eliminato', data: { row: targetRow, targa: targa } });\n  } catch (err) {\n    Logger.log('[eliminaVeicolo] Errore: ' + err.message);\n    return createJsonResponse({ success: false, message: 'Errore eliminazione veicolo: ' + err.message }, 500);\n  }\n}\n\r\n/**\r\n * Parse stringa data + ora in oggetto Date\r\n * @param {string} dateStr - Data in formato YYYY-MM-DD o DD/MM/YYYY\r\n * @param {string} timeStr - Ora in formato HH:MM\r\n * @return {Date} Oggetto Date\r\n */\r\nfunction parseDateTimeString(dateStr, timeStr) {\r\n  if (!dateStr) throw new Error('Data mancante');\r\n  if (!timeStr) timeStr = '08:00';\r\n  \r\n  // Rileva formato data (YYYY-MM-DD o DD/MM/YYYY)\r\n  var year, month, day;\r\n  \r\n  // Prova formato YYYY-MM-DD\r\n  if (dateStr.includes('-')) {\r\n    var dateParts = dateStr.split('-');\r\n    if (dateParts.length !== 3) throw new Error('Formato data non valido: ' + dateStr);\r\n    year = parseInt(dateParts[0], 10);\r\n    month = parseInt(dateParts[1], 10) - 1; // JS months are 0-indexed\r\n    day = parseInt(dateParts[2], 10);\r\n  }\r\n  // Prova formato DD/MM/YYYY\r\n  else if (dateStr.includes('/')) {\r\n    var dateParts = dateStr.split('/');\r\n    if (dateParts.length !== 3) throw new Error('Formato data non valido: ' + dateStr);\r\n    day = parseInt(dateParts[0], 10);\r\n    month = parseInt(dateParts[1], 10) - 1; // JS months are 0-indexed\r\n    year = parseInt(dateParts[2], 10);\r\n  } else {\r\n    throw new Error('Formato data non riconosciuto: ' + dateStr);\r\n  }\r\n  \r\n  // Validazione componenti data\r\n  if (isNaN(year) || isNaN(month) || isNaN(day)) {\r\n    throw new Error('Componenti data non valide: ' + dateStr);\r\n  }\r\n  \r\n  if (month < 0 || month > 11) {\r\n    throw new Error('Mese non valido: ' + (month + 1));\r\n  }\r\n  \r\n  if (day < 1 || day > 31) {\r\n    throw new Error('Giorno non valido: ' + day);\r\n  }\r\n  \r\n  // Parse ora HH:MM\r\n  var timeParts = timeStr.split(':');\r\n  if (timeParts.length !== 2) throw new Error('Formato ora non valido: ' + timeStr);\r\n  \r\n  var hours = parseInt(timeParts[0], 10);\r\n  var minutes = parseInt(timeParts[1], 10);\r\n  \r\n  // Validazione componenti ora\r\n  if (isNaN(hours) || isNaN(minutes)) {\r\n    throw new Error('Componenti ora non valide: ' + timeStr);\r\n  }\r\n  \r\n  if (hours < 0 || hours > 23) {\r\n    throw new Error('Ora non valida: ' + hours);\r\n  }\r\n  \r\n  if (minutes < 0 || minutes > 59) {\r\n    throw new Error('Minuti non validi: ' + minutes);\r\n  }\r\n  \r\n  // Crea data con timezone locale (evita problemi di conversione)\r\n  var result = new Date(year, month, day, hours, minutes, 0, 0);\r\n  \r\n  // Verifica che la data creata sia valida\r\n  if (isNaN(result.getTime())) {\r\n    throw new Error('Data creata non valida: ' + dateStr + ' ' + timeStr);\r\n  }\r\n  \r\n  // Verifica che i componenti corrispondano (per gestire casi limite come 31 febbraio)\r\n  if (result.getFullYear() !== year || result.getMonth() !== month || result.getDate() !== day) {\r\n    throw new Error('Data non valida (componenti non corrispondenti): ' + dateStr);\r\n  }\r\n  \r\n  return result;\r\n}\r\n\r\n/**\r\n * Parse Date object + stringa ora in oggetto Date completo\r\n * @param {Date|string} dateObj - Oggetto Date o stringa data\r\n * @param {string} timeStr - Ora in formato HH:MM\r\n * @return {Date} Oggetto Date con ora\r\n */\r\nfunction parseDateTimeFromValues(dateObj, timeStr) {\r\n  if (!dateObj) throw new Error('Data mancante');\r\n  \r\n  var parsedDate;\r\n  \r\n  // Se è stringa, converti in Date con gestione multi-formato\r\n  if (typeof dateObj === 'string') {\r\n    // Prova a parsare come YYYY-MM-DD\r\n    if (dateObj.includes('-')) {\r\n      var dateParts = dateObj.split('-');\r\n      if (dateParts.length === 3) {\r\n        var year = parseInt(dateParts[0], 10);\r\n        var month = parseInt(dateParts[1], 10) - 1;\r\n        var day = parseInt(dateParts[2], 10);\r\n        parsedDate = new Date(year, month, day);\r\n      }\r\n    }\r\n    // Prova a parsare come DD/MM/YYYY\r\n    else if (dateObj.includes('/')) {\r\n      var dateParts = dateObj.split('/');\r\n      if (dateParts.length === 3) {\r\n        var day = parseInt(dateParts[0], 10);\r\n        var month = parseInt(dateParts[1], 10) - 1;\r\n        var year = parseInt(dateParts[2], 10);\r\n        parsedDate = new Date(year, month, day);\r\n      }\r\n    }\r\n    \r\n    // Se non è riuscito a parsare, prova il costruttore standard\r\n    if (!parsedDate || isNaN(parsedDate.getTime())) {\r\n      parsedDate = new Date(dateObj);\r\n    }\r\n  } else if (dateObj instanceof Date) {\r\n    parsedDate = new Date(dateObj);\r\n  } else {\r\n    // Prova a convertire in Date\r\n    parsedDate = new Date(dateObj);\r\n  }\r\n  \r\n  if (!parsedDate || isNaN(parsedDate.getTime())) {\r\n    throw new Error('Data non valida: ' + dateObj);\r\n  }\r\n  \r\n  if (!timeStr) timeStr = '08:00';\r\n  \r\n  // Parse ora HH:MM con validazione\r\n  var timeParts = String(timeStr).split(':');\r\n  if (timeParts.length !== 2) throw new Error('Formato ora non valido: ' + timeStr);\r\n  \r\n  var hours = parseInt(timeParts[0], 10);\r\n  var minutes = parseInt(timeParts[1], 10);\r\n  \r\n  // Validazione componenti ora\r\n  if (isNaN(hours) || isNaN(minutes)) {\r\n    throw new Error('Componenti ora non valide: ' + timeStr);\r\n  }\r\n  \r\n  if (hours < 0 || hours > 23) {\r\n    throw new Error('Ora non valida: ' + hours);\r\n  }\r\n  \r\n  if (minutes < 0 || minutes > 59) {\r\n    throw new Error('Minuti non validi: ' + minutes);\r\n  }\r\n  \r\n  // Crea nuovo Date con ora specificata\r\n  var result = new Date(parsedDate);\r\n  result.setHours(hours, minutes, 0, 0);\r\n  \r\n  // Verifica che la data finale sia valida\r\n  if (isNaN(result.getTime())) {\r\n    throw new Error('Data/ora finale non valida: ' + dateObj + ' ' + timeStr);\r\n  }\r\n  \r\n  return result;\r\n}\r\n",
      "size": 43682,
      "lines": 1063
    },
    "backend/ManutenzioniService.gs": {
      "content": "/**\n * SERVIZIO GESTIONE MANUTENZIONI\n * \n * Gestisce manutenzioni veicoli e aggiornamento stati\n */\n\n/**\n * Crea/Aggiorna una manutenzione nel foglio MANUTENZIONI.\n * Se viene passato post.row (>1) aggiorna la riga specificata,\n * altrimenti aggiunge una nuova manutenzione in coda.\n *\n * Payload atteso:\n * - targa (string) [obbligatorio]\n * - stato (string) es. \"Programmata\" | \"In corso\" | \"Completata\"\n * - dataInizio (string gg/mm/aaaa) [obbligatorio]\n * - dataFine (string gg/mm/aaaa) [obbligatorio]\n * - costo (number/string opzionale)\n * - note (string opzionale)\n * - marca, modello, posti (opzionali; se assenti si tenta lookup da PULMINI)\n * - row (number opzionale; se presente aggiorna quella riga)\n */\nfunction setManutenzione(post) {\n  try {\n    var targa = (post && post.targa) ? String(post.targa).trim().toUpperCase() : '';\n    var stato = (post && post.stato) ? String(post.stato).trim() : '';\n    var dataInizioStr = (post && post.dataInizio) ? String(post.dataInizio).trim() : '';\n    var dataFineStr = (post && post.dataFine) ? String(post.dataFine).trim() : '';\n    var costo = (post && typeof post.costo !== 'undefined') ? post.costo : '';\n    var note = (post && post.note) ? String(post.note).trim() : '';\n    var marca = (post && post.marca) ? String(post.marca).trim() : '';\n    var modello = (post && post.modello) ? String(post.modello).trim() : '';\n    var posti = (post && post.posti) ? parseInt(post.posti, 10) : '';\n    var row = (post && post.row) ? parseInt(post.row, 10) : 0;\n\n    if (!targa || !dataInizioStr || !dataFineStr) {\n      return createJsonResponse({\n        success: false,\n        message: 'Parametri obbligatori mancanti: targa, dataInizio, dataFine'\n      }, 400);\n    }\n\n    // Converte \"gg/mm/aaaa\" in Date per scrittura corretta sullo Sheet\n    function parseDateIT(s) {\n      try {\n        var parts = String(s).split('/');\n        var gg = parseInt(parts[0], 10);\n        var mm = parseInt(parts[1], 10) - 1;\n        var aaaa = parseInt(parts[2], 10);\n        return new Date(aaaa, mm, gg);\n      } catch (e) {\n        return new Date(s);\n      }\n    }\n\n    var dataInizio = parseDateIT(dataInizioStr);\n    var dataFine = parseDateIT(dataFineStr);\n\n    var sp = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);\n    var shM = sp.getSheetByName(CONFIG.SHEETS.MANUTENZIONI);\n    if (!shM) {\n      return createJsonResponse({ success: false, message: 'Foglio MANUTENZIONI non trovato' }, 500);\n    }\n\n    // Se marca/modello/posti non sono forniti, prova a ricavarli da PULMINI\n    if (!marca || !modello || !posti) {\n      try {\n        var shP = sp.getSheetByName(CONFIG.SHEETS.PULMINI);\n        if (shP) {\n          var dataP = shP.getDataRange().getValues();\n          for (var i = 1; i < dataP.length; i++) {\n            var rp = dataP[i];\n            var tp = rp[CONFIG.PULMINI_COLS.TARGA - 1];\n            if (tp && String(tp).toUpperCase().trim() === targa) {\n              marca = marca || (rp[CONFIG.PULMINI_COLS.MARCA - 1] || '');\n              modello = modello || (rp[CONFIG.PULMINI_COLS.MODELLO - 1] || '');\n              posti = posti || (parseInt(rp[CONFIG.PULMINI_COLS.POSTI - 1], 10) || 9);\n              break;\n            }\n          }\n        }\n      } catch (e) {\n        // Ignora errori lookup, i campi restano vuoti\n      }\n    }\n\n    var values = [];\n    values[CONFIG.MANUTENZIONI_COLS.TARGA - 1] = sanitizeSheetValue(targa);\n    values[CONFIG.MANUTENZIONI_COLS.MARCA - 1] = sanitizeSheetValue(marca);\n    values[CONFIG.MANUTENZIONI_COLS.MODELLO - 1] = sanitizeSheetValue(modello);\n    values[CONFIG.MANUTENZIONI_COLS.POSTI - 1] = posti || 9;\n    values[CONFIG.MANUTENZIONI_COLS.STATO - 1] = sanitizeSheetValue(stato || 'Programmata');\n    values[CONFIG.MANUTENZIONI_COLS.DATA_INIZIO - 1] = dataInizio;\n    values[CONFIG.MANUTENZIONI_COLS.DATA_FINE - 1] = dataFine;\n    values[CONFIG.MANUTENZIONI_COLS.COSTO - 1] = costo || '';\n    values[CONFIG.MANUTENZIONI_COLS.NOTE - 1] = sanitizeSheetValue(note || '');\n\n    if (row && row > 1) {\n      // Aggiorna la riga esistente\n      var lastCol = Math.max(\n        CONFIG.MANUTENZIONI_COLS.NOTE,\n        CONFIG.MANUTENZIONI_COLS.COSTO,\n        CONFIG.MANUTENZIONI_COLS.DATA_FINE\n      );\n      shM.getRange(row, 1, 1, lastCol).setValues([values]);\n      return createJsonResponse({ success: true, message: 'Manutenzione aggiornata', data: { row: row, targa: targa } });\n    } else {\n      // Tentativo di aggiornamento per match targa + periodo se fornito\n      var matchInizioStr = (post && (post.matchDataInizio || post.matchInizio)) ? String(post.matchDataInizio || post.matchInizio) : '';\n      var matchFineStr = (post && (post.matchDataFine || post.matchFine)) ? String(post.matchDataFine || post.matchFine) : '';\n      if (matchInizioStr && matchFineStr) {\n        var dataVals = shM.getDataRange().getValues();\n        var foundRow = 0;\n        for (var r = 1; r < dataVals.length; r++) {\n          var rt = String(dataVals[r][CONFIG.MANUTENZIONI_COLS.TARGA - 1] || '').trim().toUpperCase();\n          var rdi = dataVals[r][CONFIG.MANUTENZIONI_COLS.DATA_INIZIO - 1];\n          var rdf = dataVals[r][CONFIG.MANUTENZIONI_COLS.DATA_FINE - 1];\n          var rdiStr = (rdi instanceof Date) ? formatDateToItalian(rdi) : String(rdi || '');\n          var rdfStr = (rdf instanceof Date) ? formatDateToItalian(rdf) : String(rdf || '');\n          if (rt === targa && rdiStr === matchInizioStr && rdfStr === matchFineStr) { foundRow = r + 1; break; }\n        }\n        if (foundRow) {\n          var lastC = Math.max(CONFIG.MANUTENZIONI_COLS.NOTE, CONFIG.MANUTENZIONI_COLS.COSTO, CONFIG.MANUTENZIONI_COLS.DATA_FINE);\n          shM.getRange(foundRow, 1, 1, lastC).setValues([values]);\n          return createJsonResponse({ success: true, message: 'Manutenzione aggiornata', data: { row: foundRow, targa: targa } });\n        }\n      }\n      // Aggiungi nuova riga in coda\n      shM.appendRow(values);\n      var newRow = shM.getLastRow();\n      return createJsonResponse({ success: true, message: 'Manutenzione aggiunta', data: { row: newRow, targa: targa } });\n    }\n  } catch (err) {\n    Logger.log('[setManutenzione] Errore: ' + err.message);\n    return createJsonResponse({ success: false, message: 'Errore salvataggio manutenzione: ' + err.message }, 500);\n  }\n}\n\n/**\n * Elimina una manutenzione esistente dal foglio MANUTENZIONI.\n * Parametri accettati: { targa, dataInizio, dataFine } oppure { row }\n */\nfunction eliminaManutenzione(post){\n  try{\n    var sp = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);\n    var shM = sp.getSheetByName(CONFIG.SHEETS.MANUTENZIONI);\n    if (!shM) return createJsonResponse({ success:false, message:'Foglio MANUTENZIONI non trovato' }, 500);\n    var row = (post && post.row) ? parseInt(post.row,10) : 0;\n    if (row && row > 1){ shM.deleteRow(row); return createJsonResponse({ success:true, message:'Manutenzione eliminata', data:{ row: row } }); }\n    var targa = (post && post.targa) ? String(post.targa).trim().toUpperCase() : '';\n    var di = (post && (post.dataInizio||post.matchDataInizio)) ? String(post.dataInizio||post.matchDataInizio) : '';\n    var df = (post && (post.dataFine||post.matchDataFine)) ? String(post.dataFine||post.matchDataFine) : '';\n    if (!targa || !di || !df) return createJsonResponse({ success:false, message:'Parametri mancanti: targa, dataInizio, dataFine' }, 400);\n    var dataVals = shM.getDataRange().getValues();\n    var targetRow = 0;\n    for (var r=1; r<dataVals.length; r++){\n      var rt = String(dataVals[r][CONFIG.MANUTENZIONI_COLS.TARGA - 1] || '').trim().toUpperCase();\n      var rdi = dataVals[r][CONFIG.MANUTENZIONI_COLS.DATA_INIZIO - 1];\n      var rdf = dataVals[r][CONFIG.MANUTENZIONI_COLS.DATA_FINE - 1];\n      var rdiStr = (rdi instanceof Date) ? formatDateToItalian(rdi) : String(rdi||'');\n      var rdfStr = (rdf instanceof Date) ? formatDateToItalian(rdf) : String(rdf||'');\n      if (rt===targa && rdiStr===di && rdfStr===df){ targetRow = r+1; break; }\n    }\n    if (!targetRow) return createJsonResponse({ success:false, message:'Voce manutenzione non trovata' }, 404);\n    shM.deleteRow(targetRow);\n    return createJsonResponse({ success:true, message:'Manutenzione eliminata', data:{ row: targetRow, targa: targa } });\n  }catch(err){\n    Logger.log('[eliminaManutenzione] Errore: '+err.message);\n    return createJsonResponse({ success:false, message:'Errore eliminazione manutenzione: '+err.message }, 500);\n  }\n}\n",
      "size": 8434,
      "lines": 171
    },
    "backend/EmailService.gs": {
      "content": "/**\r\n * SERVIZIO INVIO EMAIL\r\n * \r\n * Gestisce invio email (conferma, reminder, approvazione)\r\n */\r\n\r\n/**\r\n * Invia email di conferma ricezione prenotazione al cliente\r\n * @param {Object} prenotazione - Dati prenotazione\r\n */\r\nfunction inviaEmailConfermaCliente(prenotazione) {\r\n  try {\r\n    var html = UrlFetchApp.fetch('https://raw.githubusercontent.com/xDren98/imbriani-stefano-noleggio/main/email-template-conferma.html').getContentText();\r\n    \r\n    html = html.replace('{{ID_PRENOTAZIONE}}', prenotazione.idPrenotazione || 'N/A')\r\n               .replace('{{TARGA}}', prenotazione.targa || 'N/A')\r\n               .replace('{{MODELLO}}', prenotazione.modello || '')\r\n               .replace('{{GIORNO_INIZIO}}', prenotazione.giornoInizio ? new Date(prenotazione.giornoInizio).toLocaleDateString('it-IT') : '')\r\n               .replace('{{GIORNO_FINE}}', prenotazione.giornoFine ? new Date(prenotazione.giornoFine).toLocaleDateString('it-IT') : '')\r\n               .replace('{{ORA_INIZIO}}', prenotazione.oraInizio || '')\r\n               .replace('{{ORA_FINE}}', prenotazione.oraFine || '')\r\n               .replace('{{DESTINAZIONE}}', prenotazione.destinazione || '---')\r\n               .replace('{{AUTISTA_NOME}}', prenotazione.autista1 && prenotazione.autista1.nomeCompleto ? prenotazione.autista1.nomeCompleto : 'Cliente');\r\n    \r\n    MailApp.sendEmail({\r\n      to: prenotazione.email,\r\n      subject: 'Conferma Prenotazione - Imbriani Stefano Noleggio',\r\n      htmlBody: html,\r\n      name: CONFIG.EMAIL.FROM_NAME\r\n    });\r\n    \r\n    Logger.log('[inviaEmailConfermaCliente] Email inviata a: ' + prenotazione.email);\r\n  } catch (error) {\r\n    Logger.log('[inviaEmailConfermaCliente] Errore: ' + error.message);\r\n  }\r\n}\r\n\r\n/**\r\n * Invia email di approvazione preventivo al cliente\r\n * @param {Object} prenotazione - Dati prenotazione\r\n */\r\nfunction inviaEmailConfermaPreventivo(prenotazione) {\r\n  try {\r\n    var html = UrlFetchApp.fetch('https://raw.githubusercontent.com/xDren98/imbriani-stefano-noleggio/main/email-template-approvazione.html').getContentText();\r\n    \r\n    html = html.replace('{{ID_PRENOTAZIONE}}', prenotazione.idPrenotazione || 'N/A')\r\n               .replace('{{TARGA}}', prenotazione.targa || 'N/A')\r\n               .replace('{{MODELLO}}', prenotazione.modello || '')\r\n               .replace('{{GIORNO_INIZIO}}', prenotazione.giornoInizio ? new Date(prenotazione.giornoInizio).toLocaleDateString('it-IT') : '')\r\n               .replace('{{GIORNO_FINE}}', prenotazione.giornoFine ? new Date(prenotazione.giornoFine).toLocaleDateString('it-IT') : '')\r\n               .replace('{{ORA_INIZIO}}', prenotazione.oraInizio || '')\r\n               .replace('{{ORA_FINE}}', prenotazione.oraFine || '')\r\n               .replace('{{DESTINAZIONE}}', prenotazione.destinazione || '---')\r\n               .replace('{{AUTISTA_NOME}}', prenotazione.autista1 && prenotazione.autista1.nomeCompleto ? prenotazione.autista1.nomeCompleto : 'Cliente');\r\n    \r\n    MailApp.sendEmail({\r\n      to: prenotazione.email,\r\n      subject: 'Prenotazione Confermata - Imbriani Stefano Noleggio',\r\n      htmlBody: html,\r\n      name: CONFIG.EMAIL.FROM_NAME\r\n    });\r\n    \r\n    Logger.log('[inviaEmailConfermaPreventivo] Email inviata a: ' + prenotazione.email);\r\n  } catch (error) {\r\n    Logger.log('[inviaEmailConfermaPreventivo] Errore: ' + error.message);\r\n  }\r\n}\r\n\r\n/**\r\n * Invia email reminder 3 giorni prima della partenza\r\n * @param {Object} prenotazione - Dati prenotazione\r\n */\r\nfunction inviaEmailReminder(prenotazione) {\r\n  try {\r\n    var html = UrlFetchApp.fetch('https://raw.githubusercontent.com/xDren98/imbriani-stefano-noleggio/main/email-template-reminder.html').getContentText();\r\n    \r\n    html = html.replace('{{ID_PRENOTAZIONE}}', prenotazione.idPrenotazione || 'N/A')\r\n               .replace('{{TARGA}}', prenotazione.targa || 'N/A')\r\n               .replace('{{MODELLO}}', prenotazione.modello || '')\r\n               .replace('{{GIORNO_INIZIO}}', prenotazione.giornoInizio ? new Date(prenotazione.giornoInizio).toLocaleDateString('it-IT') : '')\r\n               .replace('{{GIORNO_FINE}}', prenotazione.giornoFine ? new Date(prenotazione.giornoFine).toLocaleDateString('it-IT') : '')\r\n               .replace('{{ORA_INIZIO}}', prenotazione.oraInizio || '')\r\n               .replace('{{ORA_FINE}}', prenotazione.oraFine || '')\r\n               .replace('{{DESTINAZIONE}}', prenotazione.destinazione || '---')\r\n               .replace('{{AUTISTA_NOME}}', prenotazione.autista1 && prenotazione.autista1.nomeCompleto ? prenotazione.autista1.nomeCompleto : 'Cliente');\r\n    \r\n    MailApp.sendEmail({\r\n      to: prenotazione.email,\r\n      subject: 'Promemoria Partenza - Imbriani Stefano Noleggio',\r\n      htmlBody: html,\r\n      name: CONFIG.EMAIL.FROM_NAME\r\n    });\r\n    \r\n    Logger.log('[inviaEmailReminder] Email inviata a: ' + prenotazione.email);\r\n  } catch (error) {\r\n    Logger.log('[inviaEmailReminder] Errore: ' + error.message);\r\n  }\r\n}\r\n\r\n/**\r\n * Controlla prenotazioni e invia reminder 3 giorni prima\r\n * @return {ContentService} Risposta JSON con numero email inviate\r\n */\r\nfunction checkReminderEmails() {\r\n  try {\r\n    var oggi = new Date();\r\n    var treGiorni = new Date(oggi.getTime() + (3 * 24 * 60 * 60 * 1000));\r\n    var y = treGiorni.getFullYear();\r\n    var m = String(treGiorni.getMonth() + 1).padStart(2, '0');\r\n    var d = String(treGiorni.getDate()).padStart(2, '0');\r\n    var treGiorniStr = y + '-' + m + '-' + d;\r\n    \r\n    var sh = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID)\r\n      .getSheetByName(CONFIG.SHEETS.PRENOTAZIONI);\r\n    var data = sh.getDataRange().getValues();\r\n    var sent = 0;\r\n    \r\n    for (var i = 1; i < data.length; i++) {\r\n      var row = data[i];\r\n      var stato = String(row[CONFIG.PRENOTAZIONI_COLS.STATO_PRENOTAZIONE - 1] || '');\r\n      var dataInizio = row[CONFIG.PRENOTAZIONI_COLS.GIORNO_INIZIO - 1];\r\n      var email = row[CONFIG.PRENOTAZIONI_COLS.EMAIL - 1];\r\n      \r\n      if (stato === 'Confermata' && email && dataInizio) {\r\n        var di = (dataInizio instanceof Date) ? dataInizio : parseItalianOrISO(dataInizio);\n        var diStr = di.getFullYear() + '-' + String(di.getMonth() + 1).padStart(2, '0') + '-' + String(di.getDate()).padStart(2, '0');\n        \r\n        if (diStr === treGiorniStr) {\r\n          var prenotazione = {\r\n            idPrenotazione: row[CONFIG.PRENOTAZIONI_COLS.ID_PRENOTAZIONE - 1],\r\n            targa: row[CONFIG.PRENOTAZIONI_COLS.TARGA - 1],\r\n            giornoInizio: dataInizio,\r\n            giornoFine: row[CONFIG.PRENOTAZIONI_COLS.GIORNO_FINE - 1],\r\n            oraInizio: row[CONFIG.PRENOTAZIONI_COLS.ORA_INIZIO - 1],\r\n            oraFine: row[CONFIG.PRENOTAZIONI_COLS.ORA_FINE - 1],\r\n            destinazione: row[CONFIG.PRENOTAZIONI_COLS.DESTINAZIONE - 1],\r\n            email: email,\r\n            autista1: { nomeCompleto: row[CONFIG.PRENOTAZIONI_COLS.NOME_AUTISTA_1 - 1] }\r\n          };\r\n          \r\n          try {\r\n            inviaEmailReminder(prenotazione);\r\n            sent++;\r\n          } catch (e) {\r\n            Logger.log('[checkReminderEmails] Errore invio email a ' + email + ': ' + e.message);\r\n          }\r\n        }\r\n      }\r\n    }\r\n    \r\n    return createJsonResponse({\r\n      success: true,\r\n      message: 'Check reminder completato',\r\n      emailInviate: sent\r\n    });\r\n  } catch (err) {\r\n    return createJsonResponse({\r\n      success: false,\r\n      message: 'Errore check reminder: ' + err.message\r\n    }, 500);\r\n  }\r\n}\r\n\r\n/**\r\n * Test email conferma cliente\r\n * @param {string} email - Email destinatario test\r\n * @return {ContentService} Risposta JSON\r\n */\r\nfunction testEmailConferma(email) {\r\n  var destinatario = email || 'melloanto@icloud.com';\r\n  var prenotazioneDemo = {\r\n    idPrenotazione: 'BOOK-2025-TEST',\r\n    targa: 'EC787NM',\r\n    modello: 'Mercedes Sprinter 9 Posti',\r\n    giornoInizio: new Date(2025, 10, 15),\r\n    giornoFine: new Date(2025, 10, 18),\r\n    oraInizio: '09:00',\r\n    oraFine: '18:00',\r\n    destinazione: 'Roma - Tour Colosseo e Vaticano',\r\n    email: destinatario,\r\n    autista1: { nomeCompleto: 'Mario Rossi' }\r\n  };\r\n  \r\n  try {\r\n    inviaEmailConfermaCliente(prenotazioneDemo);\r\n    return createJsonResponse({\r\n      success: true,\r\n      message: 'Email conferma test inviata a ' + destinatario\r\n    });\r\n  } catch (error) {\r\n    return createJsonResponse({\r\n      success: false,\r\n      message: 'Errore: ' + error.message\r\n    }, 500);\r\n  }\r\n}\r\n\r\n/**\r\n * Test email reminder\r\n * @param {string} email - Email destinatario test\r\n * @return {ContentService} Risposta JSON\r\n */\r\nfunction testEmailReminder(email) {\r\n  var destinatario = email || 'melloanto@icloud.com';\r\n  var prenotazioneDemo = {\r\n    idPrenotazione: 'BOOK-2025-REMINDER',\r\n    targa: 'FG123AB',\r\n    modello: 'Fiat Ducato Passo Lungo',\r\n    giornoInizio: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000),\r\n    giornoFine: new Date(Date.now() + 6 * 24 * 60 * 60 * 1000),\r\n    oraInizio: '10:00',\r\n    oraFine: '17:00',\r\n    destinazione: 'Napoli - Matrimonio',\r\n    email: destinatario,\r\n    autista1: { nomeCompleto: 'Luigi Verdi' }\r\n  };\r\n  \r\n  try {\r\n    inviaEmailReminder(prenotazioneDemo);\r\n    return createJsonResponse({\r\n      success: true,\r\n      message: 'Email reminder test inviata a ' + destinatario\r\n    });\r\n  } catch (error) {\r\n    return createJsonResponse({\r\n      success: false,\r\n      message: 'Errore: ' + error.message\r\n    }, 500);\r\n  }\r\n}\r\n\r\n/**\r\n * Test email conferma preventivo\r\n * @param {string} email - Email destinatario test\r\n * @return {ContentService} Risposta JSON\r\n */\r\nfunction testEmailConfermaPreventivo(email) {\r\n  var destinatario = email || 'melloanto@icloud.com';\r\n  var demo = {\r\n    idPrenotazione: 'BOOK-2025-CONF',\r\n    targa: 'BW123XY',\r\n    modello: 'Opel Vivaro',\r\n    giornoInizio: new Date(2025, 10, 22),\r\n    giornoFine: new Date(2025, 10, 23),\r\n    oraInizio: '08:00',\r\n    oraFine: '19:00',\r\n    destinazione: 'Firenze - Meeting',\r\n    email: destinatario,\r\n    autista1: { nomeCompleto: 'Antonio Bianchi' }\r\n  };\r\n  \r\n  try {\r\n    inviaEmailConfermaPreventivo(demo);\r\n    return createJsonResponse({\r\n      success: true,\r\n      message: 'Email conferma preventivo test inviata a ' + destinatario\r\n    });\r\n  } catch (error) {\r\n    return createJsonResponse({\r\n      success: false,\r\n      message: 'Errore: ' + error.message\r\n    }, 500);\r\n  }\r\n}\r\n\r\n/**\r\n * Setup trigger giornaliero per reminder automatici\r\n * Esegue alle 09:00 ogni giorno\r\n */\r\nfunction setupDailyTrigger() {\r\n  var triggers = ScriptApp.getProjectTriggers();\r\n  \r\n  // Rimuovi trigger esistenti\r\n  for (var i = 0; i < triggers.length; i++) {\r\n    if (triggers[i].getHandlerFunction() === 'dailyReminderCheck') {\r\n      ScriptApp.deleteTrigger(triggers[i]);\r\n    }\r\n  }\r\n  \r\n  // Crea nuovo trigger\r\n  ScriptApp.newTrigger('dailyReminderCheck')\r\n    .timeBased()\r\n    .everyDays(1)\r\n    .atHour(9)\r\n    .create();\r\n  \r\n  Logger.log('[setupDailyTrigger] Trigger giornaliero configurato per le 09:00');\r\n}\r\n\r\n/**\r\n * Funzione eseguita dal trigger giornaliero\r\n * Controlla reminder e aggiorna stati\r\n */\r\nfunction dailyReminderCheck() {\r\n  try {\r\n    checkReminderEmails();\r\n    updateStatiLive();\r\n    Logger.log('[dailyReminderCheck] Check giornaliero completato: ' + new Date().toISOString());\r\n  } catch (error) {\r\n    Logger.log('[dailyReminderCheck] Errore nel check giornaliero: ' + error.message);\r\n  }\r\n}\r\n",
      "size": 11380,
      "lines": 303
    },
    "backend/TelegramService.gs": {
      "content": "/**\r\n * SERVIZIO NOTIFICHE TELEGRAM\r\n * \r\n * Invia notifiche Telegram per nuove prenotazioni\r\n */\r\n\r\n/**\r\n * Invia notifica Telegram per nuova prenotazione\r\n * @param {Object} pren - Dati prenotazione\r\n */\r\nfunction inviaNotificaTelegram(pren) {\n  try {\n    if (!CONFIG.TELEGRAM.BOT_TOKEN || !CONFIG.TELEGRAM.CHAT_ID) { Logger.log('[inviaNotificaTelegram] Config Telegram mancante, skip invio'); return; }\n    var msg = [\r\n      '🚐 NUOVA PRENOTAZIONE IN ATTESA',\r\n      '',\r\n      '📋 Riepilogo:',\r\n      '🚗 Veicolo: ' + (pren.targa || '-'),\r\n      '📅 Dal: ' + (pren.giornoInizio || '-') + ' ' + (pren.oraInizio || '-'),\r\n      '📅 Al: ' + (pren.giornoFine || '-') + ' ' + (pren.oraFine || '-'),\r\n      '📍 Destinazione: ' + (pren.destinazione || 'Non specificata'),\r\n      '',\r\n      '👤 Autista principale:',\r\n      '👨‍💼 ' + (pren.autista1 && pren.autista1.nomeCompleto || '-'),\r\n      '🆔 ' + (pren.autista1 && pren.autista1.codiceFiscale || '-'),\r\n      '📱 ' + (pren.autista1 && pren.autista1.cellulare || '-'),\r\n      '📧 ' + (pren.email || 'Non fornita'),\r\n      '',\r\n      '⏰ Ricevuta: ' + new Date().toLocaleString('it-IT'),\r\n      '🔄 Stato: In attesa',\r\n      '',\r\n      'Accedi alla dashboard per confermare.'\r\n    ].join('\\n');\r\n    \r\n    var url = 'https://api.telegram.org/bot' + CONFIG.TELEGRAM.BOT_TOKEN + '/sendMessage';\r\n    var payload = {\r\n      chat_id: CONFIG.TELEGRAM.CHAT_ID,\r\n      text: msg,\r\n      parse_mode: 'Markdown'\r\n    };\r\n    \r\n    UrlFetchApp.fetch(url, {\r\n      method: 'post',\r\n      contentType: 'application/json',\r\n      payload: JSON.stringify(payload)\r\n    });\r\n    \r\n    Logger.log('[inviaNotificaTelegram] Notifica inviata per: ' + (pren.autista1 && pren.autista1.nomeCompleto));\r\n  } catch(e) {\n    Logger.log('[inviaNotificaTelegram] Errore: ' + (e && e.message));\n  }\n}\n\n/**\n * Invia OTP admin via Telegram\n * @param {string} name - Nome admin\n * @param {string} code - Codice OTP\n */\nfunction inviaOTPAdmin(name, code){\n  try{\n    if (!CONFIG.TELEGRAM.BOT_TOKEN || !CONFIG.TELEGRAM.CHAT_ID) { Logger.log('[inviaOTPAdmin] Config Telegram mancante, skip invio'); return; }\n    var ttlMin = CONFIG && CONFIG.SECURITY && CONFIG.SECURITY.OTP_TTL_MINUTES ? CONFIG.SECURITY.OTP_TTL_MINUTES : 5;\n    var msg = [\n      '🔐 OTP Admin — Imbriani Noleggio',\n      '👤 ' + (name || 'Admin'),\n      '🔢 OTP: ' + code,\n      '⏳ Valido per ' + ttlMin + ' minuti'\n    ].join('\\n');\n    var url = 'https://api.telegram.org/bot' + CONFIG.TELEGRAM.BOT_TOKEN + '/sendMessage';\n    var payload = { chat_id: CONFIG.TELEGRAM.CHAT_ID, text: msg };\n    var resp = UrlFetchApp.fetch(url, { method:'post', contentType:'application/json', payload: JSON.stringify(payload), muteHttpExceptions:true });\n    var txt = resp.getContentText();\n    try{\n      var obj = JSON.parse(txt);\n      if (obj && obj.ok && obj.result && obj.result.message_id){\n        var chatId = obj.result.chat && obj.result.chat.id ? obj.result.chat.id : CONFIG.TELEGRAM.CHAT_ID;\n        var key = 'OTPMSG:'+name;\n        var existing = PropertiesService.getScriptProperties().getProperty(key);\n        var data = null;\n        try{ data = existing ? JSON.parse(existing) : null; }catch(_){ data = null; }\n        if (data && data.chat_id && Array.isArray(data.message_ids)){\n          data.message_ids.push(obj.result.message_id);\n        } else {\n          data = { chat_id: chatId, message_ids: [obj.result.message_id] };\n        }\n        PropertiesService.getScriptProperties().setProperty(key, JSON.stringify(data));\n      }\n    }catch(_){ }\n  }catch(e){ Logger.log('[inviaOTPAdmin] Errore: ' + (e && e.message)); }\n}\n\nfunction deleteTelegramMessage(chatId, messageId){\n  try{\n    if (!CONFIG.TELEGRAM.BOT_TOKEN) { Logger.log('[deleteTelegramMessage] Config Telegram mancante, skip delete'); return; }\n    var url = 'https://api.telegram.org/bot' + CONFIG.TELEGRAM.BOT_TOKEN + '/deleteMessage';\n    var payload = { chat_id: chatId, message_id: messageId };\n    UrlFetchApp.fetch(url, { method:'post', contentType:'application/json', payload: JSON.stringify(payload), muteHttpExceptions:true });\n  }catch(e){ Logger.log('[deleteTelegramMessage] Errore: ' + (e && e.message)); }\n}\n",
      "size": 4183,
      "lines": 100
    },
    "backend/PDFGenerator.gs": {
      "content": "/**\r\n * SERVIZIO GENERAZIONE PDF CONTRATTI\r\n * \r\n * Gestisce creazione, eliminazione e censimento PDF\r\n */\r\n\r\n/**\r\n * Genera PDF contratto da prenotazione\r\n * @param {string} idPrenotazione - ID prenotazione\r\n * @return {Object} Oggetto con risultato generazione\r\n */\r\nfunction generaPDFContratto(idPrenotazione, sessionToken) {\n  Logger.log('[generaPDFContratto] ID: ' + idPrenotazione);\n  \n  // Verifica autorizzazione - solo admin possono generare PDF\n  if (!sessionToken || !isAdmin(sessionToken)) {\n    Logger.log('[generaPDFContratto] Accesso negato - admin richiesto');\n    return {\n      success: false,\n      message: 'Admin richiesto per generare PDF'\n    };\n  }\n  \n  try {\n    if (!CONFIG.PDF.TEMPLATE_DOC_ID || !CONFIG.PDF.PDF_FOLDER_ID || !CONFIG.SPREADSHEET_ID) {\n      throw new Error('Configurazione PDF/Spreadsheet mancante');\n    }\n    var sh = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID)\r\n      .getSheetByName(CONFIG.SHEETS.PRENOTAZIONI);\r\n    var data = sh.getDataRange().getValues();\r\n    var rowIndex = -1;\r\n    var prenotazione = null;\r\n    \r\n    for (var i = 1; i < data.length; i++) {\r\n      if (String(data[i][CONFIG.PRENOTAZIONI_COLS.ID_PRENOTAZIONE - 1]) === String(idPrenotazione)) {\r\n        rowIndex = i + 1;\r\n        prenotazione = data[i];\r\n        break;\r\n      }\r\n    }\r\n    \r\n    if (!prenotazione) {\r\n      throw new Error('Prenotazione non trovata: ' + idPrenotazione);\r\n    }\r\n    \r\n    var mappa = {};\r\n    \r\n    function formatDate(val) {\r\n      if (val instanceof Date && !isNaN(val.getTime())) {\r\n        return Utilities.formatDate(val, CONFIG.PDF.TIMEZONE, 'dd/MM/yyyy');\r\n      }\r\n      return val || '______________________________';\r\n    }\r\n    \r\n    // Dati autista 1\r\n    mappa['<<Nome>>'] = prenotazione[CONFIG.PRENOTAZIONI_COLS.NOME_AUTISTA_1 - 1] || '______________________________';\r\n    mappa['<<Data di nascita>>'] = formatDate(prenotazione[CONFIG.PRENOTAZIONI_COLS.DATA_NASCITA_AUTISTA_1 - 1]);\r\n    mappa['<<Luogo di nascita>>'] = prenotazione[CONFIG.PRENOTAZIONI_COLS.LUOGO_NASCITA_AUTISTA_1 - 1] || '______________________________';\r\n    mappa['<<Codice fiscale>>'] = prenotazione[CONFIG.PRENOTAZIONI_COLS.CODICE_FISCALE_AUTISTA_1 - 1] || '______________________________';\r\n    mappa['<<Comune di residenza>>'] = prenotazione[CONFIG.PRENOTAZIONI_COLS.COMUNE_RESIDENZA_AUTISTA_1 - 1] || '______________________________';\r\n    mappa['<<Via di residenza>>'] = prenotazione[CONFIG.PRENOTAZIONI_COLS.VIA_RESIDENZA_AUTISTA_1 - 1] || '______________________________';\r\n    mappa['<<Civico di residenza>>'] = prenotazione[CONFIG.PRENOTAZIONI_COLS.CIVICO_RESIDENZA_AUTISTA_1 - 1] || '';\r\n    mappa['<<Numero di patente>>'] = prenotazione[CONFIG.PRENOTAZIONI_COLS.NUMERO_PATENTE_AUTISTA_1 - 1] || '______________________________';\r\n    mappa['<<Data inizio validità patente>>'] = formatDate(prenotazione[CONFIG.PRENOTAZIONI_COLS.DATA_INIZIO_PATENTE_AUTISTA_1 - 1]);\r\n    mappa['<<Scadenza patente>>'] = formatDate(prenotazione[CONFIG.PRENOTAZIONI_COLS.SCADENZA_PATENTE_AUTISTA_1 - 1]);\r\n    \r\n    // Dati autista 2\r\n    mappa['<<Nome Autista 2>>'] = prenotazione[CONFIG.PRENOTAZIONI_COLS.NOME_AUTISTA_2 - 1] || '______________________________';\r\n    mappa['<<Data di nascita Autista 2>>'] = formatDate(prenotazione[CONFIG.PRENOTAZIONI_COLS.DATA_NASCITA_AUTISTA_2 - 1]);\r\n    mappa['<<Luogo di nascita Autista 2>>'] = prenotazione[CONFIG.PRENOTAZIONI_COLS.LUOGO_NASCITA_AUTISTA_2 - 1] || '______________________________';\r\n    mappa['<<Codice fiscale Autista 2>>'] = prenotazione[CONFIG.PRENOTAZIONI_COLS.CODICE_FISCALE_AUTISTA_2 - 1] || '______________________________';\r\n    mappa['<<Comune di residenza Autista 2>>'] = prenotazione[CONFIG.PRENOTAZIONI_COLS.COMUNE_RESIDENZA_AUTISTA_2 - 1] || '______________________________';\r\n    mappa['<<Via di residenza Autista 2>>'] = prenotazione[CONFIG.PRENOTAZIONI_COLS.VIA_RESIDENZA_AUTISTA_2 - 1] || '______________________________';\r\n    mappa['<<Civico di residenza Autista 2>>'] = prenotazione[CONFIG.PRENOTAZIONI_COLS.CIVICO_RESIDENZA_AUTISTA_2 - 1] || '';\r\n    mappa['<<Numero di patente Autista 2>>'] = prenotazione[CONFIG.PRENOTAZIONI_COLS.NUMERO_PATENTE_AUTISTA_2 - 1] || '______________________________';\r\n    mappa['<<Data inizio validità patente Autista 2>>'] = formatDate(prenotazione[CONFIG.PRENOTAZIONI_COLS.DATA_INIZIO_PATENTE_AUTISTA_2 - 1]);\r\n    mappa['<<Scadenza patente Autista 2>>'] = formatDate(prenotazione[CONFIG.PRENOTAZIONI_COLS.SCADENZA_PATENTE_AUTISTA_2 - 1]);\r\n    \r\n    // Dati autista 3\r\n    mappa['<<Nome Autista 3>>'] = prenotazione[CONFIG.PRENOTAZIONI_COLS.NOME_AUTISTA_3 - 1] || '______________________________';\r\n    mappa['<<Data di nascita Autista 3>>'] = formatDate(prenotazione[CONFIG.PRENOTAZIONI_COLS.DATA_NASCITA_AUTISTA_3 - 1]);\r\n    mappa['<<Luogo di nascita Autista 3>>'] = prenotazione[CONFIG.PRENOTAZIONI_COLS.LUOGO_NASCITA_AUTISTA_3 - 1] || '______________________________';\r\n    mappa['<<Codice fiscale Autista 3>>'] = prenotazione[CONFIG.PRENOTAZIONI_COLS.CODICE_FISCALE_AUTISTA_3 - 1] || '______________________________';\r\n    mappa['<<Comune di residenza Autista 3>>'] = prenotazione[CONFIG.PRENOTAZIONI_COLS.COMUNE_RESIDENZA_AUTISTA_3 - 1] || '______________________________';\r\n    mappa['<<Via di residenza Autista 3>>'] = prenotazione[CONFIG.PRENOTAZIONI_COLS.VIA_RESIDENZA_AUTISTA_3 - 1] || '______________________________';\r\n    mappa['<<Civico di residenza Autista 3>>'] = prenotazione[CONFIG.PRENOTAZIONI_COLS.CIVICO_RESIDENZA_AUTISTA_3 - 1] || '';\r\n    mappa['<<Numero di patente Autista 3>>'] = prenotazione[CONFIG.PRENOTAZIONI_COLS.NUMERO_PATENTE_AUTISTA_3 - 1] || '______________________________';\r\n    mappa['<<Data inizio validità patente Autista 3>>'] = formatDate(prenotazione[CONFIG.PRENOTAZIONI_COLS.DATA_INIZIO_PATENTE_AUTISTA_3 - 1]);\r\n    mappa['<<Scadenza patente Autista 3>>'] = formatDate(prenotazione[CONFIG.PRENOTAZIONI_COLS.SCADENZA_PATENTE_AUTISTA_3 - 1]);\r\n    \r\n    // Dati veicolo\r\n    var targa = String(prenotazione[CONFIG.PRENOTAZIONI_COLS.TARGA - 1] || '').trim().toUpperCase();\r\n    var veicolo = CONFIG.PDF.VEICOLI[targa] || { marca: '______________________________', modello: '______________________________' };\r\n    \r\n    mappa['<<Targa>>'] = targa || '______________________________';\r\n    mappa['<<marca>>'] = veicolo.marca;\r\n    mappa['<<tipo>>'] = veicolo.modello;\r\n    mappa['<<Giorno inizio noleggio>>'] = formatDate(prenotazione[CONFIG.PRENOTAZIONI_COLS.GIORNO_INIZIO - 1]);\r\n    mappa['<<Giorno fine noleggio>>'] = formatDate(prenotazione[CONFIG.PRENOTAZIONI_COLS.GIORNO_FINE - 1]);\r\n    mappa['<<Ora inizio noleggio>>'] = prenotazione[CONFIG.PRENOTAZIONI_COLS.ORA_INIZIO - 1] || '______________________________';\r\n    mappa['<<Ora fine noleggio>>'] = prenotazione[CONFIG.PRENOTAZIONI_COLS.ORA_FINE - 1] || '______________________________';\r\n    mappa['<<Destinazione>>'] = prenotazione[CONFIG.PRENOTAZIONI_COLS.DESTINAZIONE - 1] || '______________________________';\r\n    mappa['<<Cellulare>>'] = prenotazione[CONFIG.PRENOTAZIONI_COLS.CELLULARE - 1] || '______________________________';\r\n    mappa['<<Data contratto>>'] = formatDate(prenotazione[CONFIG.PRENOTAZIONI_COLS.DATA_CONTRATTO - 1]);\r\n    mappa['<<ID prenotazione>>'] = idPrenotazione;\r\n    mappa['<<Importo preventivo>>'] = prenotazione[CONFIG.PRENOTAZIONI_COLS.IMPORTO_PREVENTIVO - 1] || '0';\r\n    \r\n    Logger.log('[generaPDFContratto] Veicolo: ' + targa + ' -> ' + veicolo.marca + ' ' + veicolo.modello);\r\n    \r\n    // Se esiste un PDF precedente, eliminalo\n    var prevUrl = String(prenotazione[CONFIG.PRENOTAZIONI_COLS.PDF_URL - 1] || '').trim();\n    if (prevUrl && prevUrl.indexOf('/d/') > -1) {\n      try {\n        var prevId = prevUrl.split('/d/')[1].split('/')[0];\n        DriveApp.getFileById(prevId).setTrashed(true);\n      } catch (ePrev) { /* ignore */ }\n    }\n    // Crea copia template\n    var template = DriveApp.getFileById(CONFIG.PDF.TEMPLATE_DOC_ID);\n    var tempDoc = template.makeCopy();\r\n    var doc = DocumentApp.openById(tempDoc.getId());\r\n    var body = doc.getBody();\r\n    \r\n    // Sostituisci placeholder\r\n    var sostituzioni = 0;\r\n    for (var placeholder in mappa) {\r\n      var value = String(mappa[placeholder] || '');\r\n      var count = body.replaceText(placeholder, value);\r\n      if (count > 0) sostituzioni++;\r\n    }\r\n    \r\n    doc.saveAndClose();\r\n    Logger.log('[generaPDFContratto] Sostituzioni: ' + sostituzioni);\r\n    \r\n    // Converti in PDF\r\n    var pdfBlob = DriveApp.getFileById(tempDoc.getId()).getAs(MimeType.PDF);\r\n    var nomeCliente = String(mappa['<<Nome>>'] || 'Cliente').replace(/\\s+/g, '_');\r\n    var dataRitiro = String(mappa['<<Giorno inizio noleggio>>'] || '').replace(/\\//g, '-');\r\n    var dataArrivo = String(mappa['<<Giorno fine noleggio>>'] || '').replace(/\\//g, '-');\r\n    var nomePdf = nomeCliente + '_' + dataRitiro + '_' + dataArrivo + '.pdf';\r\n    \r\n    // Salva in cartella\r\n    var folder = DriveApp.getFolderById(CONFIG.PDF.PDF_FOLDER_ID);\r\n    var pdfFile = folder.createFile(pdfBlob).setName(nomePdf);\r\n    // Rimuovi condivisione pubblica per sicurezza - solo utenti autorizzati possono accedere\n    // pdfFile.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);\r\n    \r\n    // Elimina documento temporaneo\r\n    DriveApp.getFileById(tempDoc.getId()).setTrashed(true);\r\n    \r\n    // Aggiorna URL in foglio\r\n    sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.PDF_URL).setValue(pdfFile.getUrl());\r\n    \r\n    Logger.log('[generaPDFContratto] PDF creato: ' + nomePdf);\r\n    \r\n    return {\r\n      success: true,\r\n      pdfUrl: pdfFile.getUrl(),\r\n      pdfId: pdfFile.getId(),\r\n      nomeFile: nomePdf\r\n    };\r\n  } catch (err) {\r\n    Logger.log('[generaPDFContratto] Errore: ' + err.message);\r\n    return { success: false, message: err.message };\r\n  }\r\n}\r\n\r\n/**\r\n * Elimina PDF associato a prenotazione\r\n * @param {string} idPrenotazione - ID prenotazione\r\n */\r\nfunction eliminaPDFPrenotazione(idPrenotazione, sessionToken) {\r\n  Logger.log('[eliminaPDFPrenotazione] ID: ' + idPrenotazione);\n  \n  // Verifica autorizzazione - solo admin possono eliminare PDF\n  if (!sessionToken || !isAdmin(sessionToken)) {\n    Logger.log('[eliminaPDFPrenotazione] Accesso negato - admin richiesto');\n    return {\n      success: false,\n      message: 'Admin richiesto per eliminare PDF'\n    };\n  }\r\n  \r\n  try {\r\n    var sh = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID)\r\n      .getSheetByName(CONFIG.SHEETS.PRENOTAZIONI);\r\n    var data = sh.getDataRange().getValues();\r\n    var pdfUrl = '';\r\n    \r\n    for (var i = 1; i < data.length; i++) {\r\n      if (String(data[i][CONFIG.PRENOTAZIONI_COLS.ID_PRENOTAZIONE - 1]) === String(idPrenotazione)) {\r\n        pdfUrl = data[i][CONFIG.PRENOTAZIONI_COLS.PDF_URL - 1] || '';\r\n        break;\r\n      }\r\n    }\r\n    \r\n    if (pdfUrl && pdfUrl.indexOf('/d/') > -1) {\r\n      var pdfId = pdfUrl.split('/d/')[1].split('/')[0];\r\n      try {\r\n        var file = DriveApp.getFileById(pdfId);\r\n        file.setTrashed(true);\r\n        Logger.log('[eliminaPDFPrenotazione] PDF eliminato: ' + pdfId);\r\n      } catch (e) {\r\n        Logger.log('[eliminaPDFPrenotazione] PDF non trovato o già eliminato: ' + e.message);\r\n      }\r\n    }\r\n  } catch (err) {\r\n    Logger.log('[eliminaPDFPrenotazione] Errore: ' + err.message);\r\n  }\r\n}\r\n\r\n/**\r\n * Censisce PDF esistenti e collega a prenotazioni\r\n * @return {ContentService} Risposta JSON con statistiche\r\n */\r\nfunction censisciPDFEsistenti() {\n  Logger.log('[censisciPDFEsistenti] Avvio censimento...');\r\n  \r\n  try {\r\n    var sh = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID)\r\n      .getSheetByName(CONFIG.SHEETS.PRENOTAZIONI);\r\n    var data = sh.getDataRange().getValues();\r\n    \r\n    if (data.length <= 1) {\r\n      return createJsonResponse({\r\n        success: false,\r\n        message: 'Nessuna prenotazione trovata'\r\n      });\r\n    }\r\n    \r\n    var folder = DriveApp.getFolderById(CONFIG.PDF.PDF_FOLDER_ID);\r\n    var files = folder.getFiles();\r\n    var pdfMap = {};\r\n    \r\n    // Mappa tutti i PDF nella cartella\r\n    while (files.hasNext()) {\r\n      var file = files.next();\r\n      if (file.getMimeType() === MimeType.PDF) {\r\n        var nomePdf = file.getName();\r\n        pdfMap[nomePdf] = file.getUrl();\r\n      }\r\n    }\r\n    \r\n    var trovati = 0;\r\n    var aggiornati = 0;\r\n    var giàCollegati = 0;\r\n    \r\n    // Cerca PDF per ogni prenotazione\r\n    for (var i = 1; i < data.length; i++) {\r\n      var row = data[i];\r\n      var rowIndex = i + 1;\r\n      \r\n      var nomeClienteOriginale = String(row[CONFIG.PRENOTAZIONI_COLS.NOME_AUTISTA_1 - 1] || '');\r\n      var giornoInizio = row[CONFIG.PRENOTAZIONI_COLS.GIORNO_INIZIO - 1];\r\n      var giornoFine = row[CONFIG.PRENOTAZIONI_COLS.GIORNO_FINE - 1];\r\n      var pdfUrlEsistente = String(row[CONFIG.PRENOTAZIONI_COLS.PDF_URL - 1] || '').trim();\r\n      \r\n      if (!nomeClienteOriginale || !giornoInizio || !giornoFine) {\r\n        continue;\r\n      }\r\n      \r\n      var nomiVarianti = normalizzaNome(nomeClienteOriginale);\r\n      var dataRitiro = formatDateForFilename(parseItalianOrISO(giornoInizio));\n      var dataArrivo = formatDateForFilename(parseItalianOrISO(giornoFine));\n      \r\n      var varianti = [\r\n        nomiVarianti.senzaSpazi + '_' + dataRitiro + '_' + dataArrivo + '.pdf',\r\n        nomiVarianti.conUnderscore + '_' + dataRitiro + '_' + dataArrivo + '.pdf'\r\n      ];\r\n      \r\n      var pdfTrovato = null;\r\n      \r\n      for (var v = 0; v < varianti.length; v++) {\r\n        if (pdfMap[varianti[v]]) {\r\n          pdfTrovato = pdfMap[varianti[v]];\r\n          break;\r\n        }\r\n      }\r\n      \r\n      if (pdfTrovato) {\r\n        trovati++;\r\n        if (!pdfUrlEsistente) {\r\n          sh.getRange(rowIndex, CONFIG.PRENOTAZIONI_COLS.PDF_URL).setValue(pdfTrovato);\r\n          aggiornati++;\r\n        } else {\r\n          giàCollegati++;\r\n        }\r\n      }\r\n    }\r\n    \r\n    return createJsonResponse({\r\n      success: true,\r\n      message: 'Censimento completato',\r\n      pdfTrovati: trovati,\r\n      recordAggiornati: aggiornati,\r\n      giàCollegati: giàCollegati,\r\n      pdfNellaCartella: Object.keys(pdfMap).length\r\n    });\r\n  } catch (err) {\r\n    return createJsonResponse({\r\n      success: false,\r\n      message: 'Errore censimento: ' + err.message\r\n    }, 500);\r\n  }\r\n}\n\n/**\n * Genera un PDF manuale partendo dall'ultima riga di un foglio\n * Sostituisce i tag nel template con i valori della riga (supporta <<TAG>> e {{TAG}})\n * @param {Object} params { sheetName?: string }\n * @return {Object} { success, url, pdfId, nomeFile }\n */\nfunction generaPdfUltimaRiga(params) {\n  try {\n    var sheetName = (params && params.sheetName) || CONFIG.SHEETS.PRENOTAZIONI;\n    if (!CONFIG.PDF.TEMPLATE_DOC_ID || !CONFIG.PDF.PDF_FOLDER_ID || !CONFIG.SPREADSHEET_ID) {\n      throw new Error('Configurazione PDF/Spreadsheet mancante');\n    }\n    var ss = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);\n    var sh = ss.getSheetByName(sheetName);\n    if (!sh) throw new Error('Foglio non trovato: ' + sheetName);\n    var lr = sh.getLastRow();\n    var lc = sh.getLastColumn();\n    if (lr < 2) throw new Error('Nessun dato nel foglio');\n    var headers = sh.getRange(1, 1, 1, lc).getValues()[0];\n    var row = sh.getRange(lr, 1, 1, lc).getValues()[0];\n    var map = {};\n    for (var i = 0; i < headers.length; i++) {\n      var key = String(headers[i] || '').trim();\n      if (!key) continue;\n      var val = row[i];\n      if (val instanceof Date && !isNaN(val.getTime())) {\n        val = Utilities.formatDate(val, CONFIG.PDF.TIMEZONE, 'dd/MM/yyyy');\n      }\n      map[key] = val;\n      map[key.toUpperCase()] = val;\n      map[key.replace(/\\s+/g, '_')] = val;\n    }\n    // Crea copia del template e sostituisci\n    var template = DriveApp.getFileById(CONFIG.PDF.TEMPLATE_DOC_ID);\n    var tempDoc = template.makeCopy('Manual_'+new Date().toISOString(), DriveApp.getFolderById(CONFIG.PDF.PDF_FOLDER_ID));\n    var doc = DocumentApp.openById(tempDoc.getId());\n    var body = doc.getBody();\n    var keys = Object.keys(map);\n    for (var k = 0; k < keys.length; k++) {\n      var tag = keys[k];\n      var value = String(map[tag] || '');\n      try { body.replaceText('<<'+tag+'>>', value); } catch (e) {}\n      try { body.replaceText('{{'+tag+'}}', value); } catch (e2) {}\n    }\n    doc.saveAndClose();\n    var pdfBlob = DriveApp.getFileById(tempDoc.getId()).getAs(MimeType.PDF);\n    var pdfFile = DriveApp.getFolderById(CONFIG.PDF.PDF_FOLDER_ID).createFile(pdfBlob).setName(tempDoc.getName()+'.pdf');\n    pdfFile.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);\n    // elimina il doc temporaneo\n    DriveApp.getFileById(tempDoc.getId()).setTrashed(true);\n    return { success:true, url: pdfFile.getUrl(), pdfId: pdfFile.getId(), nomeFile: pdfFile.getName() };\n  } catch (err) {\n    return { success:false, message: err.message };\n  }\n}\n\r\n/**\r\n * Helper per formattare date nei nomi file\r\n * @param {Date} date - Data da formattare\r\n * @return {string} Data formattata gg-mm-aaaa\r\n */\r\nfunction formatDateForFilename(date) {\r\n  if (date instanceof Date && !isNaN(date.getTime())) {\r\n    var d = Utilities.formatDate(date, CONFIG.PDF.TIMEZONE, 'dd/MM/yyyy');\r\n    return d.replace(/\\//g, '-');\r\n  }\r\n  return '';\r\n}\r\n",
      "size": 17173,
      "lines": 375
    },
    "backend/CSVImportService.gs": {
      "content": "/**\n * Import CSV/Excel (rows già parsate) in PRENOTAZIONI\n * post = { rows: Array<{ targa, giornoInizio, giornoFine?, oraInizio?, oraFine?, destinazione?, nomeAutista? }> }\n * Crea prenotazioni Confermate e genera ID coerente.\n */\nfunction importaPrenotazioniCSV(post){\n  try {\n    if (!post || !post.rows || !Array.isArray(post.rows) || !post.rows.length){\n      return createJsonResponse({ success:false, message:'Nessuna riga valida in input' }, 400);\n    }\n    var shPren = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID).getSheetByName(CONFIG.SHEETS.PRENOTAZIONI);\n    var dataEsistente = shPren.getDataRange().getValues();\n    var dupSet = {};\n    for (var r=1;r<dataEsistente.length;r++){\n      var row = dataEsistente[r];\n      var t = String(row[CONFIG.PRENOTAZIONI_COLS.TARGA-1]||'').trim();\n      var gi = row[CONFIG.PRENOTAZIONI_COLS.GIORNO_INIZIO-1];\n      var gf = row[CONFIG.PRENOTAZIONI_COLS.GIORNO_FINE-1];\n      var oi = String(row[CONFIG.PRENOTAZIONI_COLS.ORA_INIZIO-1]||'').trim();\n      var of = String(row[CONFIG.PRENOTAZIONI_COLS.ORA_FINE-1]||'').trim();\n      if (t && gi){\n        var k = [t, formatISODate(gi, oi||'00:00'), gf?formatISODate(gf, of||'23:59'):''].join('|');\n        dupSet[k] = true;\n      }\n    }\n\n    var created=0, duplicates=0, skipped=0; var dettagli=[];\n    var today = new Date(); today.setHours(0,0,0,0);\n\n    for (var i=0;i<post.rows.length;i++){\n      var it = post.rows[i]||{};\n      var targa = String(it.targa||'').trim();\n      var dStart = parseDateFlexibleGS(it.giornoInizio);\n      var dEnd = parseDateFlexibleGS(it.giornoFine||it.giornoInizio);\n      var oraStart = String(it.oraInizio||'08:00');\n      var oraEnd = String(it.oraFine||'22:00');\n      var destinazione = String(it.destinazione||'').trim();\n      var nomeAutista = String(it.nomeAutista||'Import Excel').trim();\n\n      // Estrai un numero di cellulare plausibile dal titolo/nomeAutista (es. dal campo Title)\n      var cellulareEstratto = extractPhoneFromText(nomeAutista);\n\n      if (!targa || !dStart){ skipped++; dettagli.push({ esito:'skip', motivo:'manca targa o data', i }); continue; }\n      var startDay = new Date(dStart.getTime()); startDay.setHours(0,0,0,0);\n      if (startDay < today){ skipped++; dettagli.push({ esito:'skip_past', targa, dStart }); continue; }\n      var kNew = [targa, formatISODate(dStart, oraStart), formatISODate(dEnd, oraEnd)].join('|');\n      if (dupSet[kNew]){ duplicates++; dettagli.push({ esito:'dup', targa, dStart }); continue; }\n\n      var row = new Array(46).fill('');\n      row[CONFIG.PRENOTAZIONI_COLS.TIMESTAMP-1] = new Date();\n      row[CONFIG.PRENOTAZIONI_COLS.NOME_AUTISTA_1-1] = sanitizeSheetValue(nomeAutista || 'Import Excel');\n      row[CONFIG.PRENOTAZIONI_COLS.TARGA-1] = sanitizeSheetValue(targa);\n      row[CONFIG.PRENOTAZIONI_COLS.ORA_INIZIO-1] = sanitizeSheetValue(oraStart);\n      row[CONFIG.PRENOTAZIONI_COLS.ORA_FINE-1] = sanitizeSheetValue(oraEnd);\n      row[CONFIG.PRENOTAZIONI_COLS.GIORNO_INIZIO-1] = dStart;\n      row[CONFIG.PRENOTAZIONI_COLS.GIORNO_FINE-1] = dEnd;\n      row[CONFIG.PRENOTAZIONI_COLS.DESTINAZIONE-1] = sanitizeSheetValue(destinazione);\n      if (cellulareEstratto) row[CONFIG.PRENOTAZIONI_COLS.CELLULARE-1] = sanitizeSheetValue(cellulareEstratto);\n      row[CONFIG.PRENOTAZIONI_COLS.STATO_PRENOTAZIONE-1] = sanitizeSheetValue('Legacy');\n      row[CONFIG.PRENOTAZIONI_COLS.ID_PRENOTAZIONE-1] = generaNuovoIdBooking();\n\n      shPren.appendRow(row);\n      created++; dupSet[kNew] = true;\n      dettagli.push({ esito:'creato', targa, dStart, dEnd });\n    }\n\n    return createJsonResponse({ success:true, message:'Import CSV completato', created, duplicates, skipped, details:dettagli });\n  } catch(err){\n    Logger.log('[importaPrenotazioniCSV] Errore: '+err.message);\n    return createJsonResponse({ success:false, message:'Errore import CSV: '+err.message }, 500);\n  }\n}\n\n// Parsing date flessibile lato Apps Script\nfunction parseDateFlexibleGS(val){\n  if (!val) return null;\n  if (val instanceof Date && !isNaN(val.getTime())) {\n    return new Date(val.getFullYear(), val.getMonth(), val.getDate(), 12, 0, 0, 0);\n  }\n  var s = String(val).trim();\n  // dd/mm/yyyy\n  var m = s.match(/^(\\d{2})\\/(\\d{2})\\/(\\d{4})$/);\n  if (m){\n    var d = new Date(parseInt(m[3],10), parseInt(m[2],10)-1, parseInt(m[1],10), 12, 0, 0, 0);\n    return isNaN(d.getTime())?null:d;\n  }\n  // yyyy-mm-dd\n  var iso = s.match(/^(\\d{4})-(\\d{2})-(\\d{2})$/);\n  if (iso){\n    var d2 = new Date(parseInt(iso[1],10), parseInt(iso[2],10)-1, parseInt(iso[3],10), 12, 0, 0, 0);\n    return isNaN(d2.getTime())?null:d2;\n  }\n  var d3 = new Date(s);\n  return isNaN(d3.getTime())?null:new Date(d3.getFullYear(), d3.getMonth(), d3.getDate(), 12, 0, 0, 0);\n}\n\nfunction formatISODate(d, hhmm){\n  if (!(d instanceof Date)) d = new Date(d);\n  var y = d.getFullYear();\n  var m = String(d.getMonth()+1).padStart(2,'0');\n  var day = String(d.getDate()).padStart(2,'0');\n  return y+'-'+m+'-'+day+'T'+(hhmm||'00:00');\n}\n\n// Estrazione robusta di numeri di telefono da testo libero\nfunction extractPhoneFromText(text){\n  if (!text) return '';\n  var s = String(text).replace(/[^+0-9\\s]/g,' ').replace(/\\s+/g,' ').trim();\n  // Cerca pattern comuni: +39xxxxxxxxxx, 3xxxxxxxxx, 0xxxxxxxxx\n  var m = s.match(/(?:\\+39\\s*)?(3\\d[\\d\\s]{7,10}|0\\d[\\d\\s]{7,10})/);\n  if (!m) return '';\n  var num = m[0].replace(/\\s+/g,'');\n  // Normalizza: aggiungi +39 se manca ed è un mobile (3xx...) o fisso (0xx...)\n  if (!/^\\+39/.test(num)) num = '+39' + num;\n  return num;\n}\n",
      "size": 5500,
      "lines": 117
    },
    "backend/ICSImportService.gs": {
      "content": "/**\n * Importa prenotazioni da un file ICS (iCal)\n * Supporta sia URL pubblico ICS sia testo ICS incollato\n * Crea prenotazioni \"Confermata\" per bloccare correttamente la disponibilità dei veicoli\n *\n * post = {\n *   icsUrl?: string,\n *   icsText?: string,\n *   defaultTarga?: string,\n *   defaultOraInizio?: string, // es. \"08:00\"\n *   defaultOraFine?: string    // es. \"22:00\"\n * }\n */\nfunction importaPrenotazioniICS(post){\n  try {\n    var shPren = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID).getSheetByName(CONFIG.SHEETS.PRENOTAZIONI);\n    var shPulmini = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID).getSheetByName(CONFIG.SHEETS.PULMINI);\n    var rowsPulmini = shPulmini.getDataRange().getValues();\n    var targhe = [];\n    for (var i=1;i<rowsPulmini.length;i++){\n      var t = String(rowsPulmini[i][CONFIG.PULMINI_COLS.TARGA-1]||'').trim();\n      if (t) targhe.push(t);\n    }\n\n    var icsText = String(post.icsText||'').trim();\n    var icsUrl = String(post.icsUrl||'').trim();\n    if (!icsText && icsUrl){\n      try {\n        var resp = UrlFetchApp.fetch(icsUrl, { muteHttpExceptions: true });\n        if (resp && resp.getResponseCode() >= 200 && resp.getResponseCode() < 300){\n          icsText = resp.getContentText();\n        }\n      } catch(fetchErr){\n        Logger.log('[ICS] Errore fetch ICS: '+fetchErr.message);\n      }\n    }\n    if (!icsText){\n      return createJsonResponse({ success:false, message:'Nessun ICS fornito (URL o testo)' }, 400);\n    }\n\n    var events = parseICS(icsText);\n    var today = new Date(); today.setHours(0,0,0,0);\n    var defaultTarga = String(post.defaultTarga||'').trim();\n    var defaultOraInizio = String(post.defaultOraInizio||'08:00');\n    var defaultOraFine = String(post.defaultOraFine||'22:00');\n\n    // Costruisci set duplicati esistenti (chiave: targa|startISO|endISO)\n    var esistenti = shPren.getDataRange().getValues();\n    var dupSet = {};\n    for (var r=1;r<esistenti.length;r++){\n      var row = esistenti[r];\n      var t = String(row[CONFIG.PRENOTAZIONI_COLS.TARGA-1]||'').trim();\n      var gi = row[CONFIG.PRENOTAZIONI_COLS.GIORNO_INIZIO-1];\n      var gf = row[CONFIG.PRENOTAZIONI_COLS.GIORNO_FINE-1];\n      var oi = String(row[CONFIG.PRENOTAZIONI_COLS.ORA_INIZIO-1]||'').trim();\n      var of = String(row[CONFIG.PRENOTAZIONI_COLS.ORA_FINE-1]||'').trim();\n      if (t && gi){\n        var k = [t, formatISODate(gi, oi||'00:00'), gf?formatISODate(gf, of||'23:59'):''].join('|');\n        dupSet[k] = true;\n      }\n    }\n\n    var created = 0, skippedNoTarga = 0, skippedPast = 0, duplicates = 0;\n    var dettagli = [];\n\n    for (var eIdx=0;eIdx<events.length;eIdx++){\n      var ev = events[eIdx];\n      var start = ev.start; var end = ev.end||ev.start;\n      if (!start){ continue; }\n      var startDay = new Date(start.getTime()); startDay.setHours(0,0,0,0);\n      if (startDay < today){ skippedPast++; continue; }\n\n      var contentBlob = [ev.summary||'', ev.location||'', ev.description||''].join(' ').toUpperCase();\n      var foundTarga = findTarga(contentBlob, targhe) || defaultTarga;\n      if (!foundTarga){ skippedNoTarga++; dettagli.push({ esito:'skip_no_targa', summary: ev.summary||'', start: start }); continue; }\n\n      // Orari\n      var oraInizio = ev.hourStart || defaultOraInizio;\n      var oraFine = ev.hourEnd || defaultOraFine;\n\n      var kNew = [foundTarga, formatISODate(start, oraInizio), formatISODate(end, oraFine)].join('|');\n      if (dupSet[kNew]){ duplicates++; dettagli.push({ esito:'dup', targa: foundTarga, start:start }); continue; }\n\n      // Costruisci riga prenotazione Legacy\n      var row = new Array(46).fill('');\n      row[CONFIG.PRENOTAZIONI_COLS.TIMESTAMP-1] = new Date();\n      // Usa il SUMMARY (Title) come nome completo grezzo\n      var titolo = String(ev.summary||'').trim();\n      row[CONFIG.PRENOTAZIONI_COLS.NOME_AUTISTA_1-1] = sanitizeSheetValue(titolo || 'Import Legacy');\n      row[CONFIG.PRENOTAZIONI_COLS.TARGA-1] = sanitizeSheetValue(foundTarga);\n      row[CONFIG.PRENOTAZIONI_COLS.ORA_INIZIO-1] = sanitizeSheetValue(oraInizio);\n      row[CONFIG.PRENOTAZIONI_COLS.ORA_FINE-1] = sanitizeSheetValue(oraFine);\n      row[CONFIG.PRENOTAZIONI_COLS.GIORNO_INIZIO-1] = start;\n      row[CONFIG.PRENOTAZIONI_COLS.GIORNO_FINE-1] = end;\n      row[CONFIG.PRENOTAZIONI_COLS.DESTINAZIONE-1] = sanitizeSheetValue((ev.location||ev.summary||'').trim());\n      // Se nel titolo è presente un numero di telefono, estrailo e salva\n      var cellulareEstratto = extractPhoneFromText(titolo);\n      if (cellulareEstratto) row[CONFIG.PRENOTAZIONI_COLS.CELLULARE-1] = sanitizeSheetValue(cellulareEstratto);\n      row[CONFIG.PRENOTAZIONI_COLS.STATO_PRENOTAZIONE-1] = sanitizeSheetValue('Legacy');\n      row[CONFIG.PRENOTAZIONI_COLS.ID_PRENOTAZIONE-1] = generaNuovoIdBooking();\n\n      shPren.appendRow(row);\n      created++;\n      dupSet[kNew] = true;\n      dettagli.push({ esito:'creato', targa: foundTarga, start:start, end:end, destinazione: row[CONFIG.PRENOTAZIONI_COLS.DESTINAZIONE-1] });\n    }\n\n    return createJsonResponse({\n      success:true,\n      message:'Import ICS completato',\n      created: created,\n      duplicates: duplicates,\n      skippedPast: skippedPast,\n      skippedNoTarga: skippedNoTarga,\n      details: dettagli\n    });\n  } catch(err){\n    Logger.log('[importaPrenotazioniICS] Errore: '+err.message);\n    return createJsonResponse({ success:false, message:'Errore import ICS: '+err.message }, 500);\n  }\n}\n\n/**\n * Parser minimale ICS: estrae DTSTART, DTEND, SUMMARY, LOCATION, DESCRIPTION\n */\nfunction parseICS(text){\n  var lines = text.replace(/\\r\\n/g,'\\n').replace(/\\r/g,'\\n').split('\\n');\n  var events = []; var current = null;\n  for (var i=0;i<lines.length;i++){\n    var line = lines[i];\n    if (line.startsWith('BEGIN:VEVENT')){ current = {}; continue; }\n    if (!current) continue;\n    if (line.startsWith('END:VEVENT')){ events.push(current); current = null; continue; }\n    if (line.startsWith('DTSTART')){\n      var val = line.split(':').pop();\n      var d = parseICSDate(val);\n      current.start = d.date;\n      current.hourStart = d.hour;\n    } else if (line.startsWith('DTEND')){\n      var val2 = line.split(':').pop();\n      var d2 = parseICSDate(val2);\n      current.end = d2.date;\n      current.hourEnd = d2.hour;\n    } else if (line.startsWith('SUMMARY:')){\n      current.summary = line.replace('SUMMARY:','');\n    } else if (line.startsWith('LOCATION:')){\n      current.location = line.replace('LOCATION:','');\n    } else if (line.startsWith('DESCRIPTION:')){\n      current.description = line.replace('DESCRIPTION:','');\n    }\n  }\n  return events;\n}\n\n/**\n * Converte valori ICS (YYYYMMDD[THHMMSS][Z]) in Date e orario HH:MM\n */\nfunction parseICSDate(val){\n  var v = String(val||'').trim();\n  // All-day: YYYYMMDD\n  if (/^\\d{8}$/.test(v)){\n    var y = parseInt(v.slice(0,4),10);\n    var m = parseInt(v.slice(4,6),10)-1;\n    var d = parseInt(v.slice(6,8),10);\n    var dt = new Date(y,m,d);\n    return { date: dt, hour: '08:00' };\n  }\n  // Date-time: YYYYMMDDTHHMMSS(Z?)\n  var match = v.match(/^(\\d{4})(\\d{2})(\\d{2})T(\\d{2})(\\d{2})(\\d{2})(Z)?$/);\n  if (match){\n    var y = parseInt(match[1],10);\n    var m = parseInt(match[2],10)-1;\n    var d = parseInt(match[3],10);\n    var hh = parseInt(match[4],10);\n    var mm = parseInt(match[5],10);\n    var ss = parseInt(match[6],10);\n    var isUTC = !!match[7];\n    var dt = isUTC ? new Date(Date.UTC(y,m,d,hh,mm,ss)) : new Date(y,m,d,hh,mm,ss);\n    // Converte in timezone locale se era UTC\n    if (isUTC){\n      var tz = Session.getScriptTimeZone() || CONFIG.PDF.TIMEZONE || 'Europe/Rome';\n      // Apps Script usa automaticamente fuso del progetto; manteniamo l’ora locale\n      dt = new Date(dt.getTime());\n    }\n    var hourStr = String(hh).padStart(2,'0') + ':' + String(mm).padStart(2,'0');\n    return { date: dt, hour: hourStr };\n  }\n  // Fallback\n  return { date: new Date(), hour: '08:00' };\n}\n\n// Estrazione robusta di numeri di telefono da testo libero\nfunction extractPhoneFromText(text){\n  if (!text) return '';\n  var s = String(text).replace(/[^+0-9\\s]/g,' ').replace(/\\s+/g,' ').trim();\n  // Cerca pattern comuni: +39xxxxxxxxxx, 3xxxxxxxxx, 0xxxxxxxxx\n  var m = s.match(/(?:\\+39\\s*)?(3\\d[\\d\\s]{7,10}|0\\d[\\d\\s]{7,10})/);\n  if (!m) return '';\n  var num = m[0].replace(/\\s+/g,'');\n  if (!/^\\+39/.test(num)) num = '+39' + num;\n  return num;\n}\n\n/**\n * Trova la targa all’interno di un testo in base all’elenco targhe esistenti\n */\nfunction findTarga(contentUpper, targhe){\n  for (var i=0;i<targhe.length;i++){\n    var t = targhe[i].toUpperCase();\n    if (contentUpper.indexOf(t) >= 0){ return targhe[i]; }\n  }\n  return '';\n}\n\n/**\n * Restituisce ISO data+ora (YYYY-MM-DDTHH:MM) per chiave duplicati\n */\nfunction formatISODate(d, hhmm){\n  if (!(d instanceof Date)) d = new Date(d);\n  var y = d.getFullYear();\n  var m = String(d.getMonth()+1).padStart(2,'0');\n  var day = String(d.getDate()).padStart(2,'0');\n  return y+'-'+m+'-'+day+'T'+(hhmm||'00:00');\n}\n",
      "size": 8942,
      "lines": 225
    },
    "backend/OCRService.gs": {
      "content": "/**\r\n * SERVIZIO OCR DOCUMENTI AUTISTI v2.2\r\n * Estrazione robusta campo 3 patente (data e luogo separati in ogni layout)\r\n * Tutte le funzioni complete e commenti preservati.\r\n */\r\nfunction ocrDocument(post) {\n  Logger.log('[OCR] Richiesta OCR ricevuta');\n  try {\n    if (!post || !post.image) {\n      return createJsonResponse({ success: false, message: 'Immagine mancante', errorCode: 'MISSING_IMAGE' }, 400); }\n    \n    var imageBase64 = post.image;\n    var autistaNum = post.autista || 1;\n    var tipoDoc = post.tipoDocumento || 'auto';\n    var mimeType = post.mimeType || '';\n    \n    // Validazione e preprocessing immagine\n    var validationResult = validateAndPreprocessImage(imageBase64, mimeType);\n    if (!validationResult.valid) {\n      return createJsonResponse({ \n        success: false, \n        message: validationResult.error, \n        errorCode: validationResult.errorCode \n      }, 400);\n    }\n    imageBase64 = validationResult.processedImage;\n    \r\n    var visionApiKey = CONFIG.GOOGLE && CONFIG.GOOGLE.VISION_API_KEY ? CONFIG.GOOGLE.VISION_API_KEY : '';\r\n    if (!visionApiKey) {\r\n      return createJsonResponse({ success: false, message: 'Servizio OCR non configurato.', errorCode: 'CONFIG_ERROR' }, 500); }\r\n    \r\n    var visionUrl = 'https://vision.googleapis.com/v1/images:annotate?key=' + visionApiKey;\r\n    var payload = {\r\n      requests: [{ \r\n        image: { content: imageBase64 }, \r\n        features: [{ type: 'DOCUMENT_TEXT_DETECTION', maxResults: 1 }], \r\n        imageContext: { languageHints: ['it', 'en'] } \r\n      }]\r\n    };\r\n    \r\n    var options = { \r\n      method: 'post', \r\n      contentType: 'application/json', \r\n      payload: JSON.stringify(payload), \r\n      muteHttpExceptions: true,\r\n      timeout: 30000 // 30 secondi timeout\r\n    };\r\n    \r\n    Logger.log('[OCR] Invio richiesta a Google Vision API...');\r\n    var response = UrlFetchApp.fetch(visionUrl, options);\r\n    var responseCode = response.getResponseCode();\r\n    var responseText = response.getContentText();\r\n    \r\n    Logger.log('[OCR] Risposta Vision API: ' + responseCode);\r\n    \r\n    if (responseCode !== 200) { \r\n      var errorData = null;\r\n      try {\r\n        errorData = JSON.parse(responseText);\r\n      } catch(e) {}\r\n      \r\n      var errorMessage = 'Errore servizio OCR: ' + responseCode;\r\n      var errorCode = 'VISION_API_ERROR';\r\n      \r\n      if (errorData && errorData.error && errorData.error.message) {\r\n        errorMessage = errorData.error.message;\r\n        if (errorMessage.toLowerCase().includes('quota')) {\r\n          errorCode = 'QUOTA_EXCEEDED';\r\n        } else if (errorMessage.toLowerCase().includes('permission')) {\r\n          errorCode = 'PERMISSION_DENIED';\r\n        }\r\n      }\r\n      \r\n      return createJsonResponse({ \r\n        success: false, \r\n        message: errorMessage, \r\n        errorCode: errorCode,\r\n        debug: responseText.substring(0, 500)\r\n      }, responseCode);\r\n    }\r\n    \r\n    var data = JSON.parse(responseText);\r\n    var text = '';\r\n    if (data && data.responses && data.responses[0] && data.responses[0].fullTextAnnotation) {\r\n      text = data.responses[0].fullTextAnnotation.text;\r\n    }\r\n    \r\n    if (!text) { \r\n      return createJsonResponse({ \r\n        success: false, \r\n        message: 'Impossibile leggere il documento. Verifica che l\\'immagine sia chiara e ben illuminata.', \r\n        errorCode: 'NO_TEXT_DETECTED'\r\n      }, 400); \r\n    }\r\n    \r\n    Logger.log('[OCR] Testo estratto (primi 600 char): ' + text.substring(0, 600));\r\n    \r\n    if (tipoDoc === 'auto') { \r\n      tipoDoc = detectDocumentType(text); \r\n      Logger.log('[OCR] Tipo auto-rilevato: ' + tipoDoc); \r\n    }\r\n    \r\n    var extracted = parseMultiDocument(text, tipoDoc);\r\n    Logger.log('[OCR] Dati estratti: ' + JSON.stringify(extracted));\r\n    \r\n    // Valida i dati estratti\r\n    var validation = validateExtractedData(extracted, tipoDoc);\r\n    if (!validation.isValid) {\r\n      Logger.log('[OCR] Validazione dati fallita: ' + validation.warnings.join(', '));\r\n      extracted.validationWarnings = validation.warnings;\r\n    }\r\n    \r\n    return createJsonResponse({ \r\n      success: true, \r\n      message: 'Documento scansionato', \r\n      data: extracted, \r\n      autista: autistaNum, \r\n      tipoDocumento: tipoDoc, \r\n      debugText: text.substring(0, 600),\r\n      validationWarnings: validation.warnings || []\r\n    });\r\n    \r\n  } catch (err) {\r\n    Logger.log('[OCR] Errore: ' + err.message);\r\n    var errorCode = 'UNKNOWN_ERROR';\r\n    if (err.message.includes('timeout')) {\r\n      errorCode = 'TIMEOUT';\r\n    } else if (err.message.includes('network')) {\r\n      errorCode = 'NETWORK_ERROR';\r\n    }\r\n    \r\n    return createJsonResponse({ \r\n      success: false, \r\n      message: 'Errore durante l\\'elaborazione del documento: ' + err.message, \r\n      errorCode: errorCode \r\n    }, 500);\r\n  }\r\n}\r\nfunction detectDocumentType(text) {\r\n  if (/PATENTE\\s+DI\\s+GUIDA|DRIVING\\s+LICENCE/i.test(text)) return 'patente';\r\n  if (/CARTA\\s+D.?\\s?IDENTIT|IDENTITY\\s+CARD/i.test(text)) return 'carta';\r\n  if (/TESSERA\\s+SANITARIA|MINISTERO.*SALUTE/i.test(text)) return 'tessera';\r\n  return 'generico';\r\n}\r\nfunction parseMultiDocument(text, tipoDoc) {\r\n  var result = { nomeCompleto: '', nome: '', cognome: '', codiceFiscale: '', dataNascita: '', luogoNascita: '', numeroPatente: '', numeroDocumento: '', dataInizioPatente: '', scadenzaPatente: '', comuneResidenza: '', viaResidenza: '', civicoResidenza: '' };\r\n  Logger.log('[PARSE] Tipo: ' + tipoDoc);\r\n  var cfMatch = text.match(/\\b([A-Z]{6}[0-9]{2}[A-Z][0-9]{2}[A-Z][0-9]{3}[A-Z])\\b/i);\r\n  if (cfMatch) { result.codiceFiscale = cfMatch[1].toUpperCase(); Logger.log('[PARSE] ✅ CF: ' + result.codiceFiscale); }\r\n  if (tipoDoc === 'patente') { parsePatenteV2(text, result); }\r\n  else if (tipoDoc === 'carta') { parseCartaIdentita(text, result); }\r\n  else if (tipoDoc === 'tessera') { parseTesseraSanitaria(text, result); }\r\n  else { parsePatenteV2(text, result); parseCartaIdentita(text, result); }\r\n  return result;\r\n}\r\n/**\r\n * Parser PATENTE v2.2 - Estrazioni campo 3 robuste\r\n */\r\nfunction parsePatenteV2(text, result) {\r\n  Logger.log('[PARSE PATENTE v2.2] Inizio...');\r\n  var lines = text.split('\\n');\r\n  for (var i = 0; i < lines.length; i++) {\r\n    var line = lines[i].trim();\r\n    // 1. COGNOME\r\n    if (line.match(/^1[\\.\\s]/)) {\r\n      var cognome = line.replace(/^1[\\.\\s]+/, '').replace(/COGNOME|SURNAME/gi, '').trim();\r\n      if (cognome && cognome.length > 1) { result.cognome = cognome; Logger.log('[PARSE] ✅ Cognome: ' + result.cognome); }\r\n    }\r\n    // 2. NOME\r\n    if (line.match(/^2[\\.\\s]/)) {\r\n      var nome = line.replace(/^2[\\.\\s]+/, '').replace(/NOME|NAME/gi, '').trim();\r\n      if (nome && nome.length > 1) { result.nome = nome; Logger.log('[PARSE] ✅ Nome: ' + result.nome); }\r\n    }\r\n    // 3. DATA E LUOGO NASCITA - FIX\r\n    if (line.match(/^3[\\.\\s]/)) {\r\n      var nascitaLine = line.replace(/^3[\\.\\s]+/, '').trim();\r\n      Logger.log('[PARSE] Riga 3 raw: ' + nascitaLine);\r\n      // Estrai DATA (accetta 2 o 4 cifre anno, anche 16/04/66)\r\n      var dateMatch = nascitaLine.match(/(\\d{2})[\\/.:\\-](\\d{2})[\\/.:\\-](\\d{2,4})/);\r\n      if (dateMatch) {\r\n        // Data ben formata\r\n        var anno = dateMatch[3].length === 2 ? (parseInt(dateMatch[3]) > 50 ? '19' : '20') + dateMatch[3] : dateMatch[3];\r\n        result.dataNascita = anno + '-' + dateMatch[2].padStart(2, '0') + '-' + dateMatch[1].padStart(2, '0');\r\n        Logger.log('[PARSE] ✅ Data nascita: ' + result.dataNascita);\r\n        // Il resto dopo la data va come luogo\r\n        var afterDate = nascitaLine.replace(dateMatch[0], '').trim();\r\n        // Filtra header comuni/rumore\r\n        var luogoClean = afterDate.replace(/(REPUBBLICA ITALIANA|PATENTE DI GUIDA|MIT-UCO|MINISTERO|DI GUIDA|REPUBBLICA|ITALIANA)/gi,'').replace(/[\\(\\)]/g, '').replace(/\\s+/g, ' ').trim();\r\n        if (luogoClean && luogoClean.length > 2 && !/^\\d{2}\\/\\d{2}/.test(luogoClean)) {\r\n          result.luogoNascita = luogoClean;\r\n          dbg('[PARSE] ✅ Luogo nascita: ' + result.luogoNascita);\n        }\r\n      } else {\r\n        // Se la data non viene trovata, tutto della riga viene considerato luogo (fallback)\r\n        if (nascitaLine.length > 2 && !/^\\d{2}\\/\\d{2}/.test(nascitaLine)) {\r\n          result.luogoNascita = nascitaLine;\r\n        }\r\n      }\r\n    }\r\n  }\r\n  if (result.nome && result.cognome) { result.nomeCompleto = result.nome + ' ' + result.cognome; }\r\n  var allTokens = text.match(/\\b[A-Z0-9]{9,10}\\b/g);\r\n  if (allTokens) {\r\n    for (var t = 0; t < allTokens.length; t++) {\r\n      var token = allTokens[t];\r\n      if (token === result.codiceFiscale) continue;\r\n      if (result.nome && token.toUpperCase() === result.nome.toUpperCase()) continue;\r\n      if (result.cognome && token.toUpperCase() === result.cognome.toUpperCase()) continue;\r\n      if (/\\d/.test(token)) { result.numeroPatente = token; result.numeroDocumento = token; break; }\r\n    }\r\n  }\r\n  var rilascio = text.match(/(?:4a[\\.\\s]+|VALID\\s+FROM[:\\s]+)(\\d{2})[\\/.:\\-](\\d{2})[\\/.:\\-](\\d{4})/i);\r\n  if (rilascio) { result.dataInizioPatente = rilascio[3] + '-' + rilascio[2] + '-' + rilascio[1]; }\r\n  var scadenza = text.match(/(?:4b[\\.\\s]+|VALID\\s+UNTIL[:\\s]+)(\\d{2})[\\/.:\\-](\\d{2})[\\/.:\\-](\\d{4})/i);\r\n  if (scadenza) { result.scadenzaPatente = scadenza[3] + '-' + scadenza[2] + '-' + scadenza[1]; }\r\n  dbg('[PARSE PATENTE v2.2] ✅ Completato');\n}\r\nfunction parseCartaIdentita(text, result) { /* invariata */ }\r\nfunction parseTesseraSanitaria(text, result) { /* invariata */ }\r\nfunction normalizzaData(dataStr) { /* invariata */ }\r\n/**\r\n * Valida e preprocessa l'immagine base64\n */\nfunction validateAndPreprocessImage(imageBase64, mimeType) {\n  try {\n    // Rimuovi prefisso data URL se presente\n    if (imageBase64.indexOf('base64,') !== -1) {\n      imageBase64 = imageBase64.split('base64,')[1];\n    }\n    // Normalizza: rimuovi eventuali whitespace/newline\n    imageBase64 = String(imageBase64 || '').replace(/\\s+/g, '');\n    \n    // Decodifica base64 per validare\n    var decodedBytes = Utilities.base64Decode(imageBase64);\n    var sizeInBytes = decodedBytes.length;\n    var sizeInMB = sizeInBytes / (1024 * 1024);\n    \r\n    Logger.log('[OCR] Dimensione immagine: ' + sizeInMB.toFixed(2) + ' MB');\r\n    \r\n    // Validazioni\r\n    if (sizeInMB > 10) {\r\n      return { \r\n        valid: false, \r\n        error: 'L\\'immagine è troppo grande (max 10MB). Comprimi l\\'immagine e riprova.',\r\n        errorCode: 'IMAGE_TOO_LARGE'\r\n      };\r\n    }\r\n    \r\n    if (sizeInBytes < 1024) { // Meno di 1KB\r\n      return { \r\n        valid: false, \r\n        error: 'L\\'immagine è troppo piccola o corrotta.',\r\n        errorCode: 'IMAGE_TOO_SMALL'\r\n      };\r\n    }\r\n    \r\n    // Controlla se è un'immagine valida (controlla i primi byte per i magic numbers)\r\n    var firstBytes = decodedBytes.slice(0, 10);\n    var isValidImage = false;\n    \n    // JPEG: FF D8 FF\n    if (firstBytes[0] === 0xFF && firstBytes[1] === 0xD8 && firstBytes[2] === 0xFF) {\n      isValidImage = true;\n    }\n    // PNG: 89 50 4E 47 0D 0A 1A 0A\r\n    else if (firstBytes[0] === 0x89 && firstBytes[1] === 0x50 && firstBytes[2] === 0x4E && firstBytes[3] === 0x47) {\r\n      isValidImage = true;\r\n    }\r\n    // GIF: GIF87a or GIF89a\r\n    else if (firstBytes[0] === 0x47 && firstBytes[1] === 0x49 && firstBytes[2] === 0x46) {\r\n      isValidImage = true;\r\n    }\r\n    // WebP: RIFF....WEBP\r\n    else if (firstBytes[0] === 0x52 && firstBytes[1] === 0x49 && firstBytes[2] === 0x46 && firstBytes[3] === 0x46) {\n      isValidImage = true;\n    }\n    \n    // Fallback: se il mime type dichiarato è supportato, accetta comunque\n    if (!isValidImage && mimeType) {\n      var mt = String(mimeType).toLowerCase();\n      if (/^image\\/(jpeg|jpg|png|gif|webp)$/.test(mt)) {\n        isValidImage = true;\n        Logger.log('[OCR] Formato accettato via mimeType: ' + mt);\n      }\n    }\n    \n    if (!isValidImage) {\n      return { \n        valid: false, \n        error: 'Formato immagine non supportato. Usa JPEG, PNG, GIF o WebP.',\n        errorCode: 'UNSUPPORTED_FORMAT'\n      };\n    }\n    \r\n    // Se l'immagine è troppo grande, potremmo ridimensionarla, ma per ora accettiamola\r\n    // Google Vision API gestisce il ridimensionamento automatico\r\n    \r\n    var format = detectImageFormat(firstBytes);\n    if (!format && mimeType) {\n      format = String(mimeType).toLowerCase();\n    }\n    return {\n      valid: true,\n      processedImage: imageBase64,\n      sizeInBytes: sizeInBytes,\n      format: format\n    };\n    \n  } catch (error) {\n    Logger.log('[OCR] Errore validazione immagine: ' + error.message);\n    return { \n      valid: false, \n      error: 'Impossibile elaborare l\\'immagine. Verifica che sia un\\'immagine valida.',\n      errorCode: 'IMAGE_PROCESSING_ERROR'\n    };\n  }\n}\n\r\n/**\r\n * Rileva il formato dell'immagine dai primi byte\r\n */\r\nfunction detectImageFormat(firstBytes) {\r\n  if (firstBytes[0] === 0xFF && firstBytes[1] === 0xD8 && firstBytes[2] === 0xFF) return 'JPEG';\r\n  if (firstBytes[0] === 0x89 && firstBytes[1] === 0x50 && firstBytes[2] === 0x4E && firstBytes[3] === 0x47) return 'PNG';\r\n  if (firstBytes[0] === 0x47 && firstBytes[1] === 0x49 && firstBytes[2] === 0x46) return 'GIF';\r\n  if (firstBytes[0] === 0x52 && firstBytes[1] === 0x49 && firstBytes[2] === 0x46 && firstBytes[3] === 0x46) return 'WEBP';\r\n  return 'UNKNOWN';\r\n}\r\n\r\n/**\r\n * Valida i dati estratti dal documento\r\n */\r\nfunction validateExtractedData(extracted, tipoDoc) {\r\n  var warnings = [];\r\n  var isValid = true;\r\n  \r\n  try {\r\n    // Validazioni comuni per tutti i documenti\r\n    if (!extracted.codiceFiscale || extracted.codiceFiscale.length < 16) {\r\n      warnings.push('Codice fiscale non valido o mancante');\r\n      isValid = false;\r\n    }\r\n    \r\n    if (!extracted.nome || extracted.nome.length < 2) {\r\n      warnings.push('Nome non valido o mancante');\r\n      isValid = false;\r\n    }\r\n    \r\n    if (!extracted.cognome || extracted.cognome.length < 2) {\r\n      warnings.push('Cognome non valido o mancante');\r\n      isValid = false;\r\n    }\r\n    \r\n    // Validazioni specifiche per tipo documento\r\n    if (tipoDoc === 'patente') {\r\n      if (!extracted.numeroPatente || extracted.numeroPatente.length < 5) {\r\n        warnings.push('Numero patente non valido');\r\n        isValid = false;\r\n      }\r\n      \r\n      if (!extracted.dataNascita || !isValidDate(extracted.dataNascita)) {\r\n        warnings.push('Data di nascita non valida');\r\n        isValid = false;\r\n      }\r\n      \r\n      if (extracted.scadenzaPatente && !isValidDate(extracted.scadenzaPatente)) {\r\n        warnings.push('Data di scadenza patente non valida');\r\n      }\r\n    }\r\n    \r\n    if (tipoDoc === 'carta') {\r\n      if (!extracted.numeroDocumento || extracted.numeroDocumento.length < 5) {\r\n        warnings.push('Numero documento non valido');\r\n        isValid = false;\r\n      }\r\n    }\r\n    \r\n    // Controllo coerenza date\r\n    if (extracted.dataNascita && extracted.scadenzaPatente) {\r\n      var birthDate = new Date(extracted.dataNascita);\r\n      var expiryDate = new Date(extracted.scadenzaPatente);\r\n      \r\n      if (birthDate >= expiryDate) {\r\n        warnings.push('Data di nascita successiva alla scadenza del documento');\r\n        isValid = false;\r\n      }\r\n      \r\n      var age = calculateAge(birthDate);\r\n      if (age < 16) {\r\n        warnings.push('Età inferiore ai 16 anni');\r\n      }\r\n    }\r\n    \r\n  } catch (error) {\r\n    Logger.log('[OCR] Errore validazione dati: ' + error.message);\r\n    warnings.push('Errore durante la validazione dei dati');\r\n    isValid = false;\r\n  }\r\n  \r\n  return {\r\n    isValid: isValid,\r\n    warnings: warnings\r\n  };\r\n}\r\n\r\n/**\r\n * Verifica se una stringa data è valida\r\n */\r\nfunction isValidDate(dateString) {\r\n  try {\r\n    var date = new Date(dateString);\r\n    return date instanceof Date && !isNaN(date);\r\n  } catch (error) {\r\n    return false;\r\n  }\r\n}\r\n\r\n/**\r\n * Calcola l'età da una data di nascita\r\n */\r\nfunction calculateAge(birthDate) {\r\n  var today = new Date();\r\n  var birth = new Date(birthDate);\r\n  var age = today.getFullYear() - birth.getFullYear();\r\n  var monthDiff = today.getMonth() - birth.getMonth();\r\n  \r\n  if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {\r\n    age--;\r\n  }\r\n  \r\n  return age;\r\n}\r\n\r\nfunction testOcrService() { /* invariata */ }\r\n",
      "size": 16284,
      "lines": 435
    }
  },
  "configuration": {
    "requiredProperties": [
      "JWT_SECRET",
      "SPREADSHEET_ID",
      "WEBAPP_URL"
    ],
    "securityFeatures": [
      "JWT Secret Validation",
      "CSRF Token Protection",
      "Formula Injection Sanitization",
      "HTML Escaping",
      "Session Management"
    ]
  }
}