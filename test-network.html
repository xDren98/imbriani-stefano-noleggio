<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Network Error Handling</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover { background: #0056b3; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .log-entry {
            font-family: monospace;
            font-size: 12px;
            padding: 5px;
            margin: 2px 0;
            background: #f8f9fa;
            border-left: 3px solid #007bff;
        }
        .log-error { border-left-color: #dc3545; }
        .log-success { border-left-color: #28a745; }
        .log-warning { border-left-color: #ffc107; }
    </style>
</head>
<body>
    <h1>ðŸ§ª Test Gestione Errori di Rete</h1>
    
    <div class="test-section">
        <h2>Test Connessione API</h2>
        <p>Questi test verificano la gestione degli errori di rete con fallback e retry logic.</p>
        
        <button class="test-button" onclick="testSecureGet()">Test secureGet (getVeicoli)</button>
        <button class="test-button" onclick="testSecurePost()">Test securePost (debugAuth)</button>
        <button class="test-button" onclick="testFallbackOnly()">Test Solo Fallback</button>
        <button class="test-button" onclick="testRetryLogic()">Test Retry Logic</button>
        <button class="test-button" onclick="testOfflineMode()">Test ModalitÃ  Offline</button>
        <button class="test-button" onclick="clearLogs()">Pulisci Log</button>
        
        <div id="status"></div>
    </div>
    
    <div class="test-section">
        <h2>Log dei Test</h2>
        <div id="log-container" style="max-height: 400px; overflow-y: auto;"></div>
    </div>

    <script src="shared-utils.js"></script>
    <script>
        let testCount = 0;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('it-IT');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            document.getElementById('log-container').appendChild(logEntry);
            document.getElementById('log-container').scrollTop = document.getElementById('log-container').scrollHeight;
            
            if (type === 'error') {
                console.error(`[TEST ERROR] ${message}`);
            } else {
                console.log(`[TEST LOG] ${message}`);
            }
        }
        
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<span class="${type}">${message}</span>`;
        }
        
        async function testSecureGet() {
            testCount++;
            log(`=== Test ${testCount}: secureGet (getVeicoli) ===`, 'info');
            updateStatus('Testing secureGet...', 'warning');
            
            const startTime = performance.now();
            
            try {
                const result = await secureGet('getVeicoli', {});
                const duration = performance.now() - startTime;
                
                if (result && result.success) {
                    log(`âœ… SUCCESS: secureGet completato in ${duration.toFixed(2)}ms`, 'success');
                    log(`ðŸ“Š Dati ricevuti: ${result.data ? result.data.length : 0} veicoli`, 'success');
                    updateStatus(`âœ… Test completato con successo in ${duration.toFixed(2)}ms`, 'success');
                } else {
                    log(`âŒ ERROR: Risposta non valida - ${JSON.stringify(result)}`, 'error');
                    updateStatus('âŒ Test fallito: risposta non valida', 'error');
                }
            } catch (error) {
                const duration = performance.now() - startTime;
                log(`âŒ EXCEPTION: ${error.message} (after ${duration.toFixed(2)}ms)`, 'error');
                log(`ðŸ“ Stack: ${error.stack}`, 'error');
                updateStatus(`âŒ Test fallito: ${error.message}`, 'error');
            }
        }
        
        async function testSecurePost() {
            testCount++;
            log(`=== Test ${testCount}: securePost (debugAuth) ===`, 'info');
            updateStatus('Testing securePost...', 'warning');
            
            const startTime = performance.now();
            
            try {
                const result = await securePost('debugAuth', { 
                    test: true, 
                    timestamp: new Date().toISOString() 
                });
                const duration = performance.now() - startTime;
                
                if (result) {
                    log(`âœ… SUCCESS: securePost completato in ${duration.toFixed(2)}ms`, 'success');
                    log(`ðŸ“Š Risposta: ${JSON.stringify(result)}`, 'success');
                    updateStatus(`âœ… Test completato con successo in ${duration.toFixed(2)}ms`, 'success');
                } else {
                    log(`âŒ ERROR: Nessuna risposta ricevuta`, 'error');
                    updateStatus('âŒ Test fallito: nessuna risposta', 'error');
                }
            } catch (error) {
                const duration = performance.now() - startTime;
                log(`âŒ EXCEPTION: ${error.message} (after ${duration.toFixed(2)}ms)`, 'error');
                updateStatus(`âŒ Test fallito: ${error.message}`, 'error');
            }
        }
        
        async function testFallbackOnly() {
            testCount++;
            log(`=== Test ${testCount}: Solo Fallback (simulato) ===`, 'info');
            updateStatus('Testing fallback mechanism...', 'warning');
            
            // Test che forza l'uso del fallback disabilitando temporaneamente il proxy
            const originalUrl = window.CONFIG?.API_URL;
            
            try {
                // Simula proxy non disponibile
                if (window.CONFIG) {
                    window.CONFIG.API_URL = 'https://invalid-proxy-url-12345.com';
                }
                
                log('ðŸ”„ Forzando fallback con URL proxy invalido...', 'warning');
                const startTime = performance.now();
                
                const result = await secureGet('getVeicoli', {});
                const duration = performance.now() - startTime;
                
                if (result && result.success) {
                    log(`âœ… SUCCESS: Fallback funzionante! ${duration.toFixed(2)}ms`, 'success');
                    updateStatus('âœ… Fallback test superato', 'success');
                } else {
                    log(`âŒ ERROR: Fallback fallito - ${JSON.stringify(result)}`, 'error');
                    updateStatus('âŒ Fallback test fallito', 'error');
                }
                
            } catch (error) {
                const duration = performance.now() - startTime;
                log(`âŒ EXCEPTION in fallback: ${error.message} (after ${duration.toFixed(2)}ms)`, 'error');
                updateStatus(`âŒ Fallback test fallito: ${error.message}`, 'error');
            } finally {
                // Ripristina URL originale
                if (window.CONFIG && originalUrl) {
                    window.CONFIG.API_URL = originalUrl;
                }
            }
        }
        
        async function testRetryLogic() {
            testCount++;
            log(`=== Test ${testCount}: Retry Logic ===`, 'info');
            updateStatus('Testing retry mechanism...', 'warning');
            
            // Test del retry wrapper
            let attemptCount = 0;
            
            const testFunction = async () => {
                attemptCount++;
                log(`ðŸ”„ Tentativo ${attemptCount}...`, 'warning');
                
                if (attemptCount < 3) {
                    throw new Error(`Simulated failure on attempt ${attemptCount}`);
                }
                
                return { success: true, message: 'Success after retries' };
            };
            
            try {
                const result = await retryWithBackoff(testFunction, 3, 500);
                log(`âœ… SUCCESS: Retry logic funzionante! Tentativi: ${attemptCount}`, 'success');
                log(`ðŸ“Š Risultato: ${JSON.stringify(result)}`, 'success');
                updateStatus('âœ… Retry test superato', 'success');
            } catch (error) {
                log(`âŒ ERROR: Retry logic fallito - ${error.message}`, 'error');
                updateStatus('âŒ Retry test fallito', 'error');
            }
        }
        
        async function testOfflineMode() {
            testCount++;
            log(`=== Test ${testCount}: ModalitÃ  Offline ===`, 'info');
            updateStatus('Testing offline mode...', 'warning');
            
            // Simula modalitÃ  offline
            const wasOnline = navigator.onLine;
            
            try {
                // Forza stato offline (simulato)
                Object.defineProperty(navigator, 'onLine', {
                    value: false,
                    writable: true,
                    configurable: true
                });
                
                log('ðŸ“´ Simulando modalitÃ  offline...', 'warning');
                const startTime = performance.now();
                
                const result = await secureGet('getVeicoli', {});
                const duration = performance.now() - startTime;
                
                if (result && result.offline === true) {
                    log(`âœ… SUCCESS: Rilevamento offline corretto! ${duration.toFixed(2)}ms`, 'success');
                    log(`ðŸ“Š Messaggio offline: ${result.message}`, 'success');
                    updateStatus('âœ… Offline test superato', 'success');
                } else {
                    log(`âŒ ERROR: Offline non rilevato correttamente - ${JSON.stringify(result)}`, 'error');
                    updateStatus('âŒ Offline test fallito', 'error');
                }
                
            } catch (error) {
                const duration = performance.now() - startTime;
                log(`âŒ EXCEPTION in offline test: ${error.message} (after ${duration.toFixed(2)}ms)`, 'error');
                updateStatus(`âŒ Offline test fallito: ${error.message}`, 'error');
            } finally {
                // Ripristina stato online
                Object.defineProperty(navigator, 'onLine', {
                    value: wasOnline,
                    writable: true,
                    configurable: true
                });
            }
        }
        
        function clearLogs() {
            document.getElementById('log-container').innerHTML = '';
            document.getElementById('status').innerHTML = '';
            testCount = 0;
            log('ðŸ§¹ Log puliti. Pronto per nuovi test.', 'info');
        }
        
        // Log iniziale
        log('ðŸš€ Test Network Error Handling avviato', 'info');
        log(`ðŸ“¡ Stato connessione: ${navigator.onLine ? 'Online' : 'Offline'}`, 'info');
        log(`ðŸ”§ API URL: ${window.CONFIG?.API_URL || 'Non configurato'}`, 'info');
        
        // Test automatico al caricamento
        window.addEventListener('load', () => {
            setTimeout(() => {
                log('ðŸ”„ Avvio test automatico...', 'info');
                testSecureGet();
            }, 1000);
        });
        
        // Gestione cambiamenti di stato di rete
        window.addEventListener('online', () => {
            log('ðŸŸ¢ Connessione ristabilita', 'success');
        });
        
        window.addEventListener('offline', () => {
            log('ðŸ”´ Connessione persa', 'error');
        });
    </script>
</body>
</html>