<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Setup Proprietà – Imbriani</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-dark text-light">
<div class="container py-4" style="max-width: 860px;">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h1 class="h4 fw-bold mb-1">Setup Proprietà (emergenza)</h1>
      <div class="text-muted">Accedi in sviluppo, imposta Script Properties e verifica lo stato</div>
    </div>
    <div>
      <a href="admin.html" class="btn btn-outline-info">Vai ad Admin</a>
    </div>
  </div>

  <div class="card mb-3" style="background:rgba(33,37,41,.85)">
    <div class="card-body">
      <h2 class="h6 fw-bold mb-3">1. Accesso sviluppo</h2>
      <div class="row g-2 align-items-end">
        <div class="col-sm-6">
          <label class="form-label">Nome admin</label>
          <input id="dev-name" class="form-control" value="DevAdmin"/>
        </div>
        <div class="col-sm-6 d-grid">
          <button id="btn-dev-login" class="btn btn-primary"><i class="fas fa-flask me-2"></i>Accedi in sviluppo</button>
        </div>
      </div>
      <div id="dev-status" class="small text-muted mt-2">Stato: non autenticato</div>
    </div>
  </div>

  <div class="card mb-3" style="background:rgba(33,37,41,.85)">
    <div class="card-body">
      <h2 class="h6 fw-bold mb-3">2. Imposta Script Properties</h2>
      <form id="props-form" class="vstack gap-2">
        <div class="row g-2">
          <div class="col-sm-6"><label class="form-label">SPREADSHEET_ID</label><input id="SPREADSHEET_ID" class="form-control" placeholder="..."/></div>
          <div class="col-sm-6"><label class="form-label">EMAIL_FROM_EMAIL</label><input id="EMAIL_FROM_EMAIL" class="form-control" placeholder="nome@dominio"/></div>
        </div>
        <div class="row g-2">
          <div class="col-sm-6"><label class="form-label">PDF_TEMPLATE_DOC_ID</label><input id="PDF_TEMPLATE_DOC_ID" class="form-control" placeholder="..."/></div>
          <div class="col-sm-6"><label class="form-label">PDF_FOLDER_ID</label><input id="PDF_FOLDER_ID" class="form-control" placeholder="..."/></div>
        </div>
        <div class="row g-2">
          <div class="col-sm-6"><label class="form-label">GOOGLE_VISION_API_KEY</label><input id="GOOGLE_VISION_API_KEY" class="form-control" placeholder="AIza..."/></div>
          <div class="col-sm-6"><label class="form-label">SESSION_TTL_MINUTES</label><input id="SESSION_TTL_MINUTES" class="form-control" placeholder="120"/></div>
        </div>
        <div class="row g-2">
          <div class="col-sm-6"><label class="form-label">TELEGRAM_BOT_TOKEN</label><input id="TELEGRAM_BOT_TOKEN" class="form-control" placeholder="...:..."/></div>
          <div class="col-sm-6"><label class="form-label">TELEGRAM_CHAT_ID</label><input id="TELEGRAM_CHAT_ID" class="form-control" placeholder="2031..."/></div>
        </div>
        <div class="row g-2">
          <div class="col-sm-12"><label class="form-label">JWT_SECRET</label><input id="JWT_SECRET" type="password" class="form-control" placeholder="stringa lunga"/></div>
        </div>
        <div class="d-flex gap-2 mt-2">
          <button type="submit" class="btn btn-success"><i class="fas fa-save me-2"></i>Salva proprietà</button>
          <button type="button" id="btn-clear" class="btn btn-outline-warning"><i class="fas fa-eraser me-2"></i>Pulisci campi</button>
          <button type="button" id="btn-status" class="btn btn-outline-info"><i class="fas fa-clipboard-check me-2"></i>Verifica stato</button>
        </div>
        <div id="props-status" class="small text-muted mt-2">Stato: in attesa</div>
      </form>
    </div>
  </div>

  <div class="alert alert-secondary small">
    Dopo il salvataggio e la verifica, torna su <a href="admin.html" class="alert-link">Admin</a> e usa OTP o dev login normalmente.
  </div>
</div>

<script src="https://kit.fontawesome.com/a2e0e6ad20.js" crossorigin="anonymous"></script>
<script src="./config.js?v=20251113"></script>
<script src="./shared-utils.js?v=20251113"></script>
<script>
function setAdminSessionLocal(session){ try{ localStorage.setItem('imbriani_admin_session', JSON.stringify(session)); }catch(_){ } }
document.addEventListener('DOMContentLoaded', () => {
  const devName = document.getElementById('dev-name');
  const devBtn = document.getElementById('btn-dev-login');
  const devStatus = document.getElementById('dev-status');
  devBtn.onclick = async () => {
    try{
      const name = (devName.value||'').trim() || 'DevAdmin';
      const res = await window.securePost('devLogin', { name });
      if (res && res.success && res.token){
        setAdminSessionLocal({ name: res.name||name, token: res.token, role: res.role||'admin', exp: res.exp, timestamp: Date.now() });
        devStatus.textContent = 'Stato: autenticato (sviluppo)';
      } else {
        devStatus.textContent = 'Stato: errore dev login';
      }
    }catch(err){ devStatus.textContent = 'Stato: errore '+err.message; }
  };

  document.getElementById('btn-clear').onclick = () => {
    ['SPREADSHEET_ID','EMAIL_FROM_EMAIL','PDF_TEMPLATE_DOC_ID','PDF_FOLDER_ID','GOOGLE_VISION_API_KEY','SESSION_TTL_MINUTES','TELEGRAM_BOT_TOKEN','TELEGRAM_CHAT_ID','JWT_SECRET'].forEach(id=>{ try{ const el=document.getElementById(id); if(el) el.value=''; }catch(_){ } });
    document.getElementById('props-status').textContent = 'Stato: in attesa';
  };

  document.getElementById('btn-status').onclick = async () => {
    try{
      const res = await window.secureGet('configStatus', {});
      if (!res || res.success===false){ document.getElementById('props-status').textContent = 'Stato: errore '+(res?.message||''); return; }
      const s = res.status||{};
      const missing = Object.keys(s).filter(k => !s[k]);
      document.getElementById('props-status').textContent = missing.length ? ('Mancanti: '+missing.join(', ')) : 'Tutte impostate';
    }catch(err){ document.getElementById('props-status').textContent = 'Stato: errore '+err.message; }
  };

  document.getElementById('props-form').onsubmit = async (ev) => {
    ev.preventDefault();
    const payload = {};
    ['SPREADSHEET_ID','EMAIL_FROM_EMAIL','PDF_TEMPLATE_DOC_ID','PDF_FOLDER_ID','GOOGLE_VISION_API_KEY','SESSION_TTL_MINUTES','TELEGRAM_BOT_TOKEN','TELEGRAM_CHAT_ID','JWT_SECRET'].forEach(id=>{ const v=document.getElementById(id)?.value?.trim(); if(v) payload[id]=v; });
    try{
      const res = await window.securePost('setConfigProps', payload);
      if (res && res.success){ document.getElementById('props-status').textContent = 'Aggiornate: '+(res.updated||[]).join(', '); }
      else { document.getElementById('props-status').textContent = 'Errore salvataggio'; }
    }catch(err){ document.getElementById('props-status').textContent = 'Errore: '+err.message; }
  };
});
</script>
</body>
</html>
