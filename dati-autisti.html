<!DOCTYPE html>
<html lang="it" class="h-100">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dati Autisti ‚Äî Imbriani Stefano Noleggio</title>
  <meta name="description" content="Inserimento dati autisti - Imbriani Stefano Noleggio">
  <meta name="theme-color" content="#0066FF">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üöê</text></svg>">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <style>
    body{background:linear-gradient(135deg,#0f172a 0%,#1e293b 100%);min-height:100vh}
    .driver-card{border:2px dashed #334155;background:rgba(51,65,85,.35)}
    .driver-card.required{border-color:#f59e0b}
    .muted{color:#94a3b8}
  </style>
</head>
<body class="d-flex flex-column h-100">
  <header class="py-4">
    <div class="container">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
        <div>
          <h1 class="h3 text-white fw-bold mb-1">
            <i class="fas fa-users me-2"></i>
            Dati Autisti
          </h1>
          <p class="text-white-50 mb-0">Compila i dati degli autisti per completare la prenotazione</p>
        </div>
        <div class="d-flex gap-2">
          <button type="button" id="back-btn" class="btn btn-outline-light btn-sm">
            <i class="fas fa-arrow-left me-1"></i>Indietro
          </button>
          <span class="px-3 py-1 rounded-pill" style="background:linear-gradient(45deg,#06b6d4,#2563eb);color:#fff;font-weight:700">Step 3 di 3</span>
        </div>
      </div>
    </div>
  </header>

  <main class="flex-grow-1 py-4">
    <div class="container">
      <!-- Riepilogo prenotazione -->
      <div class="glass-card p-4 mb-4">
        <h5 class="fw-bold text-white mb-3"><i class="fas fa-clipboard-list me-2"></i>Riepilogo</h5>
        <div id="summary"></div>
      </div>

      <!-- Autista 1 (obbligatorio) -->
      <div class="glass-card p-4 mb-4 driver-card required">
        <h5 class="fw-bold text-white mb-3"><span class="badge bg-warning text-dark me-2">1</span> Autista principale</h5>
        <form id="driver1" class="row g-3">
          <div class="col-md-6"><label class="form-label">Nome</label><input id="d1_nome" class="form-control form-control-modern" required></div>
          <div class="col-md-6"><label class="form-label">Cognome</label><input id="d1_cognome" class="form-control form-control-modern" required></div>
          <div class="col-md-6"><label class="form-label">Codice Fiscale</label><input id="d1_cf" class="form-control form-control-modern" maxlength="16" required></div>
          <div class="col-md-6"><label class="form-label">Cellulare</label><input id="d1_cell" class="form-control form-control-modern" required></div>
          <div class="col-md-6"><label class="form-label">Data di nascita</label><input type="date" id="d1_dob" class="form-control form-control-modern"></div>
          <div class="col-md-6"><label class="form-label">Luogo di nascita</label><input id="d1_luogo" class="form-control form-control-modern"></div>
          <div class="col-md-6"><label class="form-label">Numero patente</label><input id="d1_patente" class="form-control form-control-modern"></div>
          <div class="col-md-3"><label class="form-label">Inizio validit√† patente</label><input type="date" id="d1_patente_inizio" class="form-control form-control-modern"></div>
          <div class="col-md-3"><label class="form-label">Scadenza patente</label><input type="date" id="d1_patente_scad" class="form-control form-control-modern"></div>
          <div class="col-12 muted">L'email verr√† richiesta nello step successivo.</div>
        </form>
      </div>

      <!-- Autista 2 opzionale -->
      <div class="glass-card p-4 mb-4 driver-card">
        <h5 class="fw-bold text-white mb-3"><span class="badge bg-info me-2">2</span> Autista aggiuntivo (opzionale)</h5>
        <form id="driver2" class="row g-3">
          <div class="col-md-6"><label class="form-label">Nome</label><input id="d2_nome" class="form-control form-control-modern"></div>
          <div class="col-md-6"><label class="form-label">Cognome</label><input id="d2_cognome" class="form-control form-control-modern"></div>
          <div class="col-md-6"><label class="form-label">Codice Fiscale</label><input id="d2_cf" class="form-control form-control-modern" maxlength="16"></div>
          <div class="col-md-6"><label class="form-label">Data di nascita</label><input type="date" id="d2_dob" class="form-control form-control-modern"></div>
          <div class="col-md-6"><label class="form-label">Luogo di nascita</label><input id="d2_luogo" class="form-control form-control-modern"></div>
          <div class="col-md-6"><label class="form-label">Numero patente</label><input id="d2_patente" class="form-control form-control-modern"></div>
          <div class="col-md-3"><label class="form-label">Inizio validit√† patente</label><input type="date" id="d2_patente_inizio" class="form-control form-control-modern"></div>
          <div class="col-md-3"><label class="form-label">Scadenza patente</label><input type="date" id="d2_patente_scad" class="form-control form-control-modern"></div>
        </form>
      </div>

      <!-- Autista 3 opzionale -->
      <div class="glass-card p-4 mb-4 driver-card">
        <h5 class="fw-bold text-white mb-3"><span class="badge bg-info me-2">3</span> Terzo autista (opzionale)</h5>
        <form id="driver3" class="row g-3">
          <div class="col-md-6"><label class="form-label">Nome</label><input id="d3_nome" class="form-control form-control-modern"></div>
          <div class="col-md-6"><label class="form-label">Cognome</label><input id="d3_cognome" class="form-control form-control-modern"></div>
          <div class="col-md-6"><label class="form-label">Codice Fiscale</label><input id="d3_cf" class="form-control form-control-modern" maxlength="16"></div>
          <div class="col-md-6"><label class="form-label">Data di nascita</label><input type="date" id="d3_dob" class="form-control form-control-modern"></div>
          <div class="col-md-6"><label class="form-label">Luogo di nascita</label><input id="d3_luogo" class="form-control form-control-modern"></div>
          <div class="col-md-6"><label class="form-label">Numero patente</label><input id="d3_patente" class="form-control form-control-modern"></div>
          <div class="col-md-3"><label class="form-label">Inizio validit√† patente</label><input type="date" id="d3_patente_inizio" class="form-control form-control-modern"></div>
          <div class="col-md-3"><label class="form-label">Scadenza patente</label><input type="date" id="d3_patente_scad" class="form-control form-control-modern"></div>
        </form>
      </div>

      <div class="glass-card p-4">
        <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center">
          <div class="text-white-50 small"><i class="fas fa-shield-alt me-1"></i>I dati verranno salvati nel foglio CLIENTI (insert/update per CF). Il cellulare verr√† associato al primo autista. L'email verr√† richiesta dopo.</div>
          <button id="submit-btn" class="btn btn-premium">
            <span class="spinner-border spinner-border-sm me-2 d-none" id="submit-spinner"></span>
            Salva autisti e completa prenotazione
          </button>
        </div>
      </div>
    </div>
  </main>

  <div id="toast-container" class="position-fixed top-0 end-0 p-3" style="z-index:1055"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="config.js"></script>
  <script src="shared-utils.js"></script>
  <script>
    let currentUser = null; let selectedDates = null; let selectedVehicle = null;

    document.addEventListener('DOMContentLoaded', () => {
      // Recupero dati
      try { currentUser = JSON.parse(localStorage.getItem('imbriani_user')||'null'); } catch(_){}
      try { selectedVehicle = JSON.parse(localStorage.getItem('imbriani_selected_vehicle')||'null'); } catch(_){}
      try { selectedDates = JSON.parse(localStorage.getItem('imbriani_selected_dates')||'null'); } catch(_){}

      if (!localStorage.getItem('imbriani_preventivo_richiesto')){
        if (window.showToast) showToast('Completa prima la richiesta preventivo', 'warning');
        return setTimeout(()=>location.href='richiesta-preventivo.html',1000);
      }
      if (!selectedVehicle || !selectedDates){ if (window.showToast) showToast('Dati prenotazione mancanti', 'error'); return setTimeout(()=>location.href='veicoli.html',1000); }

      bindUI();
      prefillDriver1();
      renderSummary();
    });

    function bindUI(){
      document.getElementById('back-btn')?.addEventListener('click', ()=> history.back());
      document.getElementById('submit-btn')?.addEventListener('click', onSubmit);
    }

    function renderSummary(){
      const el = document.getElementById('summary');
      const formatDate = (d)=> new Date(d).toLocaleDateString('it-IT');
      el.innerHTML = `
        <div class="row align-items-center">
          <div class="col-md-8">
            <div class="d-flex align-items-center gap-3">
              <div class="bg-primary p-3 rounded-3"><i class="fas fa-car text-white" style="font-size:1.25rem"></i></div>
              <div>
                <div class="text-white fw-semibold">${selectedVehicle?.Targa||'-'} ‚Äî ${selectedVehicle?.Marca||''} ${selectedVehicle?.Modello||''}</div>
                <div class="text-white-75 small"><i class="fas fa-users me-1"></i>${selectedVehicle?.Posti||''} posti ${selectedVehicle?.PassoLungo?'‚Ä¢ Passo Lungo':''}</div>
              </div>
            </div>
          </div>
          <div class="col-md-4 text-end">
            <div class="small text-white-50">Periodo:</div>
            <div class="text-white">${formatDate(selectedDates.dataInizio)} ${selectedDates.oraRitiro}</div>
            <div class="text-white">${formatDate(selectedDates.dataFine)} ${selectedDates.oraRiconsegna}</div>
            ${selectedDates?.destinazione?`<div class="small text-info mt-1"><i class="fas fa-map-marker-alt me-1"></i>${selectedDates.destinazione}</div>`:''}
          </div>
        </div>`;
    }

    function prefillDriver1(){
      if (!currentUser) return;
      document.getElementById('d1_nome').value = currentUser.nome || '';
      const cognomeGuess = (currentUser.cognome||'').trim();
      document.getElementById('d1_cognome').value = cognomeGuess;
      document.getElementById('d1_cf').value = currentUser.codiceFiscale || '';
      document.getElementById('d1_cell').value = currentUser.cellulare || '';
      document.getElementById('d1_dob').value = currentUser.dataNascita ? new Date(currentUser.dataNascita).toISOString().slice(0,10) : '';
      document.getElementById('d1_luogo').value = currentUser.luogoNascita || '';
      document.getElementById('d1_patente').value = currentUser.numeroPatente || '';
      document.getElementById('d1_patente_inizio').value = currentUser.inizioValiditaPatente ? new Date(currentUser.inizioValiditaPatente).toISOString().slice(0,10) : '';
      document.getElementById('d1_patente_scad').value = currentUser.scadenzaPatente ? new Date(currentUser.scadenzaPatente).toISOString().slice(0,10) : '';
    }

    function getDriverFromForm(prefix){
      const get = (id)=> document.getElementById(id)?.value?.trim()||'';
      const base = {
        nome: get(prefix+'_nome'), cognome: get(prefix+'_cognome'), codiceFiscale: get(prefix+'_cf'),
        dataNascita: get(prefix+'_dob'), luogoNascita: get(prefix+'_luogo'),
        numeroPatente: get(prefix+'_patente'), inizioValiditaPatente: get(prefix+'_patente_inizio'), scadenzaPatente: get(prefix+'_patente_scad')
      };
      return base;
    }

    function validateDriver1(d){
      if (!d.nome || !d.cognome || !d.codiceFiscale || d.codiceFiscale.length!==16){ return 'Completa nome, cognome e un CF valido (16 caratteri)'; }
      if (!document.getElementById('d1_cell').value.trim()) return 'Inserisci il cellulare del primo autista';
      return null;
    }

    async function onSubmit(){
      const btn = document.getElementById('submit-btn'); const spn = document.getElementById('submit-spinner');
      btn.disabled = true; spn.classList.remove('d-none');

      const d1 = getDriverFromForm('d1');
      const d2 = getDriverFromForm('d2');
      const d3 = getDriverFromForm('d3');
      const d1Cell = document.getElementById('d1_cell').value.trim();

      const err = validateDriver1(d1);
      if (err){ if (window.showToast) showToast(err, 'error'); btn.disabled=false; spn.classList.add('d-none'); return; }

      // Costruisci payload per backend Apps Script
      const payload = {
        action: 'creaPrenotazione',
        // dati prenotazione base
        targa: selectedVehicle?.Targa,
        giornoInizio: selectedDates?.dataInizio,
        giornoFine: selectedDates?.dataFine,
        oraInizio: selectedDates?.oraRitiro,
        oraFine: selectedDates?.oraRiconsegna,
        destinazione: selectedDates?.destinazione||'',
        // autisti
        autista1: { ...d1, cellulare: d1Cell },
        autista2: d2?.codiceFiscale? d2 : null,
        autista3: d3?.codiceFiscale? d3 : null,
        // policy: email richiesta dopo ‚Üí non inviare ora
        emailPrimoAutista: null,
        // flag per backend: aggiorna foglio CLIENTI (upsert per CF). Cellulare/email associati al primo autista.
        upsertClienti: true
      };

      try{
        const res = await fetch(CONFIG.API_URL,{
          method:'POST',
          headers:{ 'Content-Type':'application/json', 'Authorization': `Bearer ${CONFIG.TOKEN}` },
          body: JSON.stringify(payload)
        }).then(r=>r.json());

        if (!res.success){ throw new Error(res.message||'Errore creazione prenotazione'); }

        if (window.showToast) showToast('Prenotazione inviata! Riceverai conferma dopo verifica admin.', 'success');
        // Pulizia flag preventivo per evitare rientri non voluti
        localStorage.removeItem('imbriani_preventivo_richiesto');
        // TODO: redirect a pagina riepilogo/area personale
        setTimeout(()=>{ location.href = currentUser ? 'area-personale.html' : 'index.html'; }, 1000);
      }catch(e){
        console.error(e);
        if (window.showToast) showToast(e.message, 'error');
      }finally{
        btn.disabled=false; spn.classList.add('d-none');
      }
    }
  </script>
</body>
</html>