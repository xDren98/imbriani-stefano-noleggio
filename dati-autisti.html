<!DOCTYPE html>
<html lang="it" class="h-100">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dati Autisti - Imbriani Stefano Noleggio</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" integrity="sha512-RXf+QSDCUQs6b4v5A9R2v6KUVKp1R9+XcMgy7pYzFSHLn3U4a8gE9F7R5C3XxR28Z59TLEEqzvvR1vpuYeIRsA==" crossorigin="anonymous">
  <link rel="stylesheet" href="styles.css">
  <style>
    body{background:linear-gradient(135deg,#0f172a 0%,#1e293b 100%);min-height:100vh}
    .driver-card{border:2px dashed #334155;background:rgba(51,65,85,.35);margin-bottom:2rem}
    .driver-card.required{border-color:#f59e0b}
    .glass-card{background:rgba(15,23,42,.8);border:1px solid rgba(148,163,184,.2);border-radius:12px;backdrop-filter:blur(10px)}
    .ocr-minimal{background:none;padding:0;display:flex;gap:8px;margin-bottom:8px}
    .ocr-minimal label{background:rgba(22,22,22,0.2);border:1px solid #334155;color:#e2e8f0;padding:8px 16px;border-radius:8px;cursor:pointer;transition:.2s;display:flex;align-items:center;font-size:.95em;font-weight:500;}
    .ocr-minimal label:hover{background:rgba(59,130,246,0.15);color:#38bdf8;border-color:#0ea5e9;}
  </style>
</head>
<body class="d-flex flex-column h-100">
<header class="py-4">
  <div class="container d-flex align-items-center justify-content-between flex-wrap gap-3">
    <div>
      <h1 class="h3 text-white fw-bold mb-1"><i class="fas fa-users me-2"></i>Dati Autisti</h1>
      <p class="text-white-50 mb-0">Compila in automatico con scansione documenti</p>
    </div>
    <div class="d-flex gap-2">
      <button type="button" id="back-btn" class="btn btn-outline-light btn-sm"><i class="fas fa-arrow-left me-1"></i>Indietro</button>
      <span class="px-3 py-1 rounded-pill" style="background:linear-gradient(45deg,#06b6d4,#2563eb);color:#fff;font-weight:700;">Step 3 di 4</span>
    </div>
  </div>
</header>
<main class="flex-grow-1 py-4">
  <div class="container">
    <div class="glass-card p-4 mb-4">
      <h5 class="fw-bold text-white mb-3"><i class="fas fa-clipboard-list me-2"></i>Riepilogo</h5>
      <div id="summary"></div>
    </div>
    <!-- AUTISTA 1 -->
    <div class="glass-card p-4 mb-4 driver-card required">
      <h5 class="fw-bold text-white mb-3"><span class="badge bg-warning text-dark me-2">1</span> Autista principale</h5>
      <div class="ocr-minimal mb-4">
        <span class="text-white-50 small fw-semibold">Scansione rapida:</span>
        <label for="ocr-patente-1"><i class="fas fa-id-card me-1"></i>Patente</label>
        <label for="ocr-carta-1"><i class="fas fa-address-card me-1"></i>Carta d'identità</label>
        <label for="ocr-tessera-1"><i class="fas fa-credit-card me-1"></i>Tessera sanitaria</label>
      </div>
      <input type="file" id="ocr-patente-1" accept="image/jpeg,image/png,image/gif,image/webp" capture="environment" style="display:none">
      <input type="file" id="ocr-carta-1" accept="image/jpeg,image/png,image/gif,image/webp" capture="environment" style="display:none">
      <input type="file" id="ocr-tessera-1" accept="image/jpeg,image/png,image/gif,image/webp" capture="environment" style="display:none">
      <div id="ocr-preview-1" class="mt-2"></div>
      <div id="ocr-loader-1" class="mt-2 text-info" style="display:none"><div class="spinner-border spinner-border-sm me-2"></div>Scansione...</div>
      <div id="ocr-success-1" class="alert alert-success mt-2 mb-0" style="display:none"></div>
      <div id="ocr-error-1" class="alert alert-danger mt-2 mb-0" style="display:none"></div>
      <form id="driver-form-1" autocomplete="off">
        <div class="row gy-3 mt-1">
          <div class="col-md-12"><label class="form-label">Nome completo</label><input class="form-control form-control-modern" type="text" id="nomeCompleto-1" required placeholder="Mario Rossi"></div>
          <div class="col-md-6">
            <label class="form-label d-flex justify-content-between align-items-center">
              <span>Codice Fiscale</span>
              <button type="button" id="search-cf-1" class="btn btn-sm btn-outline-info"><i class="fas fa-search me-1"></i>Cerca dati cliente</button>
            </label>
            <input class="form-control form-control-modern" type="text" id="cf-1" required maxlength="16" placeholder="RSSMRA80A12H501L" pattern="^[A-Z]{6}[0-9]{2}[A-Z][0-9]{2}[A-Z][0-9]{3}[A-Z]$" title="Inserisci un Codice Fiscale valido (16 caratteri)">
          </div>
          <div class="col-md-6"><label class="form-label">Cellulare</label><input class="form-control form-control-modern" type="tel" id="cell-1" placeholder="+39..." required></div>
          <div class="col-md-6"><label class="form-label">Data di nascita</label><input type="date" class="form-control form-control-modern" id="nascita-1" required></div>
          <div class="col-md-6"><label class="form-label">Luogo di nascita</label><input class="form-control form-control-modern" type="text" id="luogo-1" required placeholder="Comune (PR)"></div>
          <div class="col-md-6"><label class="form-label">Numero Patente</label><input class="form-control form-control-modern" type="text" id="patente-1" required placeholder="..." autocomplete="off"></div>
          <div class="col-md-6"><label class="form-label">Data rilascio patente</label><input type="date" class="form-control form-control-modern" id="rilascio-1" required></div>
          <div class="col-md-6"><label class="form-label">Data scadenza patente</label><input type="date" class="form-control form-control-modern" id="scadenza-1" required></div>
          <div class="col-md-4"><label class="form-label">Comune di residenza</label><input class="form-control form-control-modern" id="comuneResidenza-1" placeholder="Comune (PR)" required></div>
          <div class="col-md-5"><label class="form-label">Via di residenza</label><input class="form-control form-control-modern" id="viaResidenza-1" placeholder="Via/Piazza" required></div>
          <div class="col-md-3"><label class="form-label">Civico</label><input class="form-control form-control-modern" id="civicoResidenza-1" placeholder="n°" required></div>
        </div>
      </form>
    </div>
    <!-- AUTISTA 2 -->
    <div class="glass-card p-4 mb-4 driver-card">
      <h5 class="fw-bold text-white mb-3"><span class="badge bg-secondary text-light me-2">2</span> Autista secondario (opzionale)</h5>
      <div class="ocr-minimal mb-4">
        <span class="text-white-50 small fw-semibold">Scansione rapida:</span>
        <label for="ocr-patente-2"><i class="fas fa-id-card me-1"></i>Patente</label>
        <label for="ocr-carta-2"><i class="fas fa-address-card me-1"></i>Carta d'identità</label>
        <label for="ocr-tessera-2"><i class="fas fa-credit-card me-1"></i>Tessera sanitaria</label>
      </div>
      <input type="file" id="ocr-patente-2" accept="image/jpeg,image/png,image/gif,image/webp" capture="environment" style="display:none">
      <input type="file" id="ocr-carta-2" accept="image/jpeg,image/png,image/gif,image/webp" capture="environment" style="display:none">
      <input type="file" id="ocr-tessera-2" accept="image/jpeg,image/png,image/gif,image/webp" capture="environment" style="display:none">
      <div id="ocr-preview-2" class="mt-2"></div>
      <div id="ocr-loader-2" class="mt-2 text-info" style="display:none"><div class="spinner-border spinner-border-sm me-2"></div>Scansione...</div>
      <div id="ocr-success-2" class="alert alert-success mt-2 mb-0" style="display:none"></div>
      <div id="ocr-error-2" class="alert alert-danger mt-2 mb-0" style="display:none"></div>
      <form id="driver-form-2" autocomplete="off">
        <div class="row gy-3 mt-1">
          <div class="col-md-12"><label class="form-label">Nome completo</label><input class="form-control form-control-modern" type="text" id="nomeCompleto-2" placeholder="Mario Rossi"></div>
          <div class="col-md-6"><label class="form-label">Codice Fiscale</label><input class="form-control form-control-modern" type="text" id="cf-2" maxlength="16" placeholder="RSSMRA80A12H501L" pattern="^[A-Z]{6}[0-9]{2}[A-Z][0-9]{2}[A-Z][0-9]{3}[A-Z]$" title="Inserisci un Codice Fiscale valido (16 caratteri)"></div>
          <div class="col-md-6"><label class="form-label">Cellulare</label><input class="form-control form-control-modern" type="tel" id="cell-2" placeholder="+39..."></div>
          <div class="col-md-6"><label class="form-label">Data di nascita</label><input type="date" class="form-control form-control-modern" id="nascita-2"></div>
          <div class="col-md-6"><label class="form-label">Luogo di nascita</label><input class="form-control form-control-modern" type="text" id="luogo-2" placeholder="Comune (PR)"></div>
          <div class="col-md-6"><label class="form-label">Numero Patente</label><input class="form-control form-control-modern" type="text" id="patente-2" placeholder="..." autocomplete="off"></div>
          <div class="col-md-6"><label class="form-label">Data rilascio patente</label><input type="date" class="form-control form-control-modern" id="rilascio-2"></div>
          <div class="col-md-6"><label class="form-label">Data scadenza patente</label><input type="date" class="form-control form-control-modern" id="scadenza-2"></div>
          <div class="col-md-4"><label class="form-label">Comune di residenza</label><input class="form-control form-control-modern" id="comuneResidenza-2" placeholder="Comune (PR)"></div>
          <div class="col-md-5"><label class="form-label">Via di residenza</label><input class="form-control form-control-modern" id="viaResidenza-2" placeholder="Via/Piazza"></div>
          <div class="col-md-3"><label class="form-label">Civico</label><input class="form-control form-control-modern" id="civicoResidenza-2" placeholder="n°"></div>
        </div>
      </form>
    </div>
    <!-- AUTISTA 3 -->
    <div class="glass-card p-4 mb-4 driver-card">
      <h5 class="fw-bold text-white mb-3"><span class="badge bg-secondary text-light me-2">3</span> Autista aggiuntivo (opzionale)</h5>
      <div class="ocr-minimal mb-4">
        <span class="text-white-50 small fw-semibold">Scansione rapida:</span>
        <label for="ocr-patente-3"><i class="fas fa-id-card me-1"></i>Patente</label>
        <label for="ocr-carta-3"><i class="fas fa-address-card me-1"></i>Carta d'identità</label>
        <label for="ocr-tessera-3"><i class="fas fa-credit-card me-1"></i>Tessera sanitaria</label>
      </div>
      <input type="file" id="ocr-patente-3" accept="image/jpeg,image/png,image/gif,image/webp" capture="environment" style="display:none">
      <input type="file" id="ocr-carta-3" accept="image/jpeg,image/png,image/gif,image/webp" capture="environment" style="display:none">
      <input type="file" id="ocr-tessera-3" accept="image/jpeg,image/png,image/gif,image/webp" capture="environment" style="display:none">
      <div id="ocr-preview-3" class="mt-2"></div>
      <div id="ocr-loader-3" class="mt-2 text-info" style="display:none"><div class="spinner-border spinner-border-sm me-2"></div>Scansione...</div>
      <div id="ocr-success-3" class="alert alert-success mt-2 mb-0" style="display:none"></div>
      <div id="ocr-error-3" class="alert alert-danger mt-2 mb-0" style="display:none"></div>
      <form id="driver-form-3" autocomplete="off">
        <div class="row gy-3 mt-1">
          <div class="col-md-12"><label class="form-label">Nome completo</label><input class="form-control form-control-modern" type="text" id="nomeCompleto-3" placeholder="Mario Rossi"></div>
          <div class="col-md-6"><label class="form-label">Codice Fiscale</label><input class="form-control form-control-modern" type="text" id="cf-3" maxlength="16" placeholder="RSSMRA80A12H501L" pattern="^[A-Z]{6}[0-9]{2}[A-Z][0-9]{2}[A-Z][0-9]{3}[A-Z]$" title="Inserisci un Codice Fiscale valido (16 caratteri)"></div>
          <div class="col-md-6"><label class="form-label">Cellulare</label><input class="form-control form-control-modern" type="tel" id="cell-3" placeholder="+39..."></div>
          <div class="col-md-6"><label class="form-label">Data di nascita</label><input type="date" class="form-control form-control-modern" id="nascita-3"></div>
          <div class="col-md-6"><label class="form-label">Luogo di nascita</label><input class="form-control form-control-modern" type="text" id="luogo-3" placeholder="Comune (PR)"></div>
          <div class="col-md-6"><label class="form-label">Numero Patente</label><input class="form-control form-control-modern" type="text" id="patente-3" placeholder="..." autocomplete="off"></div>
          <div class="col-md-6"><label class="form-label">Data rilascio patente</label><input type="date" class="form-control form-control-modern" id="rilascio-3"></div>
          <div class="col-md-6"><label class="form-label">Data scadenza patente</label><input type="date" class="form-control form-control-modern" id="scadenza-3"></div>
          <div class="col-md-4"><label class="form-label">Comune di residenza</label><input class="form-control form-control-modern" id="comuneResidenza-3" placeholder="Comune (PR)"></div>
          <div class="col-md-5"><label class="form-label">Via di residenza</label><input class="form-control form-control-modern" id="viaResidenza-3" placeholder="Via/Piazza"></div>
          <div class="col-md-3"><label class="form-label">Civico</label><input class="form-control form-control-modern" id="civicoResidenza-3" placeholder="n°"></div>
        </div>
      </form>
    </div>
    <!-- Footer -->
    <div class="text-end">
      <button id="prosegui-btn" class="btn btn-premium px-4 py-2"><i class="fas fa-arrow-right me-2"></i>Procedi al riepilogo</button>
    </div>
    <div id="toast-container" class="position-fixed top-0 end-0 p-3" style="z-index:1055;"></div>
  </div>
</main>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
<script src="config.js"></script>
<script src="shared-utils.js"></script>
<script>
const DRIVERS = [1,2,3];
function bindUI() {
  document.getElementById('back-btn').onclick = ()=>history.back();
  document.getElementById('prosegui-btn').onclick = onSubmit;
  DRIVERS.forEach(i=>{
    ['patente', 'carta', 'tessera'].forEach(tipo=>{
      const input=document.getElementById(`ocr-${tipo}-${i}`);
      const label=document.querySelector(`label[for='ocr-${tipo}-${i}']`);
      if(input && label){
        // Il label con attributo "for" scatena già il click sull'input;
        // evitare un click manuale per non aprire due volte il file picker.
        input.onchange=e=>handleOCRScan(i, tipo, e);
      }
    });
  });
  // Ricerca cliente via CF per autista principale
  const btnSearch = document.getElementById('search-cf-1');
  if (btnSearch) {
    btnSearch.onclick = async () => {
      const cf = (document.getElementById('cf-1')?.value||'').trim().toUpperCase();
      if (!cf || cf.length !== 16) { showToast('Inserisci un CF valido (16 caratteri)','warning'); return; }
      try{
        const res = await api.call({ action:'getCliente', codiceFiscale: cf });
        if (res && res.success && res.data) {
          try { localStorage.setItem('imbriani_user', JSON.stringify(res.data)); } catch(_){}
          prefillDriver(1, {
            nomeCompleto: res.data.nomeCompleto||res.data.nome||'',
            cf: res.data.codiceFiscale,
            cell: res.data.cellulare || res.data.telefono || '',
            nascita: res.data.dataNascitaFormatted || res.data.dataNascita,
            luogo: res.data.luogoNascita,
            patente: res.data.numeroPatente,
            rilascio: res.data.inizioValiditaPatenteFormatted || res.data.inizioValiditaPatente || res.data.dataInizioPatente,
            scadenza: res.data.scadenzaPatenteFormatted || res.data.scadenzaPatente,
            comuneResidenza: res.data.comuneResidenza || '',
            viaResidenza: res.data.viaResidenza || '',
            civicoResidenza: res.data.civicoResidenza || ''
          });
          showToast('Cliente trovato! Dati compilati automaticamente','success');
        } else {
          showToast(res && res.message ? res.message : 'Cliente non trovato', 'warning');
        }
      }catch(e){
        console.error(e);
        showToast('Errore ricerca cliente: ' + (e.message||e), 'error');
      }
    };
  }
}
function renderSummary() {
  document.getElementById('summary').innerHTML = `<div class='text-white'><strong>Attenzione:</strong> Compila almeno i dati dell'autista principale. Usa le card successive per aggiungere autisti extra.</div>`;
}

// Helper globale: imposta un valore data (ISO yyyy-mm-dd) su input, compatibile con flatpickr
function applyDatePrefill(inputId, isoValue){
  const el = document.getElementById(inputId);
  if (!el) return;
  const val = isoValue || '';
  if (el._flatpickr) {
    try { el._flatpickr.setDate(val, true); } catch(_){ el.value = val; }
  } else {
    el.value = val;
  }
}

function prefillDriver(i, data) {
  if(!data) return;
  if(document.getElementById(`nomeCompleto-${i}`)&&data.nomeCompleto)
    document.getElementById(`nomeCompleto-${i}`).value = data.nomeCompleto;
  if(document.getElementById(`comuneResidenza-${i}`)&&data.comuneResidenza)
    document.getElementById(`comuneResidenza-${i}`).value = data.comuneResidenza;
  if(document.getElementById(`viaResidenza-${i}`)&&data.viaResidenza)
    document.getElementById(`viaResidenza-${i}`).value = data.viaResidenza;
  if(document.getElementById(`civicoResidenza-${i}`)&&data.civicoResidenza)
    document.getElementById(`civicoResidenza-${i}`).value = data.civicoResidenza;

  // Normalizza e imposta correttamente i campi data (YYYY-MM-DD)
  function normalizeDateInput(v){
    if(!v) return '';
    try{
      if (v instanceof Date && !isNaN(v.getTime())){
        const y=v.getFullYear(), m=String(v.getMonth()+1).padStart(2,'0'), d=String(v.getDate()).padStart(2,'0');
        return `${y}-${m}-${d}`;
      }
      const s = String(v).trim();
      const mIT = s.match(/^([0-3]?\d)[\/\.\-]([0-1]?\d)[\/\.\-](\d{4})$/);
      if (mIT) return `${mIT[3]}-${String(mIT[2]).padStart(2,'0')}-${String(mIT[1]).padStart(2,'0')}`;
      if (s.includes('T')) return s.split('T')[0];
      const mISO = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (mISO) return s;
      const d2 = new Date(s);
      if (!isNaN(d2.getTime())){
        const y=d2.getFullYear(), m=String(d2.getMonth()+1).padStart(2,'0'), d=String(d2.getDate()).padStart(2,'0');
        return `${y}-${m}-${d}`;
      }
    }catch(_){ }
    return '';
  }

  if (data.nascita) {
    const v = window.toISO ? window.toISO(data.nascita) : normalizeDateInput(data.nascita);
    applyDatePrefill(`nascita-${i}`, v);
  }
  if (data.rilascio) {
    const v = window.toISO ? window.toISO(data.rilascio) : normalizeDateInput(data.rilascio);
    applyDatePrefill(`rilascio-${i}`, v);
  }
  if (data.scadenza) {
    const v = window.toISO ? window.toISO(data.scadenza) : normalizeDateInput(data.scadenza);
    applyDatePrefill(`scadenza-${i}`, v);
  }

  for(const key in data) {
    if(!['nomeCompleto','comuneResidenza','viaResidenza','civicoResidenza','nascita','rilascio','scadenza'].includes(key)&&document.getElementById(`${key}-${i}`) && data[key])
      document.getElementById(`${key}-${i}`).value = data[key];
  }
}
function analyzeFieldsAutista(i) {
  const id = `${i}`;
  let missing = [];
  ['nomeCompleto','cf','cell','nascita','luogo','patente','rilascio','scadenza','comuneResidenza','viaResidenza','civicoResidenza']
    .forEach(f=>{if(!document.getElementById(f+'-'+id).value) missing.push(f);});
  return missing;
}
function showMissingFieldsGuided(i) {
  const missing = analyzeFieldsAutista(i);
  if(missing.length>0) {
    showToast(`Compilare tutti i campi. Mancano: ${missing.join(', ')}`,'warning',5000);
    return false;
  }
  return true;
}
function onSubmit() {
  if(!showMissingFieldsGuided(1)) return;
  // Salva tutto su localStorage per riepilogo-prenotazione.html
  const driversData = {
    autista1: getDriver(1),
    autista2: getDriver(2),
    autista3: getDriver(3)
  };
  localStorage.setItem('imbriani_drivers', JSON.stringify(driversData));
  // Se presente idPrenotazione in query, aggiorna direttamente la prenotazione esistente
  const qp = new URLSearchParams(window.location.search);
  const idPren = qp.get('idPrenotazione') || qp.get('id') || '';
  const driverToken = qp.get('t') || qp.get('token') || '';
  if (idPren) {
    const payload = {
      idPrenotazione: idPren,
      autista1: Object.assign({}, driversData.autista1),
      autista2: driversData.autista2 && driversData.autista2.codiceFiscale ? Object.assign({}, driversData.autista2) : null,
      autista3: driversData.autista3 && driversData.autista3.codiceFiscale ? Object.assign({}, driversData.autista3) : null,
      cellulare: (driversData.autista1 && (driversData.autista1.cell || driversData.autista1.cellulare)) || ''
    };
    showToast('Salvo i dati autisti sulla prenotazione...', 'info');
    const action = driverToken ? 'aggiornaAutistiPubblico' : 'aggiornaPrenotazioneCompleta';
    if (driverToken) payload.t = driverToken; // invia token autisti nel campo 't'
    window.api.call({ action, ...payload })
      .then(res => {
        if (res && res.success) {
          showToast('Dati autisti aggiornati con successo!', 'success');
          setTimeout(()=>{ window.location.href = 'area-personale.html'; }, 1000);
        } else {
          showToast(res && res.message ? res.message : 'Errore aggiornamento prenotazione', 'error');
        }
      })
      .catch(err => {
        console.error('[UPDATE PRENOTAZIONE] Errore:', err);
        showToast('Errore di rete durante il salvataggio', 'error');
      });
    return;
  }
  // Flusso normale: vai al riepilogo
  showToast('Dati validati correttamente! Proseguo...','success',3500);
  setTimeout(()=>{ window.location.href = 'riepilogo-prenotazione.html'; }, 800);
}
function getDriver(i) {
  const id = `${i}`;
  const toIT = (d) => { try { return (window.formatDateIT ? window.formatDateIT(d) : d) || ''; } catch(_) { return d||''; } };
  return {
    nomeCompleto: document.getElementById('nomeCompleto-'+id).value,
    codiceFiscale: document.getElementById('cf-'+id).value,
    cell: document.getElementById('cell-'+id).value,
    dataNascita: toIT(document.getElementById('nascita-'+id).value),
    luogoNascita: document.getElementById('luogo-'+id).value,
    numeroPatente: document.getElementById('patente-'+id).value,
    inizioValiditaPatente: toIT(document.getElementById('rilascio-'+id).value),
    scadenzaPatente: toIT(document.getElementById('scadenza-'+id).value),
    comuneResidenza: document.getElementById('comuneResidenza-'+id).value,
    viaResidenza: document.getElementById('viaResidenza-'+id).value,
    civicoResidenza: document.getElementById('civicoResidenza-'+id).value
  };
}
function handleOCRScan(i, tipo, e) {
  const input = e.target;
  if(!input.files.length) return;
  
  const loader = document.getElementById('ocr-loader-'+i);
  const successDiv = document.getElementById('ocr-success-'+i);
  const errorDiv = document.getElementById('ocr-error-'+i);
  
  loader.style.display='block'; 
  successDiv.style.display='none'; 
  errorDiv.style.display='none';
  
  // Validazione file lato client
  const file = input.files[0];
  const maxSize = 10 * 1024 * 1024; // 10MB
  
  if (file.size > maxSize) {
    loader.style.display='none';
    errorDiv.textContent = 'L\'immagine è troppo grande (max 10MB). Usa un\'immagine più piccola.';
    errorDiv.style.display='block';
    return;
  }
  
  // Accettiamo solo formati immagine supportati dal servizio OCR
  const type = (file.type||'').toLowerCase();
  if (!type.startsWith('image/')) {
    loader.style.display='none';
    errorDiv.textContent = 'Il file selezionato non è un\'immagine valida.';
    errorDiv.style.display='block';
    return;
  }
  if (!/^image\/(jpeg|jpg|png|gif|webp)$/.test(type)) {
    loader.style.display='none';
    errorDiv.textContent = 'Formato immagine non supportato. Usa JPEG, PNG, GIF o WebP.';
    errorDiv.style.display='block';
    return;
  }
  
  fileToBase64(file, (base64)=>{
    performOCRWithRetry(i, tipo, base64, 0, loader, successDiv, errorDiv, type);
  });
}

/**
 * Esegue OCR con logica di retry
 */
function performOCRWithRetry(i, tipo, base64, attempt, loader, successDiv, errorDiv, mimeType) {
  const maxAttempts = 2;
  const retryDelay = 1000; // 1 secondo
  
  api.securePost('ocrDocument', { image: base64, autista: i, tipoDocumento: tipo, mimeType })
   .then(res=>{
     loader.style.display='none';
     
     if(res && res.success) {
       // Mostra warning se ci sono
       if (res.validationWarnings && res.validationWarnings.length > 0) {
         showToast('Attenzione: ' + res.validationWarnings.join(', '), 'warning', 5000);
       }
       
       prefillDriver(i, mergeFieldsSafe(res.data));
       successDiv.textContent = 'Dati riconosciuti con successo!';
       successDiv.style.display='block';
     } else {
       handleOCRError(res, errorDiv, attempt < maxAttempts - 1, () => {
         setTimeout(() => {
           performOCRWithRetry(i, tipo, base64, attempt + 1, loader, successDiv, errorDiv, mimeType);
         }, retryDelay);
       });
     }
   })
   .catch(err => {
     loader.style.display='none';
     console.error('[OCR] Errore:', err);
     
     // In caso di errore di rete, prova un retry
     if (attempt < maxAttempts - 1) {
       errorDiv.textContent = `Errore di connessione. Nuovo tentativo ${attempt + 2}/${maxAttempts}...`;
       errorDiv.style.display='block';
       
       setTimeout(() => {
         performOCRWithRetry(i, tipo, base64, attempt + 1, loader, successDiv, errorDiv, mimeType);
       }, retryDelay);
     } else {
       errorDiv.textContent = 'Impossibile contattare il servizio OCR. Verifica la connessione e riprova.';
       errorDiv.style.display='block';
     }
   });
}

/**
 * Gestisce gli errori OCR con messaggi specifici
 */
function handleOCRError(response, errorDiv, canRetry, retryCallback) {
  let errorMessage = 'Errore durante la scansione del documento.';
  
  if (response && response.errorCode) {
    switch (response.errorCode) {
      case 'MISSING_IMAGE':
        errorMessage = 'Nessuna immagine selezionata.';
        break;
      case 'IMAGE_TOO_LARGE':
        errorMessage = 'L\'immagine è troppo grande. Usa un\'immagine più piccola (max 10MB).';
        break;
      case 'IMAGE_TOO_SMALL':
        errorMessage = 'L\'immagine è troppo piccola o corrotta.';
        break;
      case 'UNSUPPORTED_FORMAT':
        errorMessage = 'Formato immagine non supportato. Usa JPEG, PNG, GIF o WebP.';
        break;
      case 'CONFIG_ERROR':
        errorMessage = 'Servizio OCR temporaneamente non disponibile.';
        break;
      case 'VISION_API_ERROR':
        errorMessage = 'Errore nel servizio di riconoscimento. Riprova con un\'immagine più chiara.';
        break;
      case 'QUOTA_EXCEEDED':
        errorMessage = 'Servizio OCR temporaneamente sovraccarico. Riprotra più tardi.';
        break;
      case 'PERMISSION_DENIED':
        errorMessage = 'Accesso al servizio OCR negato.';
        break;
      case 'NO_TEXT_DETECTED':
        errorMessage = 'Impossibile leggere il documento. Verifica che l\'immagine sia chiara e ben illuminata.';
        break;
      case 'TIMEOUT':
        errorMessage = 'Timeout durante l\'elaborazione. Riprova.';
        if (canRetry && retryCallback) {
          errorMessage += ' Nuovo tentativo in corso...';
          retryCallback();
          return;
        }
        break;
      case 'NETWORK_ERROR':
        errorMessage = 'Errore di rete. Verifica la connessione.';
        if (canRetry && retryCallback) {
          errorMessage += ' Nuovo tentativo in corso...';
          retryCallback();
          return;
        }
        break;
      default:
        if (response && response.message) {
          errorMessage = response.message;
        }
    }
  } else if (response && response.message) {
    errorMessage = response.message;
  }
  
  errorDiv.textContent = errorMessage;
  errorDiv.style.display='block';
}
function mergeFieldsSafe(fields) {
  const mapping = { nomeCompleto:'nomeCompleto', codiceFiscale:'cf', cell:'cell', dataNascita:'nascita', luogoNascita:'luogo', numeroPatente:'patente', dataInizioPatente:'rilascio', scadenzaPatente:'scadenza', comuneResidenza:'comuneResidenza', viaResidenza:'viaResidenza', civicoResidenza:'civicoResidenza' };
  let mapped = {};
  for(const key in mapping){ if(fields[key]) mapped[mapping[key]]=fields[key]; }
  return mapped;
}
function fileToBase64(file, cb) {
  const reader = new FileReader();
  reader.onload = ()=>cb(reader.result.split(',')[1]);
  reader.onerror = ()=>cb('');
  reader.readAsDataURL(file);
}
document.addEventListener('DOMContentLoaded', ()=>{
  renderSummary();
  bindUI();
  let user = sessionStorage.getItem('userData');
  if (user) {
    user = JSON.parse(user);
    function splitAddress(str){
      const s = String(str||'').trim();
      if(!s) return { via:'', civico:'' };
      const parts = s.split(/\s+/);
      if (parts.length === 1) return { via: s, civico: '' };
      const last = parts[parts.length-1];
      if (/^\d+[A-Za-z]?$/.test(last)) {
        return { via: parts.slice(0,-1).join(' '), civico: last };
      }
      return { via: s, civico: '' };
    }
    function toISO(dateStr) {
      if(!dateStr) return '';
      const parts = dateStr.split(/[\/-]/);
      if(parts.length === 3) {
        if(parts[2].length === 4) return `${parts[2]}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`;
        if(parts[0].length === 4) return `${parts[0]}-${parts[1].padStart(2,'0')}-${parts[2].padStart(2,'0')}`;
      }
      return dateStr;
    }
    const addr = splitAddress(user.indirizzo);
    prefillDriver(1, {
      nomeCompleto: user.nomeCompleto||user.nome||'',
      cf: user.codiceFiscale,
      cell: user.cellulare || user.telefono || '',
      nascita: toISO(user.dataNascitaFormatted||user.dataNascita),
      luogo: user.luogoNascita,
      patente: user.numeroPatente,
      // Supporta anche dataInizioPatente come alias
      rilascio: toISO(user.inizioValiditaPatenteFormatted||user.inizioValiditaPatente||user.dataInizioPatente),
      scadenza: toISO(user.scadenzaPatenteFormatted||user.scadenzaPatente),
      comuneResidenza: user.comuneResidenza||'',
      viaResidenza: user.viaResidenza || addr.via || '',
      civicoResidenza: user.civicoResidenza || addr.civico || ''
    });
    if(window.showToast) showToast('Dati del profilo cliente importati!','success');
  }

  // Fallback: se non c'è sessionStorage, usa localStorage (utente loggato)
  if (!sessionStorage.getItem('userData')) {
    let raw = localStorage.getItem('imbriani_user');
    if (raw) {
      let user = {};
      try { user = JSON.parse(raw); } catch(_){ }

      function splitAddress(str){
        const s = String(str||'').trim();
        if(!s) return { via:'', civico:'' };
        const parts = s.split(/\s+/);
        if (parts.length === 1) return { via: s, civico: '' };
        const last = parts[parts.length-1];
        if (/^\d+[A-Za-z]?$/.test(last)) {
          return { via: parts.slice(0,-1).join(' '), civico: last };
        }
        return { via: s, civico: '' };
      }
      function toISO(dateStr) {
        if(!dateStr) return '';
        const parts = String(dateStr).split(/[\/\-]/);
        if(parts.length === 3) {
          if(parts[2] && parts[2].length === 4) return `${parts[2]}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`;
          if(parts[0] && parts[0].length === 4) return `${parts[0]}-${parts[1].padStart(2,'0')}-${parts[2].padStart(2,'0')}`;
        }
        return dateStr;
      }

      // applyDatePrefill è ora definita globalmente all'inizio del file

      function birthDateFromCF(cf){
        try{
          const s = String(cf||'').toUpperCase();
          if(s.length !== 16) return '';
          const yy = s.substring(6,8);
          const mL = s.substring(8,9);
          const ddCode = parseInt(s.substring(9,11),10);
          const months = {A:1,B:2,C:3,D:4,E:5,H:6,L:7,M:8,P:9,R:10,S:11,T:12};
          const m = months[mL];
          if(!m || isNaN(ddCode)) return '';
          const day = ddCode>40?ddCode-40:ddCode;
          const year = parseInt(yy,10);
          const fullYear = year>=0 && year<= (new Date().getFullYear()%100) ? 2000+year : 1900+year;
          const iso = `${fullYear}-${String(m).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
          return iso;
        }catch(_){return ''}
      }

      const addr = splitAddress(user.indirizzo);
      prefillDriver(1, {
        nomeCompleto: user.nomeCompleto||user.nome||'',
        cf: user.codiceFiscale,
        cell: user.cellulare || user.telefono || '',
        nascita: toISO(user.dataNascitaFormatted||user.dataNascita),
        luogo: user.luogoNascita,
        patente: user.numeroPatente,
        rilascio: toISO(user.inizioValiditaPatenteFormatted||user.inizioValiditaPatente||user.dataInizioPatente),
        scadenza: toISO(user.scadenzaPatenteFormatted||user.scadenzaPatente),
        comuneResidenza: user.comuneResidenza||'',
        viaResidenza: user.viaResidenza || addr.via || '',
        civicoResidenza: user.civicoResidenza || addr.civico || ''
      });

      applyDatePrefill('nascita-1', toISO(user.dataNascitaFormatted||user.dataNascita));
      applyDatePrefill('rilascio-1', toISO(user.inizioValiditaPatenteFormatted||user.inizioValiditaPatente||user.dataInizioPatente));
      applyDatePrefill('scadenza-1', toISO(user.scadenzaPatenteFormatted||user.scadenzaPatente));

      // Se la data di nascita è assente, prova a derivarla dal CF
      const currentBirth = document.getElementById('nascita-1')?.value;
      if(!currentBirth){
        const cfISO = birthDateFromCF(user.codiceFiscale);
        if(cfISO) applyDatePrefill('nascita-1', cfISO);
      }

      if(window.showToast) showToast('Dati del profilo cliente importati!','success');
    }
  }

  // Prova ad arricchire dal backend se mancano dati chiave (CF presente)
  enrichFromBackendIfNeeded();
});

// Arricchisce i dati dell'utente dal backend e precompila le date se mancanti
async function enrichFromBackendIfNeeded(){
  try{
    const raw = localStorage.getItem('imbriani_user');
    let user = {};
    if (!raw) {
      // Nessun utente in storage: prova con il CF dal form
      const cfInput = document.getElementById('cf-1');
      const cfVal = (cfInput && cfInput.value || '').trim().toUpperCase();
      if (cfVal && cfVal.length === 16) {
        const res0 = await api.call({ action:'getCliente', codiceFiscale: cfVal });
        if (res0 && res0.success && res0.data) {
          user = res0.data;
          localStorage.setItem('imbriani_user', JSON.stringify(user));
        } else {
          return;
        }
      } else {
        return;
      }
    } else {
      try { user = JSON.parse(raw); } catch(_) { return; }
    }

    const hasBirth = Boolean(user.dataNascita || user.dataNascitaFormatted);
    const hasLicenseStart = Boolean(user.inizioValiditaPatente || user.inizioValiditaPatenteFormatted || user.dataInizioPatente);
    const hasLicenseEnd = Boolean(user.scadenzaPatente || user.scadenzaPatenteFormatted);
    const hasPatenteNum = Boolean(user.numeroPatente);
    const hasLuogo = Boolean(user.luogoNascita);
    const hasTelefono = Boolean(user.cellulare || user.telefono);
    const needsEnrich = !(hasBirth && hasLicenseStart && hasLicenseEnd && hasPatenteNum && hasLuogo && hasTelefono);
    if (!needsEnrich) return;

    const cf = user.codiceFiscale || (document.getElementById('cf-1')?.value || '').trim().toUpperCase();
    if (!cf || cf.length !== 16) return;
    const res = await api.call({ action:'getCliente', codiceFiscale: cf });
    if (!res || !res.success || !res.data) return;

    const updated = { ...user, ...res.data };
    localStorage.setItem('imbriani_user', JSON.stringify(updated));

    function splitAddress(str){
      const s = String(str||'').trim();
      if(!s) return { via:'', civico:'' };
      const parts = s.split(/\s+/);
      if (parts.length === 1) return { via: s, civico: '' };
      const last = parts[parts.length-1];
      if (/^\d+[A-Za-z]?$/.test(last)) {
        return { via: parts.slice(0,-1).join(' '), civico: last };
      }
      return { via: s, civico: '' };
    }

    const addr = splitAddress(updated.indirizzo);
    const nascitaISO = (function(dateStr){
      if(!dateStr) return '';
      const parts = String(dateStr).split(/[\/\-]/);
      if(parts.length === 3) {
        if(parts[2] && parts[2].length === 4) return `${parts[2]}-${String(parts[1]).padStart(2,'0')}-${String(parts[0]).padStart(2,'0')}`;
        if(parts[0] && parts[0].length === 4) return `${parts[0]}-${String(parts[1]).padStart(2,'0')}-${String(parts[2]).padStart(2,'0')}`;
      }
      return dateStr;
    })(updated.dataNascitaFormatted||updated.dataNascita);
    const rilascioISO = (function(dateStr){
      if(!dateStr) return '';
      const parts = String(dateStr).split(/[\/\-]/);
      if(parts.length === 3) {
        if(parts[2] && parts[2].length === 4) return `${parts[2]}-${String(parts[1]).padStart(2,'0')}-${String(parts[0]).padStart(2,'0')}`;
        if(parts[0] && parts[0].length === 4) return `${parts[0]}-${String(parts[1]).padStart(2,'0')}-${String(parts[2]).padStart(2,'0')}`;
      }
      return dateStr;
    })(updated.inizioValiditaPatenteFormatted||updated.inizioValiditaPatente||updated.dataInizioPatente);
    const scadenzaISO = (function(dateStr){
      if(!dateStr) return '';
      const parts = String(dateStr).split(/[\/\-]/);
      if(parts.length === 3) {
        if(parts[2] && parts[2].length === 4) return `${parts[2]}-${String(parts[1]).padStart(2,'0')}-${String(parts[0]).padStart(2,'0')}`;
        if(parts[0] && parts[0].length === 4) return `${parts[0]}-${String(parts[1]).padStart(2,'0')}-${String(parts[2]).padStart(2,'0')}`;
      }
      return dateStr;
    })(updated.scadenzaPatenteFormatted||updated.scadenzaPatente);

    prefillDriver(1, {
      nomeCompleto: updated.nomeCompleto||updated.nome||'',
      cf: updated.codiceFiscale,
      cell: updated.cellulare || updated.telefono || '',
      nascita: nascitaISO,
      luogo: updated.luogoNascita,
      patente: updated.numeroPatente,
      rilascio: rilascioISO,
      scadenza: scadenzaISO,
      comuneResidenza: updated.comuneResidenza||'',
      viaResidenza: updated.viaResidenza || addr.via || '',
      civicoResidenza: updated.civicoResidenza || addr.civico || ''
    });

    applyDatePrefill('nascita-1', nascitaISO);
    applyDatePrefill('rilascio-1', rilascioISO);
    applyDatePrefill('scadenza-1', scadenzaISO);

    // Fallback: se la data di nascita è assente, prova a derivarla dal CF
    try {
      const nascitaEl = document.getElementById('nascita-1');
      if (nascitaEl && !nascitaEl.value) {
        const cfISO = (function(cf){
          try{
            const s = String(cf||'').toUpperCase();
            if(s.length !== 16) return '';
            const yy = s.substring(6,8);
            const mL = s.substring(8,9);
            const ddCode = parseInt(s.substring(9,11),10);
            const months = {A:1,B:2,C:3,D:4,E:5,H:6,L:7,M:8,P:9,R:10,S:11,T:12};
            const m = months[mL];
            if(!m || isNaN(ddCode)) return '';
            const day = ddCode>40?ddCode-40:ddCode;
            const year = parseInt(yy,10);
            const fullYear = year>=0 && year<= (new Date().getFullYear()%100) ? 2000+year : 1900+year;
            return `${fullYear}-${String(m).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
          }catch(_){return ''}
        })(updated.codiceFiscale || document.getElementById('cf-1')?.value);
        if (cfISO) applyDatePrefill('nascita-1', cfISO);
      }
    } catch(_){ }

    if (window.showToast) showToast('Dati autocompilati dal backend del cliente loggato','info');
  }catch(err){
    console.error('[DRIVERS] Enrich backend failed:', err);
  }
}
</script>
</body>
</html>
