function mergeFieldsSafe(n, d) {
  function safeSet(id, value) {
    const el = document.getElementById(id);
    if (el && (!el.value || el.value.trim() === '') && value) {
      el.value = value;
      el.classList.add('bg-success','text-white');
      el.setAttribute('title', 'ğŸŸ© Campo compilato da documento!'); // Emoji feedback
      setTimeout(()=>{
        el.classList.remove('bg-success','text-white');
        el.setAttribute('title','');
      },1500);
    }
  }
  safeSet(`d${n}nomeCompleto`, d.nomeCompleto);
  safeSet(`d${n}cf`, d.codiceFiscale);
  safeSet(`d${n}dob`, normalizeDateInput(d.dataNascita));
  safeSet(`d${n}luogo`, d.luogoNascita);
  safeSet(`d${n}patente`, d.numeroPatente);
  safeSet(`d${n}patenteinizio`, normalizeDateInput(d.dataInizioPatente));
  safeSet(`d${n}patentescad`, normalizeDateInput(d.scadenzaPatente));
  safeSet(`d${n}comune`, d.comuneResidenza);
  safeSet(`d${n}via`, d.viaResidenza);
  safeSet(`d${n}civico`, d.civicoResidenza);
}
function normalizeDateInput(val) {
  if (!val) return '';
  if (/^\d{4}-\d{2}-\d{2}$/.test(val)) return val;
  try { 
    const d = new Date(val); 
    return d.toISOString().slice(0,10); 
  } catch (_) { return ''; }
}
function showMissingFieldsGuided(n, m, ultimo) {
  const a = document.getElementById(`missing-fields-${n}`);
  const l = document.getElementById(`missing-list-${n}`);
  const sg = document.getElementById(`suggestion-${n}`);
  if (!a || !l || !sg) return;
  l.innerHTML = m.map(x => `<li>${x.label}</li>`).join('');
  let txt = '';
  const needP = m.some(x => x.doc === 'patente');
  const needC = m.some(x => x.doc === 'carta');
  const needT = m.some(x => x.doc === 'tessera');
  const needM = m.some(x => x.doc === 'manuale');
  if (needP && ultimo !== 'patente') txt = '<strong>ğŸš— Scansiona PATENTE (fronte)</strong> per nome, date, numero';
  else if (needC && ultimo !== 'carta') txt = '<strong>ğŸ†” Scansiona CARTA D&#39;IDENTITÃ€</strong> (fronte se cartacea, retro se CIE)';
  else if (needT && ultimo !== 'tessera') txt = '<strong>ğŸ’Š Scansiona TESSERA SANITARIA</strong> per CF';
  else if (needM) txt = 'âœï¸ Inserisci manualmente: <strong>' + m.filter(x => x.doc === 'manuale').map(x => x.label).join(', ') + '</strong>';
  else txt = 'Compila manualmente i rimanenti';
  sg.innerHTML = txt;
  a.style.display = 'block';
  setTimeout(() => a.scrollIntoView({ behavior: 'smooth', block: 'center' }), 300);
}
